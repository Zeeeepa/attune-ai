{
  "template_id": "code_refactoring_workflow",
  "name": "Code Refactoring Workflow",
  "description": "Safe code refactoring with validation, testing, and review",
  "version": "1.0.0",
  "author": "Attune AI Team",
  "created_at": "2026-01-17T09:00:00Z",
  "estimated_cost_range": [
    0.15,
    2.5
  ],
  "form_schema": {
    "title": "Code Refactoring Configuration",
    "description": "Configure your code refactoring workflow with safety checks and validation",
    "questions": [
      {
        "id": "refactoring_scope",
        "type": "single_select",
        "options": [
          "Single function",
          "Single class",
          "Multiple classes in module",
          "Entire module/package"
        ],
        "required": true,
        "help_text": "Determines the complexity and agent team size",
        "text": "What is the scope of your refactoring?",
        "default": null
      },
      {
        "id": "refactoring_type",
        "type": "multi_select",
        "options": [
          "Extract method/function",
          "Rename variables/functions",
          "Simplify conditional logic",
          "Remove code duplication",
          "Improve naming conventions",
          "Update type hints",
          "Modernize syntax (e.g., f-strings, match/case)"
        ],
        "required": true,
        "help_text": "Select all applicable refactoring types",
        "text": "What type of refactoring are you performing?",
        "default": null
      },
      {
        "id": "preserve_tests",
        "type": "boolean",
        "required": true,
        "help_text": "If Yes, tests will be run before and after refactoring",
        "text": "Do you have existing tests that must pass?",
        "options": [],
        "default": null
      },
      {
        "id": "test_coverage_required",
        "type": "single_select",
        "options": [
          "60%",
          "70%",
          "80%",
          "90%",
          "95%"
        ],
        "required": false,
        "dependencies": {
          "preserve_tests": true
        },
        "help_text": "Coverage threshold for validation",
        "text": "What minimum test coverage do you require?",
        "default": null
      },
      {
        "id": "style_guide",
        "type": "single_select",
        "options": [
          "PEP 8 (Python standard)",
          "Google Python Style Guide",
          "Custom (.ruff.toml or pyproject.toml)",
          "None - skip linting"
        ],
        "required": true,
        "text": "Which style guide should be enforced?",
        "default": null
      },
      {
        "id": "safety_level",
        "type": "single_select",
        "options": [
          "Conservative (only safe refactorings)",
          "Moderate (safe + suggested improvements)",
          "Aggressive (all recommended changes)"
        ],
        "required": true,
        "help_text": "Conservative minimizes risk, Aggressive maximizes improvement",
        "text": "What safety level do you want?",
        "default": null
      },
      {
        "id": "create_backup",
        "type": "boolean",
        "required": true,
        "help_text": "Recommended: creates .bak files before modifications",
        "text": "Create backup before refactoring?",
        "options": [],
        "default": null
      },
      {
        "id": "review_required",
        "type": "boolean",
        "required": true,
        "help_text": "If Yes, shows diff and waits for approval before writing",
        "text": "Require human review before applying changes?",
        "options": [],
        "default": null
      }
    ]
  },
  "agent_composition_rules": [
    {
      "role": "code_analyzer",
      "base_template": "code_reviewer",
      "tier_strategy": "capable_first",
      "required_responses": {},
      "config": {
        "scope": "{{refactoring_scope}}",
        "analysis_depth": "deep",
        "identify_smells": true
      },
      "tools": [
        "ast_parser",
        "complexity_analyzer"
      ],
      "success_criteria": {
        "analysis_complete": true,
        "smells_identified": true
      }
    },
    {
      "role": "test_runner_before",
      "base_template": "testing_specialist",
      "tier_strategy": "cheap_only",
      "required_responses": {
        "preserve_tests": true
      },
      "config": {
        "test_phase": "before_refactoring",
        "coverage_threshold": "{{test_coverage_required}}",
        "fail_fast": true
      },
      "tools": [
        "pytest",
        "coverage"
      ],
      "success_criteria": {
        "tests_pass": true,
        "coverage_met": true
      }
    },
    {
      "role": "refactoring_planner",
      "base_template": "code_reviewer",
      "tier_strategy": "progressive",
      "required_responses": {},
      "config": {
        "refactoring_types": "{{refactoring_type}}",
        "safety_level": "{{safety_level}}",
        "create_plan": true
      },
      "tools": [
        "ast_parser",
        "refactoring_catalog"
      ],
      "success_criteria": {
        "plan_created": true,
        "risk_assessed": true
      }
    },
    {
      "role": "refactorer",
      "base_template": "code_generator",
      "tier_strategy": "capable_first",
      "required_responses": {},
      "config": {
        "refactoring_plan": "from_planner",
        "safety_level": "{{safety_level}}",
        "create_backup": "{{create_backup}}",
        "dry_run": "{{review_required}}"
      },
      "tools": [
        "ast_rewriter",
        "rope",
        "black"
      ],
      "success_criteria": {
        "refactoring_applied": true,
        "syntax_valid": true
      }
    },
    {
      "role": "style_enforcer",
      "base_template": "code_reviewer",
      "tier_strategy": "cheap_only",
      "required_responses": {},
      "config": {
        "style_guide": "{{style_guide}}",
        "auto_fix": true
      },
      "tools": [
        "ruff",
        "black",
        "isort"
      ],
      "success_criteria": {
        "style_compliant": true
      }
    },
    {
      "role": "test_runner_after",
      "base_template": "testing_specialist",
      "tier_strategy": "cheap_only",
      "required_responses": {
        "preserve_tests": true
      },
      "config": {
        "test_phase": "after_refactoring",
        "coverage_threshold": "{{test_coverage_required}}",
        "compare_with_before": true
      },
      "tools": [
        "pytest",
        "coverage",
        "pytest-benchmark"
      ],
      "success_criteria": {
        "tests_pass": true,
        "coverage_maintained": true,
        "no_performance_regression": true
      }
    },
    {
      "role": "diff_reviewer",
      "base_template": "code_reviewer",
      "tier_strategy": "progressive",
      "required_responses": {
        "review_required": true
      },
      "config": {
        "show_diff": true,
        "highlight_risks": true,
        "request_approval": true
      },
      "tools": [
        "difflib",
        "syntax_highlighter"
      ],
      "success_criteria": {
        "diff_reviewed": true,
        "approval_obtained": true
      }
    },
    {
      "role": "validator",
      "base_template": "code_reviewer",
      "tier_strategy": "capable_first",
      "required_responses": {},
      "config": {
        "validate_syntax": true,
        "validate_imports": true,
        "validate_types": true
      },
      "tools": [
        "mypy",
        "pyflakes"
      ],
      "success_criteria": {
        "validation_passed": true,
        "no_type_errors": true
      }
    }
  ]
}
