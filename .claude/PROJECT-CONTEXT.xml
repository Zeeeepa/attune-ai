<?xml version="1.0" encoding="UTF-8"?>
<project-context>
  <metadata>
    <name>Empathy Framework 4.7.0 Enhancement</name>
    <description>Integrating patterns from everything-claude-code into empathy-framework</description>
    <version>4.7.0-dev</version>
    <date>2025-01-23</date>
  </metadata>

  <attribution>
    <note>
      Architectural patterns inspired by everything-claude-code by Affaan Mustafa.
      This is an ethical enhancement with proper attribution, not a copy.
    </note>
    <source>
      <name>everything-claude-code</name>
      <author>Affaan Mustafa (@affaan-m)</author>
      <url>https://github.com/affaan-m/everything-claude-code</url>
      <license>MIT</license>
    </source>
    <target>
      <name>empathy-framework</name>
      <org>Smart AI Memory, LLC</org>
      <url>https://github.com/Smart-AI-Memory/empathy-framework</url>
      <license>Fair Source 0.9</license>
    </target>
  </attribution>

  <directories>
    <reference-project>
      <path>/Users/patrickroebuck/Documents/everything-else/everything-claude-code</path>
      <purpose>Pattern reference - DO NOT MODIFY</purpose>
      <key-folders>
        <folder purpose="command patterns">commands/</folder>
        <folder purpose="agent patterns">agents/</folder>
        <folder purpose="skill patterns">skills/</folder>
        <folder purpose="hook patterns">hooks/</folder>
        <folder purpose="rule patterns">rules/</folder>
      </key-folders>
    </reference-project>

    <target-project>
      <path>/Users/patrickroebuck/Documents/empathy1-11-2025-local/empathy-framework</path>
      <purpose>Active development - ALL CHANGES HERE</purpose>
      <key-folders>
        <folder purpose="Python modules">empathy_llm_toolkit/</folder>
        <folder purpose="commands">.claude/commands/</folder>
        <folder purpose="skills">.claude/skills/</folder>
        <folder purpose="markdown agents">agents_md/</folder>
        <folder purpose="tests">tests/</folder>
      </key-folders>
    </target-project>
  </directories>

  <completed-phases>
    <phase number="1" status="complete">
      <name>Hook System Foundation</name>
      <deliverables>
        <file>empathy_llm_toolkit/hooks/__init__.py</file>
        <file>empathy_llm_toolkit/hooks/config.py</file>
        <file>empathy_llm_toolkit/hooks/registry.py</file>
        <file>empathy_llm_toolkit/hooks/executor.py</file>
        <file>empathy_llm_toolkit/hooks/scripts/session_start.py</file>
        <file>empathy_llm_toolkit/hooks/scripts/session_end.py</file>
        <file>empathy_llm_toolkit/hooks/scripts/suggest_compact.py</file>
        <file>empathy_llm_toolkit/hooks/scripts/pre_compact.py</file>
        <file>empathy_llm_toolkit/hooks/scripts/evaluate_session.py</file>
        <file>tests/hooks/test_config.py</file>
        <file>tests/hooks/test_registry.py</file>
        <file>tests/hooks/test_executor.py</file>
      </deliverables>
      <key-classes>
        <class>HookEvent (enum): PreToolUse, PostToolUse, SessionStart, SessionEnd, PreCompact, Stop</class>
        <class>HookConfig, HookDefinition, HookMatcher, HookRule (Pydantic models)</class>
        <class>HookRegistry: register(), unregister(), fire(), fire_sync()</class>
        <class>HookExecutor: execute() for command/python/webhook types</class>
      </key-classes>
    </phase>

    <phase number="2" status="complete">
      <name>Markdown Agent Format</name>
      <deliverables>
        <file>empathy_llm_toolkit/agents_md/__init__.py</file>
        <file>empathy_llm_toolkit/agents_md/parser.py</file>
        <file>empathy_llm_toolkit/agents_md/loader.py</file>
        <file>empathy_llm_toolkit/agents_md/registry.py</file>
        <file>agents_md/architect.md</file>
        <file>agents_md/code-reviewer.md</file>
        <file>agents_md/security-reviewer.md</file>
        <file>agents_md/empathy-specialist.md</file>
        <file>agents_md/socratic-architect.md</file>
        <file>agents_md/socratic-reviewer.md</file>
        <file>tests/agents_md/test_parser.py</file>
        <file>tests/agents_md/test_loader.py</file>
        <file>tests/agents_md/test_registry.py</file>
      </deliverables>
      <key-classes>
        <class>MarkdownAgentParser: parse(), parse_file() - YAML frontmatter + markdown</class>
        <class>AgentLoader: load_from_directory() - scans for .md files</class>
        <class>AgentRegistry: singleton with get(), get_by_role(), get_by_empathy_level()</class>
      </key-classes>
      <agent-format>
        <example><![CDATA[
---
name: agent-name
description: What the agent does
role: architect|reviewer|security|empathy
model: cheap|capable|premium
tools: Read, Grep, Glob, Bash
empathy_level: 1-5
pattern_learning: true
interaction_mode: socratic
---

# Agent instructions in markdown...
        ]]></example>
      </agent-format>
    </phase>

    <phase number="3" status="complete">
      <name>Context Management</name>
      <deliverables>
        <file>empathy_llm_toolkit/context/__init__.py</file>
        <file>empathy_llm_toolkit/context/compaction.py</file>
        <file>empathy_llm_toolkit/context/manager.py</file>
        <file>.claude/skills/strategic-compact/SKILL.md</file>
        <file>.claude/skills/strategic-compact/config.json</file>
        <file>tests/context/test_compaction.py</file>
        <file>tests/context/test_manager.py</file>
        <file>tests/context/test_pre_compact_hook.py</file>
      </deliverables>
      <key-classes>
        <class>PatternSummary: compact pattern representation</class>
        <class>SBARHandoff: Situation-Background-Assessment-Recommendation for continuity</class>
        <class>CompactState: user_id, trust_level, empathy_level, patterns, session_id, phase, handoff</class>
        <class>CompactionStateManager: save_state(), load_latest_state(), load_state_by_session()</class>
        <class>ContextManager: extract_compact_state(), save_for_compaction(), restore_state(), generate_restoration_prompt()</class>
      </key-classes>
    </phase>

    <phase number="4" status="complete">
      <name>Continuous Learning Enhancement</name>
      <deliverables>
        <file>empathy_llm_toolkit/learning/__init__.py</file>
        <file>empathy_llm_toolkit/learning/evaluator.py</file>
        <file>empathy_llm_toolkit/learning/extractor.py</file>
        <file>empathy_llm_toolkit/learning/storage.py</file>
        <file>.claude/skills/continuous-learning/SKILL.md</file>
        <file>.claude/skills/continuous-learning/config.json</file>
        <file>tests/learning/test_evaluator.py</file>
        <file>tests/learning/test_extractor.py</file>
        <file>tests/learning/test_storage.py</file>
      </deliverables>
      <key-classes>
        <class>SessionQuality (enum): EXCELLENT, GOOD, AVERAGE, POOR, SKIP</class>
        <class>SessionEvaluator: evaluate(), should_extract_patterns(), get_extraction_priority()</class>
        <class>PatternCategory (enum): ERROR_RESOLUTION, USER_CORRECTION, WORKAROUND, PREFERENCE, PROJECT_SPECIFIC</class>
        <class>ExtractedPattern: category, trigger, context, resolution, confidence, tags</class>
        <class>PatternExtractor: extract_patterns(), extract_corrections(), extract_error_resolutions()</class>
        <class>LearnedSkill: aggregated patterns into higher-level skills</class>
        <class>LearnedSkillsStorage: save_pattern(), get_patterns_by_category(), search_patterns(), format_patterns_for_context()</class>
      </key-classes>
    </phase>
  </completed-phases>

  <current-phase>
    <phase number="5a" status="in-progress">
      <name>Commands System Integration</name>
      <goal>Create CommandLoader that integrates commands with hooks, context, and learning modules</goal>

      <design-decisions>
        <decision>All commands in flat .claude/commands/ folder - no builtin/ separation</decision>
        <decision>Python loader provides programmatic features while keeping commands as simple markdown</decision>
        <decision>Commands can fire hooks, access context state, apply learned patterns</decision>
      </design-decisions>

      <deliverables>
        <file status="todo">empathy_llm_toolkit/commands/__init__.py</file>
        <file status="todo">empathy_llm_toolkit/commands/loader.py</file>
        <file status="todo">empathy_llm_toolkit/commands/registry.py</file>
        <file status="todo">empathy_llm_toolkit/commands/context.py</file>
        <file status="todo">.claude/commands/compact.md</file>
        <file status="todo">.claude/commands/patterns.md</file>
        <file status="todo">.claude/commands/evaluate.md</file>
        <file status="todo">tests/commands/test_loader.py</file>
        <file status="todo">tests/commands/test_registry.py</file>
      </deliverables>

      <command-loader-requirements>
        <requirement>Scan .claude/commands/ for .md files</requirement>
        <requirement>Parse optional YAML frontmatter for metadata (description, triggers, hooks)</requirement>
        <requirement>Register commands in CommandRegistry singleton</requirement>
        <requirement>Provide CommandContext with access to hooks, context_manager, learning</requirement>
        <requirement>Fire PreCommand/PostCommand hooks when commands execute</requirement>
        <requirement>Support command aliases</requirement>
      </command-loader-requirements>

      <new-commands>
        <command name="compact">
          <purpose>Strategic context compaction preserving collaboration state</purpose>
          <integrates-with>ContextManager, CompactionStateManager, pre_compact hook</integrates-with>
        </command>
        <command name="patterns">
          <purpose>View, search, and apply learned patterns</purpose>
          <integrates-with>LearnedSkillsStorage, PatternExtractor</integrates-with>
        </command>
        <command name="evaluate">
          <purpose>Evaluate current session for learning potential</purpose>
          <integrates-with>SessionEvaluator, run_evaluate_session hook</integrates-with>
        </command>
      </new-commands>
    </phase>

    <phase number="5b" status="pending">
      <name>Integration Testing and Documentation</name>
      <deliverables>
        <file>tests/integration/test_hooks_integration.py</file>
        <file>tests/integration/test_commands_integration.py</file>
        <file>tests/integration/test_full_workflow.py</file>
        <file>docs/hooks.md</file>
        <file>docs/markdown-agents.md</file>
        <file>docs/context-management.md</file>
        <file>docs/continuous-learning.md</file>
        <file>docs/commands.md</file>
        <file>ACKNOWLEDGMENTS.md (already exists - verify complete)</file>
      </deliverables>
    </phase>
  </current-phase>

  <integration-points>
    <integration name="Commands + Hooks">
      <description>Commands fire PreCommand/PostCommand hooks</description>
      <example><![CDATA[
# When /compact runs:
hooks.fire(HookEvent.PreCommand, {"command": "compact"})
# ... execute command ...
hooks.fire(HookEvent.PostCommand, {"command": "compact", "result": result})
      ]]></example>
    </integration>

    <integration name="Commands + Context">
      <description>Commands can save/restore context state</description>
      <example><![CDATA[
# /compact command uses ContextManager
context_manager.save_for_compaction(collaboration_state)
      ]]></example>
    </integration>

    <integration name="Commands + Learning">
      <description>Commands can query and apply learned patterns</description>
      <example><![CDATA[
# /patterns command uses LearnedSkillsStorage
patterns = storage.search_patterns(user_id, query)
context_injection = storage.format_patterns_for_context(user_id)
      ]]></example>
    </integration>

    <integration name="Hooks + Learning">
      <description>SessionEnd hook triggers pattern evaluation</description>
      <example><![CDATA[
# Already implemented in evaluate_session.py
result = run_evaluate_session({"collaboration_state": state, "user_id": user_id})
      ]]></example>
    </integration>
  </integration-points>

  <existing-commands-reference>
    <note>23 existing commands in empathy-framework .claude/commands/</note>
    <commands>
      benchmark, commit, create-agent, create-team, debug, deps, explain,
      feature-overview, init, manage-docs, memory, pr, profile, publish,
      refactor, release-prep, review, review-pr, security-scan, status,
      test, test-coverage, test-maintenance
    </commands>
    <enhancement-opportunity>
      These can be enhanced incrementally to use CommandLoader infrastructure,
      fire hooks, and leverage learned patterns. Not required for 4.7.0 release.
    </enhancement-opportunity>
  </existing-commands-reference>

  <socratic-patterns>
    <note>All agents enhanced with Socratic questioning. Commands can use same patterns.</note>
    <pattern name="Sequential Funnel">
      <description>Broad question → narrowing based on response</description>
    </pattern>
    <pattern name="Conditional Branching">
      <description>Different follow-up paths based on initial answer</description>
    </pattern>
    <pattern name="Guided Discovery">
      <description>Questions that lead user to discover answer themselves</description>
    </pattern>
    <pattern name="Confirmation">
      <description>Verify understanding before taking action</description>
    </pattern>
    <tool>AskUserQuestion with header, question, options[], multiSelect</tool>
  </socratic-patterns>

  <quality-gates>
    <gate phase="5a">
      <check>pytest tests/commands/ passes 100%</check>
      <check>CommandLoader correctly scans .claude/commands/</check>
      <check>New commands (compact, patterns, evaluate) work end-to-end</check>
      <check>Hook integration fires PreCommand/PostCommand</check>
      <check>No regressions in existing test suite</check>
    </gate>
    <gate phase="5b">
      <check>pytest tests/integration/ passes 100%</check>
      <check>Full workflow test: SessionStart → commands → learning → SessionEnd</check>
      <check>Documentation complete and accurate</check>
      <check>ACKNOWLEDGMENTS.md includes all attributions</check>
    </gate>
    <gate phase="release">
      <check>All tests pass: pytest tests/</check>
      <check>Type checking: mypy empathy_llm_toolkit/</check>
      <check>Linting: ruff check empathy_llm_toolkit/</check>
      <check>Version bumped to 4.7.0 in pyproject.toml</check>
    </gate>
  </quality-gates>

  <instructions>
    <instruction priority="high">
      All development happens in empathy-framework project at:
      /Users/patrickroebuck/Documents/empathy1-11-2025-local/empathy-framework
    </instruction>
    <instruction priority="high">
      Reference everything-claude-code for patterns only - do not modify that project.
    </instruction>
    <instruction priority="high">
      Maintain attribution to Affaan Mustafa in all new module docstrings.
    </instruction>
    <instruction priority="medium">
      Keep commands in flat .claude/commands/ structure - no subdirectories.
    </instruction>
    <instruction priority="medium">
      Use Socratic questioning patterns where appropriate in commands.
    </instruction>
    <instruction priority="medium">
      Integrate with existing empathy_llm_toolkit.state.CollaborationState.
    </instruction>
  </instructions>
</project-context>
