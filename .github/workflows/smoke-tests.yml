name: Production Smoke Tests

on:
  # Run after pushes to main (Vercel auto-deploys)
  push:
    branches:
      - main
    paths:
      - 'website/**'
      - 'tests/test_production_smoke.py'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      production_url:
        description: 'Production URL to test'
        required: false
        default: 'https://attune-ai.vercel.app'

  # Run daily to catch any issues
  schedule:
    - cron: '0 9 * * *'  # 9 AM UTC daily

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  smoke-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install httpx pytest

      - name: Wait for Vercel deployment
        if: github.event_name == 'push'
        run: |
          echo "Waiting 90 seconds for Vercel deployment to complete..."
          sleep 90

      - name: Run smoke tests
        env:
          PRODUCTION_URL: ${{ github.event.inputs.production_url || 'https://attune-ai.vercel.app' }}
        run: |
          # Disable coverage plugin to avoid pytest-cov dependency
          python -m pytest tests/test_production_smoke.py -v --tb=short -p no:cov --override-ini="addopts="

      - name: Report test results
        if: failure()
        run: |
          echo "::error::Production smoke tests failed! Check https://attune-ai.vercel.app"
