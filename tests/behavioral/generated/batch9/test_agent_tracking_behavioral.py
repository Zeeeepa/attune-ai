"""Behavioral tests for agent_tracking.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

from __future__ import annotations

from datetime import datetime, timedelta
from typing import Any
from unittest.mock import MagicMock, Mock, patch

import pytest

from empathy_os.telemetry.agent_tracking import (
    AgentHeartbeat,
    HeartbeatCoordinator,
)


# Fixtures


@pytest.fixture
def sample_heartbeat_data() -> dict[str, Any]:
    """Provide sample heartbeat data for testing."""
    return {
        "agent_id": "test-agent-123",
        "status": "running",
        "progress": 0.5,
        "current_task": "Processing data",
        "last_beat": datetime(2025, 1, 15, 12, 0, 0),
        "metadata": {"workflow": "test-workflow", "run_id": "xyz"},
    }


@pytest.fixture
def sample_heartbeat(sample_heartbeat_data: dict[str, Any]) -> AgentHeartbeat:
    """Provide sample AgentHeartbeat instance."""
    return AgentHeartbeat(**sample_heartbeat_data)


@pytest.fixture
def mock_redis():
    """Provide a mocked Redis client."""
    redis_mock = MagicMock()
    redis_mock.setex = MagicMock(return_value=True)
    redis_mock.get = MagicMock(return_value=None)
    redis_mock.delete = MagicMock(return_value=1)
    redis_mock.keys = MagicMock(return_value=[])
    redis_mock.pipeline = MagicMock()
    return redis_mock


@pytest.fixture
def coordinator(mock_redis):
    """Provide HeartbeatCoordinator with mocked Redis."""
    with patch("empathy_os.telemetry.agent_tracking.redis.Redis", return_value=mock_redis):
        coordinator = HeartbeatCoordinator()
        coordinator.redis = mock_redis
        return coordinator


# AgentHeartbeat Tests


class TestAgentHeartbeatCreation:
    """Test AgentHeartbeat creation and initialization."""

    def test_given_valid_data_when_creating_heartbeat_then_initializes_correctly(
        self, sample_heartbeat_data: dict[str, Any]
    ):
        """Given valid heartbeat data, when creating AgentHeartbeat, then it initializes correctly."""
        # When
        heartbeat = AgentHeartbeat(**sample_heartbeat_data)

        # Then
        assert heartbeat.agent_id == "test-agent-123"
        assert heartbeat.status == "running"
        assert heartbeat.progress == 0.5
        assert heartbeat.current_task == "Processing data"
        assert heartbeat.last_beat == datetime(2025, 1, 15, 12, 0, 0)
        assert heartbeat.metadata == {"workflow": "test-workflow", "run_id": "xyz"}

    def test_given_no_metadata_when_creating_heartbeat_then_uses_empty_dict(self):
        """Given no metadata, when creating AgentHeartbeat, then it uses empty dict."""
        # When
        heartbeat = AgentHeartbeat(
            agent_id="agent-1",
            status="starting",
            progress=0.0,
            current_task="Initializing",
            last_beat=datetime.utcnow(),
        )

        # Then
        assert heartbeat.metadata == {}

    def test_given_progress_bounds_when_creating_heartbeat_then_accepts_values(self):
        """Given progress at boundaries, when creating heartbeat, then accepts 0.0 and 1.0."""
        # When
        heartbeat_zero = AgentHeartbeat(
            agent_id="agent-1",
            status="starting",
            progress=0.0,
            current_task="Starting",
            last_beat=datetime.utcnow(),
        )
        heartbeat_complete = AgentHeartbeat(
            agent_id="agent-2",
            status="completed",
            progress=1.0,
            current_task="Done",
            last_beat=datetime.utcnow(),
        )

        # Then
        assert heartbeat_zero.progress == 0.0
        assert heartbeat_complete.progress == 1.0


class TestAgentHeartbeatSerialization:
    """Test AgentHeartbeat serialization and deserialization."""

    def test_given_heartbeat_when_converting_to_dict_then_serializes_correctly(
        self, sample_heartbeat: AgentHeartbeat
    ):
        """Given an AgentHeartbeat, when converting to dict, then serializes all fields correctly."""
        # When
        result = sample_heartbeat.to_dict()

        # Then
        assert result["agent_id"] == "test-agent-123"
        assert result["status"] == "running"
        assert result["progress"] == 0.5
        assert result["current_task"] == "Processing data"
        assert result["last_beat"] == "2025-01-15T12:00:00"
        assert result["metadata"] == {"workflow": "test-workflow", "run_id": "xyz"}

    def test_given_dict_with_iso_string_when_creating_from_dict_then_deserializes_correctly(
        self, sample_heartbeat_data: dict[str, Any]
    ):
        """Given dict with ISO datetime string, when creating from dict, then deserializes correctly."""
        # Given
        data = sample_heartbeat_data.copy()
        data["last_beat"] = "2025-01-15T12:00:00"

        # When
        heartbeat = AgentHeartbeat.from_dict(data)

        # Then
        assert heartbeat.agent_id == "test-agent-123"
        assert heartbeat.status == "running"
        assert heartbeat.progress == 0.5
        assert heartbeat.current_task == "Processing data"
        assert heartbeat.last_beat == datetime(2025, 1, 15, 12, 0, 0)
        assert heartbeat.metadata == {"workflow": "test-workflow", "run_id": "xyz"}

    def test_given_dict_with_datetime_when_creating_from_dict_then_preserves_datetime(
        self, sample_heartbeat_data: dict[str, Any]
    ):
        """Given dict with datetime object, when creating from dict, then preserves datetime."""
        # Given
        data = sample_heartbeat_data.copy()
        expected_datetime = datetime(2025, 1, 15, 12, 30, 0)
        data["last_beat"] = expected_datetime

        # When
        heartbeat = AgentHeartbeat.from_dict(data)

        # Then
        assert heartbeat.last_beat == expected_datetime

    def test_given_dict_without_last_beat_when_creating_from_dict_then_uses_current_time(
        self, sample_heartbeat_data: dict[str, Any]
    ):
        """Given dict without last_beat, when creating from dict, then uses current time."""
        # Given
        data = sample_heartbeat_data.copy()
        data["last_beat"] = None

        # When
        before = datetime.utcnow()
        heartbeat = AgentHeartbeat.from_dict(data)
        after = datetime.utcnow()

        # Then
        assert before <= heartbeat.last_beat <= after

    def test_given_dict_without_metadata_when_creating_from_dict_then_uses_empty_dict(
        self, sample_heartbeat_data: dict[str, Any]
    ):
        """Given dict without metadata, when creating from dict, then uses empty dict."""
        # Given
        data = sample_heartbeat_data.copy()
        del data["metadata"]

        # When
        heartbeat = AgentHeartbeat.from_dict(data)

        # Then
        assert heartbeat.metadata == {}

    def test_given_heartbeat_when_serializing_and_deserializing_then_roundtrip_preserves_data(
        self, sample_heartbeat: AgentHeartbeat
    ):
        """Given a heartbeat, when serializing and deserializing, then roundtrip preserves data."""
        # When
        serialized = sample_heartbeat.to_dict()
        deserialized = AgentHeartbeat.from_dict(serialized)

        # Then
        assert deserialized.agent_id == sample_heartbeat.agent_id
        assert deserialized.status == sample_heartbeat.status
        assert deserialized.progress == sample_heartbeat.progress
        assert deserialized.current_task == sample_heartbeat.current_task
        assert deserialized.last_beat == sample_heartbeat.last_beat
        assert deserialized.metadata == sample_heartbeat.metadata


class TestHeartbeatCoordinatorInitialization:
    """Test HeartbeatCoordinator initialization."""

    def test_given_no_params_when_creating_coordinator_then_initializes_with_defaults(self):
        """Given no parameters, when creating coordinator, then initializes with default values."""
        # When
        with patch("empathy_os.telemetry.agent_tracking.redis.Redis") as mock_redis_class:
            coordinator = HeartbeatCoordinator()

            # Then
            assert coordinator.HEARTBEAT_TTL == 30
            assert coordinator.HEARTBEAT_INTERVAL == 10
            mock_redis_class.assert_called_once()

    def test_given_custom_redis_when_creating_coordinator_then_uses_custom_client(self):
        """Given custom Redis client, when creating coordinator, then uses it."""
        # Given
        custom_redis = MagicMock()

        # When
        with patch("empathy_os.telemetry.agent_tracking.redis.Redis"):
            coordinator = HeartbeatCoordinator()
            coordinator.redis = custom_redis

            # Then
            assert coordinator.redis is custom_redis


class TestHeartbeatCoordinatorStartHeartbeat:
    """Test starting agent heartbeat tracking."""

    def test_given_agent_id_when_starting_heartbeat_then_creates_initial_heartbeat(
        self, coordinator: HeartbeatCoordinator, mock_redis
    ):
        """Given agent ID, when starting heartbeat, then creates initial heartbeat in Redis."""
        # Given
        import json

        agent_id = "agent-123"
        metadata = {"workflow": "test"}

        # When
        coordinator.start_heartbeat(agent_id=agent_id, metadata=metadata)

        # Then
        mock_redis.setex.assert_called_once()
        call_args = mock_redis.setex.call_args
        assert call_args[0][0] == f"heartbeat:{agent_id}"
        assert call_args[0][1] == 30  # TTL

        stored_data = json.loads(call_args[0][2])
        assert stored_data["agent_id"] == agent_id
        assert stored_data["status"] == "starting"
        assert stored_data["progress"] == 0.0
        assert stored_data["metadata"] == metadata

    def test_given_no_metadata_when_starting_heartbeat_then_uses_empty_metadata(
        self, coordinator: HeartbeatCoordinator, mock_redis
    ):
        """Given no metadata, when starting heartbeat, then uses empty metadata dict."""
        # Given
        import json

        agent_id = "agent-456"

        # When
        coordinator.start_heartbeat(agent_id=agent_id)

        # Then
        call_args = mock_redis.setex.call_args
        stored_data = json.loads(call_args[0][2])
        assert stored_data["metadata"] == {}

    def test_given_existing_agent_when_starting_heartbeat_then_overwrites_previous(
        self, coordinator: HeartbeatCoordinator, mock_redis
    ):
        """Given existing agent, when starting heartbeat again, then overwrites previous."""
        # Given
        agent_id = "agent-789"
        coordinator.current_agent_id = agent_id

        # When
        coordinator.start_heartbeat(agent_id=agent_id, metadata={"run": 1})
        coordinator.start_heartbeat(agent_id=agent_id, metadata={"run": 2})

        # Then
        assert mock_redis.setex.call_count == 2


class TestHeartbeatCoordinatorBeat:
    """Test heartbeat update functionality."""

    def test_given_active_agent_when_beating_then_updates_heartbeat(
        self, coordinator: HeartbeatCoordinator, mock_redis
    ):
        """Given active agent, when updating beat, then updates heartbeat in Redis."""
        # Given
        import json

        agent_id = "agent-active"
        coordinator.start_heartbeat(agent_id=agent_id)
        coordinator.current_agent_id = agent_id
        mock_redis.setex.reset_mock()

        # When
        coordinator.beat(status="running", progress=0.75, current_task="Processing")

        # Then
        mock_redis.setex.assert_called_once()
        call_args = mock_redis.setex.call_args
        stored_data = json.loads(call_args[0][2])
        assert stored_data["status"] == "running"
        assert stored_data["progress"] == 0.75
        assert stored_data["current_task"] == "Processing"

    def test_given_no_current_agent_when_beating_then_raises_error(
        self, coordinator: HeartbeatCoordinator
    ):
        """Given no current agent, when updating beat, then raises ValueError."""
        # When/Then
        with pytest.raises(ValueError, match="No active agent"):
            coordinator.beat(status="running", progress=0.5, current_task="Task")

    def test_given_metadata_update_when_beating_then_merges_metadata(
        self, coordinator: HeartbeatCoordinator, mock_redis
    ):
        """Given metadata update, when beating, then merges with existing metadata."""
        # Given
        import json

        agent_id = "agent-meta"
        coordinator.start_heartbeat(agent_id=agent_id, metadata={"key1": "value1"})
        coordinator.current_agent_id = agent_id
        mock_redis.setex.reset_mock()

        # When
        coordinator.beat(
            status="running",
            progress=0.5,
            current_task="Task",
            metadata={"key2": "value2"},
        )

        # Then
        call_args = mock_redis.setex.call_args
        stored_data = json.loads(call_args[0][2])
        assert stored_data["metadata"]["key1"] == "value1"
        assert stored_data["metadata"]["key2"] == "value2"


class TestHeartbeatCoordinatorStopHeartbeat:
    """Test stopping agent heartbeat tracking."""

    def test_given_active_agent_when_stopping_heartbeat_then_updates_final_status(
        self, coordinator: HeartbeatCoordinator, mock_redis
    ):
        """Given active agent, when stopping heartbeat, then updates with final status."""
        # Given
        import json

        agent_id = "agent-stop"
        coordinator.start_heartbeat(agent_id=agent_id)
        coordinator.current_agent_id = agent_id
        mock_redis.setex.reset_mock()

        # When
        coordinator.stop_heartbeat(final_status="completed")

        # Then
        mock_redis.setex.assert_called_once()
        call_args = mock_redis.setex.call_args
        stored_data = json.loads(call_args[0][2])
        assert stored_data["status"] == "completed"
        assert stored_data["progress"] == 1.0

    def test_given_failed_status_when_stopping_heartbeat_