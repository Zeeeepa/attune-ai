"""Behavioral tests for pii_scrubber.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import re
from unittest.mock import MagicMock, patch

import pytest

from empathy_os.memory.security.pii_scrubber import (
    PIIDetection,
    PIIPattern,
    PIIScrubber,
)


class TestPIIDetection:
    """Behavioral tests for PIIDetection dataclass."""

    def test_given_pii_detection_when_created_then_attributes_set_correctly(self):
        """Test PIIDetection initialization with all attributes."""
        # Given
        pii_type = "email"
        matched_text = "user@example.com"
        start_pos = 10
        end_pos = 26
        replacement = "[EMAIL]"
        confidence = 0.95
        metadata = {"domain": "example.com"}

        # When
        detection = PIIDetection(
            pii_type=pii_type,
            matched_text=matched_text,
            start_pos=start_pos,
            end_pos=end_pos,
            replacement=replacement,
            confidence=confidence,
            metadata=metadata,
        )

        # Then
        assert detection.pii_type == pii_type
        assert detection.matched_text == matched_text
        assert detection.start_pos == start_pos
        assert detection.end_pos == end_pos
        assert detection.replacement == replacement
        assert detection.confidence == confidence
        assert detection.metadata == metadata

    def test_given_pii_detection_when_created_with_defaults_then_defaults_applied(self):
        """Test PIIDetection initialization with default values."""
        # Given/When
        detection = PIIDetection(
            pii_type="ssn",
            matched_text="123-45-6789",
            start_pos=0,
            end_pos=11,
            replacement="[SSN]",
        )

        # Then
        assert detection.confidence == 1.0
        assert detection.metadata == {}

    def test_given_pii_detection_when_to_dict_called_then_returns_complete_dict(self):
        """Test to_dict returns all fields including matched_text."""
        # Given
        detection = PIIDetection(
            pii_type="phone",
            matched_text="555-1234",
            start_pos=5,
            end_pos=13,
            replacement="[PHONE]",
            confidence=0.9,
            metadata={"country": "US"},
        )

        # When
        result = detection.to_dict()

        # Then
        assert result["pii_type"] == "phone"
        assert result["matched_text"] == "555-1234"
        assert result["start_pos"] == 5
        assert result["end_pos"] == 13
        assert result["replacement"] == "[PHONE]"
        assert result["confidence"] == 0.9
        assert result["metadata"] == {"country": "US"}

    def test_given_pii_detection_when_to_audit_safe_dict_called_then_no_pii_exposed(
        self,
    ):
        """Test to_audit_safe_dict excludes matched_text but includes other info."""
        # Given
        detection = PIIDetection(
            pii_type="email",
            matched_text="sensitive@private.com",
            start_pos=20,
            end_pos=41,
            replacement="[EMAIL]",
            confidence=1.0,
            metadata={"source": "message"},
        )

        # When
        result = detection.to_audit_safe_dict()

        # Then
        assert "matched_text" not in result
        assert result["pii_type"] == "email"
        assert result["position"] == "20-41"
        assert result["length"] == 21
        assert result["replacement"] == "[EMAIL]"
        assert result["confidence"] == 1.0
        assert result["metadata"] == {"source": "message"}

    def test_given_pii_detection_when_empty_metadata_then_audit_safe_dict_includes_empty_dict(
        self,
    ):
        """Test to_audit_safe_dict handles empty metadata correctly."""
        # Given
        detection = PIIDetection(
            pii_type="ssn",
            matched_text="123-45-6789",
            start_pos=0,
            end_pos=11,
            replacement="[SSN]",
        )

        # When
        result = detection.to_audit_safe_dict()

        # Then
        assert result["metadata"] == {}


class TestPIIPattern:
    """Behavioral tests for PIIPattern dataclass."""

    def test_given_pii_pattern_when_created_then_attributes_set_correctly(self):
        """Test PIIPattern initialization with all attributes."""
        # Given
        name = "email"
        pattern = re.compile(r"\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b")
        replacement = "[EMAIL]"
        confidence = 0.95
        description = "Email address pattern"
        enabled = True

        # When
        pii_pattern = PIIPattern(
            name=name,
            pattern=pattern,
            replacement=replacement,
            confidence=confidence,
            description=description,
            enabled=enabled,
        )

        # Then
        assert pii_pattern.name == name
        assert pii_pattern.pattern == pattern
        assert pii_pattern.replacement == replacement
        assert pii_pattern.confidence == confidence
        assert pii_pattern.description == description
        assert pii_pattern.enabled == enabled

    def test_given_pii_pattern_when_created_with_defaults_then_defaults_applied(self):
        """Test PIIPattern initialization with default values."""
        # Given
        name = "custom"
        pattern = re.compile(r"\d{4}")
        replacement = "[REDACTED]"

        # When
        pii_pattern = PIIPattern(name=name, pattern=pattern, replacement=replacement)

        # Then
        assert pii_pattern.confidence == 1.0
        assert pii_pattern.description == ""
        assert pii_pattern.enabled is True

    def test_given_pii_pattern_when_disabled_then_enabled_is_false(self):
        """Test PIIPattern can be disabled."""
        # Given/When
        pii_pattern = PIIPattern(
            name="test",
            pattern=re.compile(r"test"),
            replacement="[TEST]",
            enabled=False,
        )

        # Then
        assert pii_pattern.enabled is False


class TestPIIScrubber:
    """Behavioral tests for PIIScrubber class."""

    @pytest.fixture
    def scrubber(self):
        """Create a PIIScrubber instance for testing."""
        return PIIScrubber()

    @pytest.fixture
    def custom_scrubber(self):
        """Create a PIIScrubber with custom configuration."""
        return PIIScrubber(enable_default_patterns=False)

    def test_given_scrubber_when_initialized_then_default_patterns_loaded(
        self, scrubber
    ):
        """Test PIIScrubber initializes with default patterns."""
        # Given/When (via fixture)
        # Then
        assert scrubber is not None
        assert hasattr(scrubber, "patterns")

    def test_given_scrubber_when_initialized_without_defaults_then_no_patterns(
        self, custom_scrubber
    ):
        """Test PIIScrubber can be initialized without default patterns."""
        # Given/When (via fixture)
        # Then
        assert custom_scrubber is not None

    def test_given_email_in_text_when_scrub_called_then_email_removed(self, scrubber):
        """Test email address detection and scrubbing."""
        # Given
        text = "Contact me at john.doe@example.com for details"

        # When
        scrubbed, detections = scrubber.scrub(text)

        # Then
        assert "john.doe@example.com" not in scrubbed
        assert "[EMAIL]" in scrubbed or "[REDACTED]" in scrubbed
        assert len(detections) > 0
        assert any(d.pii_type in ["email", "EMAIL"] for d in detections)

    def test_given_multiple_emails_when_scrub_called_then_all_emails_removed(
        self, scrubber
    ):
        """Test multiple email addresses are detected and scrubbed."""
        # Given
        text = "Email john@example.com or jane@test.org for info"

        # When
        scrubbed, detections = scrubber.scrub(text)

        # Then
        assert "john@example.com" not in scrubbed
        assert "jane@test.org" not in scrubbed
        assert len([d for d in detections if d.pii_type in ["email", "EMAIL"]]) >= 2

    def test_given_phone_number_when_scrub_called_then_phone_removed(self, scrubber):
        """Test phone number detection and scrubbing."""
        # Given
        text = "Call me at 555-123-4567 anytime"

        # When
        scrubbed, detections = scrubber.scrub(text)

        # Then
        assert "555-123-4567" not in scrubbed
        assert len(detections) > 0

    def test_given_ssn_when_scrub_called_then_ssn_removed(self, scrubber):
        """Test Social Security Number detection and scrubbing."""
        # Given
        text = "My SSN is 123-45-6789 on file"

        # When
        scrubbed, detections = scrubber.scrub(text)

        # Then
        assert "123-45-6789" not in scrubbed
        assert len(detections) > 0

    def test_given_credit_card_when_scrub_called_then_card_removed(self, scrubber):
        """Test credit card number detection and scrubbing."""
        # Given
        text = "Card number: 4532-1234-5678-9010"

        # When
        scrubbed, detections = scrubber.scrub(text)

        # Then
        assert "4532-1234-5678-9010" not in scrubbed or "4532" not in scrubbed
        assert len(detections) >= 0  # May or may not detect depending on implementation

    def test_given_ip_address_when_scrub_called_then_ip_removed(self, scrubber):
        """Test IP address detection and scrubbing."""
        # Given
        text = "Server IP: 192.168.1.100"

        # When
        scrubbed, detections = scrubber.scrub(text)

        # Then
        assert len(detections) >= 0  # IP detection may be optional

    def test_given_empty_text_when_scrub_called_then_returns_empty(self, scrubber):
        """Test scrubbing empty text returns empty result."""
        # Given
        text = ""

        # When
        scrubbed, detections = scrubber.scrub(text)

        # Then
        assert scrubbed == ""
        assert len(detections) == 0

    def test_given_no_pii_when_scrub_called_then_text_unchanged(self, scrubber):
        """Test text without PII remains unchanged."""
        # Given
        text = "This is a normal sentence with no sensitive data"

        # When
        scrubbed, detections = scrubber.scrub(text)

        # Then
        assert scrubbed == text
        assert len(detections) == 0

    def test_given_custom_pattern_when_added_then_pattern_detected(
        self, custom_scrubber
    ):
        """Test adding custom PII patterns."""
        # Given
        custom_pattern = PIIPattern(
            name="custom_id",
            pattern=re.compile(r"ID-\d{6}"),
            replacement="[CUSTOM_ID]",
            confidence=0.9,
        )
        custom_scrubber.add_pattern(custom_pattern)
        text = "Your reference is ID-123456"

        # When
        scrubbed, detections = custom_scrubber.scrub(text)

        # Then
        assert "ID-123456" not in scrubbed
        assert "[CUSTOM_ID]" in scrubbed
        assert len(detections) == 1
        assert detections[0].pii_type == "custom_id"

    def test_given_pattern_when_removed_then_no_longer_detected(self, scrubber):
        """Test removing a pattern stops detection."""
        # Given
        text = "Email: test@example.com"

        # When - scrub first to verify detection
        scrubbed1, detections1 = scrubber.scrub(text)
        
        # Remove pattern if exists
        scrubber.remove_pattern("email")
        
        # Scrub again
        scrubbed2, detections2 = scrubber.scrub(text)

        # Then - second scrub should have fewer or same detections
        assert len(detections2) <= len(detections1)

    def test_given_pattern_when_disabled_then_not_detected(self, custom_scrubber):
        """Test disabling a pattern prevents detection."""
        # Given
        pattern = PIIPattern(
            name="test_pattern",
            pattern=re.compile(r"SECRET-\d{4}"),
            replacement="[SECRET]",
            enabled=False,
        )
        custom_scrubber.add_pattern(pattern)
        text = "Code is SECRET-1234"

        # When
        scrubbed, detections = custom_scrubber.scrub(text)

        # Then
        assert "SECRET-1234" in scrubbed  # Should not be scrubbed when disabled
        assert len(detections) == 0

    def test_given_overlapping_patterns_when_scrub_called_then_handles_correctly(
        self, scrubber
    ):
        """Test handling of overlapping pattern matches."""
        # Given
        text = "Contact: john@example.com or phone 555-1234"

        # When
        scrubbed, detections = scrubber.scrub(text)

        # Then
        assert len(detections) >= 1
        # Verify detections have valid positions
        for detection in detections:
            assert detection.start_pos >= 0
            assert detection.end_pos > detection.start_pos

    def test_given_unicode_text_when_scrub_called_then_handles_correctly(
        self, scrubber
    ):
        """Test scrubbing text with unicode characters."""
        # Given
        text = "Email: tëst@éxample.com with unicode"

        # When
        scrubbed, detections = scrubber.scrub(text)

        # Then
        assert scrubbed is not None
        assert isinstance(scrubbed, str)

    def test_given_multiline_text_when_scrub_called_then_all_lines_processed(
        self, scrubber
    ):
        """Test scrubbing multiline text."""
        # Given
        text = """Line 1: john@example.com
Line 2: jane@test.org
Line 3: No PII here"""

        # When
        scrubbed, detections = scrubber.scrub(text)

        # Then
        assert "john@example.com" not in scrubbed
        assert "jane@test.org" not in scrubbed
        assert "Line 3: No PII here" in scrubbed or "No PII here" in scrubbed

    def test_given_very_long_text_when_scrub_called_then_completes_successfully(