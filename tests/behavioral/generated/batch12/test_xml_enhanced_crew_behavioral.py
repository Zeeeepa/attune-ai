"""Behavioral tests for xml_enhanced_crew.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import pytest
import re
from typing import Any

from empathy_os.workflows.xml_enhanced_crew import (
    XMLAgent,
    XMLTask,
    parse_xml_response,
)


# ============================================================================
# Fixtures
# ============================================================================


@pytest.fixture
def basic_agent():
    """Given a basic XMLAgent with minimal configuration."""
    return XMLAgent(
        role="Documentation Analyst",
        goal="Scan codebase for documentation gaps",
        backstory="Expert in code documentation best practices",
    )


@pytest.fixture
def custom_agent():
    """Given a custom XMLAgent with additional configuration."""
    return XMLAgent(
        role="Security Auditor",
        goal="Identify security vulnerabilities",
        backstory="20 years of cybersecurity experience",
        expertise_level="world-class",
        custom_instructions=["Review OWASP Top 10", "Check for SQL injection"],
    )


@pytest.fixture
def legacy_agent():
    """Given an XMLAgent with XML structure disabled."""
    return XMLAgent(
        role="Code Reviewer",
        goal="Review code quality",
        backstory="Senior developer with 15 years experience",
        use_xml_structure=False,
    )


@pytest.fixture
def basic_task(basic_agent):
    """Given a basic XMLTask with minimal configuration."""
    return XMLTask(
        description="Analyze Python files for missing docstrings",
        expected_output="JSON list of files with missing documentation",
        agent=basic_agent,
    )


@pytest.fixture
def custom_task(custom_agent):
    """Given a custom XMLTask with additional configuration."""
    return XMLTask(
        description="Scan for SQL injection vulnerabilities",
        expected_output="Report with vulnerability details",
        agent=custom_agent,
        context_data={"files": ["app.py", "models.py"]},
        use_xml_structure=True,
        custom_sections={"risk_level": "high", "priority": "urgent"},
    )


@pytest.fixture
def legacy_task(legacy_agent):
    """Given an XMLTask with XML structure disabled."""
    return XMLTask(
        description="Review code quality",
        expected_output="Code review report",
        agent=legacy_agent,
        use_xml_structure=False,
    )


# ============================================================================
# XMLAgent Tests - System Prompt Generation
# ============================================================================


class TestXMLAgentSystemPrompt:
    """Behavioral tests for XMLAgent system prompt generation."""

    def test_xml_enabled_prompt_contains_required_tags(self, basic_agent):
        """
        Given an XMLAgent with XML structure enabled
        When get_system_prompt is called
        Then the prompt contains all required XML tags
        """
        prompt = basic_agent.get_system_prompt()

        assert "<agent_role>" in prompt
        assert "</agent_role>" in prompt
        assert "<agent_goal>" in prompt
        assert "</agent_goal>" in prompt
        assert "<agent_backstory>" in prompt
        assert "</agent_backstory>" in prompt
        assert "<instructions>" in prompt
        assert "</instructions>" in prompt
        assert "<output_structure>" in prompt
        assert "</output_structure>" in prompt

    def test_xml_enabled_prompt_includes_role_content(self, basic_agent):
        """
        Given an XMLAgent with role 'Documentation Analyst'
        When get_system_prompt is called
        Then the prompt includes the role in agent_role tags
        """
        prompt = basic_agent.get_system_prompt()

        assert "Documentation Analyst" in prompt
        assert "expert-level expertise" in prompt

    def test_xml_enabled_prompt_includes_goal_content(self, basic_agent):
        """
        Given an XMLAgent with specific goal
        When get_system_prompt is called
        Then the prompt includes the goal in agent_goal tags
        """
        prompt = basic_agent.get_system_prompt()

        assert "Scan codebase for documentation gaps" in prompt

    def test_xml_enabled_prompt_includes_backstory_content(self, basic_agent):
        """
        Given an XMLAgent with backstory
        When get_system_prompt is called
        Then the prompt includes the backstory in agent_backstory tags
        """
        prompt = basic_agent.get_system_prompt()

        assert "Expert in code documentation best practices" in prompt

    def test_xml_enabled_prompt_includes_custom_instructions(self, custom_agent):
        """
        Given an XMLAgent with custom instructions
        When get_system_prompt is called
        Then the prompt includes custom instructions in the instructions section
        """
        prompt = custom_agent.get_system_prompt()

        assert "Review OWASP Top 10" in prompt
        assert "Check for SQL injection" in prompt

    def test_xml_enabled_prompt_includes_default_instructions(self, basic_agent):
        """
        Given an XMLAgent with default configuration
        When get_system_prompt is called
        Then the prompt includes default instructions
        """
        prompt = basic_agent.get_system_prompt()

        assert "Carefully review all provided context data" in prompt
        assert "Think through your analysis step-by-step" in prompt
        assert "Provide thorough, actionable analysis" in prompt
        assert "Be specific and cite file paths when relevant" in prompt

    def test_xml_enabled_prompt_includes_expertise_level(self, custom_agent):
        """
        Given an XMLAgent with world-class expertise level
        When get_system_prompt is called
        Then the prompt reflects the expertise level
        """
        prompt = custom_agent.get_system_prompt()

        assert "world-class-level expertise" in prompt

    def test_xml_disabled_returns_legacy_prompt(self, legacy_agent):
        """
        Given an XMLAgent with use_xml_structure=False
        When get_system_prompt is called
        Then the prompt uses legacy format without XML tags
        """
        prompt = legacy_agent.get_system_prompt()

        assert "<agent_role>" not in prompt
        assert "Role: Code Reviewer" in prompt
        assert "Goal: Review code quality" in prompt
        assert "Backstory: Senior developer with 15 years experience" in prompt

    def test_legacy_prompt_structure(self, legacy_agent):
        """
        Given an XMLAgent with XML disabled
        When get_system_prompt is called
        Then the prompt follows legacy key-value format
        """
        prompt = legacy_agent.get_system_prompt()

        assert prompt.startswith("Role:")
        assert "\nGoal:" in prompt
        assert "\nBackstory:" in prompt

    def test_xml_prompt_numbered_instructions(self, basic_agent):
        """
        Given an XMLAgent with XML enabled
        When get_system_prompt is called
        Then instructions are numbered sequentially
        """
        prompt = basic_agent.get_system_prompt()

        assert "1. Carefully review all provided context data" in prompt
        assert "2. Think through your analysis step-by-step" in prompt
        assert "3. Provide thorough, actionable analysis" in prompt

    def test_output_structure_section_present(self, basic_agent):
        """
        Given an XMLAgent with XML enabled
        When get_system_prompt is called
        Then the prompt includes output_structure section with thinking/answer tags
        """
        prompt = basic_agent.get_system_prompt()

        assert "<thinking>" in prompt
        assert "</thinking>" in prompt
        assert "<answer>" in prompt
        assert "</answer>" in prompt


# ============================================================================
# XMLTask Tests - Task Prompt Generation
# ============================================================================


class TestXMLTaskPrompt:
    """Behavioral tests for XMLTask prompt generation."""

    def test_xml_enabled_task_contains_required_tags(self, basic_task):
        """
        Given an XMLTask with XML structure enabled
        When get_prompt is called
        Then the prompt contains all required XML tags
        """
        prompt = basic_task.get_prompt()

        assert "<task_description>" in prompt
        assert "</task_description>" in prompt
        assert "<expected_output>" in prompt
        assert "</expected_output>" in prompt
        assert "<thinking>" in prompt
        assert "</thinking>" in prompt
        assert "<answer>" in prompt
        assert "</answer>" in prompt

    def test_xml_enabled_task_includes_description(self, basic_task):
        """
        Given an XMLTask with specific description
        When get_prompt is called
        Then the prompt includes the description in task_description tags
        """
        prompt = basic_task.get_prompt()

        assert "Analyze Python files for missing docstrings" in prompt

    def test_xml_enabled_task_includes_expected_output(self, basic_task):
        """
        Given an XMLTask with expected output
        When get_prompt is called
        Then the prompt includes expected output in expected_output tags
        """
        prompt = basic_task.get_prompt()

        assert "JSON list of files with missing documentation" in prompt

    def test_xml_enabled_task_with_context_data(self, custom_task):
        """
        Given an XMLTask with context_data
        When get_prompt is called
        Then the prompt includes context_data in context tags
        """
        prompt = custom_task.get_prompt()

        assert "<context>" in prompt
        assert "</context>" in prompt
        assert "files" in prompt
        assert "app.py" in prompt
        assert "models.py" in prompt

    def test_xml_enabled_task_with_custom_sections(self, custom_task):
        """
        Given an XMLTask with custom sections
        When get_prompt is called
        Then the prompt includes custom sections with appropriate tags
        """
        prompt = custom_task.get_prompt()

        assert "<risk_level>" in prompt
        assert "high" in prompt
        assert "</risk_level>" in prompt
        assert "<priority>" in prompt
        assert "urgent" in prompt
        assert "</priority>" in prompt

    def test_xml_enabled_task_without_context_data(self, basic_task):
        """
        Given an XMLTask without context_data
        When get_prompt is called
        Then the prompt does not include context tags
        """
        prompt = basic_task.get_prompt()

        assert "<context>" not in prompt
        assert "</context>" not in prompt

    def test_xml_disabled_task_returns_legacy_format(self, legacy_task):
        """
        Given an XMLTask with use_xml_structure=False
        When get_prompt is called
        Then the prompt uses legacy format without XML tags
        """
        prompt = legacy_task.get_prompt()

        assert "<task_description>" not in prompt
        assert "Task: Review code quality" in prompt
        assert "Expected Output: Code review report" in prompt

    def test_legacy_task_structure(self, legacy_task):
        """
        Given an XMLTask with XML disabled
        When get_prompt is called
        Then the prompt follows legacy key-value format
        """
        prompt = legacy_task.get_prompt()

        assert prompt.startswith("Task:")
        assert "\nExpected Output:" in prompt

    def test_task_includes_agent_prompt_when_agent_provided(self, basic_task):
        """
        Given an XMLTask with an associated agent
        When get_prompt is called
        Then the prompt includes the agent's system prompt
        """
        prompt = basic_task.get_prompt()

        assert "<agent_role>" in prompt
        assert "Documentation Analyst" in prompt

    def test_task_without_agent_handles_gracefully(self):
        """
        Given an XMLTask without an associated agent
        When get_prompt is called
        Then the prompt is generated without agent information
        """
        task = XMLTask(
            description="Standalone task",
            expected_output="Task results",
            agent=None,
        )
        prompt = task.get_prompt()

        assert "<task_description>" in prompt
        assert "Standalone task" in prompt
        assert "<agent_role>" not in prompt


# ============================================================================
# parse_xml_response Tests
# ============================================================================


class TestParseXMLResponse:
    """Behavioral tests for parse_xml_response function."""

    def test_parse_single_tag_success(self):
        """
        Given a response with a single XML tag
        When parse_xml_response is called with that tag
        Then it returns the content within the tag
        """
        response = "<thinking>This is my analysis</thinking>"
        result = parse_xml_response(response, "thinking")

        assert result == "This is my analysis"

    def test_parse_nested_content(self):
        """
        Given a response with nested XML structure
        When parse_xml_response is called
        Then it returns content including nested tags
        """
        response = """
        <answer>
        <result>Success</result>
        <details>All tests passed</details>
        </answer>
        """
        result = parse_xml_response(response, "answer")

        assert "<result>Success</result>" in result
        assert "<details>All tests passed</details>" in result

    def test_parse_multiline_content(self):
        """
        Given a response with multiline content
        When parse_xml_response is called
        Then it returns all lines with whitespace preserved
        """
        response = """<thinking>
Line 1
Line 2
Line 3
</thinking>"""
        result = parse_xml_response(response, "thinking")

        assert "Line 1" in result
        assert "Line 2" in result
        assert "Line 3" in result

    def test_parse_tag_not_found_returns_none(self):
        """
        Given a response without the requested tag
        When parse_xml_response is called
        Then it returns None
        """
        response = "<thinking>Some content</thinking>"
        result = parse_xml_response(response, "answer")

        assert result is None

    def test_parse_empty_tag_returns_empty_string(self):
        """
        Given a response with empty XML tag
        When parse_xml_response is called
        Then it returns empty string
        """
        response = "<thinking></thinking>"
        result = parse_xml_response(response, "thinking")

        assert result == ""

    def test_parse_with_attributes_ignores_attributes(self):
        """
        Given a response with XML tags containing attributes
        When parse_xml_response is called
        Then it extracts content ignoring attributes
        """
        response = '<answer type="final">The result</answer>'
        result = parse_xml_response(response, "answer")

        assert result == "The result"

    def test_parse_first_occurrence_when_multiple_tags(self):
        """
        Given a response with multiple instances of the same tag
        When parse_xml_response is called
        Then it returns content from the first occurrence
        """
        response = "<thinking>First</thinking><thinking>Second</thinking>"
        result = parse_xml_response(response, "thinking")

        assert result == "First"

    def test_parse_with_special_characters(self):
        """
        Given a response with special characters in content
        When parse_xml_response is called
        Then it returns content with special characters preserved
        """
        response = "<answer>Result: 100% success & complete!</answer>"
        result = parse_xml_response(response, "answer")

        assert result == "Result: 100% success & complete!"

    def test_parse_with_whitespace_around_content(self):
        """
        Given a response with whitespace around content
        When parse_xml_response is called
        Then it returns content with surrounding whitespace stripped
        """
        response = "<thinking>   Content with spaces   </thinking>"
        result = parse_xml_response(response, "thinking")

        assert result == "Content with spaces"

    def test_parse_case_sensitive_tag_names(self):
        """
        Given a response with mixed case XML tags
        When parse_xml_response is called with different case
        Then it performs case-sensitive matching
        """
        response = "<Thinking>Content</Thinking>"
        result_lower = parse_xml_response(response, "thinking")
        result_exact = parse_xml_response(response, "Thinking")

        assert result_lower is None
        assert result_exact == "Content