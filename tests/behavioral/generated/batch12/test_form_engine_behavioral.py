"""Behavioral tests for form_engine.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import logging
from unittest.mock import MagicMock, patch

import pytest

from empathy_os.meta_workflows.form_engine import SocraticFormEngine
from empathy_os.meta_workflows.models import FormQuestion, FormResponse, FormSchema


class TestSocraticFormEngineInitialization:
    """Test initialization of SocraticFormEngine."""

    def test_init_without_callback_uses_defaults(self):
        """Given no callback, when initializing engine, then use_defaults should be True."""
        # Given/When
        engine = SocraticFormEngine()

        # Then
        assert engine._ask_user_callback is None
        assert engine._use_defaults_when_no_callback is True
        assert engine.responses_cache == {}

    def test_init_with_callback(self):
        """Given a callback function, when initializing engine, then callback should be stored."""
        # Given
        callback = MagicMock()

        # When
        engine = SocraticFormEngine(ask_user_callback=callback)

        # Then
        assert engine._ask_user_callback == callback
        assert engine._use_defaults_when_no_callback is True
        assert engine.responses_cache == {}

    def test_init_with_callback_and_no_defaults(self):
        """Given callback and use_defaults_when_no_callback=False, when initializing, then settings should be stored."""
        # Given
        callback = MagicMock()

        # When
        engine = SocraticFormEngine(
            ask_user_callback=callback, use_defaults_when_no_callback=False
        )

        # Then
        assert engine._ask_user_callback == callback
        assert engine._use_defaults_when_no_callback is False

    def test_init_without_callback_no_defaults(self):
        """Given no callback and use_defaults_when_no_callback=False, when initializing, then settings should be stored."""
        # When
        engine = SocraticFormEngine(use_defaults_when_no_callback=False)

        # Then
        assert engine._ask_user_callback is None
        assert engine._use_defaults_when_no_callback is False


class TestAskQuestionsWithCallback:
    """Test ask_questions method with callback (interactive mode)."""

    def test_ask_questions_with_valid_callback_response(self):
        """Given valid callback and form schema, when asking questions, then should return FormResponse."""
        # Given
        callback = MagicMock(return_value={"q1": "answer1", "q2": "answer2"})
        engine = SocraticFormEngine(ask_user_callback=callback)

        question1 = FormQuestion(
            id="q1",
            text="What is your name?",
            type="text",
            required=True,
            default="John",
        )
        question2 = FormQuestion(
            id="q2",
            text="What is your age?",
            type="number",
            required=False,
            default="25",
        )
        form_schema = FormSchema(questions=[question1, question2])
        template_id = "test_template"

        # When
        response = engine.ask_questions(form_schema, template_id)

        # Then
        assert isinstance(response, FormResponse)
        assert response.template_id == template_id
        assert response.answers == {"q1": "answer1", "q2": "answer2"}
        callback.assert_called_once()

        # Verify callback was called with correct structure
        call_args = callback.call_args[0][0]
        assert len(call_args) == 2
        assert call_args[0]["id"] == "q1"
        assert call_args[0]["text"] == "What is your name?"
        assert call_args[1]["id"] == "q2"

    def test_ask_questions_caches_response(self):
        """Given callback and form schema, when asking same questions twice, then should use cache."""
        # Given
        callback = MagicMock(return_value={"q1": "answer1"})
        engine = SocraticFormEngine(ask_user_callback=callback)

        question = FormQuestion(
            id="q1", text="Question?", type="text", required=True, default="default"
        )
        form_schema = FormSchema(questions=[question])
        template_id = "test_template"

        # When
        response1 = engine.ask_questions(form_schema, template_id)
        response2 = engine.ask_questions(form_schema, template_id)

        # Then
        assert response1 == response2
        callback.assert_called_once()  # Only called once due to caching

    def test_ask_questions_multiple_question_types(self):
        """Given form with multiple question types, when asking questions, then should handle all types."""
        # Given
        callback = MagicMock(
            return_value={
                "text_q": "text answer",
                "number_q": "42",
                "bool_q": "true",
                "select_q": "option1",
            }
        )
        engine = SocraticFormEngine(ask_user_callback=callback)

        questions = [
            FormQuestion(
                id="text_q", text="Text?", type="text", required=True, default="def"
            ),
            FormQuestion(
                id="number_q",
                text="Number?",
                type="number",
                required=True,
                default="0",
            ),
            FormQuestion(
                id="bool_q", text="Bool?", type="boolean", required=True, default="false"
            ),
            FormQuestion(
                id="select_q",
                text="Select?",
                type="select",
                required=False,
                options=["option1", "option2"],
                default="option1",
            ),
        ]
        form_schema = FormSchema(questions=questions)
        template_id = "multi_type_template"

        # When
        response = engine.ask_questions(form_schema, template_id)

        # Then
        assert len(response.answers) == 4
        assert response.answers["text_q"] == "text answer"
        assert response.answers["number_q"] == "42"
        assert response.answers["bool_q"] == "true"
        assert response.answers["select_q"] == "option1"

    def test_ask_questions_with_partial_callback_response(self):
        """Given callback returns partial answers, when asking questions, then should handle gracefully."""
        # Given
        callback = MagicMock(return_value={"q1": "answer1"})  # Missing q2
        engine = SocraticFormEngine(ask_user_callback=callback)

        questions = [
            FormQuestion(
                id="q1", text="Question 1?", type="text", required=True, default="def1"
            ),
            FormQuestion(
                id="q2", text="Question 2?", type="text", required=False, default="def2"
            ),
        ]
        form_schema = FormSchema(questions=questions)
        template_id = "partial_template"

        # When
        response = engine.ask_questions(form_schema, template_id)

        # Then
        assert response.answers == {"q1": "answer1"}


class TestAskQuestionsWithDefaults:
    """Test ask_questions method using default values (no callback)."""

    def test_ask_questions_uses_defaults_when_no_callback(self):
        """Given no callback and use_defaults=True, when asking questions, then should use default values."""
        # Given
        engine = SocraticFormEngine(use_defaults_when_no_callback=True)

        questions = [
            FormQuestion(
                id="q1", text="Question 1?", type="text", required=True, default="default1"
            ),
            FormQuestion(
                id="q2", text="Question 2?", type="text", required=False, default="default2"
            ),
        ]
        form_schema = FormSchema(questions=questions)
        template_id = "default_template"

        # When
        response = engine.ask_questions(form_schema, template_id)

        # Then
        assert response.template_id == template_id
        assert response.answers == {"q1": "default1", "q2": "default2"}

    def test_ask_questions_skips_questions_without_defaults(self):
        """Given questions without defaults, when using default mode, then should skip those questions."""
        # Given
        engine = SocraticFormEngine(use_defaults_when_no_callback=True)

        questions = [
            FormQuestion(
                id="q1", text="Question 1?", type="text", required=True, default="default1"
            ),
            FormQuestion(
                id="q2", text="Question 2?", type="text", required=False, default=None
            ),
            FormQuestion(
                id="q3", text="Question 3?", type="text", required=False, default=""
            ),
        ]
        form_schema = FormSchema(questions=questions)
        template_id = "partial_default_template"

        # When
        response = engine.ask_questions(form_schema, template_id)

        # Then
        assert response.answers == {"q1": "default1"}  # q2 and q3 not included

    def test_ask_questions_caches_default_responses(self):
        """Given default mode, when asking same questions twice, then should use cache."""
        # Given
        engine = SocraticFormEngine(use_defaults_when_no_callback=True)

        question = FormQuestion(
            id="q1", text="Question?", type="text", required=True, default="default"
        )
        form_schema = FormSchema(questions=[question])
        template_id = "cache_template"

        # When
        response1 = engine.ask_questions(form_schema, template_id)
        response2 = engine.ask_questions(form_schema, template_id)

        # Then
        assert response1 == response2
        assert response1.answers == {"q1": "default"}


class TestAskQuestionsErrorHandling:
    """Test error handling in ask_questions method."""

    def test_ask_questions_with_empty_form_schema(self):
        """Given empty form schema, when asking questions, then should log warning and return empty response."""
        # Given
        engine = SocraticFormEngine()
        form_schema = FormSchema(questions=[])
        template_id = "empty_template"

        # When
        with patch.object(logging.getLogger("empathy_os.meta_workflows.form_engine"), "warning") as mock_logger:
            response = engine.ask_questions(form_schema, template_id)

        # Then
        assert response.template_id == template_id
        assert response.answers == {}
        mock_logger.assert_called_once()

    def test_ask_questions_with_none_questions(self):
        """Given form schema with None questions, when asking, then should handle gracefully."""
        # Given
        engine = SocraticFormEngine()
        form_schema = FormSchema(questions=None)
        template_id = "none_template"

        # When
        with patch.object(logging.getLogger("empathy_os.meta_workflows.form_engine"), "warning") as mock_logger:
            response = engine.ask_questions(form_schema, template_id)

        # Then
        assert response.answers == {}
        mock_logger.assert_called_once()

    def test_ask_questions_no_callback_no_defaults_raises_error(self):
        """Given no callback and use_defaults=False, when asking questions, then should raise ValueError."""
        # Given
        engine = SocraticFormEngine(use_defaults_when_no_callback=False)

        question = FormQuestion(
            id="q1", text="Question?", type="text", required=True, default="default"
        )
        form_schema = FormSchema(questions=[question])
        template_id = "error_template"

        # When/Then
        with pytest.raises(ValueError, match="Cannot ask questions without a callback"):
            engine.ask_questions(form_schema, template_id)

    def test_ask_questions_callback_raises_exception(self):
        """Given callback that raises exception, when asking questions, then should propagate error."""
        # Given
        callback = MagicMock(side_effect=RuntimeError("Callback failed"))
        engine = SocraticFormEngine(ask_user_callback=callback)

        question = FormQuestion(
            id="q1", text="Question?", type="text", required=True, default="default"
        )
        form_schema = FormSchema(questions=[question])
        template_id = "exception_template"

        # When/Then
        with pytest.raises(RuntimeError, match="Callback failed"):
            engine.ask_questions(form_schema, template_id)

    def test_ask_questions_callback_returns_invalid_type(self):
        """Given callback returns non-dict, when asking questions, then should handle gracefully."""
        # Given
        callback = MagicMock(return_value=["not", "a", "dict"])
        engine = SocraticFormEngine(ask_user_callback=callback)

        question = FormQuestion(
            id="q1", text="Question?", type="text", required=True, default="default"
        )
        form_schema = FormSchema(questions=[question])
        template_id = "invalid_type_template"

        # When/Then - Should raise an error or handle gracefully
        with pytest.raises((TypeError, AttributeError)):
            engine.ask_questions(form_schema, template_id)

    def test_ask_questions_callback_returns_none(self):
        """Given callback returns None, when asking questions, then should handle gracefully."""
        # Given
        callback = MagicMock(return_value=None)
        engine = SocraticFormEngine(ask_user_callback=callback)

        question = FormQuestion(
            id="q1", text="Question?", type="text", required=True, default="default"
        )
        form_schema = FormSchema(questions=[question])
        template_id = "none_return_template"

        # When/Then
        with pytest.raises((TypeError, AttributeError)):
            engine.ask_questions(form_schema, template_id)


class TestFormQuestionSerialization:
    """Test FormQuestion serialization for callback invocation."""

    def test_question_serialization_includes_all_fields(self):
        """Given question with all fields, when serializing for callback, then should include all fields."""
        # Given
        callback = MagicMock(return_value={"q1": "answer"})
        engine = SocraticFormEngine(ask_user_callback=callback)

        question = FormQuestion(
            id="q1",
            text="What is your preference?",
            type="select",
            required=True,
            options=["option1", "option2", "option3"],
            default="option1",
        )
        form_schema = FormSchema(questions=[question])
        template_id = "full_fields_template"

        # When
        engine.ask_questions(form_schema, template_id)

        # Then
        call_args = callback.call_args[0][0]
        question_dict = call_args[0]
        assert question_dict["id"] == "q1"
        assert question_dict["text"] == "What is your preference?"
        assert question_dict["type"] == "select"
        assert question_dict["required"] is True
        assert question_dict["options"] == ["option1", "option2", "option3"]
        assert question_dict["default"] == "option1"

    def test_question_serialization_optional_fields(self):
        """Given question with minimal fields, when serializing, then should handle optional fields."""
        # Given
        callback = MagicMock(return_value=