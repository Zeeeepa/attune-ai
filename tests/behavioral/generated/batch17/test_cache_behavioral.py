"""Behavioral tests for cache.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import argparse
from unittest.mock import MagicMock, Mock, call, patch

import pytest

from empathy_os.cli.parsers.cache import register_parsers


class TestRegisterParsers:
    """Behavioral tests for register_parsers function."""

    @pytest.fixture
    def mock_subparsers(self):
        """Create mock subparsers object.
        
        Returns:
            MagicMock: Mock object simulating argparse subparsers
        """
        # Given: A mock subparsers object
        subparsers = MagicMock()
        cache_parser = MagicMock()
        cache_subparsers = MagicMock()
        stats_parser = MagicMock()
        clear_parser = MagicMock()
        
        # Setup return values
        subparsers.add_parser.return_value = cache_parser
        cache_parser.add_subparsers.return_value = cache_subparsers
        cache_subparsers.add_parser.side_effect = [stats_parser, clear_parser]
        
        return subparsers

    def test_registers_main_cache_parser(self, mock_subparsers):
        """Given a subparsers object,
        When register_parsers is called,
        Then it should register the main cache parser with correct parameters.
        """
        # Given: mock_subparsers fixture
        
        # When: Registering parsers
        register_parsers(mock_subparsers)
        
        # Then: Main cache parser should be added with correct parameters
        mock_subparsers.add_parser.assert_called_once_with(
            "cache",
            help="Cache monitoring and management",
            description="Monitor prompt caching performance and cost savings",
        )

    def test_creates_cache_subparsers(self, mock_subparsers):
        """Given a main cache parser,
        When register_parsers is called,
        Then it should create subparsers for cache commands.
        """
        # Given: mock_subparsers fixture
        cache_parser = mock_subparsers.add_parser.return_value
        
        # When: Registering parsers
        register_parsers(mock_subparsers)
        
        # Then: Subparsers should be created with required=True
        cache_parser.add_subparsers.assert_called_once_with(
            dest="cache_command",
            required=True
        )

    def test_registers_stats_subcommand(self, mock_subparsers):
        """Given cache subparsers,
        When register_parsers is called,
        Then it should register the stats subcommand.
        """
        # Given: mock_subparsers fixture
        cache_subparsers = mock_subparsers.add_parser.return_value.add_subparsers.return_value
        
        # When: Registering parsers
        register_parsers(mock_subparsers)
        
        # Then: Stats parser should be added with correct parameters
        calls = cache_subparsers.add_parser.call_args_list
        assert len(calls) >= 1
        assert calls[0] == call(
            "stats",
            help="Show cache performance statistics",
            description="Display prompt caching metrics including hit rate and cost savings",
        )

    def test_registers_clear_subcommand(self, mock_subparsers):
        """Given cache subparsers,
        When register_parsers is called,
        Then it should register the clear subcommand.
        """
        # Given: mock_subparsers fixture
        cache_subparsers = mock_subparsers.add_parser.return_value.add_subparsers.return_value
        
        # When: Registering parsers
        register_parsers(mock_subparsers)
        
        # Then: Clear parser should be added with correct parameters
        calls = cache_subparsers.add_parser.call_args_list
        assert len(calls) == 2
        assert calls[1] == call(
            "clear",
            help="Clear cache (note: Anthropic cache is server-side with 5min TTL)",
            description="Information about cache clearing",
        )

    def test_stats_parser_adds_days_argument(self, mock_subparsers):
        """Given a stats parser,
        When register_parsers is called,
        Then it should add the --days argument with correct settings.
        """
        # Given: mock_subparsers fixture
        cache_subparsers = mock_subparsers.add_parser.return_value.add_subparsers.return_value
        stats_parser = MagicMock()
        cache_subparsers.add_parser.side_effect = [stats_parser, MagicMock()]
        
        # When: Registering parsers
        register_parsers(mock_subparsers)
        
        # Then: Days argument should be added
        days_calls = [
            call for call in stats_parser.add_argument.call_args_list
            if call[0][0] == "--days"
        ]
        assert len(days_calls) == 1
        assert days_calls[0].kwargs["type"] == int
        assert days_calls[0].kwargs["default"] == 7
        assert "Number of days" in days_calls[0].kwargs["help"]

    def test_stats_parser_adds_format_argument(self, mock_subparsers):
        """Given a stats parser,
        When register_parsers is called,
        Then it should add the --format argument with correct choices.
        """
        # Given: mock_subparsers fixture
        cache_subparsers = mock_subparsers.add_parser.return_value.add_subparsers.return_value
        stats_parser = MagicMock()
        cache_subparsers.add_parser.side_effect = [stats_parser, MagicMock()]
        
        # When: Registering parsers
        register_parsers(mock_subparsers)
        
        # Then: Format argument should be added with table and json choices
        format_calls = [
            call for call in stats_parser.add_argument.call_args_list
            if call[0][0] == "--format"
        ]
        assert len(format_calls) == 1
        assert format_calls[0].kwargs["choices"] == ["table", "json"]
        assert format_calls[0].kwargs["default"] == "table"

    def test_stats_parser_adds_verbose_argument(self, mock_subparsers):
        """Given a stats parser,
        When register_parsers is called,
        Then it should add the --verbose/-v flag.
        """
        # Given: mock_subparsers fixture
        cache_subparsers = mock_subparsers.add_parser.return_value.add_subparsers.return_value
        stats_parser = MagicMock()
        cache_subparsers.add_parser.side_effect = [stats_parser, MagicMock()]
        
        # When: Registering parsers
        register_parsers(mock_subparsers)
        
        # Then: Verbose argument should be added as action='store_true'
        verbose_calls = [
            call for call in stats_parser.add_argument.call_args_list
            if "--verbose" in call[0]
        ]
        assert len(verbose_calls) == 1
        assert "-v" in verbose_calls[0][0]
        assert verbose_calls[0].kwargs["action"] == "store_true"

    @patch("empathy_os.cli.parsers.cache.cmd_cache_stats")
    def test_stats_parser_sets_default_function(self, mock_cmd_stats, mock_subparsers):
        """Given a stats parser,
        When register_parsers is called,
        Then it should set cmd_cache_stats as the default function.
        """
        # Given: mock_subparsers fixture and mocked command
        cache_subparsers = mock_subparsers.add_parser.return_value.add_subparsers.return_value
        stats_parser = MagicMock()
        cache_subparsers.add_parser.side_effect = [stats_parser, MagicMock()]
        
        # When: Registering parsers
        register_parsers(mock_subparsers)
        
        # Then: Default function should be set to cmd_cache_stats
        stats_parser.set_defaults.assert_called_once_with(func=mock_cmd_stats)

    @patch("empathy_os.cli.parsers.cache.cmd_cache_clear")
    def test_clear_parser_sets_default_function(self, mock_cmd_clear, mock_subparsers):
        """Given a clear parser,
        When register_parsers is called,
        Then it should set cmd_cache_clear as the default function.
        """
        # Given: mock_subparsers fixture and mocked command
        cache_subparsers = mock_subparsers.add_parser.return_value.add_subparsers.return_value
        clear_parser = MagicMock()
        cache_subparsers.add_parser.side_effect = [MagicMock(), clear_parser]
        
        # When: Registering parsers
        register_parsers(mock_subparsers)
        
        # Then: Default function should be set to cmd_cache_clear
        clear_parser.set_defaults.assert_called_once_with(func=mock_cmd_clear)

    def test_returns_none(self, mock_subparsers):
        """Given a subparsers object,
        When register_parsers is called,
        Then it should return None.
        """
        # Given: mock_subparsers fixture
        
        # When: Registering parsers
        result = register_parsers(mock_subparsers)
        
        # Then: Result should be None
        assert result is None

    @patch("empathy_os.cli.parsers.cache.cmd_cache_stats")
    @patch("empathy_os.cli.parsers.cache.cmd_cache_clear")
    def test_imports_commands_module(self, mock_clear, mock_stats, mock_subparsers):
        """Given the cache parser registration,
        When register_parsers is called,
        Then it should import the commands module.
        """
        # Given: mock_subparsers fixture and mocked commands
        
        # When: Registering parsers
        register_parsers(mock_subparsers)
        
        # Then: Commands should be imported and used
        # This is tested by the fact that the patched functions are used
        assert mock_stats is not None
        assert mock_clear is not None


class TestIntegrationWithRealArgumentParser:
    """Integration tests using real argparse.ArgumentParser."""

    @pytest.fixture
    def parser(self):
        """Create a real ArgumentParser for integration testing.
        
        Returns:
            ArgumentParser: Real parser with cache subparsers registered
        """
        # Given: A real ArgumentParser
        main_parser = argparse.ArgumentParser()
        subparsers = main_parser.add_subparsers(dest="command")
        
        # When: Registering parsers
        with patch("empathy_os.cli.parsers.cache.cmd_cache_stats"), \
             patch("empathy_os.cli.parsers.cache.cmd_cache_clear"):
            register_parsers(subparsers)
        
        return main_parser

    def test_parses_cache_stats_with_defaults(self, parser):
        """Given a parser with cache subcommands,
        When parsing 'cache stats' with no arguments,
        Then it should use default values for all options.
        """
        # Given: parser fixture
        
        # When: Parsing cache stats command
        args = parser.parse_args(["cache", "stats"])
        
        # Then: Default values should be set
        assert args.command == "cache"
        assert args.cache_command == "stats"
        assert args.days == 7
        assert args.format == "table"
        assert args.verbose is False

    def test_parses_cache_stats_with_custom_days(self, parser):
        """Given a parser with cache subcommands,
        When parsing 'cache stats --days 30',
        Then it should use the custom days value.
        """
        # Given: parser fixture
        
        # When: Parsing cache stats with custom days
        args = parser.parse_args(["cache", "stats", "--days", "30"])
        
        # Then: Custom days value should be set
        assert args.days == 30

    def test_parses_cache_stats_with_json_format(self, parser):
        """Given a parser with cache subcommands,
        When parsing 'cache stats --format json',
        Then it should use json format.
        """
        # Given: parser fixture
        
        # When: Parsing cache stats with json format
        args = parser.parse_args(["cache", "stats", "--format", "json"])
        
        # Then: Format should be json
        assert args.format == "json"

    def test_parses_cache_stats_with_verbose_flag(self, parser):
        """Given a parser with cache subcommands,
        When parsing 'cache stats -v',
        Then it should enable verbose mode.
        """
        # Given: parser fixture
        
        # When: Parsing cache stats with verbose flag
        args = parser.parse_args(["cache", "stats", "-v"])
        
        # Then: Verbose should be True
        assert args.verbose is True

    def test_parses_cache_stats_with_verbose_long_flag(self, parser):
        """Given a parser with cache subcommands,
        When parsing 'cache stats --verbose',
        Then it should enable verbose mode.
        """
        # Given: parser fixture
        
        # When: Parsing cache stats with verbose long flag
        args = parser.parse_args(["cache", "stats", "--verbose"])
        
        # Then: Verbose should be True
        assert args.verbose is True

    def test_parses_cache_stats_with_all_options(self, parser):
        """Given a parser with cache subcommands,
        When parsing cache stats with all options,
        Then it should set all values correctly.
        """
        # Given: parser fixture
        
        # When: Parsing cache stats with all options
        args = parser.parse_args([
            "cache", "stats",
            "--days", "14",
            "--format", "json",
            "--verbose"
        ])
        
        # Then: All values should be set correctly
        assert args.days == 14
        assert args.format == "json"
        assert args.verbose is True

    def test_parses_cache_clear(self, parser):
        """Given a parser with cache subcommands,
        When parsing 'cache clear',
        Then it should set the cache_command to clear.
        """
        # Given: parser fixture
        
        # When: Parsing cache clear command
        args = parser.parse_args(["cache", "clear"])
        
        # Then: Cache command should be clear
        assert args.command == "cache"
        assert args.cache_command == "clear"

    def test_rejects_invalid_format(self, parser):
        """Given a parser with cache subcommands,
        When parsing 'cache stats --format invalid',
        Then it should raise a SystemExit error.
        """
        # Given: parser fixture
        
        # When/Then: Parsing with invalid format should raise SystemExit
        with pytest.raises(SystemExit):
            parser.parse_args(["cache", "stats", "--format", "invalid"])

    def test_requires_cache_subcommand(self, parser):
        """Given a parser with cache subcomm