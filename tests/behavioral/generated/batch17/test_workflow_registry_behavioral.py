"""Behavioral tests for workflow_registry.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import pytest
from typing import Any
from unittest.mock import Mock, MagicMock

from empathy_os.routing.workflow_registry import (
    WorkflowInfo,
    WORKFLOW_REGISTRY,
)


class TestWorkflowInfo:
    """Test suite for WorkflowInfo dataclass."""

    def test_workflow_info_creation_with_minimal_fields(self):
        """
        Given: Minimal required fields for WorkflowInfo
        When: Creating a WorkflowInfo instance
        Then: Instance is created with defaults for optional fields
        """
        # Given
        name = "test-workflow"
        description = "Test workflow description"
        keywords = ["test", "workflow"]

        # When
        workflow_info = WorkflowInfo(
            name=name,
            description=description,
            keywords=keywords,
        )

        # Then
        assert workflow_info.name == name
        assert workflow_info.description == description
        assert workflow_info.keywords == keywords
        assert workflow_info.primary_domain == ""
        assert workflow_info.handles_file_types == []
        assert workflow_info.complexity == "medium"
        assert workflow_info.auto_chain is False
        assert workflow_info.chain_triggers == []
        assert workflow_info.workflow_class is None
        assert workflow_info.factory is None

    def test_workflow_info_creation_with_all_fields(self):
        """
        Given: All fields for WorkflowInfo including optional ones
        When: Creating a WorkflowInfo instance
        Then: Instance is created with all specified values
        """
        # Given
        name = "security-test"
        description = "Security testing workflow"
        keywords = ["security", "test"]
        primary_domain = "security"
        handles_file_types = [".py", ".js"]
        complexity = "high"
        auto_chain = True
        chain_triggers = [{"condition": "severity > 5", "next": "follow-up"}]
        mock_class = Mock
        mock_factory = Mock()

        # When
        workflow_info = WorkflowInfo(
            name=name,
            description=description,
            keywords=keywords,
            primary_domain=primary_domain,
            handles_file_types=handles_file_types,
            complexity=complexity,
            auto_chain=auto_chain,
            chain_triggers=chain_triggers,
            workflow_class=mock_class,
            factory=mock_factory,
        )

        # Then
        assert workflow_info.name == name
        assert workflow_info.description == description
        assert workflow_info.keywords == keywords
        assert workflow_info.primary_domain == primary_domain
        assert workflow_info.handles_file_types == handles_file_types
        assert workflow_info.complexity == complexity
        assert workflow_info.auto_chain is True
        assert workflow_info.chain_triggers == chain_triggers
        assert workflow_info.workflow_class == mock_class
        assert workflow_info.factory == mock_factory

    def test_workflow_info_mutable_default_fields(self):
        """
        Given: Multiple WorkflowInfo instances
        When: Created without specifying mutable default fields
        Then: Each instance has independent mutable field instances
        """
        # Given & When
        workflow1 = WorkflowInfo(
            name="workflow1",
            description="First workflow",
            keywords=["first"],
        )
        workflow2 = WorkflowInfo(
            name="workflow2",
            description="Second workflow",
            keywords=["second"],
        )

        # Modify first instance
        workflow1.handles_file_types.append(".py")
        workflow1.chain_triggers.append({"test": "trigger"})

        # Then
        assert workflow2.handles_file_types == []
        assert workflow2.chain_triggers == []

    def test_workflow_info_with_callable_factory(self):
        """
        Given: A callable factory function
        When: Creating WorkflowInfo with factory
        Then: Factory is stored and can be called
        """
        # Given
        def mock_factory(**kwargs):
            return {"result": "workflow_instance", **kwargs}

        # When
        workflow_info = WorkflowInfo(
            name="factory-workflow",
            description="Workflow with factory",
            keywords=["factory"],
            factory=mock_factory,
        )

        # Then
        assert workflow_info.factory is not None
        result = workflow_info.factory(param="value")
        assert result["result"] == "workflow_instance"
        assert result["param"] == "value"

    def test_workflow_info_with_workflow_class(self):
        """
        Given: A workflow class
        When: Creating WorkflowInfo with workflow_class
        Then: Class reference is stored correctly
        """
        # Given
        class MockWorkflow:
            def execute(self):
                return "executed"

        # When
        workflow_info = WorkflowInfo(
            name="class-workflow",
            description="Workflow with class",
            keywords=["class"],
            workflow_class=MockWorkflow,
        )

        # Then
        assert workflow_info.workflow_class == MockWorkflow
        instance = workflow_info.workflow_class()
        assert instance.execute() == "executed"

    def test_workflow_info_complexity_values(self):
        """
        Given: Different complexity values
        When: Creating WorkflowInfo instances
        Then: Complexity is stored as provided
        """
        # Given & When
        low_complexity = WorkflowInfo(
            name="simple",
            description="Simple workflow",
            keywords=["simple"],
            complexity="low",
        )
        high_complexity = WorkflowInfo(
            name="complex",
            description="Complex workflow",
            keywords=["complex"],
            complexity="high",
        )

        # Then
        assert low_complexity.complexity == "low"
        assert high_complexity.complexity == "high"

    def test_workflow_info_empty_keywords_list(self):
        """
        Given: An empty keywords list
        When: Creating WorkflowInfo
        Then: Instance is created successfully with empty keywords
        """
        # Given
        keywords = []

        # When
        workflow_info = WorkflowInfo(
            name="no-keywords",
            description="Workflow without keywords",
            keywords=keywords,
        )

        # Then
        assert workflow_info.keywords == []
        assert isinstance(workflow_info.keywords, list)

    def test_workflow_info_chain_triggers_structure(self):
        """
        Given: Complex chain triggers with multiple conditions
        When: Creating WorkflowInfo with chain_triggers
        Then: Triggers are stored with correct structure
        """
        # Given
        chain_triggers = [
            {"condition": "severity > 5", "next": "escalate"},
            {"condition": "type == 'critical'", "next": "immediate-review"},
            {"condition": "count > 10", "next": "batch-process", "priority": "high"},
        ]

        # When
        workflow_info = WorkflowInfo(
            name="chained-workflow",
            description="Workflow with multiple triggers",
            keywords=["chain"],
            auto_chain=True,
            chain_triggers=chain_triggers,
        )

        # Then
        assert len(workflow_info.chain_triggers) == 3
        assert workflow_info.chain_triggers[0]["condition"] == "severity > 5"
        assert workflow_info.chain_triggers[2].get("priority") == "high"


class TestWorkflowRegistry:
    """Test suite for WORKFLOW_REGISTRY."""

    def test_workflow_registry_exists(self):
        """
        Given: The workflow_registry module
        When: Accessing WORKFLOW_REGISTRY
        Then: Registry exists and is a dictionary
        """
        # When & Then
        assert WORKFLOW_REGISTRY is not None
        assert isinstance(WORKFLOW_REGISTRY, dict)

    def test_workflow_registry_contains_security_audit(self):
        """
        Given: The WORKFLOW_REGISTRY
        When: Checking for security-audit workflow
        Then: Workflow exists with expected properties
        """
        # Given
        workflow_key = "security-audit"

        # When
        workflow = WORKFLOW_REGISTRY.get(workflow_key)

        # Then
        assert workflow is not None
        assert workflow.name == "security-audit"
        assert "security" in workflow.description.lower()
        assert "security" in workflow.keywords
        assert workflow.primary_domain == "security"
        assert workflow.auto_chain is True

    def test_workflow_registry_contains_code_review(self):
        """
        Given: The WORKFLOW_REGISTRY
        When: Checking for code-review workflow
        Then: Workflow exists with expected properties
        """
        # Given
        workflow_key = "code-review"

        # When
        workflow = WORKFLOW_REGISTRY.get(workflow_key)

        # Then
        assert workflow is not None
        assert workflow.name == "code-review"
        assert "review" in workflow.description.lower()
        assert "review" in workflow.keywords
        assert workflow.primary_domain == "quality"
        assert workflow.auto_chain is True

    def test_workflow_registry_contains_bug_predict(self):
        """
        Given: The WORKFLOW_REGISTRY
        When: Checking for bug-predict workflow
        Then: Workflow exists with expected properties
        """
        # Given
        workflow_key = "bug-predict"

        # When
        workflow = WORKFLOW_REGISTRY.get(workflow_key)

        # Then
        assert workflow is not None
        assert workflow.name == "bug-predict"
        assert "bug" in workflow.description.lower() or "predict" in workflow.description.lower()
        assert "bug" in workflow.keywords

    def test_workflow_registry_all_entries_are_workflow_info(self):
        """
        Given: The WORKFLOW_REGISTRY
        When: Iterating through all entries
        Then: All values are WorkflowInfo instances
        """
        # When & Then
        for key, workflow in WORKFLOW_REGISTRY.items():
            assert isinstance(workflow, WorkflowInfo)
            assert isinstance(key, str)
            assert len(key) > 0

    def test_workflow_registry_all_workflows_have_required_fields(self):
        """
        Given: The WORKFLOW_REGISTRY
        When: Checking all workflows
        Then: All have required fields populated
        """
        # When & Then
        for key, workflow in WORKFLOW_REGISTRY.items():
            assert workflow.name, f"Workflow {key} missing name"
            assert workflow.description, f"Workflow {key} missing description"
            assert isinstance(workflow.keywords, list), f"Workflow {key} keywords not a list"

    def test_workflow_registry_security_audit_keywords(self):
        """
        Given: The security-audit workflow
        When: Checking keywords
        Then: Contains expected security-related keywords
        """
        # Given
        workflow = WORKFLOW_REGISTRY["security-audit"]
        expected_keywords = [
            "security",
            "vulnerability",
            "injection",
            "authentication",
            "authorization",
        ]

        # When & Then
        for keyword in expected_keywords:
            assert keyword in workflow.keywords, f"Missing keyword: {keyword}"

    def test_workflow_registry_security_audit_file_types(self):
        """
        Given: The security-audit workflow
        When: Checking handles_file_types
        Then: Contains expected file extensions
        """
        # Given
        workflow = WORKFLOW_REGISTRY["security-audit"]

        # When & Then
        assert ".py" in workflow.handles_file_types
        assert ".js" in workflow.handles_file_types
        assert ".ts" in workflow.handles_file_types

    def test_workflow_registry_security_audit_chain_triggers(self):
        """
        Given: The security-audit workflow
        When: Checking chain_triggers
        Then: Contains expected trigger conditions
        """
        # Given
        workflow = WORKFLOW_REGISTRY["security-audit"]

        # When & Then
        assert len(workflow.chain_triggers) > 0
        trigger_nexts = [trigger.get("next") for trigger in workflow.chain_triggers]
        assert "dependency-check" in trigger_nexts or "code-review" in trigger_nexts

    def test_workflow_registry_code_review_file_types(self):
        """
        Given: The code-review workflow
        When: Checking handles_file_types
        Then: Supports multiple programming languages
        """
        # Given
        workflow = WORKFLOW_REGISTRY["code-review"]

        # When & Then
        assert len(workflow.handles_file_types) > 0
        assert ".py" in workflow.handles_file_types
        assert ".js" in workflow.handles_file_types or ".ts" in workflow.handles_file_types

    def test_workflow_registry_keys_match_names(self):
        """
        Given: The WORKFLOW_REGISTRY
        When: Checking all entries
        Then: Registry keys match workflow names
        """
        # When & Then
        for key, workflow in WORKFLOW_REGISTRY.items():
            assert key == workflow.name, f"Key {key} doesn't match name {workflow.name}"

    def test_workflow_registry_is_mutable(self):
        """
        Given: The WORKFLOW_REGISTRY
        When: Adding a new workflow
        Then: Registry can be modified
        """
        # Given
        original_count = len(WORKFLOW_REGISTRY)
        test_workflow = WorkflowInfo(
            name="test-temp-workflow",
            description="Temporary test workflow",
            keywords=["test"],
        )

        # When
        WORKFLOW_REGISTRY["test-temp-workflow"] = test_workflow

        # Then
        assert len(WORKFLOW_REGISTRY) == original_count + 1
        assert "test-temp-workflow" in WORKFLOW_REGISTRY

        # Cleanup
        del WORKFLOW_REGISTRY["test-temp-workflow"]
        assert len(WORKFLOW_REGISTRY) == original_count

    def test_workflow_registry_nonexistent_key_returns_none(self):
        """
        Given: The WORKFLOW_REGISTRY
        When: Accessing a non-existent workflow key
        Then: Returns None
        """
        # When
        result = WORKFLOW_REGISTRY.get("nonexistent-workflow")

        # Then
        assert result is None

    def test_workflow_registry_auto_chain_workflows(self):
        """
        Given: The WORKFLOW_REGISTRY
        When: Filtering for auto-chain enabled workflows
        Then: Some workflows have auto_chain enabled
        """
        # When
        auto_chain_workflows = [
            workflow for workflow in WORKFLOW_REGISTRY.values() if workflow.auto_chain
        ]

        # Then
        assert len(auto_chain_workflows) > 0
        for workflow in auto_chain_workflows:
            assert workflow.auto_chain is True

    def test_workflow_registry_primary_domains(self):
        """
        Given: The WORKFLOW_REGISTRY
        When: Checking primary_domain fields
        Then: Workflows have meaningful domain classifications
        """
        # When
        domains = [
            workflow.primary_domain
            for workflow in WORKFLOW_REGISTRY.values()
            if workflow.primary_domain
        ]

        # Then
        assert len(domains) > 0
        assert "security" in domains or "quality" in domains

    def test_workflow_registry_complexity_levels(self):
        """
        Given: The WORKFLOW_REGISTRY
        When: Checking complexity fields
        Then: All workflows have valid complexity levels
        """
        # Given
        valid_complexity = ["low", "medium", "high"]

        # When & Then
        for workflow in WORKFLOW_REGISTRY.values():
            assert workflow.complexity in valid_complexity, (
                f"Invalid complexity: {workflow.complexity}"
            )

    def test_workflow_registry_keywords_not_empty_for_all(self):
        """
        Given: The WORKFLOW_REGISTRY
        When: Checking keywords for all workflows
        Then: All workflows have at least one keyword
        """