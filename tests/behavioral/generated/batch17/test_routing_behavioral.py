"""Behavioral tests for routing.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import argparse
from unittest.mock import Mock, patch, MagicMock

import pytest

from empathy_os.cli.parsers.routing import register_parsers


class TestRegisterParsers:
    """Behavioral tests for register_parsers function."""

    @pytest.fixture
    def mock_subparsers(self):
        """Fixture providing a mock subparsers object.

        Returns:
            Mock: Configured mock subparsers object
        """
        subparsers = Mock()
        parser = Mock()
        subparsers.add_parser.return_value = parser

        # Create mock for routing subparsers
        routing_subparsers = Mock()
        parser.add_subparsers.return_value = routing_subparsers

        # Create mocks for each subcommand parser
        stats_parser = Mock()
        check_parser = Mock()
        models_parser = Mock()

        routing_subparsers.add_parser.side_effect = [
            stats_parser,
            check_parser,
            models_parser,
        ]

        return subparsers

    @pytest.fixture
    def mock_commands(self):
        """Fixture providing mocked command functions.

        Returns:
            dict: Dictionary of mocked command functions
        """
        with patch(
            "empathy_os.cli.parsers.routing.cmd_routing_stats"
        ) as mock_stats, patch(
            "empathy_os.cli.parsers.routing.cmd_routing_check"
        ) as mock_check, patch(
            "empathy_os.cli.parsers.routing.cmd_routing_models"
        ) as mock_models:
            yield {
                "stats": mock_stats,
                "check": mock_check,
                "models": mock_models,
            }

    def test_given_subparsers_when_register_parsers_then_routing_parser_created(
        self, mock_subparsers, mock_commands
    ):
        """Given subparsers object
        When register_parsers is called
        Then routing parser is created with correct configuration
        """
        # When
        register_parsers(mock_subparsers)

        # Then
        mock_subparsers.add_parser.assert_called_once_with(
            "routing",
            help="Adaptive model routing statistics and recommendations",
            description="Analyze model routing performance based on historical telemetry",
        )

    def test_given_routing_parser_when_register_parsers_then_subparsers_created(
        self, mock_subparsers, mock_commands
    ):
        """Given routing parser
        When register_parsers is called
        Then routing subparsers are created with required=True
        """
        # Given
        routing_parser = mock_subparsers.add_parser.return_value

        # When
        register_parsers(mock_subparsers)

        # Then
        routing_parser.add_subparsers.assert_called_once_with(
            dest="routing_command", required=True
        )

    def test_given_routing_subparsers_when_register_parsers_then_stats_parser_created(
        self, mock_subparsers, mock_commands
    ):
        """Given routing subparsers
        When register_parsers is called
        Then stats parser is created with correct configuration
        """
        # Given
        routing_parser = mock_subparsers.add_parser.return_value
        routing_subparsers = routing_parser.add_subparsers.return_value

        # When
        register_parsers(mock_subparsers)

        # Then
        calls = routing_subparsers.add_parser.call_args_list
        stats_call = calls[0]
        assert stats_call[0][0] == "stats"
        assert stats_call[1]["help"] == "Show routing statistics for a workflow"
        assert (
            stats_call[1]["description"]
            == "Display model performance metrics and recommendations"
        )

    def test_given_stats_parser_when_register_parsers_then_workflow_argument_added(
        self, mock_subparsers, mock_commands
    ):
        """Given stats parser
        When register_parsers is called
        Then workflow positional argument is added
        """
        # Given
        routing_parser = mock_subparsers.add_parser.return_value
        routing_subparsers = routing_parser.add_subparsers.return_value
        stats_parser = routing_subparsers.add_parser.return_value

        # When
        register_parsers(mock_subparsers)

        # Then
        calls = stats_parser.add_argument.call_args_list
        workflow_call = calls[0]
        assert workflow_call[0][0] == "workflow"
        assert workflow_call[1]["help"] == "Workflow name (e.g., 'code-review')"

    def test_given_stats_parser_when_register_parsers_then_stage_argument_added(
        self, mock_subparsers, mock_commands
    ):
        """Given stats parser
        When register_parsers is called
        Then stage optional argument is added
        """
        # Given
        routing_parser = mock_subparsers.add_parser.return_value
        routing_subparsers = routing_parser.add_subparsers.return_value
        stats_parser = routing_subparsers.add_parser.return_value

        # When
        register_parsers(mock_subparsers)

        # Then
        calls = stats_parser.add_argument.call_args_list
        stage_call = calls[1]
        assert stage_call[0][0] == "--stage"
        assert (
            stage_call[1]["help"]
            == "Stage name (optional, shows all stages if not specified)"
        )

    def test_given_stats_parser_when_register_parsers_then_days_argument_added(
        self, mock_subparsers, mock_commands
    ):
        """Given stats parser
        When register_parsers is called
        Then days argument is added with default value
        """
        # Given
        routing_parser = mock_subparsers.add_parser.return_value
        routing_subparsers = routing_parser.add_subparsers.return_value
        stats_parser = routing_subparsers.add_parser.return_value

        # When
        register_parsers(mock_subparsers)

        # Then
        calls = stats_parser.add_argument.call_args_list
        days_call = calls[2]
        assert days_call[0][0] == "--days"
        assert days_call[1]["type"] == int
        assert days_call[1]["default"] == 7
        assert days_call[1]["help"] == "Number of days to analyze (default: 7)"

    def test_given_stats_parser_when_register_parsers_then_default_func_set(
        self, mock_subparsers, mock_commands
    ):
        """Given stats parser
        When register_parsers is called
        Then default func is set to cmd_routing_stats
        """
        # Given
        routing_parser = mock_subparsers.add_parser.return_value
        routing_subparsers = routing_parser.add_subparsers.return_value
        stats_parser = routing_subparsers.add_parser.return_value

        # When
        register_parsers(mock_subparsers)

        # Then
        stats_parser.set_defaults.assert_called_once_with(func=mock_commands["stats"])

    def test_given_routing_subparsers_when_register_parsers_then_check_parser_created(
        self, mock_subparsers, mock_commands
    ):
        """Given routing subparsers
        When register_parsers is called
        Then check parser is created with correct configuration
        """
        # Given
        routing_parser = mock_subparsers.add_parser.return_value
        routing_subparsers = routing_parser.add_subparsers.return_value

        # When
        register_parsers(mock_subparsers)

        # Then
        calls = routing_subparsers.add_parser.call_args_list
        check_call = calls[1]
        assert check_call[0][0] == "check"
        assert check_call[1]["help"] == "Check for tier upgrade recommendations"
        assert (
            check_call[1]["description"]
            == "Analyze failure rates and recommend tier upgrades"
        )

    def test_given_check_parser_when_register_parsers_then_workflow_argument_added(
        self, mock_subparsers, mock_commands
    ):
        """Given check parser
        When register_parsers is called
        Then workflow optional argument is added
        """
        # Given
        routing_parser = mock_subparsers.add_parser.return_value
        routing_subparsers = routing_parser.add_subparsers.return_value
        routing_subparsers.add_parser.return_value = Mock()
        check_parser = routing_subparsers.add_parser.side_effect[1]

        # When
        register_parsers(mock_subparsers)

        # Then
        calls = check_parser.add_argument.call_args_list
        workflow_call = calls[0]
        assert workflow_call[0][0] == "--workflow"
        assert (
            workflow_call[1]["help"] == "Workflow name (required unless --all is used)"
        )

    def test_given_check_parser_when_register_parsers_then_stage_argument_added(
        self, mock_subparsers, mock_commands
    ):
        """Given check parser
        When register_parsers is called
        Then stage optional argument is added
        """
        # Given
        routing_parser = mock_subparsers.add_parser.return_value
        routing_subparsers = routing_parser.add_subparsers.return_value
        check_parser = routing_subparsers.add_parser.side_effect[1]

        # When
        register_parsers(mock_subparsers)

        # Then
        calls = check_parser.add_argument.call_args_list
        stage_call = calls[1]
        assert stage_call[0][0] == "--stage"
        assert stage_call[1]["help"] == "Stage name (optional)"

    def test_given_check_parser_when_register_parsers_then_all_argument_added(
        self, mock_subparsers, mock_commands
    ):
        """Given check parser
        When register_parsers is called
        Then all flag argument is added
        """
        # Given
        routing_parser = mock_subparsers.add_parser.return_value
        routing_subparsers = routing_parser.add_subparsers.return_value
        check_parser = routing_subparsers.add_parser.side_effect[1]

        # When
        register_parsers(mock_subparsers)

        # Then
        calls = check_parser.add_argument.call_args_list
        all_call = calls[2]
        assert all_call[0][0] == "--all"
        assert all_call[1]["action"] == "store_true"
        assert all_call[1]["help"] == "Check all workflows"

    def test_given_check_parser_when_register_parsers_then_days_argument_added(
        self, mock_subparsers, mock_commands
    ):
        """Given check parser
        When register_parsers is called
        Then days argument is added with default value
        """
        # Given
        routing_parser = mock_subparsers.add_parser.return_value
        routing_subparsers = routing_parser.add_subparsers.return_value
        check_parser = routing_subparsers.add_parser.side_effect[1]

        # When
        register_parsers(mock_subparsers)

        # Then
        calls = check_parser.add_argument.call_args_list
        days_call = calls[3]
        assert days_call[0][0] == "--days"
        assert days_call[1]["type"] == int
        assert days_call[1]["default"] == 7
        assert days_call[1]["help"] == "Number of days to analyze (default: 7)"

    def test_given_check_parser_when_register_parsers_then_default_func_set(
        self, mock_subparsers, mock_commands
    ):
        """Given check parser
        When register_parsers is called
        Then default func is set to cmd_routing_check
        """
        # Given
        routing_parser = mock_subparsers.add_parser.return_value
        routing_subparsers = routing_parser.add_subparsers.return_value
        check_parser = routing_subparsers.add_parser.side_effect[1]

        # When
        register_parsers(mock_subparsers)

        # Then
        check_parser.set_defaults.assert_called_once_with(func=mock_commands["check"])

    def test_given_routing_subparsers_when_register_parsers_then_models_parser_created(
        self, mock_subparsers, mock_commands
    ):
        """Given routing subparsers
        When register_parsers is called
        Then models parser is created with correct configuration
        """
        # Given
        routing_parser = mock_subparsers.add_parser.return_value
        routing_subparsers = routing_parser.add_subparsers.return_value

        # When
        register_parsers(mock_subparsers)

        # Then
        calls = routing_subparsers.add_parser.call_args_list
        models_call = calls[2]
        assert models_call[0][0] == "models"
        assert models_call[1]["help"] == "Compare model performance"
        assert (
            models_call[1]["description"]
            == "Show performance metrics for all models from a provider"
        )

    def test_given_models_parser_when_register_parsers_then_provider_argument_added(
        self, mock_subparsers, mock_commands
    ):
        """Given models parser
        When register_parsers is called
        Then provider argument is added with default value
        """
        # Given
        routing_parser = mock_subparsers.add_parser.return_value
        routing_subparsers = routing_parser.add_subparsers.return_value
        models_parser = routing_subparsers.add_parser.side_effect[2]

        # When
        register_parsers(mock_subparsers)

        # Then
        calls = models_parser.add_argument.call_args_list
        provider_call = calls[0]
        assert provider_call[0][0] == "--provider"
        assert provider_call[1]["default"] == "anthropic"
        assert provider_call[1]["help"] == "Provider name (default: anthropic)"

    def test_given_models_parser_when_register_parsers_then_days_argument_added(
        self, mock_subparsers, mock_commands
    ):
        """Given models parser
        When register_parsers is called
        Then days argument is added with default value
        """
        # Given
        routing_parser = mock_subparsers.add_parser.return_value
        routing_subparsers = routing_parser.add_subparsers.return_value
        models_parser = routing_subparsers.add_parser.side_effect[2]

        # When
        register_parsers(mock_subparsers)

        # Then
        calls = models_parser.add_argument.call_args_list
        days_