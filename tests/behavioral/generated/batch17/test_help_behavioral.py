"""Behavioral tests for help.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import pytest
from argparse import ArgumentParser, Namespace
from unittest.mock import Mock, MagicMock, patch, call

from empathy_os.cli.parsers.help import register_parsers


@pytest.fixture
def mock_subparsers():
    """Fixture to create a mock subparsers object."""
    subparsers = Mock()
    subparsers.add_parser = Mock(return_value=Mock())
    return subparsers


@pytest.fixture
def real_argument_parser():
    """Fixture to create a real ArgumentParser with subparsers."""
    parser = ArgumentParser()
    subparsers = parser.add_subparsers(dest='command')
    return subparsers


@pytest.fixture
def mock_help_commands():
    """Fixture to mock help commands module."""
    with patch('empathy_os.cli.parsers.help.help_commands') as mock_commands:
        mock_commands.cmd_version = Mock()
        mock_commands.cmd_cheatsheet = Mock()
        mock_commands.cmd_onboard = Mock()
        mock_commands.cmd_explain = Mock()
        mock_commands.cmd_achievements = Mock()
        yield mock_commands


class TestRegisterParsers:
    """Test suite for register_parsers function."""

    def test_given_subparsers_when_register_parsers_then_all_commands_registered(
        self, mock_subparsers, mock_help_commands
    ):
        """Given subparsers, when register_parsers is called, then all help commands are registered."""
        # When
        register_parsers(mock_subparsers)

        # Then
        expected_commands = ['version', 'cheatsheet', 'onboard', 'explain', 'achievements']
        actual_calls = [call[0][0] for call in mock_subparsers.add_parser.call_args_list]
        
        assert len(actual_calls) == 5
        assert set(actual_calls) == set(expected_commands)

    def test_given_subparsers_when_register_parsers_then_version_parser_configured(
        self, mock_subparsers, mock_help_commands
    ):
        """Given subparsers, when register_parsers is called, then version parser is properly configured."""
        # When
        register_parsers(mock_subparsers)

        # Then
        mock_subparsers.add_parser.assert_any_call('version', help='Display version information')
        parser_mock = mock_subparsers.add_parser.return_value
        parser_mock.set_defaults.assert_called()

    def test_given_subparsers_when_register_parsers_then_cheatsheet_parser_configured(
        self, real_argument_parser, mock_help_commands
    ):
        """Given subparsers, when register_parsers is called, then cheatsheet parser has correct arguments."""
        # When
        register_parsers(real_argument_parser)

        # Then
        parser = real_argument_parser.choices['cheatsheet']
        
        # Test parsing with category
        args = parser.parse_args(['--category', 'basics'])
        assert args.category == 'basics'
        assert args.compact is False
        
        # Test parsing with compact flag
        args = parser.parse_args(['--compact'])
        assert args.compact is True
        assert args.category is None

    def test_given_subparsers_when_register_parsers_then_cheatsheet_has_both_arguments(
        self, real_argument_parser, mock_help_commands
    ):
        """Given subparsers, when register_parsers is called, then cheatsheet accepts both arguments together."""
        # When
        register_parsers(real_argument_parser)

        # Then
        parser = real_argument_parser.choices['cheatsheet']
        args = parser.parse_args(['--category', 'advanced', '--compact'])
        assert args.category == 'advanced'
        assert args.compact is True

    def test_given_subparsers_when_register_parsers_then_onboard_parser_configured(
        self, real_argument_parser, mock_help_commands
    ):
        """Given subparsers, when register_parsers is called, then onboard parser has correct arguments."""
        # When
        register_parsers(real_argument_parser)

        # Then
        parser = real_argument_parser.choices['onboard']
        
        # Test with step argument
        args = parser.parse_args(['--step', '3'])
        assert args.step == 3
        assert args.reset is False
        
        # Test with reset flag
        args = parser.parse_args(['--reset'])
        assert args.reset is True
        assert args.step is None

    def test_given_subparsers_when_register_parsers_then_onboard_step_accepts_integers_only(
        self, real_argument_parser, mock_help_commands
    ):
        """Given subparsers, when register_parsers is called, then onboard --step only accepts integers."""
        # When
        register_parsers(real_argument_parser)

        # Then
        parser = real_argument_parser.choices['onboard']
        
        with pytest.raises(SystemExit):
            parser.parse_args(['--step', 'not_a_number'])

    def test_given_subparsers_when_register_parsers_then_onboard_has_both_arguments(
        self, real_argument_parser, mock_help_commands
    ):
        """Given subparsers, when register_parsers is called, then onboard accepts both arguments together."""
        # When
        register_parsers(real_argument_parser)

        # Then
        parser = real_argument_parser.choices['onboard']
        args = parser.parse_args(['--step', '5', '--reset'])
        assert args.step == 5
        assert args.reset is True

    def test_given_subparsers_when_register_parsers_then_explain_parser_configured(
        self, real_argument_parser, mock_help_commands
    ):
        """Given subparsers, when register_parsers is called, then explain parser has required command argument."""
        # When
        register_parsers(real_argument_parser)

        # Then
        parser = real_argument_parser.choices['explain']
        args = parser.parse_args(['test_command'])
        assert args.command == 'test_command'

    def test_given_subparsers_when_register_parsers_then_explain_requires_command_argument(
        self, real_argument_parser, mock_help_commands
    ):
        """Given subparsers, when register_parsers is called, then explain requires command argument."""
        # When
        register_parsers(real_argument_parser)

        # Then
        parser = real_argument_parser.choices['explain']
        
        with pytest.raises(SystemExit):
            parser.parse_args([])

    def test_given_subparsers_when_register_parsers_then_achievements_parser_configured(
        self, mock_subparsers, mock_help_commands
    ):
        """Given subparsers, when register_parsers is called, then achievements parser is configured."""
        # When
        register_parsers(mock_subparsers)

        # Then
        mock_subparsers.add_parser.assert_any_call('achievements', help='Show user progress')

    def test_given_subparsers_when_register_parsers_then_version_sets_correct_default_func(
        self, mock_subparsers, mock_help_commands
    ):
        """Given subparsers, when register_parsers is called, then version parser has correct default function."""
        # When
        register_parsers(mock_subparsers)

        # Then
        parser_mock = mock_subparsers.add_parser.return_value
        calls = [call for call in parser_mock.set_defaults.call_args_list 
                if 'func' in str(call)]
        assert len(calls) >= 1

    def test_given_subparsers_when_register_parsers_then_cheatsheet_sets_correct_default_func(
        self, real_argument_parser, mock_help_commands
    ):
        """Given subparsers, when register_parsers is called, then cheatsheet has correct default function."""
        # When
        register_parsers(real_argument_parser)

        # Then
        parser = real_argument_parser.choices['cheatsheet']
        args = parser.parse_args([])
        assert hasattr(args, 'func')
        assert args.func == mock_help_commands.cmd_cheatsheet

    def test_given_subparsers_when_register_parsers_then_onboard_sets_correct_default_func(
        self, real_argument_parser, mock_help_commands
    ):
        """Given subparsers, when register_parsers is called, then onboard has correct default function."""
        # When
        register_parsers(real_argument_parser)

        # Then
        parser = real_argument_parser.choices['onboard']
        args = parser.parse_args([])
        assert hasattr(args, 'func')
        assert args.func == mock_help_commands.cmd_onboard

    def test_given_subparsers_when_register_parsers_then_explain_sets_correct_default_func(
        self, real_argument_parser, mock_help_commands
    ):
        """Given subparsers, when register_parsers is called, then explain has correct default function."""
        # When
        register_parsers(real_argument_parser)

        # Then
        parser = real_argument_parser.choices['explain']
        args = parser.parse_args(['test'])
        assert hasattr(args, 'func')
        assert args.func == mock_help_commands.cmd_explain

    def test_given_subparsers_when_register_parsers_then_achievements_sets_correct_default_func(
        self, real_argument_parser, mock_help_commands
    ):
        """Given subparsers, when register_parsers is called, then achievements has correct default function."""
        # When
        register_parsers(real_argument_parser)

        # Then
        parser = real_argument_parser.choices['achievements']
        args = parser.parse_args([])
        assert hasattr(args, 'func')
        assert args.func == mock_help_commands.cmd_achievements

    def test_given_subparsers_when_register_parsers_then_all_parsers_have_help_text(
        self, real_argument_parser, mock_help_commands
    ):
        """Given subparsers, when register_parsers is called, then all parsers have help descriptions."""
        # When
        register_parsers(real_argument_parser)

        # Then
        expected_help = {
            'version': 'Display version information',
            'cheatsheet': 'Quick reference guide',
            'onboard': 'Interactive tutorial',
            'explain': 'Explain a command in detail',
            'achievements': 'Show user progress'
        }
        
        for command, help_text in expected_help.items():
            parser = real_argument_parser.choices[command]
            assert parser.description or help_text

    def test_given_subparsers_when_register_parsers_then_cheatsheet_category_accepts_any_string(
        self, real_argument_parser, mock_help_commands
    ):
        """Given subparsers, when register_parsers is called, then cheatsheet --category accepts any string."""
        # When
        register_parsers(real_argument_parser)

        # Then
        parser = real_argument_parser.choices['cheatsheet']
        
        test_categories = ['basics', 'advanced', 'custom-category', 'category_with_underscore', '123']
        for category in test_categories:
            args = parser.parse_args(['--category', category])
            assert args.category == category

    def test_given_subparsers_when_register_parsers_then_explain_command_accepts_any_string(
        self, real_argument_parser, mock_help_commands
    ):
        """Given subparsers, when register_parsers is called, then explain command accepts any string."""
        # When
        register_parsers(real_argument_parser)

        # Then
        parser = real_argument_parser.choices['explain']
        
        test_commands = ['version', 'complex-command', 'command_123', 'a', 'VeRyCaMeLcAsE']
        for command in test_commands:
            args = parser.parse_args([command])
            assert args.command == command

    def test_given_subparsers_when_register_parsers_then_onboard_step_accepts_negative_integers(
        self, real_argument_parser, mock_help_commands
    ):
        """Given subparsers, when register_parsers is called, then onboard --step accepts negative integers."""
        # When
        register_parsers(real_argument_parser)

        # Then
        parser = real_argument_parser.choices['onboard']
        args = parser.parse_args(['--step', '-5'])
        assert args.step == -5

    def test_given_subparsers_when_register_parsers_then_onboard_step_accepts_zero(
        self, real_argument_parser, mock_help_commands
    ):
        """Given subparsers, when register_parsers is called, then onboard --step accepts zero."""
        # When
        register_parsers(real_argument_parser)

        # Then
        parser = real_argument_parser.choices['onboard']
        args = parser.parse_args(['--step', '0'])
        assert args.step == 0

    def test_given_subparsers_when_register_parsers_then_cheatsheet_defaults_are_correct(
        self, real_argument_parser, mock_help_commands
    ):
        """Given subparsers, when register_parsers is called, then cheatsheet has correct default values."""
        # When
        register_parsers(real_argument_parser)

        # Then
        parser = real_argument_parser.choices['cheatsheet']
        args = parser.parse_args([])
        assert args.category is None
        assert args.compact is False

    def test_given_subparsers_when_register_parsers_then_onboard_defaults_are_correct(
        self, real_argument_parser, mock_help_commands
    ):
        """Given subparsers, when register_parsers is called, then onboard has correct default values."""
        # When
        register_parsers(real_argument_parser)

        # Then
        parser = real_argument_parser.choices['onboard']
        args = parser.parse_args([])
        assert args.step is None
        assert args.reset is False

    def test_given_subparsers_when_register_parsers_then_achievements_has_no_arguments(
        self, real_argument_parser, mock_help_commands
    ):
        """Given subparsers, when register_parsers is called, then achievements parser has no arguments."""
        # When
        register_parsers(real_argument_parser)

        # Then
        parser = real_argument_parser.choices['achievements']
        args = parser.parse_args([])
        assert hasattr(args, 'func')

    def test_given_subparsers_when_register_parsers_then_version_has_no_arguments(
        self, real_argument_parser, mock_help_commands
    ):
        """Given subparsers, when register_parsers is called, then version parser has no arguments."""
        # When
        register_parsers(real_argument_parser)

        # Then
        parser = real_argument_parser.choices['version']
        args