"""Behavioral tests for cli.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import argparse
import json
import sys
from io import StringIO
from unittest.mock import MagicMock, Mock, patch

import pytest

from empathy_os.workflows.progressive.cli import (
    cmd_analytics,
    cmd_cleanup,
    cmd_list_results,
    cmd_show_report,
)


@pytest.fixture
def mock_storage_path(tmp_path):
    """Fixture providing a temporary storage path."""
    return str(tmp_path / "test_storage")


@pytest.fixture
def sample_results():
    """Fixture providing sample result data."""
    return [
        {
            "task_id": "task_001_abc123",
            "workflow": "progressive_test",
            "total_cost": 1.25,
            "cost_savings_percent": 35.5,
            "success": True,
        },
        {
            "task_id": "task_002_def456",
            "workflow": "another_workflow",
            "total_cost": 0.75,
            "cost_savings_percent": 12.3,
            "success": False,
        },
        {
            "task_id": "task_003_ghi789",
            "workflow": "very_long_workflow_name_that_exceeds_limit",
            "total_cost": 2.50,
            "cost_savings_percent": 0.0,
            "success": True,
        },
    ]


@pytest.fixture
def sample_result_data():
    """Fixture providing detailed result data for a single task."""
    return {
        "task_id": "task_001_abc123",
        "workflow": "progressive_test",
        "total_cost": 1.25,
        "cost_savings_percent": 35.5,
        "success": True,
        "report": "Detailed execution report with cost analysis and performance metrics.",
    }


@pytest.fixture
def sample_analytics():
    """Fixture providing sample analytics data."""
    return {
        "total_runs": 10,
        "successful_runs": 8,
        "failed_runs": 2,
        "total_cost": 15.50,
        "average_cost": 1.55,
        "total_savings_percent": 25.5,
        "workflow_stats": {
            "progressive_test": {"runs": 5, "avg_cost": 1.20},
            "another_workflow": {"runs": 5, "avg_cost": 1.90},
        },
    }


class TestCmdListResults:
    """Behavioral tests for cmd_list_results function."""

    def test_given_no_results_when_list_called_then_displays_empty_message(
        self, capsys, mock_storage_path
    ):
        """Given no saved results exist,
        When cmd_list_results is called,
        Then it displays a message indicating no results found."""
        # Given
        args = argparse.Namespace(storage_path=mock_storage_path)

        with patch(
            "empathy_os.workflows.progressive.cli.list_saved_results", return_value=[]
        ):
            # When
            exit_code = cmd_list_results(args)

            # Then
            captured = capsys.readouterr()
            assert exit_code == 0
            assert f"No results found in {mock_storage_path}" in captured.out

    def test_given_multiple_results_when_list_called_then_displays_formatted_table(
        self, capsys, mock_storage_path, sample_results
    ):
        """Given multiple saved results exist,
        When cmd_list_results is called,
        Then it displays a formatted table with all results."""
        # Given
        args = argparse.Namespace(storage_path=mock_storage_path)

        with patch(
            "empathy_os.workflows.progressive.cli.list_saved_results",
            return_value=sample_results,
        ):
            # When
            exit_code = cmd_list_results(args)

            # Then
            captured = capsys.readouterr()
            assert exit_code == 0
            assert "Found 3 progressive workflow results" in captured.out
            assert "task_001_abc123" in captured.out
            assert "task_002_def456" in captured.out
            assert "task_003_ghi789" in captured.out
            assert "$1.25" in captured.out
            assert "$0.75" in captured.out
            assert "$2.50" in captured.out
            assert "35.5%" in captured.out
            assert "✅" in captured.out
            assert "❌" in captured.out

    def test_given_no_storage_path_when_list_called_then_uses_default_path(
        self, capsys
    ):
        """Given no storage path is provided,
        When cmd_list_results is called,
        Then it uses the default storage path."""
        # Given
        args = argparse.Namespace(storage_path=None)

        with patch(
            "empathy_os.workflows.progressive.cli.list_saved_results", return_value=[]
        ) as mock_list:
            # When
            exit_code = cmd_list_results(args)

            # Then
            assert exit_code == 0
            mock_list.assert_called_once_with(".empathy/progressive_runs")

    def test_given_result_with_missing_fields_when_list_called_then_uses_defaults(
        self, capsys, mock_storage_path
    ):
        """Given results with missing fields,
        When cmd_list_results is called,
        Then it uses default values for missing fields."""
        # Given
        incomplete_result = [{"task_id": "task_incomplete"}]
        args = argparse.Namespace(storage_path=mock_storage_path)

        with patch(
            "empathy_os.workflows.progressive.cli.list_saved_results",
            return_value=incomplete_result,
        ):
            # When
            exit_code = cmd_list_results(args)

            # Then
            captured = capsys.readouterr()
            assert exit_code == 0
            assert "task_incomplete" in captured.out
            assert "unknown" in captured.out
            assert "$0.00" in captured.out
            assert "❌" in captured.out

    def test_given_very_long_workflow_name_when_list_called_then_truncates_name(
        self, capsys, mock_storage_path, sample_results
    ):
        """Given a result with a very long workflow name,
        When cmd_list_results is called,
        Then it truncates the workflow name to fit the table."""
        # Given
        args = argparse.Namespace(storage_path=mock_storage_path)

        with patch(
            "empathy_os.workflows.progressive.cli.list_saved_results",
            return_value=[sample_results[2]],
        ):
            # When
            exit_code = cmd_list_results(args)

            # Then
            captured = capsys.readouterr()
            assert exit_code == 0
            # Workflow name should be truncated to 14 characters
            lines = captured.out.split("\n")
            data_line = [l for l in lines if "task_003_ghi789" in l][0]
            # Check that the workflow column doesn't contain the full name
            assert "very_long_workflow_name_that_exceeds_limit" not in data_line


class TestCmdShowReport:
    """Behavioral tests for cmd_show_report function."""

    def test_given_valid_task_id_when_show_report_called_then_displays_report(
        self, capsys, mock_storage_path, sample_result_data
    ):
        """Given a valid task ID exists,
        When cmd_show_report is called,
        Then it displays the detailed report."""
        # Given
        args = argparse.Namespace(
            task_id="task_001_abc123", storage_path=mock_storage_path, json=False
        )

        with patch(
            "empathy_os.workflows.progressive.cli.load_result_from_disk",
            return_value=sample_result_data,
        ):
            # When
            exit_code = cmd_show_report(args)

            # Then
            captured = capsys.readouterr()
            assert exit_code == 0
            assert sample_result_data["report"] in captured.out

    def test_given_valid_task_id_with_json_flag_when_show_report_called_then_displays_json(
        self, capsys, mock_storage_path, sample_result_data
    ):
        """Given a valid task ID and JSON flag,
        When cmd_show_report is called,
        Then it displays the result as JSON."""
        # Given
        args = argparse.Namespace(
            task_id="task_001_abc123", storage_path=mock_storage_path, json=True
        )

        with patch(
            "empathy_os.workflows.progressive.cli.load_result_from_disk",
            return_value=sample_result_data,
        ):
            # When
            exit_code = cmd_show_report(args)

            # Then
            captured = capsys.readouterr()
            assert exit_code == 0
            output_data = json.loads(captured.out)
            assert output_data == sample_result_data

    def test_given_nonexistent_task_id_when_show_report_called_then_returns_error(
        self, capsys, mock_storage_path
    ):
        """Given a nonexistent task ID,
        When cmd_show_report is called,
        Then it returns an error code and displays error message."""
        # Given
        args = argparse.Namespace(
            task_id="nonexistent_task", storage_path=mock_storage_path, json=False
        )

        with patch(
            "empathy_os.workflows.progressive.cli.load_result_from_disk",
            side_effect=FileNotFoundError("Task not found"),
        ):
            # When
            exit_code = cmd_show_report(args)

            # Then
            captured = capsys.readouterr()
            assert exit_code == 1
            assert "Error: Task not found" in captured.err

    def test_given_no_storage_path_when_show_report_called_then_uses_default_path(
        self, capsys, sample_result_data
    ):
        """Given no storage path is provided,
        When cmd_show_report is called,
        Then it uses the default storage path."""
        # Given
        args = argparse.Namespace(task_id="task_001", storage_path=None, json=False)

        with patch(
            "empathy_os.workflows.progressive.cli.load_result_from_disk",
            return_value=sample_result_data,
        ) as mock_load:
            # When
            exit_code = cmd_show_report(args)

            # Then
            assert exit_code == 0
            mock_load.assert_called_once_with("task_001", ".empathy/progressive_runs")

    def test_given_result_without_report_when_show_report_called_then_displays_no_report_message(
        self, capsys, mock_storage_path
    ):
        """Given a result without a report field,
        When cmd_show_report is called,
        Then it displays a message indicating no report found."""
        # Given
        result_without_report = {"task_id": "task_001", "success": True}
        args = argparse.Namespace(
            task_id="task_001", storage_path=mock_storage_path, json=False
        )

        with patch(
            "empathy_os.workflows.progressive.cli.load_result_from_disk",
            return_value=result_without_report,
        ):
            # When
            exit_code = cmd_show_report(args)

            # Then
            captured = capsys.readouterr()
            assert exit_code == 0
            assert "No report found for this task" in captured.out

    def test_given_result_with_empty_report_when_show_report_called_then_displays_no_report_message(
        self, capsys, mock_storage_path
    ):
        """Given a result with an empty report field,
        When cmd_show_report is called,
        Then it displays a message indicating no report found."""
        # Given
        result_with_empty_report = {"task_id": "task_001", "success": True, "report": ""}
        args = argparse.Namespace(
            task_id="task_001", storage_path=mock_storage_path, json=False
        )

        with patch(
            "empathy_os.workflows.progressive.cli.load_result_from_disk",
            return_value=result_with_empty_report,
        ):
            # When
            exit_code = cmd_show_report(args)

            # Then
            captured = capsys.readouterr()
            assert exit_code == 0
            assert "No report found for this task" in captured.out


class TestCmdAnalytics:
    """Behavioral tests for cmd_analytics function."""

    def test_given_analytics_data_when_analytics_called_then_displays_formatted_report(
        self, capsys, mock_storage_path, sample_analytics
    ):
        """Given analytics data exists,
        When cmd_analytics is called,
        Then it displays a formatted analytics report."""
        # Given
        args = argparse.Namespace(storage_path=mock_storage_path, json=False)
        formatted_report = "Analytics Report: 10 total runs, $15.50 total cost"

        with patch(
            "empathy_os.workflows.progressive.cli.generate_cost_analytics",
            return_value=sample_analytics,
        ), patch(
            "empathy_os.workflows.progressive.cli.format_cost_analytics_report",
            return_value=formatted_report,
        ):
            # When
            exit_code = cmd_analytics(args)

            # Then
            captured = capsys.readouterr()
            assert exit_code == 0
            assert formatted_report in captured.out

    def test_given_analytics_with_json_flag_when_analytics_called_then_displays_json(
        self, capsys, mock_storage_path, sample_analytics
    ):
        """Given analytics data and JSON flag,
        When cmd_analytics is called,
        Then it displays the analytics as JSON."""
        # Given
        args = argparse.Namespace(storage_path=mock_storage_path, json=True)

        with patch(
            "empathy_os.workflows.progressive.cli.generate_cost_analytics",
            return_value=sample_analytics,
        ):
            # When
            exit_code = cmd_analytics(args)

            # Then
            captured = capsys.readouterr()
            assert exit_code == 0
            output_data = json.loads(captured.out)
            assert output_data == sample_analytics

    def test_given_no_results_when_analytics_called_then_displays_no_results_message(
        self, capsys, mock_storage_path
    ):
        """Given no results exist,
        When cmd_analytics is called,
        Then it displays a message indicating no results found."""
        # Given
        args = argparse.Namespace(storage_path=mock_storage_path, json=False)
        empty_analytics = {"total_runs": 0}

        with patch(
            "empathy_os.workflows.progressive.cli.generate_cost_analytics",
            return_value=empty_analytics,
        ):
            # When
            exit_code = cmd_analytics(args)

            # Then
            captured = capsys.readouterr()
            assert exit_code == 0
            assert f"No results found in {mock_storage_path}" in captured.out

    def test_given_no_storage_path