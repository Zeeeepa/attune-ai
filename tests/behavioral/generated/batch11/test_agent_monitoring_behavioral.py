"""Behavioral tests for agent_monitoring.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import pytest
from datetime import datetime, timedelta
from unittest.mock import Mock, patch, MagicMock
from typing import Dict

from empathy_os.agent_monitoring import (
    AgentMetrics,
    TeamMetrics,
    AgentMonitor,
)
from empathy_os.pattern_library import PatternLibrary


# Fixtures

@pytest.fixture
def mock_pattern_library():
    """Provides a mocked PatternLibrary instance."""
    library = Mock(spec=PatternLibrary)
    library.get_pattern_count.return_value = 0
    library.get_all_patterns.return_value = []
    return library


@pytest.fixture
def agent_metrics():
    """Provides a fresh AgentMetrics instance."""
    return AgentMetrics(agent_id="agent-1")


@pytest.fixture
def populated_agent_metrics():
    """Provides an AgentMetrics instance with test data."""
    return AgentMetrics(
        agent_id="agent-1",
        total_interactions=10,
        total_response_time_ms=1000.0,
        patterns_discovered=5,
        patterns_used=8,
        successful_pattern_uses=6,
        failed_pattern_uses=2,
    )


@pytest.fixture
def team_metrics():
    """Provides a fresh TeamMetrics instance."""
    return TeamMetrics()


@pytest.fixture
def populated_team_metrics():
    """Provides a TeamMetrics instance with test data."""
    return TeamMetrics(
        active_agents=3,
        total_agents=5,
        shared_patterns=10,
        total_interactions=100,
        pattern_reuse_count=20,
        cross_agent_reuses=15,
    )


@pytest.fixture
def agent_monitor(mock_pattern_library):
    """Provides a fresh AgentMonitor instance."""
    return AgentMonitor(pattern_library=mock_pattern_library)


# AgentMetrics Tests

class TestAgentMetricsCreation:
    """Tests for AgentMetrics initialization and creation."""

    def test_given_agent_id_when_creating_metrics_then_initializes_with_defaults(self):
        """
        Given: An agent ID
        When: Creating an AgentMetrics instance
        Then: It initializes with default values
        """
        metrics = AgentMetrics(agent_id="test-agent")
        
        assert metrics.agent_id == "test-agent"
        assert metrics.total_interactions == 0
        assert metrics.total_response_time_ms == 0.0
        assert metrics.patterns_discovered == 0
        assert metrics.patterns_used == 0
        assert metrics.successful_pattern_uses == 0
        assert metrics.failed_pattern_uses == 0
        assert isinstance(metrics.first_seen, datetime)
        assert isinstance(metrics.last_active, datetime)

    def test_given_custom_values_when_creating_metrics_then_uses_provided_values(self):
        """
        Given: Custom metric values
        When: Creating an AgentMetrics instance with those values
        Then: It uses the provided values
        """
        first_seen = datetime(2025, 1, 1, 12, 0, 0)
        last_active = datetime(2025, 1, 2, 12, 0, 0)
        
        metrics = AgentMetrics(
            agent_id="custom-agent",
            total_interactions=100,
            total_response_time_ms=5000.0,
            patterns_discovered=10,
            patterns_used=20,
            successful_pattern_uses=15,
            failed_pattern_uses=5,
            first_seen=first_seen,
            last_active=last_active,
        )
        
        assert metrics.agent_id == "custom-agent"
        assert metrics.total_interactions == 100
        assert metrics.total_response_time_ms == 5000.0
        assert metrics.patterns_discovered == 10
        assert metrics.patterns_used == 20
        assert metrics.successful_pattern_uses == 15
        assert metrics.failed_pattern_uses == 5
        assert metrics.first_seen == first_seen
        assert metrics.last_active == last_active


class TestAgentMetricsAverageResponseTime:
    """Tests for AgentMetrics.avg_response_time_ms property."""

    def test_given_no_interactions_when_calculating_avg_response_time_then_returns_zero(
        self, agent_metrics
    ):
        """
        Given: An agent with no interactions
        When: Calculating average response time
        Then: Returns 0.0
        """
        assert agent_metrics.avg_response_time_ms == 0.0

    def test_given_interactions_when_calculating_avg_response_time_then_returns_average(
        self, populated_agent_metrics
    ):
        """
        Given: An agent with 10 interactions totaling 1000ms
        When: Calculating average response time
        Then: Returns 100.0
        """
        assert populated_agent_metrics.avg_response_time_ms == 100.0

    def test_given_single_interaction_when_calculating_avg_response_time_then_returns_total(self):
        """
        Given: An agent with one interaction
        When: Calculating average response time
        Then: Returns the total response time
        """
        metrics = AgentMetrics(
            agent_id="agent-1",
            total_interactions=1,
            total_response_time_ms=250.0,
        )
        
        assert metrics.avg_response_time_ms == 250.0


class TestAgentMetricsSuccessRate:
    """Tests for AgentMetrics.success_rate property."""

    def test_given_no_pattern_uses_when_calculating_success_rate_then_returns_zero(
        self, agent_metrics
    ):
        """
        Given: An agent with no pattern uses
        When: Calculating success rate
        Then: Returns 0.0
        """
        assert agent_metrics.success_rate == 0.0

    def test_given_pattern_uses_when_calculating_success_rate_then_returns_ratio(
        self, populated_agent_metrics
    ):
        """
        Given: An agent with 6 successful and 2 failed pattern uses
        When: Calculating success rate
        Then: Returns 0.75 (6/8)
        """
        assert populated_agent_metrics.success_rate == 0.75

    def test_given_all_successful_uses_when_calculating_success_rate_then_returns_one(self):
        """
        Given: An agent with all successful pattern uses
        When: Calculating success rate
        Then: Returns 1.0
        """
        metrics = AgentMetrics(
            agent_id="agent-1",
            successful_pattern_uses=10,
            failed_pattern_uses=0,
        )
        
        assert metrics.success_rate == 1.0

    def test_given_all_failed_uses_when_calculating_success_rate_then_returns_zero(self):
        """
        Given: An agent with all failed pattern uses
        When: Calculating success rate
        Then: Returns 0.0
        """
        metrics = AgentMetrics(
            agent_id="agent-1",
            successful_pattern_uses=0,
            failed_pattern_uses=10,
        )
        
        assert metrics.success_rate == 0.0


class TestAgentMetricsPatternContributionRate:
    """Tests for AgentMetrics.pattern_contribution_rate property."""

    def test_given_no_interactions_when_calculating_contribution_rate_then_returns_zero(
        self, agent_metrics
    ):
        """
        Given: An agent with no interactions
        When: Calculating pattern contribution rate
        Then: Returns 0.0
        """
        assert agent_metrics.pattern_contribution_rate == 0.0

    def test_given_interactions_when_calculating_contribution_rate_then_returns_ratio(
        self, populated_agent_metrics
    ):
        """
        Given: An agent with 5 patterns discovered in 10 interactions
        When: Calculating pattern contribution rate
        Then: Returns 0.5
        """
        assert populated_agent_metrics.pattern_contribution_rate == 0.5

    def test_given_more_patterns_than_interactions_when_calculating_rate_then_returns_value_above_one(
        self,
    ):
        """
        Given: An agent discovering multiple patterns per interaction
        When: Calculating pattern contribution rate
        Then: Returns value greater than 1.0
        """
        metrics = AgentMetrics(
            agent_id="agent-1",
            total_interactions=5,
            patterns_discovered=10,
        )
        
        assert metrics.pattern_contribution_rate == 2.0


# TeamMetrics Tests

class TestTeamMetricsCreation:
    """Tests for TeamMetrics initialization and creation."""

    def test_given_no_args_when_creating_team_metrics_then_initializes_with_defaults(self):
        """
        Given: No arguments
        When: Creating a TeamMetrics instance
        Then: It initializes with default zero values
        """
        metrics = TeamMetrics()
        
        assert metrics.active_agents == 0
        assert metrics.total_agents == 0
        assert metrics.shared_patterns == 0
        assert metrics.total_interactions == 0
        assert metrics.pattern_reuse_count == 0
        assert metrics.cross_agent_reuses == 0

    def test_given_custom_values_when_creating_team_metrics_then_uses_provided_values(self):
        """
        Given: Custom team metric values
        When: Creating a TeamMetrics instance
        Then: It uses the provided values
        """
        metrics = TeamMetrics(
            active_agents=5,
            total_agents=10,
            shared_patterns=20,
            total_interactions=100,
            pattern_reuse_count=30,
            cross_agent_reuses=25,
        )
        
        assert metrics.active_agents == 5
        assert metrics.total_agents == 10
        assert metrics.shared_patterns == 20
        assert metrics.total_interactions == 100
        assert metrics.pattern_reuse_count == 30
        assert metrics.cross_agent_reuses == 25


class TestTeamMetricsPatternReuseRate:
    """Tests for TeamMetrics.pattern_reuse_rate property."""

    def test_given_no_shared_patterns_when_calculating_reuse_rate_then_returns_zero(
        self, team_metrics
    ):
        """
        Given: A team with no shared patterns
        When: Calculating pattern reuse rate
        Then: Returns 0.0
        """
        assert team_metrics.pattern_reuse_rate == 0.0

    def test_given_shared_patterns_when_calculating_reuse_rate_then_returns_ratio(
        self, populated_team_metrics
    ):
        """
        Given: A team with 10 shared patterns and 20 reuses
        When: Calculating pattern reuse rate
        Then: Returns 2.0
        """
        assert populated_team_metrics.pattern_reuse_rate == 2.0

    def test_given_patterns_with_no_reuse_when_calculating_rate_then_returns_zero(self):
        """
        Given: Shared patterns that haven't been reused
        When: Calculating pattern reuse rate
        Then: Returns 0.0
        """
        metrics = TeamMetrics(
            shared_patterns=10,
            pattern_reuse_count=0,
        )
        
        assert metrics.pattern_reuse_rate == 0.0


class TestTeamMetricsCollaborationEfficiency:
    """Tests for TeamMetrics.collaboration_efficiency property."""

    def test_given_no_pattern_reuse_when_calculating_efficiency_then_returns_zero(
        self, team_metrics
    ):
        """
        Given: A team with no pattern reuse
        When: Calculating collaboration efficiency
        Then: Returns 0.0
        """
        assert team_metrics.collaboration_efficiency == 0.0

    def test_given_pattern_reuse_when_calculating_efficiency_then_returns_ratio(
        self, populated_team_metrics
    ):
        """
        Given: A team with 15 cross-agent reuses out of 20 total reuses
        When: Calculating collaboration efficiency
        Then: Returns 0.75
        """
        assert populated_team_metrics.collaboration_efficiency == 0.75

    def test_given_all_cross_agent_reuse_when_calculating_efficiency_then_returns_one(self):
        """
        Given: All pattern reuses are cross-agent
        When: Calculating collaboration efficiency
        Then: Returns 1.0
        """
        metrics = TeamMetrics(
            pattern_reuse_count=20,
            cross_agent_reuses=20,
        )
        
        assert metrics.collaboration_efficiency == 1.0

    def test_given_no_cross_agent_reuse_when_calculating_efficiency_then_returns_zero(self):
        """
        Given: No cross-agent pattern reuse
        When: Calculating collaboration efficiency
        Then: Returns 0.0
        """
        metrics = TeamMetrics(
            pattern_reuse_count=20,
            cross_agent_reuses=0,
        )
        
        assert metrics.collaboration_efficiency == 0.0


# AgentMonitor Tests

class TestAgentMonitorCreation:
    """Tests for AgentMonitor initialization."""

    def test_given_pattern_library_when_creating_monitor_then_initializes_successfully(
        self, mock_pattern_library
    ):
        """
        Given: A pattern library instance
        When: Creating an AgentMonitor
        Then: It initializes with empty metrics
        """
        monitor = AgentMonitor(pattern_library=mock_pattern_library)
        
        assert monitor.pattern_library == mock_pattern_library
        assert isinstance(monitor.agent_metrics, dict)
        assert len(monitor.agent_metrics) == 0

    def test_given_no_pattern_library_when_creating_monitor_then_raises_error(self):
        """
        Given: No pattern library provided
        When: Creating an AgentMonitor
        Then: It raises a TypeError
        """
        with pytest.raises(TypeError):
            AgentMonitor()


class TestAgentMonitorRecordInteraction:
    """Tests for AgentMonitor.record_interaction method."""

    def test_given_new_agent_when_recording_interaction_then_creates_agent_metrics(
        self, agent_monitor
    ):
        """
        Given: A new agent ID
        When: Recording an interaction
        Then: Creates metrics for that agent
        """
        agent_monitor.record_interaction(agent_id="agent-1", response_time_ms=100.0)
        
        assert "agent-1" in agent_monitor.agent_metrics
        metrics = agent_monitor.agent_metrics["agent-1"]
        assert metrics.agent_id == "agent-1"
        assert metrics.total_interactions == 1
        assert metrics.total_response_time_ms == 100.0

    def test_given_existing_agent_when_recording_interaction_then_updates_metrics(
        self, agent_monitor
    ):
        """
        Given: An existing agent with metrics
        When: Recording another interaction
        Then: Updates the existing metrics
        """
        agent_monitor.record_interaction(agent_id="agent-1", response_time_ms=100.0)
        agent_monitor.record_interaction(agent_id="agent-1", response_time_ms=200.0)
        
        metrics = agent_monitor.agent_metrics["agent-1"]
        assert metrics.total_interactions == 2
        assert metrics.total_response_time_ms == 300.0

    def test_given_multiple_agents_when_recording_interactions_then_tracks_separately(
        self, agent_