"""Behavioral tests for cli 2.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import argparse
import json
import sys
from io import StringIO
from unittest.mock import MagicMock, Mock, patch

import pytest

from empathy_os.workflows.progressive.cli_2 import (
    cmd_analytics,
    cmd_cleanup,
    cmd_list_results,
    cmd_show_report,
)


@pytest.fixture
def mock_storage_path():
    """Provide a standard test storage path."""
    return "/test/storage/path"


@pytest.fixture
def sample_result():
    """Provide a sample result dictionary."""
    return {
        "task_id": "task-123-abc-456",
        "workflow": "research_workflow",
        "total_cost": 1.23,
        "cost_savings_percent": 45.6,
        "success": True,
        "report": "# Test Report\n\nThis is a test report.",
    }


@pytest.fixture
def sample_results_list(sample_result):
    """Provide a list of sample results."""
    return [
        sample_result,
        {
            "task_id": "task-789-def-012",
            "workflow": "analysis_workflow",
            "total_cost": 2.45,
            "cost_savings_percent": 30.2,
            "success": False,
        },
        {
            "task_id": "task-345-ghi-678",
            "workflow": "very_long_workflow_name_that_exceeds_limit",
            "total_cost": 0.05,
            "cost_savings_percent": 78.9,
            "success": True,
        },
    ]


@pytest.fixture
def sample_analytics():
    """Provide sample analytics data."""
    return {
        "total_runs": 42,
        "successful_runs": 38,
        "failed_runs": 4,
        "total_cost": 125.50,
        "average_cost": 2.99,
        "total_savings": 45.2,
        "average_savings_percent": 52.3,
    }


class TestCmdListResults:
    """Test suite for cmd_list_results function."""

    def test_given_no_results_when_listing_then_shows_empty_message(
        self, mock_storage_path, capsys
    ):
        """Given no saved results exist,
        When listing results,
        Then display empty message and return success code.
        """
        # Given
        args = argparse.Namespace(storage_path=mock_storage_path)

        with patch(
            "empathy_os.workflows.progressive.cli_2.list_saved_results",
            return_value=[],
        ):
            # When
            exit_code = cmd_list_results(args)

            # Then
            assert exit_code == 0
            captured = capsys.readouterr()
            assert f"No results found in {mock_storage_path}" in captured.out

    def test_given_multiple_results_when_listing_then_displays_formatted_table(
        self, mock_storage_path, sample_results_list, capsys
    ):
        """Given multiple saved results exist,
        When listing results,
        Then display formatted table with all results.
        """
        # Given
        args = argparse.Namespace(storage_path=mock_storage_path)

        with patch(
            "empathy_os.workflows.progressive.cli_2.list_saved_results",
            return_value=sample_results_list,
        ):
            # When
            exit_code = cmd_list_results(args)

            # Then
            assert exit_code == 0
            captured = capsys.readouterr()
            assert "Found 3 progressive workflow results" in captured.out
            assert "task-123-abc-456" in captured.out
            assert "task-789-def-012" in captured.out
            assert "task-345-ghi-678" in captured.out
            assert "research_workfl" in captured.out
            assert "$1.23" in captured.out
            assert "45.6%" in captured.out
            assert "✅" in captured.out
            assert "❌" in captured.out

    def test_given_default_storage_path_when_listing_then_uses_default(
        self, capsys
    ):
        """Given no storage path specified,
        When listing results,
        Then use default storage path.
        """
        # Given
        args = argparse.Namespace(storage_path=None)
        expected_default = ".empathy/progressive_runs"

        with patch(
            "empathy_os.workflows.progressive.cli_2.list_saved_results",
            return_value=[],
        ) as mock_list:
            # When
            exit_code = cmd_list_results(args)

            # Then
            assert exit_code == 0
            mock_list.assert_called_once_with(expected_default)

    def test_given_result_with_missing_fields_when_listing_then_shows_defaults(
        self, mock_storage_path, capsys
    ):
        """Given result with missing fields,
        When listing results,
        Then display default values for missing fields.
        """
        # Given
        args = argparse.Namespace(storage_path=mock_storage_path)
        incomplete_result = {"task_id": "incomplete-task"}

        with patch(
            "empathy_os.workflows.progressive.cli_2.list_saved_results",
            return_value=[incomplete_result],
        ):
            # When
            exit_code = cmd_list_results(args)

            # Then
            assert exit_code == 0
            captured = capsys.readouterr()
            assert "incomplete-task" in captured.out
            assert "unknown" in captured.out
            assert "$0.00" in captured.out

    def test_given_long_workflow_name_when_listing_then_truncates_properly(
        self, mock_storage_path, capsys
    ):
        """Given result with long workflow name,
        When listing results,
        Then truncate workflow name to fit table format.
        """
        # Given
        args = argparse.Namespace(storage_path=mock_storage_path)
        result_with_long_name = {
            "task_id": "test-task",
            "workflow": "very_long_workflow_name_exceeding_column_width",
            "total_cost": 1.0,
            "cost_savings_percent": 10.0,
            "success": True,
        }

        with patch(
            "empathy_os.workflows.progressive.cli_2.list_saved_results",
            return_value=[result_with_long_name],
        ):
            # When
            exit_code = cmd_list_results(args)

            # Then
            assert exit_code == 0
            captured = capsys.readouterr()
            # Workflow should be truncated to 14 characters
            assert "very_long_work" in captured.out


class TestCmdShowReport:
    """Test suite for cmd_show_report function."""

    def test_given_valid_task_id_when_showing_report_then_displays_report(
        self, mock_storage_path, sample_result, capsys
    ):
        """Given valid task ID,
        When showing report,
        Then display the report content.
        """
        # Given
        args = argparse.Namespace(
            task_id="task-123-abc-456",
            storage_path=mock_storage_path,
            json=False,
        )

        with patch(
            "empathy_os.workflows.progressive.cli_2.load_result_from_disk",
            return_value=sample_result,
        ):
            # When
            exit_code = cmd_show_report(args)

            # Then
            assert exit_code == 0
            captured = capsys.readouterr()
            assert "# Test Report" in captured.out
            assert "This is a test report." in captured.out

    def test_given_json_flag_when_showing_report_then_outputs_json(
        self, mock_storage_path, sample_result, capsys
    ):
        """Given JSON output flag is set,
        When showing report,
        Then output result as JSON.
        """
        # Given
        args = argparse.Namespace(
            task_id="task-123-abc-456",
            storage_path=mock_storage_path,
            json=True,
        )

        with patch(
            "empathy_os.workflows.progressive.cli_2.load_result_from_disk",
            return_value=sample_result,
        ):
            # When
            exit_code = cmd_show_report(args)

            # Then
            assert exit_code == 0
            captured = capsys.readouterr()
            parsed_json = json.loads(captured.out)
            assert parsed_json["task_id"] == "task-123-abc-456"
            assert parsed_json["workflow"] == "research_workflow"

    def test_given_nonexistent_task_when_showing_report_then_returns_error(
        self, mock_storage_path, capsys
    ):
        """Given task ID does not exist,
        When showing report,
        Then return error code and display error message.
        """
        # Given
        args = argparse.Namespace(
            task_id="nonexistent-task",
            storage_path=mock_storage_path,
            json=False,
        )

        with patch(
            "empathy_os.workflows.progressive.cli_2.load_result_from_disk",
            side_effect=FileNotFoundError("Task not found"),
        ):
            # When
            exit_code = cmd_show_report(args)

            # Then
            assert exit_code == 1
            captured = capsys.readouterr()
            assert "Error: Task not found" in captured.err

    def test_given_result_without_report_when_showing_then_displays_message(
        self, mock_storage_path, capsys
    ):
        """Given result without report field,
        When showing report,
        Then display no report message.
        """
        # Given
        args = argparse.Namespace(
            task_id="task-no-report",
            storage_path=mock_storage_path,
            json=False,
        )
        result_without_report = {
            "task_id": "task-no-report",
            "workflow": "test",
        }

        with patch(
            "empathy_os.workflows.progressive.cli_2.load_result_from_disk",
            return_value=result_without_report,
        ):
            # When
            exit_code = cmd_show_report(args)

            # Then
            assert exit_code == 0
            captured = capsys.readouterr()
            assert "No report found for this task" in captured.out

    def test_given_default_storage_path_when_showing_report_then_uses_default(
        self, sample_result
    ):
        """Given no storage path specified,
        When showing report,
        Then use default storage path.
        """
        # Given
        args = argparse.Namespace(
            task_id="test-task",
            storage_path=None,
            json=False,
        )
        expected_default = ".empathy/progressive_runs"

        with patch(
            "empathy_os.workflows.progressive.cli_2.load_result_from_disk",
            return_value=sample_result,
        ) as mock_load:
            # When
            cmd_show_report(args)

            # Then
            mock_load.assert_called_once_with("test-task", expected_default)

    def test_given_empty_report_when_showing_then_displays_no_report_message(
        self, mock_storage_path, capsys
    ):
        """Given result with empty report string,
        When showing report,
        Then display no report message.
        """
        # Given
        args = argparse.Namespace(
            task_id="task-empty-report",
            storage_path=mock_storage_path,
            json=False,
        )
        result_with_empty_report = {
            "task_id": "task-empty-report",
            "report": "",
        }

        with patch(
            "empathy_os.workflows.progressive.cli_2.load_result_from_disk",
            return_value=result_with_empty_report,
        ):
            # When
            exit_code = cmd_show_report(args)

            # Then
            assert exit_code == 0
            captured = capsys.readouterr()
            assert "No report found for this task" in captured.out


class TestCmdAnalytics:
    """Test suite for cmd_analytics function."""

    def test_given_analytics_data_when_generating_report_then_displays_formatted_report(
        self, mock_storage_path, sample_analytics, capsys
    ):
        """Given analytics data exists,
        When generating analytics report,
        Then display formatted analytics report.
        """
        # Given
        args = argparse.Namespace(
            storage_path=mock_storage_path,
            json=False,
        )
        formatted_report = "Analytics Report:\nTotal Runs: 42\n"

        with patch(
            "empathy_os.workflows.progressive.cli_2.generate_cost_analytics",
            return_value=sample_analytics,
        ), patch(
            "empathy_os.workflows.progressive.cli_2.format_cost_analytics_report",
            return_value=formatted_report,
        ):
            # When
            exit_code = cmd_analytics(args)

            # Then
            assert exit_code == 0
            captured = capsys.readouterr()
            assert "Analytics Report:" in captured.out
            assert "Total Runs: 42" in captured.out

    def test_given_json_flag_when_generating_analytics_then_outputs_json(
        self, mock_storage_path, sample_analytics, capsys
    ):
        """Given JSON output flag is set,
        When generating analytics,
        Then output analytics as JSON.
        """
        # Given
        args = argparse.Namespace(
            storage_path=mock_storage_path,
            json=True,
        )

        with patch(
            "empathy_os.workflows.progressive.cli_2.generate_cost_analytics",
            return_value=sample_analytics,
        ):
            # When
            exit_code = cmd_analytics(args)

            # Then
            assert exit_code == 0
            captured = capsys.readouterr()
            parsed_json = json.loads(captured.out)
            assert parsed_json["total_runs"] == 42
            assert parsed_json["successful_runs"] == 38
            assert parsed_json["total_cost"] == 125.50

    def test_given_no_results_when_generating_analytics_then_shows_empty_message(
        self, mock_storage_path, capsys
    ):
        """Given no results exist,
        When generating analytics,
        Then display no results message.
        """
        # Given
        args = argparse.Namespace(
            storage_path=mock_storage_path,
            json=False,
        )
        empty_analytics = {
            "total_runs": 0,
            "successful_runs": 0,
            "failed_runs": 0,
        }

        with patch(
            "empathy_os.workflows.progressive.cli_2.generate_cost_analytics",
            return_value=empty_analytics,
        ):
            # When
            exit_code = cmd_analytics(args)

            # Then
            assert exit_code == 0
            captured = capsys.readouterr()
            assert f"No results found in {mock_storage_path}" in captured.out

    def test_given_default_storage_path_when_generating_analytics_then_uses_default(
        self, sample_analytics