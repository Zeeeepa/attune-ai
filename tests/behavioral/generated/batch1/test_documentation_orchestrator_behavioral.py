"""Behavioral tests for documentation_orchestrator.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import asyncio
from dataclasses import dataclass
from datetime import datetime
from pathlib import Path
from typing import Any
from unittest.mock import AsyncMock, MagicMock, Mock, patch

import pytest

from empathy_os.workflows.documentation_orchestrator import (
    DocumentationItem,
    DocumentationOrchestrator,
    OrchestratorResult,
)


# Fixtures


@pytest.fixture
def mock_project_index():
    """Given a mocked ProjectIndex."""
    with patch("empathy_os.workflows.documentation_orchestrator.ProjectIndex") as mock:
        instance = MagicMock()
        instance.root_path = Path("/test/project")
        instance.get_stale_docs.return_value = []
        instance.get_undocumented_files.return_value = []
        instance.update_documentation_status = MagicMock()
        mock.return_value = instance
        yield instance


@pytest.fixture
def mock_scout_crew():
    """Given a mocked ManageDocumentationCrew."""
    with patch(
        "empathy_os.workflows.documentation_orchestrator.ManageDocumentationCrew"
    ) as mock:
        instance = MagicMock()
        result = MagicMock()
        result.stale_docs = []
        result.missing_docs = []
        result.total_cost = 0.0
        result.duration_seconds = 1.0
        instance.run = AsyncMock(return_value=result)
        mock.return_value = instance
        yield mock


@pytest.fixture
def mock_writer_workflow():
    """Given a mocked DocumentGenerationWorkflow."""
    with patch(
        "empathy_os.workflows.documentation_orchestrator.DocumentGenerationWorkflow"
    ) as mock:
        instance = MagicMock()
        instance.generate_documentation = AsyncMock(
            return_value={
                "success": True,
                "output_path": "/test/docs/output.md",
                "cost": 0.05,
            }
        )
        mock.return_value = instance
        yield mock


@pytest.fixture
def sample_documentation_items():
    """Given sample documentation items."""
    return [
        DocumentationItem(
            file_path="src/module1.py",
            issue_type="stale_doc",
            severity="high",
            priority=1,
            details="Documentation is 30 days old",
            related_source=["src/module1.py"],
            days_stale=30,
            loc=150,
        ),
        DocumentationItem(
            file_path="src/module2.py",
            issue_type="missing_docstring",
            severity="medium",
            priority=2,
            details="Missing class docstring",
            related_source=["src/module2.py"],
            days_stale=0,
            loc=80,
        ),
        DocumentationItem(
            file_path="src/module3.py",
            issue_type="no_documentation",
            severity="low",
            priority=3,
            details="No documentation file",
            related_source=["src/module3.py"],
            days_stale=0,
            loc=50,
        ),
    ]


# DocumentationItem Tests


class TestDocumentationItem:
    """Behavioral tests for DocumentationItem dataclass."""

    def test_given_required_fields_when_created_then_instance_valid(self):
        """Given required fields when DocumentationItem created then instance is valid."""
        # Given
        file_path = "test.py"
        issue_type = "stale_doc"
        severity = "high"
        priority = 1

        # When
        item = DocumentationItem(
            file_path=file_path,
            issue_type=issue_type,
            severity=severity,
            priority=priority,
        )

        # Then
        assert item.file_path == file_path
        assert item.issue_type == issue_type
        assert item.severity == severity
        assert item.priority == priority
        assert item.details == ""
        assert item.related_source == []
        assert item.days_stale == 0
        assert item.loc == 0

    def test_given_all_fields_when_created_then_all_fields_set(self):
        """Given all fields when DocumentationItem created then all fields are set."""
        # Given/When
        item = DocumentationItem(
            file_path="src/test.py",
            issue_type="missing_docstring",
            severity="medium",
            priority=2,
            details="Missing function docs",
            related_source=["src/test.py", "src/utils.py"],
            days_stale=10,
            loc=200,
        )

        # Then
        assert item.file_path == "src/test.py"
        assert item.issue_type == "missing_docstring"
        assert item.severity == "medium"
        assert item.priority == 2
        assert item.details == "Missing function docs"
        assert item.related_source == ["src/test.py", "src/utils.py"]
        assert item.days_stale == 10
        assert item.loc == 200


# OrchestratorResult Tests


class TestOrchestratorResult:
    """Behavioral tests for OrchestratorResult dataclass."""

    def test_given_minimal_fields_when_created_then_defaults_set(self):
        """Given minimal fields when OrchestratorResult created then defaults are set."""
        # Given/When
        result = OrchestratorResult(success=True, phase="scout")

        # Then
        assert result.success is True
        assert result.phase == "scout"
        assert result.items_found == 0
        assert result.stale_docs == 0
        assert result.missing_docs == 0
        assert result.items_processed == 0
        assert result.docs_generated == []
        assert result.docs_updated == []
        assert result.docs_skipped == []
        assert result.total_cost == 0.0
        assert result.scout_cost == 0.0
        assert result.generation_cost == 0.0
        assert result.duration_seconds == 0.0
        assert result.errors == []
        assert result.metadata == {}

    def test_given_all_fields_when_created_then_all_fields_set(self):
        """Given all fields when OrchestratorResult created then all fields are set."""
        # Given/When
        result = OrchestratorResult(
            success=False,
            phase="generate",
            items_found=10,
            stale_docs=5,
            missing_docs=5,
            items_processed=3,
            docs_generated=["doc1.md"],
            docs_updated=["doc2.md"],
            docs_skipped=["doc3.md"],
            total_cost=1.5,
            scout_cost=0.5,
            generation_cost=1.0,
            duration_seconds=120.5,
            errors=["Error 1", "Error 2"],
            metadata={"key": "value"},
        )

        # Then
        assert result.success is False
        assert result.phase == "generate"
        assert result.items_found == 10
        assert result.stale_docs == 5
        assert result.missing_docs == 5
        assert result.items_processed == 3
        assert result.docs_generated == ["doc1.md"]
        assert result.docs_updated == ["doc2.md"]
        assert result.docs_skipped == ["doc3.md"]
        assert result.total_cost == 1.5
        assert result.scout_cost == 0.5
        assert result.generation_cost == 1.0
        assert result.duration_seconds == 120.5
        assert result.errors == ["Error 1", "Error 2"]
        assert result.metadata == {"key": "value"}


# DocumentationOrchestrator Tests


class TestDocumentationOrchestratorInit:
    """Behavioral tests for DocumentationOrchestrator initialization."""

    def test_given_valid_path_when_initialized_then_instance_created(
        self, mock_project_index
    ):
        """Given valid path when initialized then DocumentationOrchestrator instance created."""
        # Given
        project_path = Path("/test/project")

        # When
        orchestrator = DocumentationOrchestrator(project_path=project_path)

        # Then
        assert orchestrator.project_path == project_path
        assert orchestrator.max_items_per_run == 10
        assert orchestrator.dry_run is False
        assert orchestrator.enable_scout is True
        assert orchestrator.enable_writer is True

    def test_given_custom_config_when_initialized_then_config_applied(
        self, mock_project_index
    ):
        """Given custom config when initialized then configuration is applied."""
        # Given
        project_path = Path("/test/project")
        max_items = 5
        dry_run = True
        enable_scout = False

        # When
        orchestrator = DocumentationOrchestrator(
            project_path=project_path,
            max_items_per_run=max_items,
            dry_run=dry_run,
            enable_scout=enable_scout,
        )

        # Then
        assert orchestrator.max_items_per_run == max_items
        assert orchestrator.dry_run is dry_run
        assert orchestrator.enable_scout is enable_scout

    def test_given_string_path_when_initialized_then_converted_to_path(
        self, mock_project_index
    ):
        """Given string path when initialized then converted to Path object."""
        # Given
        project_path = "/test/project"

        # When
        orchestrator = DocumentationOrchestrator(project_path=project_path)

        # Then
        assert isinstance(orchestrator.project_path, Path)
        assert str(orchestrator.project_path) == project_path


class TestDocumentationOrchestratorScout:
    """Behavioral tests for DocumentationOrchestrator scout phase."""

    @pytest.mark.asyncio
    async def test_given_stale_docs_when_scout_runs_then_items_found(
        self, mock_project_index, mock_scout_crew
    ):
        """Given stale docs when scout runs then documentation items are found."""
        # Given
        orchestrator = DocumentationOrchestrator(project_path=Path("/test/project"))
        
        scout_result = MagicMock()
        scout_result.stale_docs = [
            {"file_path": "docs/test.md", "days_stale": 30, "related_source": ["src/test.py"]}
        ]
        scout_result.missing_docs = []
        scout_result.total_cost = 0.10
        scout_result.duration_seconds = 2.5
        
        mock_scout_crew.return_value.run = AsyncMock(return_value=scout_result)

        # When
        items = await orchestrator._run_scout_phase()

        # Then
        assert len(items) == 1
        assert items[0].file_path == "docs/test.md"
        assert items[0].issue_type == "stale_doc"
        assert items[0].days_stale == 30

    @pytest.mark.asyncio
    async def test_given_missing_docs_when_scout_runs_then_items_found(
        self, mock_project_index, mock_scout_crew
    ):
        """Given missing docs when scout runs then undocumented items are found."""
        # Given
        orchestrator = DocumentationOrchestrator(project_path=Path("/test/project"))
        
        scout_result = MagicMock()
        scout_result.stale_docs = []
        scout_result.missing_docs = [
            {"file_path": "src/new.py", "loc": 150, "priority": 1}
        ]
        scout_result.total_cost = 0.05
        scout_result.duration_seconds = 1.5
        
        mock_scout_crew.return_value.run = AsyncMock(return_value=scout_result)

        # When
        items = await orchestrator._run_scout_phase()

        # Then
        assert len(items) == 1
        assert items[0].file_path == "src/new.py"
        assert items[0].issue_type == "no_documentation"
        assert items[0].loc == 150

    @pytest.mark.asyncio
    async def test_given_scout_disabled_when_run_then_empty_list_returned(
        self, mock_project_index
    ):
        """Given scout disabled when run then empty list is returned."""
        # Given
        orchestrator = DocumentationOrchestrator(
            project_path=Path("/test/project"), enable_scout=False
        )

        # When
        items = await orchestrator._run_scout_phase()

        # Then
        assert items == []

    @pytest.mark.asyncio
    async def test_given_scout_error_when_run_then_exception_raised(
        self, mock_project_index, mock_scout_crew
    ):
        """Given scout error when run then exception is raised."""
        # Given
        orchestrator = DocumentationOrchestrator(project_path=Path("/test/project"))
        mock_scout_crew.return_value.run = AsyncMock(
            side_effect=Exception("Scout failed")
        )

        # When/Then
        with pytest.raises(Exception, match="Scout failed"):
            await orchestrator._run_scout_phase()


class TestDocumentationOrchestratorPrioritize:
    """Behavioral tests for DocumentationOrchestrator prioritization."""

    def test_given_items_when_prioritized_then_sorted_by_priority(
        self, sample_documentation_items, mock_project_index
    ):
        """Given items when prioritized then sorted by priority level."""
        # Given
        orchestrator = DocumentationOrchestrator(project_path=Path("/test/project"))

        # When
        prioritized = orchestrator._prioritize_items(sample_documentation_items)

        # Then
        assert len(prioritized) == 3
        assert prioritized[0].priority == 1
        assert prioritized[1].priority == 2
        assert prioritized[2].priority == 3

    def test_given_max_items_limit_when_prioritized_then_truncated(
        self, sample_documentation_items, mock_project_index
    ):
        """Given max items limit when prioritized then list is truncated."""
        # Given
        orchestrator = DocumentationOrchestrator(
            project_path=Path("/test/project"), max_items_per_run=2
        )

        # When
        prioritized = orchestrator._prioritize_items(sample_documentation_items)

        # Then
        assert len(prioritized) == 2
        assert prioritized[0].priority == 1
        assert prioritized[1].priority == 2

    def test_given_empty_list_when_prioritized_then_empty_returned(
        self, mock_project_index
    ):
        """Given empty list when prioritized then empty list returned."""
        # Given
        orchestrator = DocumentationOrchestrator(project_path=Path("/test/project"))

        # When
        prioritized = orchestrator._prioritize_items([])

        # Then
        assert prioritized == []

    def test_given_items_with_same_priority_when_prioritized_then_order_preserved(
        self, mock_project_index
    ):
        """Given items with same priority when prioritized then original order preserved."""
        # Given
        orchestrator = DocumentationOrchestrator(project_path=Path("/test/project"))
        items = [
            DocumentationItem("a.py", "stale_doc", "high", 1),
            DocumentationItem("b.py", "stale_doc", "high", 1),
            DocumentationItem("c.py