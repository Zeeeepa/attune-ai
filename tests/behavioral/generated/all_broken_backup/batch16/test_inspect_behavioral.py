"""Behavioral tests for inspect.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import argparse
from unittest.mock import MagicMock, call, patch

import pytest

from empathy_os.cli.parsers import inspect


@pytest.fixture
def mock_subparsers():
    """Create a mock ArgumentParser subparsers object.
    
    Returns:
        MagicMock: Mock subparsers with add_parser method
    """
    subparsers = MagicMock()
    mock_parser = MagicMock(spec=argparse.ArgumentParser)
    subparsers.add_parser.return_value = mock_parser
    return subparsers


@pytest.fixture
def real_subparsers():
    """Create a real ArgumentParser with subparsers for integration testing.
    
    Returns:
        ArgumentParser subparsers object
    """
    parser = argparse.ArgumentParser()
    return parser.add_subparsers()


class TestRegisterParsers:
    """Test suite for register_parsers function."""

    def test_given_subparsers_when_registering_then_all_commands_added(
        self, mock_subparsers
    ):
        """Given a subparsers object,
        When registering parsers,
        Then all expected commands are added.
        """
        # When
        inspect.register_parsers(mock_subparsers)

        # Then
        expected_commands = ["run", "inspect", "export", "import"]
        actual_calls = [call[0][0] for call in mock_subparsers.add_parser.call_args_list]
        
        assert mock_subparsers.add_parser.call_count == 4
        assert set(actual_calls) == set(expected_commands)

    def test_given_subparsers_when_registering_then_run_parser_configured(
        self, mock_subparsers
    ):
        """Given a subparsers object,
        When registering parsers,
        Then run parser is configured with correct arguments.
        """
        # Given
        mock_run_parser = MagicMock()
        mock_subparsers.add_parser.return_value = mock_run_parser

        # When
        inspect.register_parsers(mock_subparsers)

        # Then
        run_parser_call = mock_subparsers.add_parser.call_args_list[0]
        assert run_parser_call[0][0] == "run"
        assert "help" in run_parser_call[1]
        assert "Interactive REPL mode" in run_parser_call[1]["help"]

        # Verify arguments added
        arg_calls = mock_run_parser.add_argument.call_args_list
        arg_names = [call[0][0] for call in arg_calls]
        assert "--config" in arg_names or "-c" in [call[0][1] for call in arg_calls if len(call[0]) > 1]
        assert "--user-id" in arg_names
        assert "--level" in arg_names

    def test_given_subparsers_when_registering_then_run_parser_has_defaults(
        self, mock_subparsers
    ):
        """Given a subparsers object,
        When registering run parser,
        Then parser has correct default values and function.
        """
        # Given
        mock_run_parser = MagicMock()
        mock_subparsers.add_parser.return_value = mock_run_parser

        # When
        inspect.register_parsers(mock_subparsers)

        # Then - check level default
        level_call = None
        for call_args in mock_run_parser.add_argument.call_args_list:
            if "--level" in call_args[0]:
                level_call = call_args
                break
        
        assert level_call is not None
        assert level_call[1]["type"] == int
        assert level_call[1]["default"] == 4

        # Check func is set
        mock_run_parser.set_defaults.assert_called_once()
        assert "func" in mock_run_parser.set_defaults.call_args[1]

    def test_given_subparsers_when_registering_then_inspect_parser_configured(
        self, mock_subparsers
    ):
        """Given a subparsers object,
        When registering parsers,
        Then inspect parser is configured with correct arguments.
        """
        # Given
        mock_inspect_parser = MagicMock()
        
        def add_parser_side_effect(name, **kwargs):
            parser = MagicMock()
            if name == "inspect":
                return mock_inspect_parser
            return MagicMock()
        
        mock_subparsers.add_parser.side_effect = add_parser_side_effect

        # When
        inspect.register_parsers(mock_subparsers)

        # Then
        inspect_parser_calls = [
            call for call in mock_subparsers.add_parser.call_args_list
            if call[0][0] == "inspect"
        ]
        assert len(inspect_parser_calls) == 1
        assert "help" in inspect_parser_calls[0][1]

        # Verify positional argument with choices
        positional_calls = [
            call for call in mock_inspect_parser.add_argument.call_args_list
            if not call[0][0].startswith("-")
        ]
        assert len(positional_calls) == 1
        assert positional_calls[0][0][0] == "type"
        assert "choices" in positional_calls[0][1]
        assert set(positional_calls[0][1]["choices"]) == {"patterns", "metrics", "state"}

    def test_given_subparsers_when_registering_then_inspect_parser_has_optional_args(
        self, mock_subparsers
    ):
        """Given a subparsers object,
        When registering inspect parser,
        Then parser has correct optional arguments.
        """
        # Given
        mock_inspect_parser = MagicMock()
        
        def add_parser_side_effect(name, **kwargs):
            if name == "inspect":
                return mock_inspect_parser
            return MagicMock()
        
        mock_subparsers.add_parser.side_effect = add_parser_side_effect

        # When
        inspect.register_parsers(mock_subparsers)

        # Then
        arg_calls = mock_inspect_parser.add_argument.call_args_list
        optional_args = [call[0][0] for call in arg_calls if call[0][0].startswith("--")]
        
        assert "--user-id" in optional_args
        assert "--db" in optional_args
        assert "--state-dir" in optional_args

    def test_given_subparsers_when_registering_then_export_parser_configured(
        self, mock_subparsers
    ):
        """Given a subparsers object,
        When registering parsers,
        Then export parser is configured with correct arguments.
        """
        # Given
        mock_export_parser = MagicMock()
        
        def add_parser_side_effect(name, **kwargs):
            if name == "export":
                return mock_export_parser
            return MagicMock()
        
        mock_subparsers.add_parser.side_effect = add_parser_side_effect

        # When
        inspect.register_parsers(mock_subparsers)

        # Then
        export_parser_calls = [
            call for call in mock_subparsers.add_parser.call_args_list
            if call[0][0] == "export"
        ]
        assert len(export_parser_calls) == 1

        # Check positional argument
        positional_calls = [
            call for call in mock_export_parser.add_argument.call_args_list
            if not call[0][0].startswith("-")
        ]
        assert len(positional_calls) == 1
        assert positional_calls[0][0][0] == "output"

    def test_given_subparsers_when_registering_then_export_parser_has_format_choices(
        self, mock_subparsers
    ):
        """Given a subparsers object,
        When registering export parser,
        Then parser has format argument with correct choices.
        """
        # Given
        mock_export_parser = MagicMock()
        
        def add_parser_side_effect(name, **kwargs):
            if name == "export":
                return mock_export_parser
            return MagicMock()
        
        mock_subparsers.add_parser.side_effect = add_parser_side_effect

        # When
        inspect.register_parsers(mock_subparsers)

        # Then
        format_call = None
        for call_args in mock_export_parser.add_argument.call_args_list:
            if "--format" in call_args[0]:
                format_call = call_args
                break
        
        assert format_call is not None
        assert format_call[1]["default"] == "json"
        assert format_call[1]["choices"] == ["json"]

    def test_given_subparsers_when_registering_then_export_parser_has_optional_args(
        self, mock_subparsers
    ):
        """Given a subparsers object,
        When registering export parser,
        Then parser has correct optional arguments.
        """
        # Given
        mock_export_parser = MagicMock()
        
        def add_parser_side_effect(name, **kwargs):
            if name == "export":
                return mock_export_parser
            return MagicMock()
        
        mock_subparsers.add_parser.side_effect = add_parser_side_effect

        # When
        inspect.register_parsers(mock_subparsers)

        # Then
        arg_calls = mock_export_parser.add_argument.call_args_list
        optional_args = [call[0][0] for call in arg_calls if call[0][0].startswith("--")]
        
        assert "--user-id" in optional_args
        assert "--db" in optional_args
        assert "--format" in optional_args

    def test_given_subparsers_when_registering_then_import_parser_configured(
        self, mock_subparsers
    ):
        """Given a subparsers object,
        When registering parsers,
        Then import parser is configured with correct arguments.
        """
        # Given
        mock_import_parser = MagicMock()
        
        def add_parser_side_effect(name, **kwargs):
            if name == "import":
                return mock_import_parser
            return MagicMock()
        
        mock_subparsers.add_parser.side_effect = add_parser_side_effect

        # When
        inspect.register_parsers(mock_subparsers)

        # Then
        import_parser_calls = [
            call for call in mock_subparsers.add_parser.call_args_list
            if call[0][0] == "import"
        ]
        assert len(import_parser_calls) == 1

        # Check positional argument
        positional_calls = [
            call for call in mock_import_parser.add_argument.call_args_list
            if not call[0][0].startswith("-")
        ]
        assert len(positional_calls) == 1
        assert positional_calls[0][0][0] == "input"

    def test_given_subparsers_when_registering_then_import_parser_has_db_arg(
        self, mock_subparsers
    ):
        """Given a subparsers object,
        When registering import parser,
        Then parser has db optional argument.
        """
        # Given
        mock_import_parser = MagicMock()
        
        def add_parser_side_effect(name, **kwargs):
            if name == "import":
                return mock_import_parser
            return MagicMock()
        
        mock_subparsers.add_parser.side_effect = add_parser_side_effect

        # When
        inspect.register_parsers(mock_subparsers)

        # Then
        arg_calls = mock_import_parser.add_argument.call_args_list
        optional_args = [call[0][0] for call in arg_calls if call[0][0].startswith("--")]
        
        assert "--db" in optional_args

    def test_given_subparsers_when_registering_then_all_parsers_have_func_defaults(
        self, mock_subparsers
    ):
        """Given a subparsers object,
        When registering parsers,
        Then all parsers have func defaults set.
        """
        # Given
        parsers = {}
        
        def add_parser_side_effect(name, **kwargs):
            parser = MagicMock()
            parsers[name] = parser
            return parser
        
        mock_subparsers.add_parser.side_effect = add_parser_side_effect

        # When
        inspect.register_parsers(mock_subparsers)

        # Then
        for name, parser in parsers.items():
            parser.set_defaults.assert_called_once()
            call_kwargs = parser.set_defaults.call_args[1]
            assert "func" in call_kwargs
            assert callable(call_kwargs["func"])

    def test_given_real_parser_when_registering_then_parsers_work_correctly(
        self, real_subparsers
    ):
        """Given a real ArgumentParser,
        When registering parsers,
        Then parsers can be used successfully.
        """
        # When
        inspect.register_parsers(real_subparsers)

        # Then - verify it doesn't raise any exceptions
        # This is an integration test to ensure compatibility with real ArgumentParser

    def test_given_subparsers_when_registering_then_help_messages_are_descriptive(
        self, mock_subparsers
    ):
        """Given a subparsers object,
        When registering parsers,
        Then all help messages are descriptive.
        """
        # When
        inspect.register_parsers(mock_subparsers)

        # Then
        for call_args in mock_subparsers.add_parser.call_args_list:
            assert "help" in call_args[1]
            assert len(call_args[1]["help"]) > 0
            assert call_args[1]["help"] != ""

    def test_given_subparsers_when_registering_then_run_level_has_help_text(
        self, mock_subparsers
    ):
        """Given a subparsers object,
        When registering run parser with level argument,
        Then level argument has descriptive help text.
        """
        # Given
        mock_run_parser = MagicMock()
        mock_subparsers.add_parser.return_value = mock_run_parser

        # When
        inspect.register_parsers(mock_subparsers)

        # Then
        level_call = None
        for call_args in mock_run_parser.add_argument.call_args_list:
            if "--level" in call_args[0]:
                level_call = call_args
                break
        
        assert level_call is not None
        assert "help" in level_call[1]
        assert "1-5" in level_call[1]["help"]
        assert "default: 4" in level_call[1]["help"]

    def test_given_subparsers_when_registering_then_inspect_type_has_help_text(