"""Behavioral tests for config.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import os
from pathlib import Path
from unittest.mock import MagicMock, patch

import pytest

from empathy_os.hot_reload.config import HotReloadConfig, get_hot_reload_config


@pytest.fixture
def clean_environment(monkeypatch):
    """Clean environment variables before each test."""
    # Given: A clean environment with no hot-reload environment variables
    monkeypatch.delenv("HOT_RELOAD_ENABLED", raising=False)
    monkeypatch.delenv("HOT_RELOAD_WS_PATH", raising=False)
    monkeypatch.delenv("HOT_RELOAD_DELAY", raising=False)
    monkeypatch.delenv("HOT_RELOAD_WATCH_DIRS", raising=False)
    
    # Reset global config
    import empathy_os.hot_reload.config as config_module
    config_module._config = None


@pytest.fixture
def mock_file_structure(tmp_path):
    """Create a mock file structure for testing."""
    # Given: A temporary directory structure mimicking the project
    workflows = tmp_path / "workflows"
    workflows.mkdir()
    
    plugin_workflows = tmp_path / "empathy_software_plugin" / "workflows"
    plugin_workflows.mkdir(parents=True)
    
    toolkit_workflows = tmp_path / "empathy_llm_toolkit" / "workflows"
    toolkit_workflows.mkdir(parents=True)
    
    return {
        "root": tmp_path,
        "workflows": workflows,
        "plugin_workflows": plugin_workflows,
        "toolkit_workflows": toolkit_workflows,
    }


class TestHotReloadConfigInit:
    """Test cases for HotReloadConfig initialization."""

    def test_default_configuration_when_no_environment_variables_set(self, clean_environment):
        """Test that default configuration is used when no environment variables are set."""
        # Given: No environment variables are set (clean_environment)
        # When: Creating a new HotReloadConfig instance
        config = HotReloadConfig()
        
        # Then: Default values should be used
        assert config.enabled is False
        assert config.websocket_path == "/ws/hot-reload"
        assert config.reload_delay == 0.5
        assert isinstance(config.watch_dirs, list)

    def test_enabled_when_environment_variable_is_true(self, clean_environment, monkeypatch):
        """Test that hot-reload is enabled when environment variable is 'true'."""
        # Given: HOT_RELOAD_ENABLED environment variable is set to 'true'
        monkeypatch.setenv("HOT_RELOAD_ENABLED", "true")
        
        # When: Creating a new HotReloadConfig instance
        config = HotReloadConfig()
        
        # Then: Hot-reload should be enabled
        assert config.enabled is True

    def test_enabled_when_environment_variable_is_uppercase_true(self, clean_environment, monkeypatch):
        """Test that hot-reload is enabled when environment variable is 'TRUE'."""
        # Given: HOT_RELOAD_ENABLED environment variable is set to 'TRUE'
        monkeypatch.setenv("HOT_RELOAD_ENABLED", "TRUE")
        
        # When: Creating a new HotReloadConfig instance
        config = HotReloadConfig()
        
        # Then: Hot-reload should be enabled
        assert config.enabled is True

    def test_disabled_when_environment_variable_is_false(self, clean_environment, monkeypatch):
        """Test that hot-reload is disabled when environment variable is 'false'."""
        # Given: HOT_RELOAD_ENABLED environment variable is set to 'false'
        monkeypatch.setenv("HOT_RELOAD_ENABLED", "false")
        
        # When: Creating a new HotReloadConfig instance
        config = HotReloadConfig()
        
        # Then: Hot-reload should be disabled
        assert config.enabled is False

    def test_disabled_when_environment_variable_is_invalid(self, clean_environment, monkeypatch):
        """Test that hot-reload is disabled when environment variable has invalid value."""
        # Given: HOT_RELOAD_ENABLED environment variable is set to an invalid value
        monkeypatch.setenv("HOT_RELOAD_ENABLED", "invalid")
        
        # When: Creating a new HotReloadConfig instance
        config = HotReloadConfig()
        
        # Then: Hot-reload should be disabled
        assert config.enabled is False

    def test_custom_websocket_path_when_environment_variable_set(self, clean_environment, monkeypatch):
        """Test that custom websocket path is used when environment variable is set."""
        # Given: HOT_RELOAD_WS_PATH environment variable is set
        custom_path = "/custom/ws/path"
        monkeypatch.setenv("HOT_RELOAD_WS_PATH", custom_path)
        
        # When: Creating a new HotReloadConfig instance
        config = HotReloadConfig()
        
        # Then: Custom websocket path should be used
        assert config.websocket_path == custom_path

    def test_custom_reload_delay_when_environment_variable_set(self, clean_environment, monkeypatch):
        """Test that custom reload delay is used when environment variable is set."""
        # Given: HOT_RELOAD_DELAY environment variable is set
        custom_delay = "1.5"
        monkeypatch.setenv("HOT_RELOAD_DELAY", custom_delay)
        
        # When: Creating a new HotReloadConfig instance
        config = HotReloadConfig()
        
        # Then: Custom reload delay should be used
        assert config.reload_delay == 1.5

    def test_reload_delay_with_integer_string(self, clean_environment, monkeypatch):
        """Test that reload delay works with integer string value."""
        # Given: HOT_RELOAD_DELAY environment variable is set to integer string
        monkeypatch.setenv("HOT_RELOAD_DELAY", "2")
        
        # When: Creating a new HotReloadConfig instance
        config = HotReloadConfig()
        
        # Then: Reload delay should be converted to float
        assert config.reload_delay == 2.0


class TestHotReloadConfigGetWatchDirs:
    """Test cases for _get_watch_dirs method."""

    @patch.object(Path, "exists")
    @patch("empathy_os.hot_reload.config.Path")
    def test_returns_existing_default_directories(self, mock_path_class, mock_exists, clean_environment):
        """Test that only existing default directories are returned."""
        # Given: A project structure where some directories exist
        mock_parent = MagicMock()
        mock_parent.__truediv__ = lambda self, other: MagicMock(spec=Path, exists=lambda: True)
        
        mock_file = MagicMock()
        mock_file.parent.parent = mock_parent
        mock_path_class.return_value = mock_file
        mock_path_class.__file__ = __file__
        
        # Mock exists to return True for all paths
        mock_exists.return_value = True
        
        # When: Creating a new HotReloadConfig instance
        with patch("empathy_os.hot_reload.config.Path.__file__", __file__):
            config = HotReloadConfig()
        
        # Then: watch_dirs should be a list
        assert isinstance(config.watch_dirs, list)

    @patch.object(Path, "exists")
    @patch("empathy_os.hot_reload.config.Path")
    def test_filters_out_nonexistent_directories(self, mock_path_class, mock_exists, clean_environment):
        """Test that non-existent directories are filtered out."""
        # Given: A project structure where no directories exist
        mock_parent = MagicMock()
        
        def mock_truediv(self, other):
            path_mock = MagicMock(spec=Path)
            path_mock.exists = MagicMock(return_value=False)
            return path_mock
        
        mock_parent.__truediv__ = mock_truediv
        
        mock_file = MagicMock()
        mock_file.parent.parent = mock_parent
        mock_path_class.return_value = mock_file
        
        # When: Creating a new HotReloadConfig instance
        config = HotReloadConfig()
        
        # Then: watch_dirs should be empty or minimal
        assert isinstance(config.watch_dirs, list)

    def test_uses_environment_override_for_watch_directories(self, clean_environment, monkeypatch, tmp_path):
        """Test that environment variable overrides default watch directories."""
        # Given: HOT_RELOAD_WATCH_DIRS environment variable is set
        dir1 = tmp_path / "custom1"
        dir2 = tmp_path / "custom2"
        monkeypatch.setenv("HOT_RELOAD_WATCH_DIRS", f"{dir1},{dir2}")
        
        # When: Creating a new HotReloadConfig instance
        config = HotReloadConfig()
        
        # Then: Custom directories should be used
        assert len(config.watch_dirs) == 2
        assert config.watch_dirs[0] == dir1
        assert config.watch_dirs[1] == dir2

    def test_strips_whitespace_from_environment_watch_dirs(self, clean_environment, monkeypatch, tmp_path):
        """Test that whitespace is stripped from environment variable watch dirs."""
        # Given: HOT_RELOAD_WATCH_DIRS with spaces around paths
        dir1 = tmp_path / "custom1"
        dir2 = tmp_path / "custom2"
        monkeypatch.setenv("HOT_RELOAD_WATCH_DIRS", f" {dir1} , {dir2} ")
        
        # When: Creating a new HotReloadConfig instance
        config = HotReloadConfig()
        
        # Then: Paths should be stripped of whitespace
        assert len(config.watch_dirs) == 2
        assert config.watch_dirs[0] == dir1
        assert config.watch_dirs[1] == dir2

    def test_handles_single_directory_in_environment(self, clean_environment, monkeypatch, tmp_path):
        """Test that single directory in environment variable works correctly."""
        # Given: HOT_RELOAD_WATCH_DIRS with single directory
        dir1 = tmp_path / "single"
        monkeypatch.setenv("HOT_RELOAD_WATCH_DIRS", str(dir1))
        
        # When: Creating a new HotReloadConfig instance
        config = HotReloadConfig()
        
        # Then: Single directory should be in watch_dirs
        assert len(config.watch_dirs) == 1
        assert config.watch_dirs[0] == dir1


class TestHotReloadConfigToDict:
    """Test cases for to_dict method."""

    def test_converts_config_to_dictionary(self, clean_environment, monkeypatch):
        """Test that configuration is properly converted to dictionary."""
        # Given: A configured HotReloadConfig instance
        monkeypatch.setenv("HOT_RELOAD_ENABLED", "true")
        monkeypatch.setenv("HOT_RELOAD_WS_PATH", "/test/ws")
        monkeypatch.setenv("HOT_RELOAD_DELAY", "1.0")
        config = HotReloadConfig()
        
        # When: Converting to dictionary
        result = config.to_dict()
        
        # Then: Dictionary should contain all configuration values
        assert isinstance(result, dict)
        assert "enabled" in result
        assert "watch_dirs" in result
        assert "websocket_path" in result
        assert "reload_delay" in result
        assert result["enabled"] is True
        assert result["websocket_path"] == "/test/ws"
        assert result["reload_delay"] == 1.0

    def test_watch_dirs_converted_to_strings(self, clean_environment, monkeypatch, tmp_path):
        """Test that watch_dirs are converted to strings in dictionary."""
        # Given: A config with Path objects in watch_dirs
        dir1 = tmp_path / "test"
        monkeypatch.setenv("HOT_RELOAD_WATCH_DIRS", str(dir1))
        config = HotReloadConfig()
        
        # When: Converting to dictionary
        result = config.to_dict()
        
        # Then: watch_dirs should be list of strings
        assert isinstance(result["watch_dirs"], list)
        assert all(isinstance(d, str) for d in result["watch_dirs"])
        assert str(dir1) in result["watch_dirs"]

    def test_empty_watch_dirs_returns_empty_list(self, clean_environment):
        """Test that empty watch_dirs returns empty list in dictionary."""
        # Given: A config with no watch directories
        with patch.object(HotReloadConfig, "_get_watch_dirs", return_value=[]):
            config = HotReloadConfig()
        
        # When: Converting to dictionary
        result = config.to_dict()
        
        # Then: watch_dirs should be empty list
        assert result["watch_dirs"] == []

    def test_dictionary_contains_default_values(self, clean_environment):
        """Test that dictionary contains correct default values."""
        # Given: A config with default values
        config = HotReloadConfig()
        
        # When: Converting to dictionary
        result = config.to_dict()
        
        # Then: Default values should be present
        assert result["enabled"] is False
        assert result["websocket_path"] == "/ws/hot-reload"
        assert result["reload_delay"] == 0.5


class TestGetHotReloadConfig:
    """Test cases for get_hot_reload_config function."""

    def test_returns_singleton_instance(self, clean_environment):
        """Test that get_hot_reload_config returns the same instance."""
        # Given: No prior config instance
        # When: Calling get_hot_reload_config multiple times
        config1 = get_hot_reload_config()
        config2 = get_hot_reload_config()
        
        # Then: Should return the same instance
        assert config1 is config2

    def test_creates_new_instance_when_none_exists(self, clean_environment):
        """Test that a new instance is created when none exists."""
        # Given: No global config instance
        import empathy_os.hot_reload.config as config_module
        config_module._config = None
        
        # When: Calling get_hot_reload_config
        config = get_hot_reload_config()
        
        # Then: Should return a HotReloadConfig instance
        assert isinstance(config, HotReloadConfig)

    def test_returns_existing_instance_when_already_initialized(self, clean_environment):
        """Test that existing instance is returned when already initialized."""
        # Given: An existing global config instance
        existing_config = HotReloadConfig()
        import empathy_os.hot_reload.config as config_module
        config_module._config = existing_config
        
        # When: Calling get_hot_reload_config
        config = get_hot_reload_config()
        
        # Then: Should return the existing instance
        assert config is existing_config

    def test_config_persists_across_calls(self, clean_environment, monkeypatch):
        """Test that configuration persists across multiple calls."""
        # Given: Environment configured with specific values
        monkeypatch.setenv("HOT_RELOAD_ENABLED", "true")
        monkeypatch.setenv("HOT_RELOAD_DELAY", "2.5")
        
        # When: Getting config multiple times
        config1 = get_hot_reload_config