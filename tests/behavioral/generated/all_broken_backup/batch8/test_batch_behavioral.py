"""Behavioral tests for batch.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import json
import pytest
from pathlib import Path
from unittest.mock import Mock, MagicMock, patch, mock_open
from argparse import Namespace

from empathy_os.cli.commands.batch import (
    cmd_batch_submit,
    cmd_batch_status,
)


@pytest.fixture
def mock_api_key(monkeypatch):
    """Fixture to set ANTHROPIC_API_KEY environment variable."""
    monkeypatch.setenv("ANTHROPIC_API_KEY", "test-api-key-12345")
    return "test-api-key-12345"


@pytest.fixture
def mock_no_api_key(monkeypatch):
    """Fixture to unset ANTHROPIC_API_KEY environment variable."""
    monkeypatch.delenv("ANTHROPIC_API_KEY", raising=False)


@pytest.fixture
def sample_batch_requests():
    """Fixture providing sample batch request data."""
    return [
        {
            "task_id": "task_1",
            "task_type": "analyze_logs",
            "input_data": {"logs": "ERROR: Connection failed"},
            "model_tier": "capable"
        },
        {
            "task_id": "task_2",
            "task_type": "analyze_logs",
            "input_data": {"logs": "WARNING: High memory usage"},
            "model_tier": "capable"
        }
    ]


@pytest.fixture
def temp_input_file(tmp_path, sample_batch_requests):
    """Fixture to create a temporary input file with batch requests."""
    file_path = tmp_path / "batch_requests.json"
    with open(file_path, 'w') as f:
        json.dump(sample_batch_requests, f)
    return file_path


@pytest.fixture
def mock_batch_workflow():
    """Fixture providing a mocked BatchProcessingWorkflow."""
    with patch('empathy_os.cli.commands.batch.BatchProcessingWorkflow') as mock_workflow_class:
        mock_workflow = MagicMock()
        mock_workflow_class.return_value = mock_workflow
        yield mock_workflow


@pytest.fixture
def mock_batch_request():
    """Fixture providing a mocked batch request object."""
    mock_req = MagicMock()
    mock_req.task_id = "task_1"
    mock_req.task_type = "analyze_logs"
    return mock_req


class TestCmdBatchSubmit:
    """Behavioral tests for cmd_batch_submit function."""

    def test_submit_batch_with_valid_file_succeeds(
        self, mock_api_key, temp_input_file, mock_batch_workflow, capsys
    ):
        """
        Given: A valid input file with batch requests and API key set
        When: cmd_batch_submit is called
        Then: Batch is submitted successfully and batch ID is displayed
        """
        # Given
        args = Namespace(input_file=str(temp_input_file))
        mock_batch_workflow.load_requests_from_file.return_value = [
            Mock(task_id="task_1"),
            Mock(task_id="task_2")
        ]
        mock_batch_workflow.batch_provider.create_batch.return_value = "batch_xyz123"
        mock_batch_workflow._format_messages.return_value = [
            {"role": "user", "content": "test"}
        ]

        # When
        result = cmd_batch_submit(args)

        # Then
        assert result == 0
        captured = capsys.readouterr()
        assert "‚úÖ Batch submitted successfully!" in captured.out
        assert "batch_xyz123" in captured.out
        assert "Found 2 requests" in captured.out
        mock_batch_workflow.load_requests_from_file.assert_called_once_with(str(temp_input_file))
        mock_batch_workflow.batch_provider.create_batch.assert_called_once()

    def test_submit_batch_with_nonexistent_file_fails(self, mock_api_key, capsys):
        """
        Given: A path to a non-existent file
        When: cmd_batch_submit is called
        Then: Error message is displayed and function returns 1
        """
        # Given
        args = Namespace(input_file="/nonexistent/path/file.json")

        # When
        result = cmd_batch_submit(args)

        # Then
        assert result == 1
        captured = capsys.readouterr()
        assert "‚ùå Error: Input file not found" in captured.out

    def test_submit_batch_without_api_key_fails(
        self, mock_no_api_key, temp_input_file, capsys
    ):
        """
        Given: No ANTHROPIC_API_KEY environment variable set
        When: cmd_batch_submit is called
        Then: Error message about missing API key is displayed
        """
        # Given
        args = Namespace(input_file=str(temp_input_file))

        # When
        result = cmd_batch_submit(args)

        # Then
        assert result == 1
        captured = capsys.readouterr()
        assert "‚ùå Error: ANTHROPIC_API_KEY environment variable not set" in captured.out

    def test_submit_batch_with_workflow_exception_fails(
        self, mock_api_key, temp_input_file, mock_batch_workflow, capsys
    ):
        """
        Given: BatchProcessingWorkflow raises an exception during processing
        When: cmd_batch_submit is called
        Then: Error message is displayed and function returns 1
        """
        # Given
        args = Namespace(input_file=str(temp_input_file))
        mock_batch_workflow.load_requests_from_file.side_effect = Exception("Connection error")

        # When
        result = cmd_batch_submit(args)

        # Then
        assert result == 1
        captured = capsys.readouterr()
        assert "‚ùå Error: Connection error" in captured.out

    def test_submit_batch_creates_correct_batch_params(
        self, mock_api_key, temp_input_file, mock_batch_workflow
    ):
        """
        Given: Valid batch requests with specific task IDs
        When: cmd_batch_submit is called
        Then: create_batch is called with correctly formatted parameters
        """
        # Given
        args = Namespace(input_file=str(temp_input_file))
        mock_req1 = Mock(task_id="task_1")
        mock_req2 = Mock(task_id="task_2")
        mock_batch_workflow.load_requests_from_file.return_value = [mock_req1, mock_req2]
        mock_batch_workflow._format_messages.return_value = [
            {"role": "user", "content": "test"}
        ]
        mock_batch_workflow.batch_provider.create_batch.return_value = "batch_123"

        # When
        cmd_batch_submit(args)

        # Then
        call_args = mock_batch_workflow.batch_provider.create_batch.call_args[0][0]
        assert len(call_args) == 2
        assert call_args[0]["custom_id"] == "task_1"
        assert call_args[1]["custom_id"] == "task_2"
        assert call_args[0]["params"]["model"] == "claude-sonnet-4-5-20250929"
        assert call_args[0]["params"]["max_tokens"] == 4096

    def test_submit_batch_displays_monitoring_instructions(
        self, mock_api_key, temp_input_file, mock_batch_workflow, capsys
    ):
        """
        Given: Successful batch submission
        When: cmd_batch_submit completes
        Then: Instructions for monitoring and retrieving results are displayed
        """
        # Given
        args = Namespace(input_file=str(temp_input_file))
        mock_batch_workflow.load_requests_from_file.return_value = [Mock(task_id="task_1")]
        mock_batch_workflow.batch_provider.create_batch.return_value = "batch_xyz"
        mock_batch_workflow._format_messages.return_value = [{"role": "user", "content": "test"}]

        # When
        cmd_batch_submit(args)

        # Then
        captured = capsys.readouterr()
        assert "Monitor status with: empathy batch status batch_xyz" in captured.out
        assert "Retrieve results with: empathy batch results batch_xyz output.json" in captured.out
        assert "Or wait for completion: empathy batch wait batch_xyz" in captured.out

    def test_submit_batch_with_empty_file_succeeds(
        self, mock_api_key, tmp_path, mock_batch_workflow, capsys
    ):
        """
        Given: An input file with empty list of requests
        When: cmd_batch_submit is called
        Then: Batch is submitted with zero requests
        """
        # Given
        empty_file = tmp_path / "empty.json"
        with open(empty_file, 'w') as f:
            json.dump([], f)
        args = Namespace(input_file=str(empty_file))
        mock_batch_workflow.load_requests_from_file.return_value = []
        mock_batch_workflow.batch_provider.create_batch.return_value = "batch_empty"

        # When
        result = cmd_batch_submit(args)

        # Then
        assert result == 0
        captured = capsys.readouterr()
        assert "Found 0 requests" in captured.out

    def test_submit_batch_with_invalid_json_fails(
        self, mock_api_key, tmp_path, mock_batch_workflow, capsys
    ):
        """
        Given: An input file with invalid JSON
        When: cmd_batch_submit is called
        Then: Error is displayed and function returns 1
        """
        # Given
        invalid_file = tmp_path / "invalid.json"
        with open(invalid_file, 'w') as f:
            f.write("{ invalid json }")
        args = Namespace(input_file=str(invalid_file))
        mock_batch_workflow.load_requests_from_file.side_effect = json.JSONDecodeError(
            "Invalid", "", 0
        )

        # When
        result = cmd_batch_submit(args)

        # Then
        assert result == 1
        captured = capsys.readouterr()
        assert "‚ùå Error:" in captured.out


class TestCmdBatchStatus:
    """Behavioral tests for cmd_batch_status function."""

    def test_check_status_with_valid_batch_id_succeeds(
        self, mock_api_key, mock_batch_workflow, capsys
    ):
        """
        Given: A valid batch ID and API key
        When: cmd_batch_status is called
        Then: Status information is retrieved and displayed
        """
        # Given
        args = Namespace(batch_id="batch_xyz123")
        mock_batch_workflow.batch_provider.get_batch_status.return_value = {
            "status": "processing",
            "total": 100,
            "completed": 50
        }

        # When
        with patch('empathy_os.cli.commands.batch.BatchProcessingWorkflow') as mock_class:
            mock_class.return_value = mock_batch_workflow
            result = cmd_batch_status(args)

        # Then
        assert result == 0
        captured = capsys.readouterr()
        assert "üîç Checking status for batch batch_xyz123" in captured.out

    def test_check_status_without_api_key_fails(self, mock_no_api_key, capsys):
        """
        Given: No ANTHROPIC_API_KEY environment variable set
        When: cmd_batch_status is called
        Then: Error message about missing API key is displayed
        """
        # Given
        args = Namespace(batch_id="batch_xyz123")

        # When
        result = cmd_batch_status(args)

        # Then
        assert result == 1
        captured = capsys.readouterr()
        assert "‚ùå Error: ANTHROPIC_API_KEY environment variable not set" in captured.out

    def test_check_status_with_workflow_exception_fails(
        self, mock_api_key, mock_batch_workflow, capsys
    ):
        """
        Given: BatchProcessingWorkflow raises an exception
        When: cmd_batch_status is called
        Then: Error message is displayed and function returns 1
        """
        # Given
        args = Namespace(batch_id="batch_xyz123")

        # When
        with patch('empathy_os.cli.commands.batch.BatchProcessingWorkflow') as mock_class:
            mock_class.side_effect = Exception("API connection failed")
            result = cmd_batch_status(args)

        # Then
        assert result == 1
        captured = capsys.readouterr()
        assert "‚ùå Error:" in captured.out

    def test_check_status_displays_batch_id(self, mock_api_key, mock_batch_workflow, capsys):
        """
        Given: A specific batch ID
        When: cmd_batch_status is called
        Then: The batch ID is displayed in the output
        """
        # Given
        batch_id = "batch_test_12345"
        args = Namespace(batch_id=batch_id)

        # When
        with patch('empathy_os.cli.commands.batch.BatchProcessingWorkflow') as mock_class:
            mock_class.return_value = mock_batch_workflow
            mock_batch_workflow.batch_provider.get_batch_status.return_value = {
                "status": "completed"
            }
            cmd_batch_status(args)

        # Then
        captured = capsys.readouterr()
        assert batch_id in captured.out

    def test_check_status_with_empty_batch_id_attempts_check(
        self, mock_api_key, mock_batch_workflow, capsys
    ):
        """
        Given: An empty batch ID string
        When: cmd_batch_status is called
        Then: Function attempts to check status with empty ID
        """
        # Given
        args = Namespace(batch_id="")

        # When
        with patch('empathy_os.cli.commands.batch.BatchProcessingWorkflow') as mock_class:
            mock_class.return_value = mock_batch_workflow
            result = cmd_batch_status(args)

        # Then
        captured = capsys.readouterr()
        assert "üîç Checking status for batch" in captured.out

    def test_check_status_with_special_characters_in_batch_id(
        self, mock_api_key, mock_batch_workflow, capsys
    ):
        """
        Given: A batch ID with special characters
        When: cmd_batch_status is called
        Then: The batch ID is used as-is
        """
        # Given
        batch_id = "batch-123_abc!@#"
        args = Namespace(batch_id=batch_id)

        # When
        with patch('empathy_os.cli.commands.batch.BatchProcessingWorkflow') as mock_class:
            mock_class.return_value = mock_batch_workflow
            mock_batch_workflow.batch_provider.get_batch_status.return_value = {
                "status": "processing"
            }
            cmd_batch_status(args)

        # Then
        captured = capsys.readouterr()
        assert batch_id in captured.out


class TestIntegration:
    """Integration tests for batch command workflow."""

    def test_full_batch_workflow_simulation(
        self, mock_api_key, temp_input_file, mock_batch_workflow, capsys