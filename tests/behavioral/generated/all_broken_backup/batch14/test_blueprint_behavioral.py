"""Behavioral tests for blueprint.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

from __future__ import annotations

import json
import uuid
from typing import Any

import pytest

from empathy_os.socratic.blueprint import (
    AgentBlueprint,
    AgentRole,
    ToolCategory,
    ToolSpec,
    WorkflowBlueprint,
    WorkflowStep,
)


# Fixtures


@pytest.fixture
def basic_tool_spec() -> ToolSpec:
    """Given a basic tool specification."""
    return ToolSpec(
        id="test_tool",
        name="Test Tool",
        category=ToolCategory.CODE_ANALYSIS,
        description="A test tool for analysis",
        parameters={
            "pattern": {"type": "string", "required": True},
            "depth": {"type": "integer", "required": False, "default": 1},
        },
    )


@pytest.fixture
def minimal_tool_spec() -> ToolSpec:
    """Given a minimal tool specification without parameters."""
    return ToolSpec(
        id="minimal_tool",
        name="Minimal Tool",
        category=ToolCategory.FILESYSTEM,
        description="Minimal tool with no parameters",
    )


@pytest.fixture
def basic_agent_blueprint(basic_tool_spec: ToolSpec) -> AgentBlueprint:
    """Given a basic agent blueprint."""
    return AgentBlueprint(
        name="TestAgent",
        role=AgentRole.ANALYZER,
        description="Test agent for analysis",
        objective="Analyze test code",
        tools=[basic_tool_spec],
        capabilities=["pattern_matching", "code_review"],
        constraints=["max_file_size: 1MB", "timeout: 30s"],
    )


@pytest.fixture
def minimal_agent_blueprint() -> AgentBlueprint:
    """Given a minimal agent blueprint without tools."""
    return AgentBlueprint(
        name="MinimalAgent",
        role=AgentRole.ASSISTANT,
        description="Minimal test agent",
        objective="Assist with tasks",
    )


@pytest.fixture
def workflow_step() -> WorkflowStep:
    """Given a basic workflow step."""
    return WorkflowStep(
        agent_name="TestAgent",
        action="analyze_code",
        inputs={"file_path": "${input.file_path}"},
        outputs={"analysis_result": "result"},
    )


@pytest.fixture
def basic_workflow_blueprint(
    basic_agent_blueprint: AgentBlueprint, workflow_step: WorkflowStep
) -> WorkflowBlueprint:
    """Given a basic workflow blueprint."""
    return WorkflowBlueprint(
        name="TestWorkflow",
        description="Test workflow for code analysis",
        objective="Analyze and report on code quality",
        agents=[basic_agent_blueprint],
        steps=[workflow_step],
        inputs={"file_path": {"type": "string", "required": True}},
        outputs={"report": {"type": "object"}},
    )


# ToolSpec Tests


class TestToolSpecCreation:
    """Tests for ToolSpec creation and initialization."""

    def test_given_valid_parameters_when_creating_toolspec_then_all_fields_set(
        self, basic_tool_spec: ToolSpec
    ):
        """Given valid parameters, when creating ToolSpec, then all fields are set correctly."""
        # Then
        assert basic_tool_spec.id == "test_tool"
        assert basic_tool_spec.name == "Test Tool"
        assert basic_tool_spec.category == ToolCategory.CODE_ANALYSIS
        assert basic_tool_spec.description == "A test tool for analysis"
        assert "pattern" in basic_tool_spec.parameters
        assert basic_tool_spec.parameters["pattern"]["required"] is True

    def test_given_no_parameters_when_creating_toolspec_then_parameters_default_empty(
        self, minimal_tool_spec: ToolSpec
    ):
        """Given no parameters, when creating ToolSpec, then parameters default to empty dict."""
        # Then
        assert minimal_tool_spec.parameters == {}

    def test_given_complex_parameters_when_creating_toolspec_then_parameters_preserved(
        self,
    ):
        """Given complex parameters, when creating ToolSpec, then all parameter details preserved."""
        # Given
        complex_params = {
            "config": {
                "type": "object",
                "required": True,
                "properties": {"nested": {"type": "string"}},
            },
            "optional_list": {"type": "array", "required": False, "items": {"type": "integer"}},
        }

        # When
        tool = ToolSpec(
            id="complex_tool",
            name="Complex Tool",
            category=ToolCategory.API,
            description="Tool with complex params",
            parameters=complex_params,
        )

        # Then
        assert tool.parameters == complex_params
        assert tool.parameters["config"]["properties"]["nested"]["type"] == "string"


class TestToolSpecSerialization:
    """Tests for ToolSpec serialization."""

    def test_given_toolspec_when_converting_to_dict_then_all_fields_included(
        self, basic_tool_spec: ToolSpec
    ):
        """Given a ToolSpec, when converting to dict, then all fields are included."""
        # When
        result = basic_tool_spec.__dict__

        # Then
        assert "id" in result
        assert "name" in result
        assert "category" in result
        assert "description" in result
        assert "parameters" in result

    def test_given_toolspec_with_enum_when_accessing_category_then_enum_value_available(
        self, basic_tool_spec: ToolSpec
    ):
        """Given a ToolSpec with enum, when accessing category, then enum value is available."""
        # Then
        assert basic_tool_spec.category.value == "code_analysis"
        assert basic_tool_spec.category == ToolCategory.CODE_ANALYSIS


# AgentBlueprint Tests


class TestAgentBlueprintCreation:
    """Tests for AgentBlueprint creation and initialization."""

    def test_given_valid_parameters_when_creating_agent_blueprint_then_all_fields_set(
        self, basic_agent_blueprint: AgentBlueprint
    ):
        """Given valid parameters, when creating AgentBlueprint, then all fields are set."""
        # Then
        assert basic_agent_blueprint.name == "TestAgent"
        assert basic_agent_blueprint.role == AgentRole.ANALYZER
        assert basic_agent_blueprint.description == "Test agent for analysis"
        assert basic_agent_blueprint.objective == "Analyze test code"
        assert len(basic_agent_blueprint.tools) == 1
        assert len(basic_agent_blueprint.capabilities) == 2
        assert len(basic_agent_blueprint.constraints) == 2
        assert isinstance(basic_agent_blueprint.id, str)

    def test_given_no_optional_fields_when_creating_agent_blueprint_then_defaults_applied(
        self, minimal_agent_blueprint: AgentBlueprint
    ):
        """Given no optional fields, when creating AgentBlueprint, then defaults are applied."""
        # Then
        assert minimal_agent_blueprint.tools == []
        assert minimal_agent_blueprint.capabilities == []
        assert minimal_agent_blueprint.constraints == []
        assert minimal_agent_blueprint.metadata == {}

    def test_given_new_agent_blueprint_when_checking_id_then_valid_uuid_generated(self):
        """Given new AgentBlueprint, when checking ID, then valid UUID is generated."""
        # When
        agent = AgentBlueprint(
            name="NewAgent",
            role=AgentRole.GENERATOR,
            description="New agent",
            objective="Generate content",
        )

        # Then
        assert isinstance(agent.id, str)
        # Should not raise
        uuid.UUID(agent.id)

    def test_given_multiple_tools_when_creating_agent_blueprint_then_all_tools_preserved(self):
        """Given multiple tools, when creating AgentBlueprint, then all tools are preserved."""
        # Given
        tools = [
            ToolSpec(
                id=f"tool_{i}",
                name=f"Tool {i}",
                category=ToolCategory.CODE_ANALYSIS,
                description=f"Tool {i} description",
            )
            for i in range(3)
        ]

        # When
        agent = AgentBlueprint(
            name="MultiToolAgent",
            role=AgentRole.SPECIALIST,
            description="Agent with multiple tools",
            objective="Use all the tools",
            tools=tools,
        )

        # Then
        assert len(agent.tools) == 3
        assert all(isinstance(tool, ToolSpec) for tool in agent.tools)

    def test_given_metadata_when_creating_agent_blueprint_then_metadata_stored(self):
        """Given metadata, when creating AgentBlueprint, then metadata is stored."""
        # Given
        metadata = {
            "version": "1.0",
            "author": "test_user",
            "tags": ["analysis", "testing"],
        }

        # When
        agent = AgentBlueprint(
            name="MetadataAgent",
            role=AgentRole.REVIEWER,
            description="Agent with metadata",
            objective="Review code",
            metadata=metadata,
        )

        # Then
        assert agent.metadata == metadata
        assert agent.metadata["version"] == "1.0"
        assert "analysis" in agent.metadata["tags"]


class TestAgentBlueprintMethods:
    """Tests for AgentBlueprint methods."""

    def test_given_agent_blueprint_when_converting_to_string_then_readable_representation(
        self, basic_agent_blueprint: AgentBlueprint
    ):
        """Given AgentBlueprint, when converting to string, then readable representation returned."""
        # When
        result = str(basic_agent_blueprint)

        # Then
        assert "TestAgent" in result
        assert "analyzer" in result.lower()

    def test_given_two_identical_blueprints_when_comparing_then_equal(self):
        """Given two identical blueprints, when comparing, then they are equal."""
        # Given
        agent1 = AgentBlueprint(
            name="Agent",
            role=AgentRole.FIXER,
            description="Fixer agent",
            objective="Fix bugs",
        )
        agent1_id = agent1.id

        # Create identical agent with same ID
        agent2 = AgentBlueprint(
            name="Agent",
            role=AgentRole.FIXER,
            description="Fixer agent",
            objective="Fix bugs",
        )
        # Manually set same ID for comparison
        object.__setattr__(agent2, "id", agent1_id)

        # Then
        assert agent1.id == agent2.id
        assert agent1.name == agent2.name
        assert agent1.role == agent2.role


# WorkflowStep Tests


class TestWorkflowStepCreation:
    """Tests for WorkflowStep creation and initialization."""

    def test_given_valid_parameters_when_creating_workflow_step_then_all_fields_set(
        self, workflow_step: WorkflowStep
    ):
        """Given valid parameters, when creating WorkflowStep, then all fields are set."""
        # Then
        assert workflow_step.agent_name == "TestAgent"
        assert workflow_step.action == "analyze_code"
        assert "file_path" in workflow_step.inputs
        assert "analysis_result" in workflow_step.outputs
        assert isinstance(workflow_step.id, str)

    def test_given_no_optional_fields_when_creating_workflow_step_then_defaults_applied(self):
        """Given no optional fields, when creating WorkflowStep, then defaults are applied."""
        # When
        step = WorkflowStep(
            agent_name="SimpleAgent",
            action="simple_action",
        )

        # Then
        assert step.inputs == {}
        assert step.outputs == {}
        assert step.depends_on == []
        assert step.condition is None
        assert step.parallel is False

    def test_given_dependencies_when_creating_workflow_step_then_dependencies_stored(self):
        """Given dependencies, when creating WorkflowStep, then dependencies are stored."""
        # When
        step = WorkflowStep(
            agent_name="DependentAgent",
            action="dependent_action",
            depends_on=["step1", "step2", "step3"],
        )

        # Then
        assert len(step.depends_on) == 3
        assert "step1" in step.depends_on

    def test_given_condition_when_creating_workflow_step_then_condition_stored(self):
        """Given condition, when creating WorkflowStep, then condition is stored."""
        # Given
        condition = "result.status == 'success'"

        # When
        step = WorkflowStep(
            agent_name="ConditionalAgent",
            action="conditional_action",
            condition=condition,
        )

        # Then
        assert step.condition == condition

    def test_given_parallel_flag_when_creating_workflow_step_then_flag_set(self):
        """Given parallel flag, when creating WorkflowStep, then flag is set correctly."""
        # When
        step = WorkflowStep(
            agent_name="ParallelAgent",
            action="parallel_action",
            parallel=True,
        )

        # Then
        assert step.parallel is True


# WorkflowBlueprint Tests


class TestWorkflowBlueprintCreation:
    """Tests for WorkflowBlueprint creation and initialization."""

    def test_given_valid_parameters_when_creating_workflow_blueprint_then_all_fields_set(
        self, basic_workflow_blueprint: WorkflowBlueprint
    ):
        """Given valid parameters, when creating WorkflowBlueprint, then all fields are set."""
        # Then
        assert basic_workflow_blueprint.name == "TestWorkflow"
        assert basic_workflow_blueprint.description == "Test workflow for code analysis"
        assert basic_workflow_blueprint.objective == "Analyze and report on code quality"
        assert len(basic_workflow_blueprint.agents) == 1
        assert len(basic_workflow_blueprint.steps) == 1
        assert "file_path" in basic_workflow_blueprint.inputs
        assert "report" in basic_workflow_blueprint.outputs
        assert isinstance(basic_workflow_blueprint.id, str)

    def test_given_no_optional_fields_when_creating_workflow_blueprint_then_defaults_applied(
        self,
    ):
        """Given no optional fields, when creating WorkflowBlueprint, then defaults are applied."""
        # When
        workflow = WorkflowBlueprint(
            name="MinimalWorkflow",
            description="Minimal workflow",
            objective="Do minimal work",
        )

        # Then
        assert workflow.agents == []
        assert workflow.steps == []
        assert workflow.inputs == {}
        assert workflow.outputs == {}
        assert workflow.metadata == {}

    def test_given_multiple_agents_when_creating_workflow_blueprint_then_all_agents_preserved(
        self,
    ):
        """Given multiple agents, when creating WorkflowBlueprint, then all agents are preserved."""
        # Given
        agents = [
            AgentBlueprint(
                name=f"Agent{i}",
                role=AgentRole.ANALYZER,
                description=f"Agent {i}",
                objective=f"Objective {i}",
            )
            for i in range(3)
        ]

        # When
        workflow = WorkflowBlueprint(
            name="MultiAgentWorkflow",
            description="Workflow with multiple agents",
            objective="Coordinate multiple agents",
            agents=agents,
        )

        # Then
        assert len(workflow.agents) == 3
        assert all(isinstance(agent, AgentBlueprint) for agent in workflow.agents)

    def test_given