"""Behavioral tests for context_optimizer.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import pytest
from empathy_os.optimization.context_optimizer import (
    CompressionLevel,
    ContextOptimizer,
)


# Fixtures


@pytest.fixture
def simple_xml():
    """Given a simple XML prompt."""
    return """<thinking>
        This is a thought process.
    </thinking>
    <answer>
        This is the answer.
    </answer>"""


@pytest.fixture
def complex_xml():
    """Given a complex XML prompt with nested tags."""
    return """<agent_role>
        <description>
            Senior Software Engineer
        </description>
    </agent_role>
    <agent_goal>
        <description>
            Analyze code quality
        </description>
    </agent_goal>
    <thinking>
        <analysis>
            The code has issues.
        </analysis>
        <recommendation>
            Refactor the module.
        </recommendation>
    </thinking>
    <answer>
        <code_review>
            <security_issue>SQL injection risk</security_issue>
            <performance_issue>N+1 query problem</performance_issue>
        </code_review>
    </answer>"""


@pytest.fixture
def xml_with_comments():
    """Given XML with comments."""
    return """<!-- This is a comment -->
    <thinking>
        Content here
        <!-- Another comment -->
    </thinking>
    <answer>Final answer</answer>"""


@pytest.fixture
def xml_with_whitespace():
    """Given XML with excessive whitespace."""
    return """<thinking>
    
        Too     many    spaces
        
        
        Multiple blank lines
        
    </thinking>"""


@pytest.fixture
def xml_with_redundancy():
    """Given XML with redundant content."""
    return """<thinking>
        This pattern repeats.
        This pattern repeats.
    </thinking>
    <answer>
        Same text appears.
        Same text appears.
    </answer>"""


# CompressionLevel Enum Tests


class TestCompressionLevel:
    """Test suite for CompressionLevel enum."""

    def test_compression_level_values(self):
        """Given compression levels
        When accessing their values
        Then should return correct strings."""
        # Given/When/Then
        assert CompressionLevel.NONE.value == "none"
        assert CompressionLevel.LIGHT.value == "light"
        assert CompressionLevel.MODERATE.value == "moderate"
        assert CompressionLevel.AGGRESSIVE.value == "aggressive"

    def test_compression_level_members(self):
        """Given CompressionLevel enum
        When checking members
        Then should have all expected levels."""
        # Given/When
        levels = [level.name for level in CompressionLevel]
        
        # Then
        assert "NONE" in levels
        assert "LIGHT" in levels
        assert "MODERATE" in levels
        assert "AGGRESSIVE" in levels
        assert len(levels) == 4


# ContextOptimizer Initialization Tests


class TestContextOptimizerInitialization:
    """Test suite for ContextOptimizer initialization."""

    def test_default_initialization(self):
        """Given no compression level
        When creating ContextOptimizer
        Then should use MODERATE by default."""
        # Given/When
        optimizer = ContextOptimizer()
        
        # Then
        assert optimizer.level == CompressionLevel.MODERATE

    def test_initialization_with_level(self):
        """Given a specific compression level
        When creating ContextOptimizer
        Then should use that level."""
        # Given
        level = CompressionLevel.LIGHT
        
        # When
        optimizer = ContextOptimizer(level)
        
        # Then
        assert optimizer.level == level

    def test_tag_mappings_initialized(self):
        """Given ContextOptimizer initialization
        When checking tag mappings
        Then should have forward and reverse mappings."""
        # Given/When
        optimizer = ContextOptimizer()
        
        # Then
        assert "thinking" in optimizer._tag_mappings
        assert optimizer._tag_mappings["thinking"] == "t"
        assert "t" in optimizer._reverse_mappings
        assert optimizer._reverse_mappings["t"] == "thinking"

    def test_all_tag_mappings_complete(self):
        """Given tag mappings
        When checking reverse mappings
        Then should have complete bidirectional mapping."""
        # Given/When
        optimizer = ContextOptimizer()
        
        # Then
        for key, value in optimizer._tag_mappings.items():
            assert optimizer._reverse_mappings[value] == key


# Optimization Tests - NONE Level


class TestOptimizationNoneLevel:
    """Test suite for NONE compression level."""

    def test_none_level_no_changes(self, simple_xml):
        """Given NONE compression level
        When optimizing XML
        Then should return unchanged XML."""
        # Given
        optimizer = ContextOptimizer(CompressionLevel.NONE)
        
        # When
        result = optimizer.optimize(simple_xml)
        
        # Then
        assert result == simple_xml

    def test_none_level_preserves_whitespace(self, xml_with_whitespace):
        """Given NONE compression level with whitespace
        When optimizing XML
        Then should preserve all whitespace."""
        # Given
        optimizer = ContextOptimizer(CompressionLevel.NONE)
        
        # When
        result = optimizer.optimize(xml_with_whitespace)
        
        # Then
        assert result == xml_with_whitespace

    def test_none_level_preserves_comments(self, xml_with_comments):
        """Given NONE compression level with comments
        When optimizing XML
        Then should preserve all comments."""
        # Given
        optimizer = ContextOptimizer(CompressionLevel.NONE)
        
        # When
        result = optimizer.optimize(xml_with_comments)
        
        # Then
        assert result == xml_with_comments


# Optimization Tests - LIGHT Level


class TestOptimizationLightLevel:
    """Test suite for LIGHT compression level."""

    def test_light_level_strips_whitespace(self, xml_with_whitespace):
        """Given LIGHT compression level
        When optimizing XML with excess whitespace
        Then should strip whitespace."""
        # Given
        optimizer = ContextOptimizer(CompressionLevel.LIGHT)
        
        # When
        result = optimizer.optimize(xml_with_whitespace)
        
        # Then
        assert "     " not in result
        assert "\n\n\n" not in result
        assert len(result) < len(xml_with_whitespace)

    def test_light_level_removes_comments(self, xml_with_comments):
        """Given LIGHT compression level
        When optimizing XML with comments
        Then should remove comments."""
        # Given
        optimizer = ContextOptimizer(CompressionLevel.LIGHT)
        
        # When
        result = optimizer.optimize(xml_with_comments)
        
        # Then
        assert "<!--" not in result
        assert "-->" not in result

    def test_light_level_preserves_tags(self, simple_xml):
        """Given LIGHT compression level
        When optimizing XML
        Then should not compress tag names."""
        # Given
        optimizer = ContextOptimizer(CompressionLevel.LIGHT)
        
        # When
        result = optimizer.optimize(simple_xml)
        
        # Then
        assert "<thinking>" in result or "thinking" in result
        assert "<answer>" in result or "answer" in result

    def test_light_level_preserves_content(self, simple_xml):
        """Given LIGHT compression level
        When optimizing XML
        Then should preserve content text."""
        # Given
        optimizer = ContextOptimizer(CompressionLevel.LIGHT)
        
        # When
        result = optimizer.optimize(simple_xml)
        
        # Then
        assert "thought process" in result.lower()
        assert "answer" in result.lower()


# Optimization Tests - MODERATE Level


class TestOptimizationModerateLevel:
    """Test suite for MODERATE compression level."""

    def test_moderate_level_compresses_tags(self, simple_xml):
        """Given MODERATE compression level
        When optimizing XML
        Then should compress tag names."""
        # Given
        optimizer = ContextOptimizer(CompressionLevel.MODERATE)
        
        # When
        result = optimizer.optimize(simple_xml)
        
        # Then
        # Should have compressed tags or show compression behavior
        assert len(result) < len(simple_xml)

    def test_moderate_level_strips_whitespace(self, xml_with_whitespace):
        """Given MODERATE compression level
        When optimizing XML with whitespace
        Then should strip whitespace."""
        # Given
        optimizer = ContextOptimizer(CompressionLevel.MODERATE)
        
        # When
        result = optimizer.optimize(xml_with_whitespace)
        
        # Then
        assert len(result) < len(xml_with_whitespace)

    def test_moderate_level_removes_redundancy(self, xml_with_redundancy):
        """Given MODERATE compression level
        When optimizing XML with redundant content
        Then should remove redundancy."""
        # Given
        optimizer = ContextOptimizer(CompressionLevel.MODERATE)
        
        # When
        result = optimizer.optimize(xml_with_redundancy)
        
        # Then
        assert len(result) < len(xml_with_redundancy)

    def test_moderate_level_complex_xml(self, complex_xml):
        """Given MODERATE compression level
        When optimizing complex nested XML
        Then should compress significantly."""
        # Given
        optimizer = ContextOptimizer(CompressionLevel.MODERATE)
        
        # When
        result = optimizer.optimize(complex_xml)
        
        # Then
        assert len(result) < len(complex_xml)
        # Should reduce by at least 15%
        reduction_ratio = len(result) / len(complex_xml)
        assert reduction_ratio < 0.85


# Optimization Tests - AGGRESSIVE Level


class TestOptimizationAggressiveLevel:
    """Test suite for AGGRESSIVE compression level."""

    def test_aggressive_level_maximum_compression(self, complex_xml):
        """Given AGGRESSIVE compression level
        When optimizing complex XML
        Then should achieve maximum compression."""
        # Given
        optimizer = ContextOptimizer(CompressionLevel.AGGRESSIVE)
        
        # When
        result = optimizer.optimize(complex_xml)
        
        # Then
        # Should reduce by at least 25%
        reduction_ratio = len(result) / len(complex_xml)
        assert reduction_ratio < 0.75

    def test_aggressive_level_all_optimizations(self, complex_xml):
        """Given AGGRESSIVE compression level
        When optimizing XML
        Then should apply all optimization strategies."""
        # Given
        optimizer = ContextOptimizer(CompressionLevel.AGGRESSIVE)
        original_length = len(complex_xml)
        
        # When
        result = optimizer.optimize(complex_xml)
        
        # Then
        # Should be significantly shorter
        assert len(result) < original_length * 0.75
        # Should have no comments
        assert "<!--" not in result
        # Should have minimal whitespace
        assert "    " not in result or result.count("    ") < 3


# Edge Cases Tests


class TestEdgeCases:
    """Test suite for edge cases."""

    def test_empty_string(self):
        """Given an empty string
        When optimizing
        Then should return empty string."""
        # Given
        optimizer = ContextOptimizer()
        
        # When
        result = optimizer.optimize("")
        
        # Then
        assert result == ""

    def test_whitespace_only(self):
        """Given whitespace-only string
        When optimizing
        Then should handle gracefully."""
        # Given
        optimizer = ContextOptimizer(CompressionLevel.LIGHT)
        
        # When
        result = optimizer.optimize("   \n\n   \t\t   ")
        
        # Then
        assert isinstance(result, str)
        assert len(result) <= len("   \n\n   \t\t   ")

    def test_no_xml_tags(self):
        """Given plain text without XML
        When optimizing
        Then should handle gracefully."""
        # Given
        optimizer = ContextOptimizer()
        text = "This is just plain text without any XML tags."
        
        # When
        result = optimizer.optimize(text)
        
        # Then
        assert isinstance(result, str)
        assert "plain text" in result

    def test_malformed_xml(self):
        """Given malformed XML
        When optimizing
        Then should handle gracefully."""
        # Given
        optimizer = ContextOptimizer()
        malformed = "<thinking>Unclosed tag"
        
        # When
        result = optimizer.optimize(malformed)
        
        # Then
        assert isinstance(result, str)

    def test_nested_same_tags(self):
        """Given XML with nested same tags
        When optimizing
        Then should handle correctly."""
        # Given
        optimizer = ContextOptimizer(CompressionLevel.MODERATE)
        nested = "<thinking><thinking>Inner</thinking></thinking>"
        
        # When
        result = optimizer.optimize(nested)
        
        # Then
        assert isinstance(result, str)
        assert len(result) <= len(nested)

    def test_special_characters(self):
        """Given XML with special characters
        When optimizing
        Then should preserve special characters."""
        # Given
        optimizer = ContextOptimizer()
        special = "<thinking>&lt;script&gt;&amp;</thinking>"
        
        # When
        result = optimizer.optimize(special)
        
        # Then
        assert "&lt;" in result or "<" in result
        assert "&amp;" in result or "&" in result

    def test_very_long_content(self):
        """Given very long XML content
        When optimizing
        Then should handle efficiently."""
        # Given
        optimizer = ContextOptimizer(CompressionLevel.AGGRESSIVE)
        long_content = "<thinking>" + "x" * 10000 + "</thinking>"
        
        # When
        result = optimizer.optimize(long_content)
        
        # Then
        assert isinstance(result, str)
        assert len(result) <= len(long_content)


# Integration Tests


class TestIntegration:
    """Integration tests for complete optimization workflows."""

    def test_multiple_optimization_passes(self, complex_xml):
        """Given optimized XML
        When optimizing again
        Then should be idempotent or nearly so."""
        # Given
        optimizer = ContextOptimizer(CompressionLevel.MODERATE)
        
        # When
        first_pass = optimizer.optimize(complex_xml)
        second_pass = optimizer.optimize(first_pass)
        
        # Then
        # Second pass should not reduce much further
        assert len(second_pass) >= len(first_pass) * 0.95

    def test_optimization_comparison_across_levels(self, complex_xml):
        """Given different compression levels
        When optimizing the same XML
        Then should have increasing compression."""
        # Given
        none_opt = ContextOptimizer(CompressionLevel.NONE)
        light_opt = ContextOptimizer(CompressionLevel.LIGHT)
        mod_opt = ContextOptimizer(CompressionLevel.MODERATE)
        agg_opt = ContextOptimizer(CompressionLevel.AGGRESSIVE)
        
        # When
        none_result = none_opt.optimize(complex_xml)
        light_result = light_opt.optimize(complex_xml)
        mod_result = mod_opt.optimize(complex_xml)
        agg_result = agg_opt.optimize(complex_xml)
        
        # Then
        assert len(none_result) >= len(light_result)
        assert len(light_result) >= len