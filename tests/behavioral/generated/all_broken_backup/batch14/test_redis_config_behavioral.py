"""Behavioral tests for redis_config.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import os
from unittest.mock import MagicMock, Mock, patch

import pytest

from empathy_os.redis_config import (
    get_redis_config,
    get_redis_memory,
    parse_redis_url,
)
from empathy_os.memory.short_term import RedisConfig


class TestParseRedisUrl:
    """Behavioral tests for parse_redis_url function."""

    def test_given_standard_redis_url_when_parsed_then_returns_correct_parameters(self):
        """Test parsing standard redis:// URL with all components."""
        # Given
        url = "redis://user:password123@example.com:6380/2"

        # When
        result = parse_redis_url(url)

        # Then
        assert result["host"] == "example.com"
        assert result["port"] == 6380
        assert result["password"] == "password123"
        assert result["db"] == 2
        assert result["ssl"] is False

    def test_given_ssl_redis_url_when_parsed_then_ssl_enabled(self):
        """Test parsing rediss:// URL enables SSL."""
        # Given
        url = "rediss://user:pass@secure-host.com:6379/0"

        # When
        result = parse_redis_url(url)

        # Then
        assert result["host"] == "secure-host.com"
        assert result["port"] == 6379
        assert result["password"] == "pass"
        assert result["db"] == 0
        assert result["ssl"] is True

    def test_given_url_without_password_when_parsed_then_password_is_none(self):
        """Test parsing URL without password."""
        # Given
        url = "redis://localhost:6379"

        # When
        result = parse_redis_url(url)

        # Then
        assert result["host"] == "localhost"
        assert result["port"] == 6379
        assert result["password"] is None
        assert result["db"] == 0
        assert result["ssl"] is False

    def test_given_url_without_port_when_parsed_then_uses_default_port(self):
        """Test parsing URL without explicit port uses default 6379."""
        # Given
        url = "redis://localhost"

        # When
        result = parse_redis_url(url)

        # Then
        assert result["host"] == "localhost"
        assert result["port"] == 6379

    def test_given_url_without_db_when_parsed_then_uses_default_db_zero(self):
        """Test parsing URL without database number defaults to 0."""
        # Given
        url = "redis://localhost:6379"

        # When
        result = parse_redis_url(url)

        # Then
        assert result["db"] == 0

    def test_given_url_with_username_when_parsed_then_parses_correctly(self):
        """Test parsing URL with username in credentials."""
        # Given
        url = "redis://myuser:mypass@redis.example.com:6379/1"

        # When
        result = parse_redis_url(url)

        # Then
        assert result["host"] == "redis.example.com"
        assert result["password"] == "mypass"
        assert result["db"] == 1

    def test_given_url_with_trailing_slash_when_parsed_then_handles_correctly(self):
        """Test parsing URL with trailing slash but no db number."""
        # Given
        url = "redis://localhost:6379/"

        # When
        result = parse_redis_url(url)

        # Then
        assert result["db"] == 0

    def test_given_railway_ssl_url_when_parsed_then_ssl_enabled(self):
        """Test parsing Railway-style rediss:// URL."""
        # Given
        url = "rediss://default:password@myproject.railway.app:6379"

        # When
        result = parse_redis_url(url)

        # Then
        assert result["ssl"] is True
        assert result["host"] == "myproject.railway.app"
        assert result["password"] == "password"


class TestGetRedisConfig:
    """Behavioral tests for get_redis_config function."""

    def test_given_redis_url_env_when_getting_config_then_parses_url(self, monkeypatch):
        """Test configuration from REDIS_URL environment variable."""
        # Given
        monkeypatch.setenv("REDIS_URL", "redis://user:pass@host.com:6380/3")

        # When
        config = get_redis_config()

        # Then
        assert config.host == "host.com"
        assert config.port == 6380
        assert config.password == "pass"
        assert config.db == 3
        assert config.ssl is False

    def test_given_rediss_url_env_when_getting_config_then_ssl_enabled(self, monkeypatch):
        """Test SSL configuration from rediss:// URL."""
        # Given
        monkeypatch.setenv("REDIS_URL", "rediss://user:pass@secure.com:6379/0")

        # When
        config = get_redis_config()

        # Then
        assert config.ssl is True
        assert config.host == "secure.com"

    def test_given_individual_env_vars_when_getting_config_then_uses_them(self, monkeypatch):
        """Test configuration from individual environment variables."""
        # Given
        monkeypatch.setenv("REDIS_HOST", "myhost")
        monkeypatch.setenv("REDIS_PORT", "7000")
        monkeypatch.setenv("REDIS_PASSWORD", "secret")
        monkeypatch.setenv("REDIS_DB", "5")

        # When
        config = get_redis_config()

        # Then
        assert config.host == "myhost"
        assert config.port == 7000
        assert config.password == "secret"
        assert config.db == 5

    def test_given_no_env_vars_when_getting_config_then_uses_defaults(self, monkeypatch):
        """Test default configuration when no environment variables set."""
        # Given
        for key in ["REDIS_URL", "REDIS_HOST", "REDIS_PORT", "REDIS_PASSWORD", "REDIS_DB"]:
            monkeypatch.delenv(key, raising=False)

        # When
        config = get_redis_config()

        # Then
        assert config.host == "localhost"
        assert config.port == 6379
        assert config.db == 0

    def test_given_ssl_env_true_when_getting_config_then_ssl_enabled(self, monkeypatch):
        """Test SSL enabled via REDIS_SSL environment variable."""
        # Given
        monkeypatch.setenv("REDIS_SSL", "true")

        # When
        config = get_redis_config()

        # Then
        assert config.ssl is True

    def test_given_ssl_env_false_when_getting_config_then_ssl_disabled(self, monkeypatch):
        """Test SSL disabled via REDIS_SSL environment variable."""
        # Given
        monkeypatch.setenv("REDIS_SSL", "false")

        # When
        config = get_redis_config()

        # Then
        assert config.ssl is False

    def test_given_ssl_cert_reqs_when_getting_config_then_sets_cert_reqs(self, monkeypatch):
        """Test SSL certificate requirements configuration."""
        # Given
        monkeypatch.setenv("REDIS_SSL", "true")
        monkeypatch.setenv("REDIS_SSL_CERT_REQS", "required")

        # When
        config = get_redis_config()

        # Then
        assert config.ssl is True
        assert config.ssl_cert_reqs == "required"

    def test_given_ssl_ca_certs_when_getting_config_then_sets_ca_certs(self, monkeypatch):
        """Test SSL CA certificates path configuration."""
        # Given
        monkeypatch.setenv("REDIS_SSL", "true")
        monkeypatch.setenv("REDIS_SSL_CA_CERTS", "/path/to/ca.pem")

        # When
        config = get_redis_config()

        # Then
        assert config.ssl_ca_certs == "/path/to/ca.pem"

    def test_given_ssl_certfile_when_getting_config_then_sets_certfile(self, monkeypatch):
        """Test SSL client certificate configuration."""
        # Given
        monkeypatch.setenv("REDIS_SSL", "true")
        monkeypatch.setenv("REDIS_SSL_CERTFILE", "/path/to/cert.pem")

        # When
        config = get_redis_config()

        # Then
        assert config.ssl_certfile == "/path/to/cert.pem"

    def test_given_ssl_keyfile_when_getting_config_then_sets_keyfile(self, monkeypatch):
        """Test SSL client key configuration."""
        # Given
        monkeypatch.setenv("REDIS_SSL", "true")
        monkeypatch.setenv("REDIS_SSL_KEYFILE", "/path/to/key.pem")

        # When
        config = get_redis_config()

        # Then
        assert config.ssl_keyfile == "/path/to/key.pem"

    def test_given_socket_timeout_when_getting_config_then_sets_timeout(self, monkeypatch):
        """Test socket timeout configuration."""
        # Given
        monkeypatch.setenv("REDIS_SOCKET_TIMEOUT", "10.5")

        # When
        config = get_redis_config()

        # Then
        assert config.socket_timeout == 10.5

    def test_given_max_connections_when_getting_config_then_sets_max_connections(self, monkeypatch):
        """Test max connections configuration."""
        # Given
        monkeypatch.setenv("REDIS_MAX_CONNECTIONS", "25")

        # When
        config = get_redis_config()

        # Then
        assert config.max_connections == 25

    def test_given_retry_settings_when_getting_config_then_sets_retry_params(self, monkeypatch):
        """Test retry settings configuration."""
        # Given
        monkeypatch.setenv("REDIS_RETRY_MAX_ATTEMPTS", "5")
        monkeypatch.setenv("REDIS_RETRY_BASE_DELAY", "0.5")
        monkeypatch.setenv("REDIS_RETRY_MAX_DELAY", "5.0")

        # When
        config = get_redis_config()

        # Then
        assert config.retry_max_attempts == 5
        assert config.retry_base_delay == 0.5
        assert config.retry_max_delay == 5.0

    def test_given_sentinel_hosts_when_getting_config_then_parses_hosts(self, monkeypatch):
        """Test Sentinel hosts configuration."""
        # Given
        monkeypatch.setenv("REDIS_SENTINEL_HOSTS", "sentinel1:26379,sentinel2:26379")
        monkeypatch.setenv("REDIS_SENTINEL_MASTER", "mymaster")

        # When
        config = get_redis_config()

        # Then
        assert config.sentinel_hosts == [("sentinel1", 26379), ("sentinel2", 26379)]
        assert config.sentinel_master == "mymaster"

    def test_given_sentinel_host_without_port_when_getting_config_then_uses_default_port(self, monkeypatch):
        """Test Sentinel host without port uses default 26379."""
        # Given
        monkeypatch.setenv("REDIS_SENTINEL_HOSTS", "sentinel1")
        monkeypatch.setenv("REDIS_SENTINEL_MASTER", "mymaster")

        # When
        config = get_redis_config()

        # Then
        assert config.sentinel_hosts == [("sentinel1", 26379)]

    def test_given_redis_url_overrides_individual_vars_when_getting_config_then_url_takes_precedence(self, monkeypatch):
        """Test REDIS_URL takes precedence over individual variables."""
        # Given
        monkeypatch.setenv("REDIS_URL", "redis://urlhost:6380/2")
        monkeypatch.setenv("REDIS_HOST", "otherhost")
        monkeypatch.setenv("REDIS_PORT", "7000")

        # When
        config = get_redis_config()

        # Then
        assert config.host == "urlhost"
        assert config.port == 6380
        assert config.db == 2

    def test_given_railway_deployment_when_getting_config_then_uses_railway_url(self, monkeypatch):
        """Test Railway deployment configuration."""
        # Given
        monkeypatch.setenv("REDIS_URL", "rediss://default:railwaypass@railway.redis:6379")

        # When
        config = get_redis_config()

        # Then
        assert config.host == "railway.redis"
        assert config.password == "railwaypass"
        assert config.ssl is True


class TestGetRedisMemory:
    """Behavioral tests for get_redis_memory function."""

    @patch("empathy_os.redis_config.RedisShortTermMemory")
    def test_given_no_args_when_getting_memory_then_uses_env_config(self, mock_redis_memory, monkeypatch):
        """Test getting Redis memory with environment configuration."""
        # Given
        monkeypatch.setenv("REDIS_HOST", "envhost")
        mock_instance = Mock()
        mock_redis_memory.return_value = mock_instance

        # When
        result = get_redis_memory()

        # Then
        mock_redis_memory.assert_called_once()
        call_args = mock_redis_memory.call_args
        assert call_args[1]["config"].host == "envhost"

    @patch("empathy_os.redis_config.RedisShortTermMemory")
    def test_given_url_arg_when_getting_memory_then_uses_url(self, mock_redis_memory, monkeypatch):
        """Test getting Redis memory with explicit URL."""
        # Given
        url = "redis://customhost:6380/1"
        mock_instance = Mock()
        mock_redis_memory.return_value = mock_instance
        # Clear env to ensure URL takes precedence
        monkeypatch.delenv("REDIS_URL", raising=False)

        # When
        result = get_redis_memory(url=url)

        # Then
        mock_redis_memory.assert_called_once()
        call_args = mock_redis_memory.call_args
        assert call_args[1]["config"].host == "customhost"
        assert call_args[1]["config"].port == 6380
        assert call_args[1]["config"].db == 1

    @patch("empathy_os.redis_config.RedisShortTermMemory")
    def test_given_config_arg_when_getting_memory_then_uses_config(self, mock_redis_memory):
        """Test getting Redis memory with explicit config."""
        # Given
        config = RedisConfig(host="confighost", port=7000, db=3)
        mock_instance = Mock()
        mock_redis_memory.return_value = mock_instance

        # When
        result = get_redis_memory(config=config)

        # Then
        mock_redis_memory.assert_called_once()
        call_args = mock_redis_memory.call_args
        assert call_args[1]["config"].host == "confighost"
        assert call_args[1]["config"].port == 7