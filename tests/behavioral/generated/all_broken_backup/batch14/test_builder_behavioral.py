"""Behavioral tests for builder.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

from __future__ import annotations

from typing import TYPE_CHECKING
from unittest.mock import MagicMock, Mock, patch

import pytest

from empathy_os.workflows.builder import WorkflowBuilder

if TYPE_CHECKING:
    from empathy_os.cache import BaseCache
    from empathy_os.models import LLMExecutor, TelemetryBackend, UnifiedModelProvider
    from empathy_os.workflows.base import BaseWorkflow
    from empathy_os.workflows.config import WorkflowConfig
    from empathy_os.workflows.progress import ProgressCallback
    from empathy_os.workflows.routing import TierRoutingStrategy
    from empathy_os.workflows.tier_tracking import WorkflowTierTracker


@pytest.fixture
def mock_workflow_class():
    """Create a mock workflow class for testing."""
    mock_class = MagicMock()
    mock_class.__name__ = "MockWorkflow"
    mock_instance = MagicMock()
    mock_class.return_value = mock_instance
    return mock_class


@pytest.fixture
def mock_config():
    """Create a mock workflow configuration."""
    config = MagicMock(spec=["WorkflowConfig"])
    return config


@pytest.fixture
def mock_executor():
    """Create a mock LLM executor."""
    executor = MagicMock(spec=["LLMExecutor"])
    return executor


@pytest.fixture
def mock_provider():
    """Create a mock unified model provider."""
    provider = MagicMock(spec=["UnifiedModelProvider"])
    return provider


@pytest.fixture
def mock_cache():
    """Create a mock cache instance."""
    cache = MagicMock(spec=["BaseCache"])
    return cache


@pytest.fixture
def mock_telemetry():
    """Create a mock telemetry backend."""
    telemetry = MagicMock(spec=["TelemetryBackend"])
    return telemetry


@pytest.fixture
def mock_progress_callback():
    """Create a mock progress callback."""
    callback = MagicMock()
    return callback


@pytest.fixture
def mock_tier_tracker():
    """Create a mock tier tracker."""
    tracker = MagicMock(spec=["WorkflowTierTracker"])
    return tracker


@pytest.fixture
def mock_routing_strategy():
    """Create a mock routing strategy."""
    strategy = MagicMock(spec=["TierRoutingStrategy"])
    return strategy


class TestWorkflowBuilderInitialization:
    """Tests for WorkflowBuilder initialization."""

    def test_given_workflow_class_when_initialize_builder_then_sets_class(
        self, mock_workflow_class
    ):
        """GIVEN a workflow class
        WHEN initializing the builder
        THEN it should store the workflow class.
        """
        # When
        builder = WorkflowBuilder(mock_workflow_class)

        # Then
        assert builder.workflow_class == mock_workflow_class

    def test_given_workflow_class_when_initialize_builder_then_sets_default_values(
        self, mock_workflow_class
    ):
        """GIVEN a workflow class
        WHEN initializing the builder
        THEN it should set default values for all optional parameters.
        """
        # When
        builder = WorkflowBuilder(mock_workflow_class)

        # Then
        assert builder._config is None
        assert builder._executor is None
        assert builder._provider is None
        assert builder._cache is None
        assert builder._enable_cache is True
        assert builder._telemetry_backend is None
        assert builder._enable_telemetry is True
        assert builder._progress_callback is None
        assert builder._tier_tracker is None
        assert builder._routing_strategy is None


class TestWorkflowBuilderWithConfig:
    """Tests for with_config method."""

    def test_given_config_when_with_config_then_sets_config(
        self, mock_workflow_class, mock_config
    ):
        """GIVEN a workflow configuration
        WHEN calling with_config
        THEN it should set the config and return self.
        """
        # Given
        builder = WorkflowBuilder(mock_workflow_class)

        # When
        result = builder.with_config(mock_config)

        # Then
        assert builder._config == mock_config
        assert result is builder

    def test_given_none_config_when_with_config_then_sets_none(self, mock_workflow_class):
        """GIVEN None as config
        WHEN calling with_config
        THEN it should set config to None.
        """
        # Given
        builder = WorkflowBuilder(mock_workflow_class)

        # When
        result = builder.with_config(None)

        # Then
        assert builder._config is None
        assert result is builder


class TestWorkflowBuilderWithExecutor:
    """Tests for with_executor method."""

    def test_given_executor_when_with_executor_then_sets_executor(
        self, mock_workflow_class, mock_executor
    ):
        """GIVEN an LLM executor
        WHEN calling with_executor
        THEN it should set the executor and return self.
        """
        # Given
        builder = WorkflowBuilder(mock_workflow_class)

        # When
        result = builder.with_executor(mock_executor)

        # Then
        assert builder._executor == mock_executor
        assert result is builder

    def test_given_none_executor_when_with_executor_then_sets_none(
        self, mock_workflow_class
    ):
        """GIVEN None as executor
        WHEN calling with_executor
        THEN it should set executor to None.
        """
        # Given
        builder = WorkflowBuilder(mock_workflow_class)

        # When
        result = builder.with_executor(None)

        # Then
        assert builder._executor is None
        assert result is builder


class TestWorkflowBuilderWithProvider:
    """Tests for with_provider method."""

    def test_given_provider_when_with_provider_then_sets_provider(
        self, mock_workflow_class, mock_provider
    ):
        """GIVEN a model provider
        WHEN calling with_provider
        THEN it should set the provider and return self.
        """
        # Given
        builder = WorkflowBuilder(mock_workflow_class)

        # When
        result = builder.with_provider(mock_provider)

        # Then
        assert builder._provider == mock_provider
        assert result is builder

    def test_given_none_provider_when_with_provider_then_sets_none(
        self, mock_workflow_class
    ):
        """GIVEN None as provider
        WHEN calling with_provider
        THEN it should set provider to None.
        """
        # Given
        builder = WorkflowBuilder(mock_workflow_class)

        # When
        result = builder.with_provider(None)

        # Then
        assert builder._provider is None
        assert result is builder


class TestWorkflowBuilderWithCache:
    """Tests for with_cache method."""

    def test_given_cache_when_with_cache_then_sets_cache(
        self, mock_workflow_class, mock_cache
    ):
        """GIVEN a cache instance
        WHEN calling with_cache
        THEN it should set the cache and return self.
        """
        # Given
        builder = WorkflowBuilder(mock_workflow_class)

        # When
        result = builder.with_cache(mock_cache)

        # Then
        assert builder._cache == mock_cache
        assert result is builder

    def test_given_none_cache_when_with_cache_then_sets_none(self, mock_workflow_class):
        """GIVEN None as cache
        WHEN calling with_cache
        THEN it should set cache to None.
        """
        # Given
        builder = WorkflowBuilder(mock_workflow_class)

        # When
        result = builder.with_cache(None)

        # Then
        assert builder._cache is None
        assert result is builder


class TestWorkflowBuilderWithCacheEnabled:
    """Tests for with_cache_enabled method."""

    def test_given_true_when_with_cache_enabled_then_enables_cache(
        self, mock_workflow_class
    ):
        """GIVEN True
        WHEN calling with_cache_enabled
        THEN it should enable cache and return self.
        """
        # Given
        builder = WorkflowBuilder(mock_workflow_class)

        # When
        result = builder.with_cache_enabled(True)

        # Then
        assert builder._enable_cache is True
        assert result is builder

    def test_given_false_when_with_cache_enabled_then_disables_cache(
        self, mock_workflow_class
    ):
        """GIVEN False
        WHEN calling with_cache_enabled
        THEN it should disable cache and return self.
        """
        # Given
        builder = WorkflowBuilder(mock_workflow_class)

        # When
        result = builder.with_cache_enabled(False)

        # Then
        assert builder._enable_cache is False
        assert result is builder


class TestWorkflowBuilderWithTelemetry:
    """Tests for with_telemetry method."""

    def test_given_telemetry_when_with_telemetry_then_sets_telemetry(
        self, mock_workflow_class, mock_telemetry
    ):
        """GIVEN a telemetry backend
        WHEN calling with_telemetry
        THEN it should set the telemetry backend and return self.
        """
        # Given
        builder = WorkflowBuilder(mock_workflow_class)

        # When
        result = builder.with_telemetry(mock_telemetry)

        # Then
        assert builder._telemetry_backend == mock_telemetry
        assert result is builder

    def test_given_none_telemetry_when_with_telemetry_then_sets_none(
        self, mock_workflow_class
    ):
        """GIVEN None as telemetry
        WHEN calling with_telemetry
        THEN it should set telemetry to None.
        """
        # Given
        builder = WorkflowBuilder(mock_workflow_class)

        # When
        result = builder.with_telemetry(None)

        # Then
        assert builder._telemetry_backend is None
        assert result is builder


class TestWorkflowBuilderWithTelemetryEnabled:
    """Tests for with_telemetry_enabled method."""

    def test_given_true_when_with_telemetry_enabled_then_enables_telemetry(
        self, mock_workflow_class
    ):
        """GIVEN True
        WHEN calling with_telemetry_enabled
        THEN it should enable telemetry and return self.
        """
        # Given
        builder = WorkflowBuilder(mock_workflow_class)

        # When
        result = builder.with_telemetry_enabled(True)

        # Then
        assert builder._enable_telemetry is True
        assert result is builder

    def test_given_false_when_with_telemetry_enabled_then_disables_telemetry(
        self, mock_workflow_class
    ):
        """GIVEN False
        WHEN calling with_telemetry_enabled
        THEN it should disable telemetry and return self.
        """
        # Given
        builder = WorkflowBuilder(mock_workflow_class)

        # When
        result = builder.with_telemetry_enabled(False)

        # Then
        assert builder._enable_telemetry is False
        assert result is builder


class TestWorkflowBuilderWithProgressCallback:
    """Tests for with_progress_callback method."""

    def test_given_callback_when_with_progress_callback_then_sets_callback(
        self, mock_workflow_class, mock_progress_callback
    ):
        """GIVEN a progress callback
        WHEN calling with_progress_callback
        THEN it should set the callback and return self.
        """
        # Given
        builder = WorkflowBuilder(mock_workflow_class)

        # When
        result = builder.with_progress_callback(mock_progress_callback)

        # Then
        assert builder._progress_callback == mock_progress_callback
        assert result is builder

    def test_given_none_callback_when_with_progress_callback_then_sets_none(
        self, mock_workflow_class
    ):
        """GIVEN None as callback
        WHEN calling with_progress_callback
        THEN it should set callback to None.
        """
        # Given
        builder = WorkflowBuilder(mock_workflow_class)

        # When
        result = builder.with_progress_callback(None)

        # Then
        assert builder._progress_callback is None
        assert result is builder


class TestWorkflowBuilderWithTierTracker:
    """Tests for with_tier_tracker method."""

    def test_given_tracker_when_with_tier_tracker_then_sets_tracker(
        self, mock_workflow_class, mock_tier_tracker
    ):
        """GIVEN a tier tracker
        WHEN calling with_tier_tracker
        THEN it should set the tracker and return self.
        """
        # Given
        builder = WorkflowBuilder(mock_workflow_class)

        # When
        result = builder.with_tier_tracker(mock_tier_tracker)

        # Then
        assert builder._tier_tracker == mock_tier_tracker
        assert result is builder

    def test_given_none_tracker_when_with_tier_tracker_then_sets_none(
        self, mock_workflow_class
    ):
        """GIVEN None as tracker
        WHEN calling with_tier_tracker
        THEN it should set tracker to None.
        """
        # Given
        builder = WorkflowBuilder(mock_workflow_class)

        # When
        result = builder.with_tier_tracker(None)

        # Then
        assert builder._tier_tracker is None
        assert result is builder


class TestWorkflowBuilderWithRouting:
    """Tests for with_routing method."""

    def test_given_strategy_when_with_routing_then_sets_strategy(
        self, mock_workflow_class, mock_routing_strategy
    ):
        """GIVEN a routing strategy
        WHEN calling with_routing
        THEN it should set the strategy and return self.
        """
        # Given
        builder = WorkflowBuilder(mock_workflow_class)

        # When
        result = builder.with_routing(mock_routing_strategy)

        # Then
        assert builder._routing_strategy == mock_routing_strategy
        assert result is builder

    def test_given_none_strategy_when_with_routing_then_sets_none(
        self, mock_workflow_class
    ):
        """GIVEN None as strategy
        WHEN calling with_routing
        THEN it should set strategy to None.
        """
        # Given
        builder = WorkflowBuilder(mock_workflow_class)

        # When
        result = builder.with_routing(None)

        # Then
        assert builder._routing_strategy is None
        assert result is builder


class TestWorkflowBuilderBuild:
    """Tests for build method."""

    def test_given_minimal_config_when_build_then_creates_workflow(
        self, mock_workflow_class
    ):
        """GIVEN minimal configuration
        WHEN calling build
        THEN it should create workflow instance with default values.
        """
        # Given
        builder = WorkflowBuilder(mock_workflow_class)

        # When
        result = builder.build()

        # Then
        mock_workflow_class.assert_called_once_with(
            config=None,
            executor=None,
            provider=None,
            cache=None,
            enable_cache=True,
            telemetry_backend=None,
            enable_telemetry=True,
            progress_callback=None,
            tier_tracker=None,
            routing_strategy=None,
        )
        assert result == mock_workflow_class.return_value

    def test_given_all_parameters_when_build_then