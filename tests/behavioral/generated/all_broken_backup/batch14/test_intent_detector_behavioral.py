"""Behavioral tests for intent_detector.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import pytest
from unittest.mock import Mock, patch, MagicMock
from empathy_os.meta_workflows.intent_detector import (
    IntentMatch,
    IntentDetector,
    detect_intent,
)


class TestIntentMatch:
    """Test the IntentMatch dataclass."""

    def test_given_all_fields_when_creating_intent_match_then_all_fields_set(self):
        """Given all fields provided, when creating IntentMatch, then all fields are set correctly."""
        # Given
        template_id = "test-template"
        template_name = "Test Template"
        confidence = 0.85
        matched_keywords = ["test", "template"]
        description = "A test template"

        # When
        intent_match = IntentMatch(
            template_id=template_id,
            template_name=template_name,
            confidence=confidence,
            matched_keywords=matched_keywords,
            description=description,
        )

        # Then
        assert intent_match.template_id == template_id
        assert intent_match.template_name == template_name
        assert intent_match.confidence == confidence
        assert intent_match.matched_keywords == matched_keywords
        assert intent_match.description == description

    def test_given_minimal_fields_when_creating_intent_match_then_defaults_applied(self):
        """Given minimal fields, when creating IntentMatch, then default values are applied."""
        # Given / When
        intent_match = IntentMatch(
            template_id="test-id",
            template_name="Test Name",
            confidence=0.5,
        )

        # Then
        assert intent_match.template_id == "test-id"
        assert intent_match.template_name == "Test Name"
        assert intent_match.confidence == 0.5
        assert intent_match.matched_keywords == []
        assert intent_match.description == ""

    def test_given_confidence_zero_when_creating_intent_match_then_accepts_zero(self):
        """Given confidence of 0.0, when creating IntentMatch, then it accepts the value."""
        # Given / When
        intent_match = IntentMatch(
            template_id="id",
            template_name="name",
            confidence=0.0,
        )

        # Then
        assert intent_match.confidence == 0.0

    def test_given_confidence_one_when_creating_intent_match_then_accepts_one(self):
        """Given confidence of 1.0, when creating IntentMatch, then it accepts the value."""
        # Given / When
        intent_match = IntentMatch(
            template_id="id",
            template_name="name",
            confidence=1.0,
        )

        # Then
        assert intent_match.confidence == 1.0


class TestIntentDetector:
    """Test the IntentDetector class."""

    def test_given_release_keywords_when_detecting_intent_then_returns_release_prep_template(self):
        """Given input with release keywords, when detecting intent, then returns release-prep template."""
        # Given
        detector = IntentDetector()
        user_input = "I need to prepare for a release"

        # When
        matches = detector.detect(user_input)

        # Then
        assert len(matches) > 0
        assert any(m.template_id == "release-prep" for m in matches)

    def test_given_test_coverage_keywords_when_detecting_intent_then_returns_coverage_template(self):
        """Given input with test coverage keywords, when detecting intent, then returns test-coverage-boost template."""
        # Given
        detector = IntentDetector()
        user_input = "I need to improve test coverage"

        # When
        matches = detector.detect(user_input)

        # Then
        assert len(matches) > 0
        assert any(m.template_id == "test-coverage-boost" for m in matches)

    def test_given_code_review_keywords_when_detecting_intent_then_returns_code_review_template(self):
        """Given input with code review keywords, when detecting intent, then returns code-review template."""
        # Given
        detector = IntentDetector()
        user_input = "I need a code review for my pull request"

        # When
        matches = detector.detect(user_input)

        # Then
        assert len(matches) > 0
        assert any(m.template_id == "code-review" for m in matches)

    def test_given_research_keywords_when_detecting_intent_then_returns_research_template(self):
        """Given input with research keywords, when detecting intent, then returns research template."""
        # Given
        detector = IntentDetector()
        user_input = "I need to research a new technology"

        # When
        matches = detector.detect(user_input)

        # Then
        assert len(matches) > 0
        assert any(m.template_id == "research" for m in matches)

    def test_given_empty_string_when_detecting_intent_then_returns_empty_list(self):
        """Given empty string input, when detecting intent, then returns empty list."""
        # Given
        detector = IntentDetector()
        user_input = ""

        # When
        matches = detector.detect(user_input)

        # Then
        assert matches == []

    def test_given_whitespace_only_when_detecting_intent_then_returns_empty_list(self):
        """Given whitespace-only input, when detecting intent, then returns empty list."""
        # Given
        detector = IntentDetector()
        user_input = "   \t\n  "

        # When
        matches = detector.detect(user_input)

        # Then
        assert matches == []

    def test_given_no_matching_keywords_when_detecting_intent_then_returns_empty_list(self):
        """Given input with no matching keywords, when detecting intent, then returns empty list."""
        # Given
        detector = IntentDetector()
        user_input = "xyz123 random gibberish qwerty"

        # When
        matches = detector.detect(user_input)

        # Then
        assert matches == []

    def test_given_multiple_matching_patterns_when_detecting_intent_then_returns_sorted_by_confidence(self):
        """Given input matching multiple patterns, when detecting intent, then returns results sorted by confidence."""
        # Given
        detector = IntentDetector()
        user_input = "I need to prepare for release and improve test coverage and get a code review"

        # When
        matches = detector.detect(user_input)

        # Then
        assert len(matches) > 1
        for i in range(len(matches) - 1):
            assert matches[i].confidence >= matches[i + 1].confidence

    def test_given_case_variations_when_detecting_intent_then_matches_case_insensitive(self):
        """Given input with various case, when detecting intent, then matches case-insensitively."""
        # Given
        detector = IntentDetector()
        inputs = [
            "I need to RELEASE this",
            "i need to Release this",
            "I NEED TO RELEASE THIS",
        ]

        # When / Then
        for user_input in inputs:
            matches = detector.detect(user_input)
            assert len(matches) > 0
            assert any(m.template_id == "release-prep" for m in matches)

    def test_given_phrase_pattern_when_detecting_intent_then_matches_phrase(self):
        """Given input matching a phrase pattern, when detecting intent, then detects the match."""
        # Given
        detector = IntentDetector()
        user_input = "Are we ready to deploy?"

        # When
        matches = detector.detect(user_input)

        # Then
        assert len(matches) > 0
        assert any(m.template_id == "release-prep" for m in matches)

    def test_given_max_results_when_detecting_intent_then_limits_results(self):
        """Given max_results parameter, when detecting intent, then limits number of results."""
        # Given
        detector = IntentDetector()
        user_input = "I need to prepare for release and improve test coverage and get a code review"
        max_results = 2

        # When
        matches = detector.detect(user_input, max_results=max_results)

        # Then
        assert len(matches) <= max_results

    def test_given_min_confidence_when_detecting_intent_then_filters_low_confidence(self):
        """Given min_confidence parameter, when detecting intent, then filters out low confidence matches."""
        # Given
        detector = IntentDetector()
        user_input = "release"
        min_confidence = 0.9

        # When
        matches = detector.detect(user_input, min_confidence=min_confidence)

        # Then
        for match in matches:
            assert match.confidence >= min_confidence

    def test_given_high_min_confidence_when_detecting_intent_then_may_return_empty(self):
        """Given very high min_confidence, when detecting intent, then may return empty list."""
        # Given
        detector = IntentDetector()
        user_input = "release"
        min_confidence = 0.99

        # When
        matches = detector.detect(user_input, min_confidence=min_confidence)

        # Then
        assert isinstance(matches, list)

    def test_given_special_characters_when_detecting_intent_then_handles_gracefully(self):
        """Given input with special characters, when detecting intent, then handles gracefully."""
        # Given
        detector = IntentDetector()
        user_input = "I need to release!!! @#$% ***"

        # When
        matches = detector.detect(user_input)

        # Then
        assert isinstance(matches, list)
        if matches:
            assert any(m.template_id == "release-prep" for m in matches)

    def test_given_very_long_input_when_detecting_intent_then_processes_successfully(self):
        """Given very long input, when detecting intent, then processes successfully."""
        # Given
        detector = IntentDetector()
        user_input = "release " * 1000

        # When
        matches = detector.detect(user_input)

        # Then
        assert isinstance(matches, list)
        if matches:
            assert any(m.template_id == "release-prep" for m in matches)

    def test_given_unicode_input_when_detecting_intent_then_handles_unicode(self):
        """Given input with unicode characters, when detecting intent, then handles correctly."""
        # Given
        detector = IntentDetector()
        user_input = "I need to release 发布 this"

        # When
        matches = detector.detect(user_input)

        # Then
        assert isinstance(matches, list)

    def test_given_keyword_weight_when_detecting_intent_then_applies_weight_to_confidence(self):
        """Given keyword with higher weight, when detecting intent, then confidence reflects weight."""
        # Given
        detector = IntentDetector()
        user_input = "security scan for release"

        # When
        matches = detector.detect(user_input)

        # Then
        release_matches = [m for m in matches if m.template_id == "release-prep"]
        assert len(release_matches) > 0
        assert release_matches[0].confidence > 0

    def test_given_matched_keywords_when_detecting_intent_then_populates_matched_keywords(self):
        """Given matching keywords, when detecting intent, then populates matched_keywords field."""
        # Given
        detector = IntentDetector()
        user_input = "I need to prepare for a release"

        # When
        matches = detector.detect(user_input)

        # Then
        release_matches = [m for m in matches if m.template_id == "release-prep"]
        if release_matches:
            assert len(release_matches[0].matched_keywords) > 0

    def test_given_template_in_builtin_when_detecting_intent_then_includes_description(self):
        """Given matching template exists in BUILTIN_TEMPLATES, when detecting intent, then includes description."""
        # Given
        detector = IntentDetector()
        user_input = "I need to prepare for a release"

        # When
        matches = detector.detect(user_input)

        # Then
        release_matches = [m for m in matches if m.template_id == "release-prep"]
        if release_matches:
            assert release_matches[0].description != ""
            assert release_matches[0].template_name != ""

    @patch("empathy_os.meta_workflows.intent_detector.BUILTIN_TEMPLATES", {})
    def test_given_no_builtin_templates_when_detecting_intent_then_handles_gracefully(self):
        """Given no builtin templates, when detecting intent, then handles gracefully."""
        # Given
        detector = IntentDetector()
        user_input = "I need to prepare for a release"

        # When
        matches = detector.detect(user_input)

        # Then
        assert isinstance(matches, list)

    def test_given_multiple_keyword_matches_when_detecting_intent_then_increases_confidence(self):
        """Given multiple matching keywords, when detecting intent, then confidence is higher."""
        # Given
        detector = IntentDetector()
        single_keyword = "release"
        multiple_keywords = "release deploy publish ship launch"

        # When
        single_matches = detector.detect(single_keyword)
        multiple_matches = detector.detect(multiple_keywords)

        # Then
        single_release = [m for m in single_matches if m.template_id == "release-prep"]
        multiple_release = [m for m in multiple_matches if m.template_id == "release-prep"]
        
        if single_release and multiple_release:
            assert multiple_release[0].confidence >= single_release[0].confidence

    def test_given_phrase_match_when_detecting_intent_then_higher_confidence_than_keyword(self):
        """Given phrase pattern match, when detecting intent, then confidence is boosted."""
        # Given
        detector = IntentDetector()
        phrase_input = "ready to release"
        keyword_input = "release"

        # When
        phrase_matches = detector.detect(phrase_input)
        keyword_matches = detector.detect(keyword_input)

        # Then
        phrase_release = [m for m in phrase_matches if m.template_id == "release-prep"]
        keyword_release = [m for m in keyword_matches if m.template_id == "release-prep"]
        
        if phrase_release and keyword_release:
            assert phrase_release[0].confidence >= keyword_release[0].confidence


class TestDetectIntentFunction:
    """Test the standalone detect_intent function."""

    def test_given_valid_input_when_calling_detect_intent_then_returns_matches(self):
        """Given valid input, when calling detect_intent function, then returns matches."""
        # Given
        user_input = "I need to prepare for a release"

        # When
        matches = detect_intent(user_input)

        # Then
        assert isinstance(matches, list)
        assert len(matches) > 0

    def test_given_empty_input_when_calling_detect_intent_then_returns_empty_list(self):
        """Given empty input, when calling detect_intent function, then returns empty list."""
        # Given
        user_input = ""

        # When
        matches = detect_intent(user_input)

        # Then
        assert matches == []

    def test_given_max_results_when_calling_detect_intent_then_limits_results(self):
        """Given max_results parameter, when calling detect_intent function, then limits results."""
        # Given
        user_input = "I need to prepare for release and improve test coverage"
        max_results = 1

        # When
        matches = detect_intent(user_input, max_results=max_results)

        # Then
        assert len(matches)