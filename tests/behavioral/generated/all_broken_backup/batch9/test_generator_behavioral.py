"""Behavioral tests for generator.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

from __future__ import annotations

from datetime import datetime
from typing import Any
from unittest.mock import MagicMock, Mock, patch

import pytest

from empathy_os.socratic.blueprint import (
    AgentBlueprint,
    AgentRole,
    AgentSpec,
    StageSpec,
    ToolCategory,
    ToolSpec,
    WorkflowBlueprint,
)
from empathy_os.socratic.generator import AgentTemplate
from empathy_os.socratic.success import SuccessCriteria


# =============================================================================
# FIXTURES
# =============================================================================


@pytest.fixture
def agent_template() -> AgentTemplate:
    """Provide a basic agent template for testing.

    Returns:
        AgentTemplate with default configuration
    """
    return AgentTemplate(
        id="test_agent",
        name="Test Agent",
        role=AgentRole.ANALYZER,
        base_goal="Analyze and evaluate content",
        base_backstory="Expert in content analysis and evaluation",
        default_tools=["search", "analyze"],
        quality_focus=["accuracy", "completeness"],
        languages=["en", "es"],
        model_tier="capable",
        custom_instructions=["Be thorough", "Consider edge cases"],
    )


@pytest.fixture
def multilingual_template() -> AgentTemplate:
    """Provide a multilingual agent template.

    Returns:
        AgentTemplate supporting all languages
    """
    return AgentTemplate(
        id="multi_agent",
        name="Multilingual Agent",
        role=AgentRole.TRANSLATOR,
        base_goal="Translate content accurately",
        base_backstory="Professional translator with years of experience",
        default_tools=["translate", "dictionary"],
        quality_focus=["accuracy", "fluency"],
        languages=[],  # Empty = all languages
        model_tier="advanced",
    )


@pytest.fixture
def basic_customizations() -> dict[str, Any]:
    """Provide basic customization dictionary.

    Returns:
        Dict with common customization fields
    """
    return {
        "id": "custom_agent",
        "name": "Custom Agent",
        "goal": "Custom goal",
        "backstory": "Custom backstory",
        "languages": ["fr", "de"],
        "quality_focus": ["speed"],
        "tools": ["custom_tool"],
    }


@pytest.fixture
def advanced_customizations() -> dict[str, Any]:
    """Provide advanced customization dictionary.

    Returns:
        Dict with advanced customization fields
    """
    return {
        "goal_suffix": "with high precision",
        "expertise": ["machine learning", "data science"],
        "quality_focus": ["precision", "recall"],
        "tools": ["ml_analyzer", "data_validator"],
    }


@pytest.fixture
def mock_tool_spec() -> ToolSpec:
    """Provide a mock ToolSpec.

    Returns:
        ToolSpec instance for testing
    """
    return ToolSpec(
        name="test_tool",
        category=ToolCategory.ANALYSIS,
        description="A test tool for analysis",
        required_params=["input"],
        optional_params=["config"],
    )


@pytest.fixture
def agent_spec() -> AgentSpec:
    """Provide a complete agent specification.

    Returns:
        AgentSpec instance for testing
    """
    return AgentSpec(
        id="spec_agent",
        name="Spec Agent",
        role=AgentRole.VALIDATOR,
        goal="Validate output quality",
        backstory="Quality assurance expert",
        tools=[
            ToolSpec(
                name="validator",
                category=ToolCategory.VALIDATION,
                description="Validates content",
                required_params=["content"],
                optional_params=[],
            )
        ],
        quality_focus=["accuracy"],
        languages=["en"],
    )


# =============================================================================
# AGENT TEMPLATE TESTS
# =============================================================================


class TestAgentTemplateCreation:
    """Tests for AgentTemplate instantiation and basic properties."""

    def test_given_valid_params_when_created_then_template_initialized(self):
        """Given valid parameters
        When AgentTemplate is created
        Then all fields are properly initialized
        """
        # Given
        template_id = "test_id"
        name = "Test Name"
        role = AgentRole.ANALYZER
        goal = "Test goal"
        backstory = "Test backstory"
        tools = ["tool1", "tool2"]
        quality = ["quality1"]
        languages = ["en"]
        
        # When
        template = AgentTemplate(
            id=template_id,
            name=name,
            role=role,
            base_goal=goal,
            base_backstory=backstory,
            default_tools=tools,
            quality_focus=quality,
            languages=languages,
        )
        
        # Then
        assert template.id == template_id
        assert template.name == name
        assert template.role == role
        assert template.base_goal == goal
        assert template.base_backstory == backstory
        assert template.default_tools == tools
        assert template.quality_focus == quality
        assert template.languages == languages
        assert template.model_tier == "capable"
        assert template.custom_instructions == []

    def test_given_custom_model_tier_when_created_then_tier_set(self):
        """Given custom model tier
        When AgentTemplate is created
        Then model_tier reflects custom value
        """
        # Given
        tier = "advanced"
        
        # When
        template = AgentTemplate(
            id="test",
            name="Test",
            role=AgentRole.ANALYZER,
            base_goal="Goal",
            base_backstory="Backstory",
            default_tools=[],
            quality_focus=[],
            languages=[],
            model_tier=tier,
        )
        
        # Then
        assert template.model_tier == tier

    def test_given_custom_instructions_when_created_then_instructions_stored(self):
        """Given custom instructions list
        When AgentTemplate is created
        Then custom_instructions contains all items
        """
        # Given
        instructions = ["instruction1", "instruction2", "instruction3"]
        
        # When
        template = AgentTemplate(
            id="test",
            name="Test",
            role=AgentRole.COORDINATOR,
            base_goal="Goal",
            base_backstory="Backstory",
            default_tools=[],
            quality_focus=[],
            languages=[],
            custom_instructions=instructions,
        )
        
        # Then
        assert template.custom_instructions == instructions
        assert len(template.custom_instructions) == 3


class TestAgentTemplateCreateSpec:
    """Tests for AgentTemplate.create_spec method."""

    def test_given_no_customizations_when_create_spec_then_defaults_used(
        self, agent_template: AgentTemplate
    ):
        """Given no customizations
        When create_spec is called
        Then default template values are used
        """
        # Given
        # agent_template fixture
        
        # When
        spec = agent_template.create_spec()
        
        # Then
        assert spec.id == agent_template.id
        assert spec.name == agent_template.name
        assert spec.role == agent_template.role
        assert spec.goal == agent_template.base_goal
        assert spec.backstory == agent_template.base_backstory
        assert spec.languages == agent_template.languages
        assert spec.quality_focus == agent_template.quality_focus

    def test_given_none_customizations_when_create_spec_then_defaults_used(
        self, agent_template: AgentTemplate
    ):
        """Given None as customizations
        When create_spec is called
        Then default template values are used
        """
        # Given
        customizations = None
        
        # When
        spec = agent_template.create_spec(customizations)
        
        # Then
        assert spec.id == agent_template.id
        assert spec.name == agent_template.name
        assert spec.goal == agent_template.base_goal

    def test_given_custom_id_when_create_spec_then_id_overridden(
        self, agent_template: AgentTemplate
    ):
        """Given customizations with id
        When create_spec is called
        Then spec uses custom id
        """
        # Given
        custom_id = "custom_id_123"
        customizations = {"id": custom_id}
        
        # When
        spec = agent_template.create_spec(customizations)
        
        # Then
        assert spec.id == custom_id

    def test_given_custom_name_when_create_spec_then_name_overridden(
        self, agent_template: AgentTemplate
    ):
        """Given customizations with name
        When create_spec is called
        Then spec uses custom name
        """
        # Given
        custom_name = "Custom Name"
        customizations = {"name": custom_name}
        
        # When
        spec = agent_template.create_spec(customizations)
        
        # Then
        assert spec.name == custom_name

    def test_given_custom_goal_when_create_spec_then_goal_replaced(
        self, agent_template: AgentTemplate
    ):
        """Given customizations with goal
        When create_spec is called
        Then spec uses custom goal completely
        """
        # Given
        custom_goal = "Completely new goal"
        customizations = {"goal": custom_goal}
        
        # When
        spec = agent_template.create_spec(customizations)
        
        # Then
        assert spec.goal == custom_goal
        assert agent_template.base_goal not in spec.goal

    def test_given_goal_suffix_when_create_spec_then_suffix_appended(
        self, agent_template: AgentTemplate
    ):
        """Given customizations with goal_suffix
        When create_spec is called
        Then goal_suffix is appended to base_goal
        """
        # Given
        suffix = "with extra requirements"
        customizations = {"goal_suffix": suffix}
        
        # When
        spec = agent_template.create_spec(customizations)
        
        # Then
        assert spec.goal == f"{agent_template.base_goal} {suffix}"
        assert agent_template.base_goal in spec.goal
        assert suffix in spec.goal

    def test_given_custom_backstory_when_create_spec_then_backstory_replaced(
        self, agent_template: AgentTemplate
    ):
        """Given customizations with backstory
        When create_spec is called
        Then spec uses custom backstory
        """
        # Given
        custom_backstory = "New professional background"
        customizations = {"backstory": custom_backstory}
        
        # When
        spec = agent_template.create_spec(customizations)
        
        # Then
        assert spec.backstory == custom_backstory

    def test_given_expertise_when_create_spec_then_backstory_extended(
        self, agent_template: AgentTemplate
    ):
        """Given customizations with expertise list
        When create_spec is called
        Then expertise is appended to backstory
        """
        # Given
        expertise = ["AI", "Machine Learning", "NLP"]
        customizations = {"expertise": expertise}
        
        # When
        spec = agent_template.create_spec(customizations)
        
        # Then
        assert agent_template.base_backstory in spec.backstory
        assert "Specialized in:" in spec.backstory
        assert "AI" in spec.backstory
        assert "Machine Learning" in spec.backstory
        assert "NLP" in spec.backstory

    def test_given_custom_languages_when_create_spec_then_languages_replaced(
        self, agent_template: AgentTemplate
    ):
        """Given customizations with languages
        When create_spec is called
        Then spec uses custom languages
        """
        # Given
        custom_languages = ["fr", "de", "it"]
        customizations = {"languages": custom_languages}
        
        # When
        spec = agent_template.create_spec(customizations)
        
        # Then
        assert spec.languages == custom_languages
        assert spec.languages != agent_template.languages

    def test_given_empty_languages_when_create_spec_then_all_languages_supported(
        self, multilingual_template: AgentTemplate
    ):
        """Given template with empty languages list
        When create_spec is called
        Then spec supports all languages
        """
        # Given
        assert multilingual_template.languages == []
        
        # When
        spec = multilingual_template.create_spec()
        
        # Then
        assert spec.languages == []

    def test_given_quality_focus_when_create_spec_then_quality_merged(
        self, agent_template: AgentTemplate
    ):
        """Given customizations with quality_focus
        When create_spec is called
        Then quality_focus is merged with template defaults
        """
        # Given
        additional_quality = ["speed", "efficiency"]
        customizations = {"quality_focus": additional_quality}
        original_quality = agent_template.quality_focus.copy()
        
        # When
        spec = agent_template.create_spec(customizations)
        
        # Then
        assert all(q in spec.quality_focus for q in original_quality)
        assert all(q in spec.quality_focus for q in additional_quality)

    def test_given_duplicate_quality_when_create_spec_then_deduped(
        self, agent_template: AgentTemplate
    ):
        """Given customizations with duplicate quality_focus items
        When create_spec is called
        Then duplicates are removed preserving order
        """
        # Given
        # agent_template has ["accuracy", "completeness"]
        customizations = {"quality_focus": ["accuracy", "speed", "completeness"]}
        
        # When
        spec = agent_template.create_spec(customizations)
        
        # Then
        assert len(spec.quality_focus) == len(set(spec.quality_focus))
        # Order should be preserved: accuracy, completeness, speed
        assert spec.quality_focus[0] == "accuracy"
        assert spec.quality_focus[1] == "completeness"
        assert "speed" in spec.quality_focus

    def test_given_all_customizations_when_create_spec_then_all_applied(
        self, agent_template: AgentTemplate, basic_customizations: dict[str, Any]
    ):
        """Given all possible customizations
        When create_spec is called
        Then all customizations are properly applied
        """
        # Given
        # basic_customizations fixture
        
        # When
        spec = agent_template.create_spec(basic_customizations)
        
        # Then
        assert spec.id == basic_customizations["id"]
        assert spec.name == basic_customizations["name"]
        assert spec.goal == basic_customizations["goal"]
        assert spec.backstory == basic_customizations["backstory"]
        assert spec.languages == basic_customizations["languages"]
        assert "speed" in spec.quality_focus

    def test_given_advanced_customizations_when_create_spec_then_complex_merge(
        self, agent_template: AgentTemplate, advanced_customizations: dict[str, Any]
    ):
        """Given advanced customizations with suffixes and lists
        When create_spec is called
        Then complex merge logic works correctly
        """
        # Given
        # advanced_customizations fixture
        
        # When
        spec = agent_template.create_spec(advanced_customizations)
        
        # Then
        # Goal has suffix
        assert agent_template.base_goal in spec.goal
        assert advanced_customizations["goal_suffix"] in spec.goal
        
        # Backstory has expertise
        assert agent_template.base_backstory in spec.backstory
        assert "machine learning" in spec.backstory
        assert "data science