"""Behavioral tests for status.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import json
from argparse import Namespace
from unittest.mock import MagicMock, Mock, patch

import pytest


@pytest.fixture
def basic_args():
    """Fixture providing basic command arguments."""
    return Namespace(
        patterns_dir="./patterns",
        project_root=".",
        inactivity=30,
        full=False,
        json=False,
        select=None,
        force=False,
    )


@pytest.fixture
def mock_collector():
    """Fixture providing a mocked SessionStatusCollector."""
    with patch("empathy_os.cli.commands.status.SessionStatusCollector") as mock:
        collector_instance = Mock()
        collector_instance.should_show.return_value = True
        collector_instance.collect.return_value = {
            "patterns": [],
            "git_context": {},
            "health": {},
        }
        collector_instance.format_output.return_value = "Status output"
        collector_instance.format_json.return_value = "{}"
        collector_instance.get_action_prompt.return_value = "Action prompt"
        collector_instance.record_interaction.return_value = None
        mock.return_value = collector_instance
        yield mock


class TestCmdStatus:
    """Behavioral tests for cmd_status function."""

    def test_given_recent_activity_when_not_forced_then_shows_no_update_message(
        self, basic_args, mock_collector, capsys
    ):
        """Given recent activity detected
        When status command is run without force flag
        Then it displays no update needed message and exits early.
        """
        # Given
        from empathy_os.cli.commands.status import cmd_status

        mock_collector.return_value.should_show.return_value = False

        # When
        cmd_status(basic_args)

        # Then
        captured = capsys.readouterr()
        assert "No status update needed" in captured.out
        assert "Use --force to show status anyway" in captured.out
        mock_collector.return_value.collect.assert_not_called()

    def test_given_force_flag_when_recent_activity_then_shows_status_anyway(
        self, basic_args, mock_collector, capsys
    ):
        """Given force flag is set
        When status command is run with recent activity
        Then it displays status regardless of activity.
        """
        # Given
        from empathy_os.cli.commands.status import cmd_status

        basic_args.force = True
        mock_collector.return_value.should_show.return_value = False

        # When
        cmd_status(basic_args)

        # Then
        captured = capsys.readouterr()
        assert "No status update needed" not in captured.out
        mock_collector.return_value.collect.assert_called_once()

    def test_given_no_recent_activity_when_status_called_then_shows_full_report(
        self, basic_args, mock_collector, capsys
    ):
        """Given no recent activity detected
        When status command is run
        Then it collects and displays full status report.
        """
        # Given
        from empathy_os.cli.commands.status import cmd_status

        mock_collector.return_value.should_show.return_value = True
        mock_collector.return_value.format_output.return_value = "Full status report"

        # When
        cmd_status(basic_args)

        # Then
        captured = capsys.readouterr()
        assert "Full status report" in captured.out
        mock_collector.return_value.collect.assert_called_once()
        mock_collector.return_value.record_interaction.assert_called_once()

    def test_given_json_flag_when_status_called_then_outputs_json_format(
        self, basic_args, mock_collector, capsys
    ):
        """Given json flag is set
        When status command is run
        Then it outputs status in JSON format.
        """
        # Given
        from empathy_os.cli.commands.status import cmd_status

        basic_args.json = True
        status_data = {"patterns": ["p1"], "health": {"score": 85}}
        mock_collector.return_value.collect.return_value = status_data
        mock_collector.return_value.format_json.return_value = json.dumps(status_data)

        # When
        cmd_status(basic_args)

        # Then
        captured = capsys.readouterr()
        assert '"patterns"' in captured.out
        assert '"health"' in captured.out
        mock_collector.return_value.format_json.assert_called_once_with(status_data)
        mock_collector.return_value.format_output.assert_not_called()

    def test_given_full_flag_when_status_called_then_shows_all_items_without_limit(
        self, basic_args, mock_collector, capsys
    ):
        """Given full flag is set
        When status command is run
        Then it displays all items without limit.
        """
        # Given
        from empathy_os.cli.commands.status import cmd_status

        basic_args.full = True
        status_data = {"patterns": list(range(20))}
        mock_collector.return_value.collect.return_value = status_data

        # When
        cmd_status(basic_args)

        # Then
        mock_collector.return_value.format_output.assert_called_once()
        call_args = mock_collector.return_value.format_output.call_args
        assert call_args[1]["max_items"] is None

    def test_given_no_full_flag_when_status_called_then_limits_to_five_items(
        self, basic_args, mock_collector, capsys
    ):
        """Given full flag is not set
        When status command is run
        Then it limits display to 5 items.
        """
        # Given
        from empathy_os.cli.commands.status import cmd_status

        basic_args.full = False
        status_data = {"patterns": list(range(20))}
        mock_collector.return_value.collect.return_value = status_data

        # When
        cmd_status(basic_args)

        # Then
        mock_collector.return_value.format_output.assert_called_once()
        call_args = mock_collector.return_value.format_output.call_args
        assert call_args[1]["max_items"] == 5

    def test_given_select_option_when_valid_selection_then_shows_action_prompt(
        self, basic_args, mock_collector, capsys
    ):
        """Given select option with valid selection number
        When status command is run
        Then it displays action prompt for that selection.
        """
        # Given
        from empathy_os.cli.commands.status import cmd_status

        basic_args.select = 3
        status_data = {"patterns": ["p1", "p2", "p3"]}
        mock_collector.return_value.collect.return_value = status_data
        mock_collector.return_value.get_action_prompt.return_value = (
            "Prompt for item 3"
        )

        # When
        cmd_status(basic_args)

        # Then
        captured = capsys.readouterr()
        assert "Action prompt for selection 3" in captured.out
        assert "Prompt for item 3" in captured.out
        mock_collector.return_value.get_action_prompt.assert_called_once_with(
            status_data, 3
        )

    def test_given_select_option_when_invalid_selection_then_shows_error_message(
        self, basic_args, mock_collector, capsys
    ):
        """Given select option with invalid selection number
        When status command is run
        Then it displays invalid selection message.
        """
        # Given
        from empathy_os.cli.commands.status import cmd_status

        basic_args.select = 99
        status_data = {"patterns": ["p1", "p2"]}
        mock_collector.return_value.collect.return_value = status_data
        mock_collector.return_value.get_action_prompt.return_value = None

        # When
        cmd_status(basic_args)

        # Then
        captured = capsys.readouterr()
        assert "Invalid selection: 99" in captured.out

    def test_given_select_option_when_status_called_then_does_not_record_interaction(
        self, basic_args, mock_collector
    ):
        """Given select option is provided
        When status command is run
        Then it does not record interaction.
        """
        # Given
        from empathy_os.cli.commands.status import cmd_status

        basic_args.select = 1
        status_data = {"patterns": ["p1"]}
        mock_collector.return_value.collect.return_value = status_data
        mock_collector.return_value.get_action_prompt.return_value = "Prompt"

        # When
        cmd_status(basic_args)

        # Then
        mock_collector.return_value.record_interaction.assert_not_called()

    def test_given_custom_paths_when_status_called_then_initializes_collector_correctly(
        self, basic_args, mock_collector
    ):
        """Given custom patterns_dir and project_root
        When status command is run
        Then collector is initialized with correct paths.
        """
        # Given
        from empathy_os.cli.commands.status import cmd_status

        basic_args.patterns_dir = "/custom/patterns"
        basic_args.project_root = "/custom/project"

        # When
        cmd_status(basic_args)

        # Then
        mock_collector.assert_called_once_with(
            patterns_dir="/custom/patterns",
            project_root="/custom/project",
            config={"inactivity_minutes": 30},
        )

    def test_given_custom_inactivity_when_status_called_then_uses_custom_config(
        self, basic_args, mock_collector
    ):
        """Given custom inactivity minutes
        When status command is run
        Then collector is initialized with custom config.
        """
        # Given
        from empathy_os.cli.commands.status import cmd_status

        basic_args.inactivity = 60

        # When
        cmd_status(basic_args)

        # Then
        call_args = mock_collector.call_args
        assert call_args[1]["config"]["inactivity_minutes"] == 60


class TestCmdReview:
    """Behavioral tests for cmd_review function."""

    def test_given_review_command_when_called_then_shows_deprecation_message(
        self, basic_args, capsys
    ):
        """Given review command is called
        When function executes
        Then it displays deprecation warning.
        """
        # Given
        from empathy_os.cli.commands.status import cmd_review

        # When
        cmd_review(basic_args)

        # Then
        captured = capsys.readouterr()
        assert "The 'review' command has been deprecated" in captured.out

    def test_given_review_command_when_called_then_suggests_alternatives(
        self, basic_args, capsys
    ):
        """Given review command is called
        When function executes
        Then it suggests alternative commands.
        """
        # Given
        from empathy_os.cli.commands.status import cmd_review

        # When
        cmd_review(basic_args)

        # Then
        captured = capsys.readouterr()
        assert "empathy workflow run bug-predict" in captured.out
        assert "ruff check" in captured.out
        assert "bandit -r" in captured.out

    def test_given_review_command_when_called_then_explains_removal(
        self, basic_args, capsys
    ):
        """Given review command is called
        When function executes
        Then it explains module removal.
        """
        # Given
        from empathy_os.cli.commands.status import cmd_review

        # When
        cmd_review(basic_args)

        # Then
        captured = capsys.readouterr()
        assert "CodeReviewWorkflow module has been removed" in captured.out


class TestCmdHealth:
    """Behavioral tests for cmd_health function."""

    def test_given_health_command_when_called_then_shows_deprecation_message(
        self, basic_args, capsys
    ):
        """Given health command is called
        When function executes
        Then it displays deprecation warning.
        """
        # Given
        from empathy_os.cli.commands.status import cmd_health

        # When
        cmd_health(basic_args)

        # Then
        captured = capsys.readouterr()
        assert "The 'health' command has been deprecated" in captured.out

    def test_given_health_command_when_called_then_suggests_status_alternative(
        self, basic_args, capsys
    ):
        """Given health command is called
        When function executes
        Then it suggests using status command instead.
        """
        # Given
        from empathy_os.cli.commands.status import cmd_health

        # When
        cmd_health(basic_args)

        # Then
        captured = capsys.readouterr()
        assert "empathy status" in captured.out


class TestEdgeCases:
    """Edge case tests for status commands."""

    def test_given_collector_raises_exception_when_status_called_then_propagates_error(
        self, basic_args, mock_collector
    ):
        """Given collector raises an exception
        When status command is run
        Then exception propagates to caller.
        """
        # Given
        from empathy_os.cli.commands.status import cmd_status

        mock_collector.return_value.collect.side_effect = RuntimeError(
            "Collection failed"
        )

        # When/Then
        with pytest.raises(RuntimeError, match="Collection failed"):
            cmd_status(basic_args)

    def test_given_empty_status_data_when_formatted_then_handles_gracefully(
        self, basic_args, mock_collector, capsys
    ):
        """Given status collection returns empty data
        When status is formatted
        Then it handles empty data gracefully.
        """
        # Given
        from empathy_os.cli.commands.status import cmd_status

        mock_collector.return_value.collect.return_value = {}
        mock_collector.return_value.format_output.return_value = "No data available"

        # When
        cmd_status(basic_args)

        # Then
        captured = capsys.readouterr()
        assert "No data available" in captured.out

    def test_given_selection_zero_when_status_called_then_handles_correctly(
        self, basic_args, mock_collector, capsys
    ):
        """Given selection of 0
        When status command is run
        Then it attempts to get action prompt for 0.
        """
        # Given
        from empathy_os.cli.commands.status import cmd_status

        basic_args.select = 0
        status_data = {"patterns": ["p1"]}
        mock_collector.return_value.collect.return_value = status_data
        mock_collector.return_value.get_action_prompt.return_value = "Prompt for 0"

        # When
        cmd_status(basic_args)

        # Then
        captured = capsys.readouterr()
        assert "Action prompt for selection 0" in captured.out
        mock_collector.return_value.get_action_prompt.assert_called_once_with(
            status_data, 0
        )

    def test_given_negative_selection_when_status_called_then_treats_as_invalid(
        self, basic_args, mock_collector, capsys
    ):
        """Given negative selection