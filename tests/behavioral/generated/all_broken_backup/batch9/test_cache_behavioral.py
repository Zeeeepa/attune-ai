"""Behavioral tests for cache.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import json
import pytest
from argparse import Namespace
from datetime import datetime, timedelta
from pathlib import Path
from unittest.mock import Mock, mock_open, patch, MagicMock

from empathy_os.cli.commands.cache import (
    cmd_cache_stats,
    _collect_cache_stats,
    _display_cache_report,
)


@pytest.fixture
def mock_args():
    """Fixture providing default command arguments."""
    return Namespace(days=7, format="table", verbose=False)


@pytest.fixture
def mock_args_json():
    """Fixture providing JSON format arguments."""
    return Namespace(days=7, format="json", verbose=False)


@pytest.fixture
def mock_args_verbose():
    """Fixture providing verbose arguments."""
    return Namespace(days=7, format="table", verbose=True)


@pytest.fixture
def sample_log_content():
    """Fixture providing sample log file content."""
    now = datetime.now()
    today = now.strftime("%Y-%m-%d")
    yesterday = (now - timedelta(days=1)).strftime("%Y-%m-%d")
    
    return f"""{today} 10:30:45,123 INFO - Cache HIT: 1,500 tokens read - saved $0.15
{today} 10:31:00,456 INFO - Cache WRITE: 2,000 tokens written - cost $0.10
{yesterday} 15:22:11,789 INFO - Cache HIT: 3,200 tokens read - saved $0.32
{yesterday} 16:45:30,012 INFO - Cache WRITE: 1,800 tokens written - cost $0.09
2020-01-01 12:00:00,000 INFO - Cache HIT: 500 tokens read - saved $0.05
"""


@pytest.fixture
def sample_stats():
    """Fixture providing sample cache statistics."""
    return {
        "total_requests": 100,
        "cache_hits": 45,
        "cache_writes": 30,
        "cache_hit_rate": 45.0,
        "total_cache_read_tokens": 15000,
        "total_cache_write_tokens": 10000,
        "total_savings": 12.50,
        "avg_savings_per_hit": 0.28,
        "days_analyzed": 7,
    }


@pytest.fixture
def empty_stats():
    """Fixture providing empty statistics when no log file exists."""
    return {
        "error": "No log file found",
        "message": "Enable logging to track cache performance",
        "total_requests": 0,
        "cache_hits": 0,
        "cache_writes": 0,
        "total_savings": 0.0,
    }


class TestCmdCacheStats:
    """Behavioral tests for cmd_cache_stats function."""

    def test_given_valid_args_when_table_format_then_displays_formatted_report(
        self, mock_args, sample_stats, capsys
    ):
        """Test that table format displays a formatted report."""
        # Given
        with patch(
            "empathy_os.cli.commands.cache._collect_cache_stats",
            return_value=sample_stats,
        ):
            with patch("empathy_os.cli.commands.cache._display_cache_report") as mock_display:
                # When
                cmd_cache_stats(mock_args)
                
                # Then
                mock_display.assert_called_once_with(sample_stats, verbose=False)
                captured = capsys.readouterr()
                assert "Analyzing cache performance" in captured.out
                assert "7 days" in captured.out

    def test_given_json_format_when_called_then_outputs_json(
        self, mock_args_json, sample_stats, capsys
    ):
        """Test that JSON format outputs valid JSON."""
        # Given
        with patch(
            "empathy_os.cli.commands.cache._collect_cache_stats",
            return_value=sample_stats,
        ):
            # When
            cmd_cache_stats(mock_args_json)
            
            # Then
            captured = capsys.readouterr()
            assert "Analyzing cache performance" in captured.out
            
            # Extract JSON from output
            lines = captured.out.split("\n")
            json_lines = [l for l in lines if l.strip().startswith("{") or "total_requests" in l]
            json_output = "\n".join(lines[2:])  # Skip the header lines
            
            parsed = json.loads(json_output.strip())
            assert parsed["total_requests"] == 100
            assert parsed["cache_hits"] == 45

    def test_given_verbose_flag_when_called_then_passes_verbose_to_display(
        self, mock_args_verbose, sample_stats
    ):
        """Test that verbose flag is passed to display function."""
        # Given
        with patch(
            "empathy_os.cli.commands.cache._collect_cache_stats",
            return_value=sample_stats,
        ):
            with patch("empathy_os.cli.commands.cache._display_cache_report") as mock_display:
                # When
                cmd_cache_stats(mock_args_verbose)
                
                # Then
                mock_display.assert_called_once_with(sample_stats, verbose=True)

    def test_given_custom_days_when_called_then_uses_custom_days(
        self, sample_stats, capsys
    ):
        """Test that custom days parameter is used."""
        # Given
        custom_args = Namespace(days=14, format="table", verbose=False)
        
        with patch(
            "empathy_os.cli.commands.cache._collect_cache_stats",
            return_value=sample_stats,
        ) as mock_collect:
            with patch("empathy_os.cli.commands.cache._display_cache_report"):
                # When
                cmd_cache_stats(custom_args)
                
                # Then
                mock_collect.assert_called_once_with(days=14)
                captured = capsys.readouterr()
                assert "14 days" in captured.out

    def test_given_no_log_file_when_json_format_then_outputs_error_json(
        self, mock_args_json, empty_stats, capsys
    ):
        """Test that missing log file produces error JSON."""
        # Given
        with patch(
            "empathy_os.cli.commands.cache._collect_cache_stats",
            return_value=empty_stats,
        ):
            # When
            cmd_cache_stats(mock_args_json)
            
            # Then
            captured = capsys.readouterr()
            json_output = "\n".join(captured.out.split("\n")[2:])
            parsed = json.loads(json_output.strip())
            assert "error" in parsed
            assert parsed["error"] == "No log file found"


class TestCollectCacheStats:
    """Behavioral tests for _collect_cache_stats function."""

    def test_given_log_file_exists_when_collected_then_returns_stats(
        self, sample_log_content
    ):
        """Test that cache stats are collected from existing log file."""
        # Given
        mock_path = Mock(spec=Path)
        mock_path.exists.return_value = True
        
        with patch("empathy_os.cli.commands.cache.Path") as mock_path_class:
            mock_path_class.cwd.return_value = mock_path / "empathy_os.log"
            mock_path_class.home.return_value = mock_path
            mock_path_class.return_value = mock_path
            
            # Return True for first path check
            mock_path.exists.side_effect = [True, True, True]
            
            with patch(
                "builtins.open",
                mock_open(read_data=sample_log_content),
            ):
                # When
                stats = _collect_cache_stats(days=7)
                
                # Then
                assert stats["cache_hits"] == 2  # Two hits within date range
                assert stats["cache_writes"] == 2  # Two writes within date range
                assert stats["total_cache_read_tokens"] == 4700  # 1,500 + 3,200
                assert stats["total_cache_write_tokens"] == 3800  # 2,000 + 1,800
                assert stats["total_savings"] == pytest.approx(0.47, 0.01)

    def test_given_no_log_file_when_collected_then_returns_error_dict(self):
        """Test that missing log file returns error dictionary."""
        # Given
        with patch("empathy_os.cli.commands.cache.Path") as mock_path_class:
            mock_cwd = Mock()
            mock_cwd.exists.return_value = False
            
            mock_home = Mock()
            mock_home.exists.return_value = False
            
            mock_tmp = Mock()
            mock_tmp.exists.return_value = False
            
            mock_path_class.cwd.return_value = mock_cwd / "empathy_os.log"
            mock_path_class.home.return_value = mock_home / ".empathy"
            mock_path_class.return_value = mock_tmp
            
            (mock_cwd / "empathy_os.log").exists.return_value = False
            (mock_home / ".empathy" / "logs" / "empathy_os.log").exists.return_value = False
            mock_tmp.exists.return_value = False
            
            # When
            stats = _collect_cache_stats(days=7)
            
            # Then
            assert "error" in stats
            assert stats["error"] == "No log file found"
            assert stats["total_requests"] == 0
            assert stats["cache_hits"] == 0

    def test_given_custom_days_when_collected_then_filters_by_date(self):
        """Test that custom days parameter filters log entries correctly."""
        # Given
        now = datetime.now()
        old_date = (now - timedelta(days=10)).strftime("%Y-%m-%d")
        
        old_log_content = f"""{old_date} 10:30:45,123 INFO - Cache HIT: 1,000 tokens read - saved $0.10
"""
        
        mock_path = Mock(spec=Path)
        mock_path.exists.return_value = True
        
        with patch("empathy_os.cli.commands.cache.Path") as mock_path_class:
            mock_path_class.cwd.return_value = mock_path / "empathy_os.log"
            mock_path.exists.return_value = True
            
            with patch(
                "builtins.open",
                mock_open(read_data=old_log_content),
            ):
                # When
                stats = _collect_cache_stats(days=7)
                
                # Then
                assert stats["cache_hits"] == 0  # Outside 7-day window

    def test_given_malformed_log_lines_when_collected_then_skips_invalid_entries(self):
        """Test that malformed log lines are gracefully skipped."""
        # Given
        today = datetime.now().strftime("%Y-%m-%d")
        malformed_log = f"""{today} 10:30:45,123 INFO - Invalid cache line
{today} 10:31:00,456 INFO - Cache HIT: 1,500 tokens read - saved $0.15
Not a valid log line at all
{today} 10:32:00,789 INFO - Cache WRITE: 2,000 tokens written - cost $0.10
"""
        
        mock_path = Mock(spec=Path)
        mock_path.exists.return_value = True
        
        with patch("empathy_os.cli.commands.cache.Path") as mock_path_class:
            mock_path_class.cwd.return_value = mock_path / "empathy_os.log"
            mock_path.exists.return_value = True
            
            with patch(
                "builtins.open",
                mock_open(read_data=malformed_log),
            ):
                # When
                stats = _collect_cache_stats(days=7)
                
                # Then
                assert stats["cache_hits"] == 1
                assert stats["cache_writes"] == 1

    def test_given_empty_log_file_when_collected_then_returns_zero_stats(self):
        """Test that empty log file returns zero statistics."""
        # Given
        mock_path = Mock(spec=Path)
        mock_path.exists.return_value = True
        
        with patch("empathy_os.cli.commands.cache.Path") as mock_path_class:
            mock_path_class.cwd.return_value = mock_path / "empathy_os.log"
            mock_path.exists.return_value = True
            
            with patch("builtins.open", mock_open(read_data="")):
                # When
                stats = _collect_cache_stats(days=7)
                
                # Then
                assert stats["total_requests"] == 0
                assert stats["cache_hits"] == 0
                assert stats["cache_writes"] == 0
                assert stats["total_savings"] == 0.0

    def test_given_file_read_error_when_collected_then_handles_exception(self):
        """Test that file read errors are handled gracefully."""
        # Given
        mock_path = Mock(spec=Path)
        mock_path.exists.return_value = True
        
        with patch("empathy_os.cli.commands.cache.Path") as mock_path_class:
            mock_path_class.cwd.return_value = mock_path / "empathy_os.log"
            mock_path.exists.return_value = True
            
            with patch("builtins.open", side_effect=IOError("Permission denied")):
                # When
                stats = _collect_cache_stats(days=7)
                
                # Then
                assert "error" in stats

    def test_given_log_with_commas_in_tokens_when_collected_then_parses_correctly(self):
        """Test that token numbers with commas are parsed correctly."""
        # Given
        today = datetime.now().strftime("%Y-%m-%d")
        log_with_commas = f"""{today} 10:30:45,123 INFO - Cache HIT: 12,500 tokens read - saved $1.25
{today} 10:31:00,456 INFO - Cache WRITE: 8,300 tokens written - cost $0.83
"""
        
        mock_path = Mock(spec=Path)
        mock_path.exists.return_value = True
        
        with patch("empathy_os.cli.commands.cache.Path") as mock_path_class:
            mock_path_class.cwd.return_value = mock_path / "empathy_os.log"
            mock_path.exists.return_value = True
            
            with patch(
                "builtins.open",
                mock_open(read_data=log_with_commas),
            ):
                # When
                stats = _collect_cache_stats(days=7)
                
                # Then
                assert stats["total_cache_read_tokens"] == 12500
                assert stats["total_cache_write_tokens"] == 8300

    def test_given_invalid_timestamp_when_collected_then_skips_line(self):
        """Test that lines with invalid timestamps are skipped."""
        # Given
        today = datetime.now().strftime("%Y-%m-%d")
        invalid_timestamp_log = f"""INVALID-DATE 10:30:45,123 INFO - Cache HIT: 1,500