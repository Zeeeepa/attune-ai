"""Behavioral tests for integration.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import logging
from typing import Any
from unittest.mock import AsyncMock, MagicMock, Mock, patch

import pytest
from fastapi import FastAPI, WebSocket

from empathy_os.hot_reload.integration import HotReloadIntegration


@pytest.fixture
def mock_config():
    """Provide mock hot reload configuration."""
    config = Mock()
    config.enabled = True
    config.websocket_path = "/hot-reload/ws"
    config.watch_dirs = ["/tmp/workflows"]
    config.patterns = ["*.py"]
    config.debounce_seconds = 1.0
    return config


@pytest.fixture
def mock_register_callback():
    """Provide mock workflow registration callback."""
    return Mock(return_value=True)


@pytest.fixture
def mock_notification_callback():
    """Provide mock notification callback."""
    return Mock()


@pytest.fixture
def mock_reloader():
    """Provide mock WorkflowReloader."""
    reloader = Mock()
    reloader.reload_workflow = Mock(return_value=True)
    return reloader


@pytest.fixture
def mock_watcher():
    """Provide mock WorkflowFileWatcher."""
    watcher = Mock()
    watcher.start = Mock()
    watcher.stop = Mock()
    return watcher


@pytest.fixture
def mock_notification_manager():
    """Provide mock NotificationManager."""
    manager = Mock()
    manager.connect = AsyncMock()
    manager.disconnect = Mock()
    return manager


@pytest.fixture
def fastapi_app():
    """Provide FastAPI application instance."""
    return FastAPI()


@pytest.fixture
def mock_websocket():
    """Provide mock WebSocket."""
    websocket = AsyncMock(spec=WebSocket)
    websocket.accept = AsyncMock()
    websocket.close = AsyncMock()
    return websocket


class TestHotReloadIntegrationInit:
    """Test suite for HotReloadIntegration initialization."""

    @patch("empathy_os.hot_reload.integration.get_hot_reload_config")
    @patch("empathy_os.hot_reload.integration.create_notification_callback")
    @patch("empathy_os.hot_reload.integration.WorkflowReloader")
    def test_given_enabled_config_when_init_then_components_created(
        self,
        mock_reloader_class,
        mock_create_callback,
        mock_get_config,
        fastapi_app,
        mock_register_callback,
        mock_config,
        mock_notification_callback,
    ):
        """Test initialization with hot-reload enabled."""
        # Given
        mock_get_config.return_value = mock_config
        mock_create_callback.return_value = mock_notification_callback

        # When
        integration = HotReloadIntegration(fastapi_app, mock_register_callback)

        # Then
        assert integration.app == fastapi_app
        assert integration.register_callback == mock_register_callback
        assert integration.config == mock_config
        assert integration.notification_callback == mock_notification_callback
        mock_reloader_class.assert_called_once()
        assert integration.watcher is None

    @patch("empathy_os.hot_reload.integration.get_hot_reload_config")
    @patch("empathy_os.hot_reload.integration.create_notification_callback")
    @patch("empathy_os.hot_reload.integration.WorkflowReloader")
    def test_given_disabled_config_when_init_then_no_websocket_setup(
        self,
        mock_reloader_class,
        mock_create_callback,
        mock_get_config,
        fastapi_app,
        mock_register_callback,
    ):
        """Test initialization with hot-reload disabled."""
        # Given
        mock_config = Mock()
        mock_config.enabled = False
        mock_get_config.return_value = mock_config
        mock_create_callback.return_value = Mock()

        # When
        integration = HotReloadIntegration(fastapi_app, mock_register_callback)

        # Then
        assert integration.config.enabled is False
        # WebSocket endpoint should not be added

    @patch("empathy_os.hot_reload.integration.get_hot_reload_config")
    @patch("empathy_os.hot_reload.integration.create_notification_callback")
    @patch("empathy_os.hot_reload.integration.WorkflowReloader")
    def test_given_custom_websocket_path_when_init_then_path_configured(
        self,
        mock_reloader_class,
        mock_create_callback,
        mock_get_config,
        fastapi_app,
        mock_register_callback,
    ):
        """Test initialization with custom WebSocket path."""
        # Given
        mock_config = Mock()
        mock_config.enabled = True
        mock_config.websocket_path = "/custom/ws/path"
        mock_get_config.return_value = mock_config
        mock_create_callback.return_value = Mock()

        # When
        integration = HotReloadIntegration(fastapi_app, mock_register_callback)

        # Then
        assert integration.config.websocket_path == "/custom/ws/path"


class TestRegisterWorkflowWrapper:
    """Test suite for _register_workflow_wrapper method."""

    @patch("empathy_os.hot_reload.integration.get_hot_reload_config")
    @patch("empathy_os.hot_reload.integration.create_notification_callback")
    @patch("empathy_os.hot_reload.integration.WorkflowReloader")
    def test_given_successful_registration_when_wrapper_called_then_returns_true(
        self,
        mock_reloader_class,
        mock_create_callback,
        mock_get_config,
        fastapi_app,
        mock_config,
    ):
        """Test successful workflow registration."""
        # Given
        mock_get_config.return_value = mock_config
        mock_create_callback.return_value = Mock()
        mock_register_callback = Mock(return_value=True)
        integration = HotReloadIntegration(fastapi_app, mock_register_callback)
        workflow_class = Mock()

        # When
        result = integration._register_workflow_wrapper("workflow_1", workflow_class)

        # Then
        assert result is True
        mock_register_callback.assert_called_once_with("workflow_1", workflow_class)

    @patch("empathy_os.hot_reload.integration.get_hot_reload_config")
    @patch("empathy_os.hot_reload.integration.create_notification_callback")
    @patch("empathy_os.hot_reload.integration.WorkflowReloader")
    def test_given_failed_registration_when_wrapper_called_then_returns_false(
        self,
        mock_reloader_class,
        mock_create_callback,
        mock_get_config,
        fastapi_app,
        mock_config,
    ):
        """Test failed workflow registration."""
        # Given
        mock_get_config.return_value = mock_config
        mock_create_callback.return_value = Mock()
        mock_register_callback = Mock(return_value=False)
        integration = HotReloadIntegration(fastapi_app, mock_register_callback)
        workflow_class = Mock()

        # When
        result = integration._register_workflow_wrapper("workflow_1", workflow_class)

        # Then
        assert result is False
        mock_register_callback.assert_called_once_with("workflow_1", workflow_class)

    @patch("empathy_os.hot_reload.integration.get_hot_reload_config")
    @patch("empathy_os.hot_reload.integration.create_notification_callback")
    @patch("empathy_os.hot_reload.integration.WorkflowReloader")
    @patch("empathy_os.hot_reload.integration.logger")
    def test_given_exception_when_wrapper_called_then_logs_error_and_returns_false(
        self,
        mock_logger,
        mock_reloader_class,
        mock_create_callback,
        mock_get_config,
        fastapi_app,
        mock_config,
    ):
        """Test exception handling in workflow registration."""
        # Given
        mock_get_config.return_value = mock_config
        mock_create_callback.return_value = Mock()
        error_message = "Registration failed"
        mock_register_callback = Mock(side_effect=Exception(error_message))
        integration = HotReloadIntegration(fastapi_app, mock_register_callback)
        workflow_class = Mock()

        # When
        result = integration._register_workflow_wrapper("workflow_1", workflow_class)

        # Then
        assert result is False
        mock_logger.error.assert_called_once()
        assert "workflow_1" in str(mock_logger.error.call_args)

    @patch("empathy_os.hot_reload.integration.get_hot_reload_config")
    @patch("empathy_os.hot_reload.integration.create_notification_callback")
    @patch("empathy_os.hot_reload.integration.WorkflowReloader")
    def test_given_none_workflow_class_when_wrapper_called_then_handles_gracefully(
        self,
        mock_reloader_class,
        mock_create_callback,
        mock_get_config,
        fastapi_app,
        mock_config,
    ):
        """Test wrapper with None workflow class."""
        # Given
        mock_get_config.return_value = mock_config
        mock_create_callback.return_value = Mock()
        mock_register_callback = Mock(return_value=True)
        integration = HotReloadIntegration(fastapi_app, mock_register_callback)

        # When
        result = integration._register_workflow_wrapper("workflow_1", None)

        # Then
        mock_register_callback.assert_called_once_with("workflow_1", None)


class TestSetupWebsocketEndpoint:
    """Test suite for _setup_websocket_endpoint method."""

    @patch("empathy_os.hot_reload.integration.get_hot_reload_config")
    @patch("empathy_os.hot_reload.integration.create_notification_callback")
    @patch("empathy_os.hot_reload.integration.WorkflowReloader")
    @patch("empathy_os.hot_reload.integration.get_notification_manager")
    async def test_given_websocket_connection_when_endpoint_called_then_connects(
        self,
        mock_get_manager,
        mock_reloader_class,
        mock_create_callback,
        mock_get_config,
        fastapi_app,
        mock_config,
        mock_register_callback,
        mock_notification_manager,
        mock_websocket,
    ):
        """Test WebSocket endpoint accepts connections."""
        # Given
        mock_get_config.return_value = mock_config
        mock_create_callback.return_value = Mock()
        mock_get_manager.return_value = mock_notification_manager
        integration = HotReloadIntegration(fastapi_app, mock_register_callback)

        # Find the websocket route
        websocket_route = None
        for route in fastapi_app.routes:
            if hasattr(route, "path") and route.path == mock_config.websocket_path:
                websocket_route = route
                break

        # When/Then - WebSocket endpoint should be registered
        assert websocket_route is not None

    @patch("empathy_os.hot_reload.integration.get_hot_reload_config")
    @patch("empathy_os.hot_reload.integration.create_notification_callback")
    @patch("empathy_os.hot_reload.integration.WorkflowReloader")
    def test_given_enabled_config_when_setup_then_websocket_route_added(
        self,
        mock_reloader_class,
        mock_create_callback,
        mock_get_config,
        fastapi_app,
        mock_config,
        mock_register_callback,
    ):
        """Test WebSocket route is added when enabled."""
        # Given
        mock_get_config.return_value = mock_config
        mock_create_callback.return_value = Mock()

        # When
        integration = HotReloadIntegration(fastapi_app, mock_register_callback)

        # Then
        route_paths = [route.path for route in fastapi_app.routes if hasattr(route, "path")]
        assert mock_config.websocket_path in route_paths


class TestStartMethod:
    """Test suite for start method."""

    @patch("empathy_os.hot_reload.integration.get_hot_reload_config")
    @patch("empathy_os.hot_reload.integration.create_notification_callback")
    @patch("empathy_os.hot_reload.integration.WorkflowReloader")
    @patch("empathy_os.hot_reload.integration.WorkflowFileWatcher")
    def test_given_enabled_config_when_start_then_watcher_created_and_started(
        self,
        mock_watcher_class,
        mock_reloader_class,
        mock_create_callback,
        mock_get_config,
        fastapi_app,
        mock_config,
        mock_register_callback,
        mock_watcher,
    ):
        """Test starting hot-reload with enabled configuration."""
        # Given
        mock_get_config.return_value = mock_config
        mock_create_callback.return_value = Mock()
        mock_watcher_class.return_value = mock_watcher
        integration = HotReloadIntegration(fastapi_app, mock_register_callback)

        # When
        integration.start()

        # Then
        mock_watcher_class.assert_called_once()
        mock_watcher.start.assert_called_once()
        assert integration.watcher == mock_watcher

    @patch("empathy_os.hot_reload.integration.get_hot_reload_config")
    @patch("empathy_os.hot_reload.integration.create_notification_callback")
    @patch("empathy_os.hot_reload.integration.WorkflowReloader")
    @patch("empathy_os.hot_reload.integration.logger")
    def test_given_disabled_config_when_start_then_logs_info_and_returns(
        self,
        mock_logger,
        mock_reloader_class,
        mock_create_callback,
        mock_get_config,
        fastapi_app,
        mock_register_callback,
    ):
        """Test starting hot-reload with disabled configuration."""
        # Given
        mock_config = Mock()
        mock_config.enabled = False
        mock_get_config.return_value = mock_config
        mock_create_callback.return_value = Mock()
        integration = HotReloadIntegration(fastapi_app, mock_register_callback)

        # When
        integration.start()

        # Then
        mock_logger.info.assert_called_once()
        assert "disabled" in str(mock_logger.info.call_args).lower()

    @patch("empathy_os.hot_reload.integration.get_hot_reload_config")
    @patch("empathy_os.hot_reload.integration.create_notification_callback")
    @patch("empathy_os.hot_reload.integration.WorkflowReloader")
    @patch("empathy_os.hot_reload.integration.WorkflowFileWatcher")
    @patch("empathy_os.hot_reload.integration.logger")
    def test_given_exception_when_start_then_logs_error(
        self,
        mock_logger,
        mock_watcher_class,
        mock_reloader_class,
        mock_create_callback,
        mock_