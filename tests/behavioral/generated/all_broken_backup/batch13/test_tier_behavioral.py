"""Behavioral tests for tier.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import pytest
from unittest.mock import Mock, patch, MagicMock
from argparse import Namespace
from io import StringIO
import sys


@pytest.fixture
def mock_tier_recommender():
    """Fixture providing a mocked TierRecommender instance."""
    with patch('empathy_os.cli.commands.tier.TierRecommender') as mock_class:
        mock_instance = MagicMock()
        mock_class.return_value = mock_instance
        yield mock_instance


@pytest.fixture
def capture_output():
    """Fixture to capture stdout during test execution."""
    old_stdout = sys.stdout
    sys.stdout = StringIO()
    yield sys.stdout
    sys.stdout = old_stdout


class TestCmdTierRecommend:
    """Behavioral tests for cmd_tier_recommend function."""

    def test_given_basic_description_when_recommend_then_displays_results(
        self, mock_tier_recommender, capture_output
    ):
        """
        Given: A basic bug description without files or complexity
        When: cmd_tier_recommend is called
        Then: Display tier recommendation with all details
        """
        from empathy_os.cli.commands.tier import cmd_tier_recommend

        # Given
        args = Namespace(
            description="Fix login bug",
            files=None,
            complexity=None
        )
        
        mock_result = Mock()
        mock_result.tier = "HAIKU"
        mock_result.confidence = 0.85
        mock_result.expected_cost = 0.025
        mock_result.expected_attempts = 1.2
        mock_result.reasoning = "Simple bug fix with clear patterns"
        mock_result.similar_patterns_count = 5
        mock_result.fallback_used = False
        
        mock_tier_recommender.recommend.return_value = mock_result

        # When
        cmd_tier_recommend(args)

        # Then
        output = capture_output.getvalue()
        assert "TIER RECOMMENDATION" in output
        assert "Fix login bug" in output
        assert "HAIKU" in output
        assert "85.0%" in output
        assert "$0.025" in output
        assert "1.2" in output
        assert "Simple bug fix with clear patterns" in output
        assert "5 similar patterns" in output
        
        mock_tier_recommender.recommend.assert_called_once_with(
            bug_description="Fix login bug",
            files_affected=None,
            complexity_hint=None
        )

    def test_given_files_list_when_recommend_then_splits_files_correctly(
        self, mock_tier_recommender, capture_output
    ):
        """
        Given: A description with comma-separated files list
        When: cmd_tier_recommend is called
        Then: Files are split and passed as list to recommender
        """
        from empathy_os.cli.commands.tier import cmd_tier_recommend

        # Given
        args = Namespace(
            description="Update API endpoint",
            files="api.py,models.py,tests.py",
            complexity="medium"
        )
        
        mock_result = Mock()
        mock_result.tier = "SONNET"
        mock_result.confidence = 0.75
        mock_result.expected_cost = 0.150
        mock_result.expected_attempts = 1.5
        mock_result.reasoning = "Medium complexity API changes"
        mock_result.similar_patterns_count = 3
        mock_result.fallback_used = False
        
        mock_tier_recommender.recommend.return_value = mock_result

        # When
        cmd_tier_recommend(args)

        # Then
        mock_tier_recommender.recommend.assert_called_once_with(
            bug_description="Update API endpoint",
            files_affected=["api.py", "models.py", "tests.py"],
            complexity_hint="medium"
        )

    def test_given_high_complexity_when_recommend_then_shows_opus_tier(
        self, mock_tier_recommender, capture_output
    ):
        """
        Given: A high complexity task
        When: cmd_tier_recommend is called
        Then: OPUS tier is recommended with appropriate details
        """
        from empathy_os.cli.commands.tier import cmd_tier_recommend

        # Given
        args = Namespace(
            description="Refactor authentication system",
            files="auth.py,middleware.py,decorators.py",
            complexity="high"
        )
        
        mock_result = Mock()
        mock_result.tier = "OPUS"
        mock_result.confidence = 0.92
        mock_result.expected_cost = 0.500
        mock_result.expected_attempts = 2.0
        mock_result.reasoning = "Complex architectural changes requiring deep analysis"
        mock_result.similar_patterns_count = 10
        mock_result.fallback_used = False
        
        mock_tier_recommender.recommend.return_value = mock_result

        # When
        cmd_tier_recommend(args)

        # Then
        output = capture_output.getvalue()
        assert "OPUS" in output
        assert "92.0%" in output
        assert "$0.500" in output
        assert "2.0" in output

    def test_given_no_historical_data_when_recommend_then_shows_fallback_warning(
        self, mock_tier_recommender, capture_output
    ):
        """
        Given: No historical patterns available
        When: cmd_tier_recommend is called
        Then: Display warning about fallback being used
        """
        from empathy_os.cli.commands.tier import cmd_tier_recommend

        # Given
        args = Namespace(
            description="New type of bug",
            files=None,
            complexity=None
        )
        
        mock_result = Mock()
        mock_result.tier = "SONNET"
        mock_result.confidence = 0.50
        mock_result.expected_cost = 0.100
        mock_result.expected_attempts = 1.5
        mock_result.reasoning = "Using conservative default"
        mock_result.similar_patterns_count = 0
        mock_result.fallback_used = True
        
        mock_tier_recommender.recommend.return_value = mock_result

        # When
        cmd_tier_recommend(args)

        # Then
        output = capture_output.getvalue()
        assert "No historical data - using conservative default" in output
        assert "more patterns are collected" in output
        assert "more accurate and personalized" in output

    def test_given_empty_files_string_when_recommend_then_handles_gracefully(
        self, mock_tier_recommender, capture_output
    ):
        """
        Given: Empty string for files argument
        When: cmd_tier_recommend is called
        Then: Handles empty string without error
        """
        from empathy_os.cli.commands.tier import cmd_tier_recommend

        # Given
        args = Namespace(
            description="Quick fix",
            files="",
            complexity=None
        )
        
        mock_result = Mock()
        mock_result.tier = "HAIKU"
        mock_result.confidence = 0.80
        mock_result.expected_cost = 0.020
        mock_result.expected_attempts = 1.0
        mock_result.reasoning = "Simple fix"
        mock_result.similar_patterns_count = 2
        mock_result.fallback_used = False
        
        mock_tier_recommender.recommend.return_value = mock_result

        # When
        cmd_tier_recommend(args)

        # Then
        mock_tier_recommender.recommend.assert_called_once()
        call_args = mock_tier_recommender.recommend.call_args[1]
        assert call_args['files_affected'] == [""]

    def test_given_single_file_when_recommend_then_passes_single_element_list(
        self, mock_tier_recommender, capture_output
    ):
        """
        Given: A single file without commas
        When: cmd_tier_recommend is called
        Then: File is passed as single-element list
        """
        from empathy_os.cli.commands.tier import cmd_tier_recommend

        # Given
        args = Namespace(
            description="Fix typo",
            files="readme.md",
            complexity="low"
        )
        
        mock_result = Mock()
        mock_result.tier = "HAIKU"
        mock_result.confidence = 0.95
        mock_result.expected_cost = 0.010
        mock_result.expected_attempts = 1.0
        mock_result.reasoning = "Documentation fix"
        mock_result.similar_patterns_count = 15
        mock_result.fallback_used = False
        
        mock_tier_recommender.recommend.return_value = mock_result

        # When
        cmd_tier_recommend(args)

        # Then
        mock_tier_recommender.recommend.assert_called_once_with(
            bug_description="Fix typo",
            files_affected=["readme.md"],
            complexity_hint="low"
        )

    def test_given_very_high_confidence_when_recommend_then_displays_confidence_correctly(
        self, mock_tier_recommender, capture_output
    ):
        """
        Given: A recommendation with very high confidence
        When: cmd_tier_recommend is called
        Then: Confidence percentage is displayed with one decimal place
        """
        from empathy_os.cli.commands.tier import cmd_tier_recommend

        # Given
        args = Namespace(
            description="Standard bug",
            files=None,
            complexity=None
        )
        
        mock_result = Mock()
        mock_result.tier = "HAIKU"
        mock_result.confidence = 0.999
        mock_result.expected_cost = 0.015
        mock_result.expected_attempts = 1.0
        mock_result.reasoning = "Very common pattern"
        mock_result.similar_patterns_count = 100
        mock_result.fallback_used = False
        
        mock_tier_recommender.recommend.return_value = mock_result

        # When
        cmd_tier_recommend(args)

        # Then
        output = capture_output.getvalue()
        assert "99.9%" in output

    def test_given_zero_similar_patterns_when_recommend_then_shows_warning_message(
        self, mock_tier_recommender, capture_output
    ):
        """
        Given: Recommendation with zero similar patterns
        When: cmd_tier_recommend is called
        Then: Warning about no historical data is shown
        """
        from empathy_os.cli.commands.tier import cmd_tier_recommend

        # Given
        args = Namespace(
            description="Unique issue",
            files=None,
            complexity=None
        )
        
        mock_result = Mock()
        mock_result.tier = "SONNET"
        mock_result.confidence = 0.60
        mock_result.expected_cost = 0.100
        mock_result.expected_attempts = 1.5
        mock_result.reasoning = "No similar patterns found"
        mock_result.similar_patterns_count = 0
        mock_result.fallback_used = False
        
        mock_tier_recommender.recommend.return_value = mock_result

        # When
        cmd_tier_recommend(args)

        # Then
        output = capture_output.getvalue()
        assert "No historical data" in output


class TestCmdTierStats:
    """Behavioral tests for cmd_tier_stats function."""

    def test_given_no_patterns_when_stats_then_shows_empty_message(
        self, mock_tier_recommender, capture_output
    ):
        """
        Given: No patterns have been collected
        When: cmd_tier_stats is called
        Then: Display message about no patterns and helpful tip
        """
        from empathy_os.cli.commands.tier import cmd_tier_stats

        # Given
        args = Namespace()
        mock_tier_recommender.get_stats.return_value = {
            "total_patterns": 0
        }

        # When
        cmd_tier_stats(args)

        # Then
        output = capture_output.getvalue()
        assert "TIER PATTERN LEARNING STATS" in output
        assert "No patterns collected yet" in output
        assert "automatically collected" in output
        assert "cascading workflows" in output

    def test_given_basic_stats_when_stats_then_displays_summary(
        self, mock_tier_recommender, capture_output
    ):
        """
        Given: Basic statistics available
        When: cmd_tier_stats is called
        Then: Display total patterns and average savings
        """
        from empathy_os.cli.commands.tier import cmd_tier_stats

        # Given
        args = Namespace()
        mock_tier_recommender.get_stats.return_value = {
            "total_patterns": 25,
            "avg_savings_percent": 35.5,
            "tier_distribution": {
                "HAIKU": 15,
                "SONNET": 8,
                "OPUS": 2
            },
            "bug_type_distribution": {
                "authentication": 10,
                "database": 8,
                "ui": 7
            }
        }

        # When
        cmd_tier_stats(args)

        # Then
        output = capture_output.getvalue()
        assert "Total Patterns: 25" in output
        assert "Avg Savings:" in output

    def test_given_tier_distribution_when_stats_then_shows_tier_breakdown(
        self, mock_tier_recommender, capture_output
    ):
        """
        Given: Statistics with tier distribution
        When: cmd_tier_stats is called
        Then: Display tier distribution with counts
        """
        from empathy_os.cli.commands.tier import cmd_tier_stats

        # Given
        args = Namespace()
        mock_tier_recommender.get_stats.return_value = {
            "total_patterns": 50,
            "avg_savings_percent": 42.0,
            "tier_distribution": {
                "HAIKU": 30,
                "SONNET": 15,
                "OPUS": 5
            },
            "bug_type_distribution": {}
        }

        # When
        cmd_tier_stats(args)

        # Then
        output = capture_output.getvalue()
        assert "Total Patterns: 50" in output
        # The actual implementation may vary, but we verify the call was made
        mock_tier_recommender.get_stats.assert_called_once()

    def test_given_bug_type_distribution_when_stats_then_shows_bug_types(
        self, mock_tier_recommender, capture_output
    ):
        """
        Given: Statistics with bug type distribution
        When: cmd_tier_stats is called
        Then: Display bug type distribution
        """
        from empathy_os.cli.commands.tier import cmd_tier_stats

        # Given
        args = Namespace()
        mock_tier_recommender.get_stats.return_value = {
            "total_patterns": 100,
            "avg_savings_percent": 40.0,
            "tier_distribution": {
                "HAIKU": 60,
                "SONNET": 30,
                "OPUS": 10
            },
            "bug_type_distribution": {
                "performance": 25,
                "security": 20,
                "feature": 30,
                "bugfix": 25
            }
        }

        # When
        cmd_tier_stats(args)

        # Then
        output = capture_output.getvalue()
        assert "Total Patterns: 100" in output
        mock_tier_recommender.get_stats.assert_called_once()

    def test_given_empty_stats_dict_when_stats_then_handles_gracefully(