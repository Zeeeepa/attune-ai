"""Behavioral tests for templates.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

from __future__ import annotations

from typing import Protocol
from unittest.mock import MagicMock

import pytest

from empathy_os.prompts.context import PromptContext
from empathy_os.prompts.templates import (
    PlainTextPromptTemplate,
    PromptTemplate,
    XmlPromptTemplate,
)


# Fixtures


@pytest.fixture
def basic_context() -> PromptContext:
    """Provide a basic prompt context for testing."""
    return PromptContext(
        role="helpful assistant",
        goal="assist the user",
        instructions=["Be concise", "Be accurate"],
        constraints=["No profanity", "Be respectful"],
        input_type="text",
        input_payload="Hello world",
    )


@pytest.fixture
def minimal_context() -> PromptContext:
    """Provide a minimal prompt context with only required fields."""
    return PromptContext(
        role="assistant",
        goal="help",
        input_type="query",
        input_payload="test",
    )


@pytest.fixture
def context_with_extras() -> PromptContext:
    """Provide a context with extra metadata."""
    return PromptContext(
        role="analyst",
        goal="analyze data",
        instructions=["Review carefully"],
        constraints=["Use facts only"],
        input_type="data",
        input_payload="sample data",
        extra={"priority": "high", "category": "analysis"},
    )


@pytest.fixture
def context_with_special_chars() -> PromptContext:
    """Provide a context with special XML characters."""
    return PromptContext(
        role="parser & validator",
        goal="test <special> & \"quoted\" chars",
        instructions=["Handle & < > properly", 'Use "quotes" carefully'],
        constraints=["Don't break <xml>", "Escape & properly"],
        input_type="text",
        input_payload='<tag attr="value">content & more</tag>',
    )


@pytest.fixture
def context_with_cdata() -> PromptContext:
    """Provide a context with CDATA content."""
    return PromptContext(
        role="code reviewer",
        goal="review code",
        input_type="code",
        input_payload="if (x < y && z > 0) { return <result>; }",
    )


@pytest.fixture
def empty_lists_context() -> PromptContext:
    """Provide a context with empty instruction and constraint lists."""
    return PromptContext(
        role="assistant",
        goal="test empty lists",
        instructions=[],
        constraints=[],
        input_type="text",
        input_payload="test",
    )


# Protocol Tests


class TestPromptTemplateProtocol:
    """Test the PromptTemplate protocol."""

    def test_given_protocol_when_checking_structure_then_has_render_method(self):
        """
        Given: The PromptTemplate protocol
        When: Checking its structure
        Then: It should have a render method signature
        """
        assert hasattr(PromptTemplate, "render")
        assert callable(getattr(PromptTemplate, "render", None))

    def test_given_compliant_class_when_checking_protocol_then_is_valid(self):
        """
        Given: A class that implements the PromptTemplate protocol
        When: Checking if it's a valid implementation
        Then: It should be recognized as compliant
        """

        class CustomTemplate:
            def render(self, context: PromptContext) -> str:
                return "rendered"

        # Protocol compliance is structural, not nominal
        template = CustomTemplate()
        assert hasattr(template, "render")
        assert callable(template.render)

    def test_given_protocol_when_used_as_type_hint_then_accepts_implementations(self):
        """
        Given: The PromptTemplate protocol
        When: Used as a type hint
        Then: It should accept any compliant implementation
        """

        def use_template(template: PromptTemplate, context: PromptContext) -> str:
            return template.render(context)

        plain_template = PlainTextPromptTemplate(name="test")
        xml_template = XmlPromptTemplate(name="test")
        context = PromptContext(
            role="test", goal="test", input_type="text", input_payload="test"
        )

        # Both should work with the function
        assert isinstance(use_template(plain_template, context), str)
        assert isinstance(use_template(xml_template, context), str)


# PlainTextPromptTemplate Tests


class TestPlainTextPromptTemplateInitialization:
    """Test PlainTextPromptTemplate initialization."""

    def test_given_minimal_args_when_creating_template_then_uses_defaults(self):
        """
        Given: Only a name argument
        When: Creating a PlainTextPromptTemplate
        Then: It should use default values for optional parameters
        """
        template = PlainTextPromptTemplate(name="test")

        assert template.name == "test"
        assert template.include_role is True
        assert template.include_constraints is True

    def test_given_all_args_when_creating_template_then_sets_all_attributes(self):
        """
        Given: All constructor arguments
        When: Creating a PlainTextPromptTemplate
        Then: It should set all attributes correctly
        """
        template = PlainTextPromptTemplate(
            name="custom", include_role=False, include_constraints=False
        )

        assert template.name == "custom"
        assert template.include_role is False
        assert template.include_constraints is False


class TestPlainTextPromptTemplateRenderBasic:
    """Test basic rendering functionality of PlainTextPromptTemplate."""

    def test_given_basic_context_when_rendering_then_includes_all_sections(
        self, basic_context
    ):
        """
        Given: A basic prompt context
        When: Rendering with PlainTextPromptTemplate
        Then: It should include role, goal, instructions, constraints, and input
        """
        template = PlainTextPromptTemplate(name="test")
        result = template.render(basic_context)

        assert "You are a helpful assistant." in result
        assert "Goal: assist the user" in result
        assert "Instructions:" in result
        assert "1. Be concise" in result
        assert "2. Be accurate" in result
        assert "Guidelines:" in result
        assert "- No profanity" in result
        assert "- Be respectful" in result
        assert "Input (text):" in result
        assert "Hello world" in result

    def test_given_minimal_context_when_rendering_then_includes_required_sections(
        self, minimal_context
    ):
        """
        Given: A minimal context without optional fields
        When: Rendering with PlainTextPromptTemplate
        Then: It should include only role, goal, and input
        """
        template = PlainTextPromptTemplate(name="test")
        result = template.render(minimal_context)

        assert "You are a assistant." in result
        assert "Goal: help" in result
        assert "Input (query):" in result
        assert "test" in result

    def test_given_include_role_false_when_rendering_then_excludes_role(
        self, basic_context
    ):
        """
        Given: A template with include_role=False
        When: Rendering a context
        Then: It should not include the role section
        """
        template = PlainTextPromptTemplate(name="test", include_role=False)
        result = template.render(basic_context)

        assert "You are a" not in result
        assert "Goal: assist the user" in result

    def test_given_include_constraints_false_when_rendering_then_excludes_constraints(
        self, basic_context
    ):
        """
        Given: A template with include_constraints=False
        When: Rendering a context
        Then: It should not include the constraints section
        """
        template = PlainTextPromptTemplate(name="test", include_constraints=False)
        result = template.render(basic_context)

        assert "Guidelines:" not in result
        assert "No profanity" not in result
        assert "Instructions:" in result  # Should still have instructions

    def test_given_empty_instructions_when_rendering_then_excludes_instructions_section(
        self, empty_lists_context
    ):
        """
        Given: A context with empty instructions list
        When: Rendering
        Then: It should not include an instructions section
        """
        template = PlainTextPromptTemplate(name="test")
        result = template.render(empty_lists_context)

        assert "Instructions:" not in result
        assert "Goal: test empty lists" in result

    def test_given_empty_constraints_when_rendering_then_excludes_constraints_section(
        self, empty_lists_context
    ):
        """
        Given: A context with empty constraints list
        When: Rendering
        Then: It should not include a guidelines section
        """
        template = PlainTextPromptTemplate(name="test")
        result = template.render(empty_lists_context)

        assert "Guidelines:" not in result
        assert "Goal: test empty lists" in result


class TestPlainTextPromptTemplateRenderFormatting:
    """Test formatting and structure of PlainTextPromptTemplate output."""

    def test_given_context_when_rendering_then_uses_proper_line_breaks(
        self, basic_context
    ):
        """
        Given: A context with multiple sections
        When: Rendering
        Then: It should use proper line breaks between sections
        """
        template = PlainTextPromptTemplate(name="test")
        result = template.render(basic_context)

        # Check that sections are separated by blank lines
        lines = result.split("\n")
        assert "" in lines  # Has empty lines

    def test_given_multiple_instructions_when_rendering_then_numbers_them(
        self, basic_context
    ):
        """
        Given: A context with multiple instructions
        When: Rendering
        Then: It should number them sequentially
        """
        template = PlainTextPromptTemplate(name="test")
        result = template.render(basic_context)

        assert "1. Be concise" in result
        assert "2. Be accurate" in result

    def test_given_multiple_constraints_when_rendering_then_bullet_points_them(
        self, basic_context
    ):
        """
        Given: A context with multiple constraints
        When: Rendering
        Then: It should use bullet points for each
        """
        template = PlainTextPromptTemplate(name="test")
        result = template.render(basic_context)

        assert "- No profanity" in result
        assert "- Be respectful" in result

    def test_given_multiline_input_when_rendering_then_preserves_format(self):
        """
        Given: A context with multiline input payload
        When: Rendering
        Then: It should preserve the multiline format
        """
        context = PromptContext(
            role="test",
            goal="test",
            input_type="text",
            input_payload="Line 1\nLine 2\nLine 3",
        )
        template = PlainTextPromptTemplate(name="test")
        result = template.render(context)

        assert "Line 1\nLine 2\nLine 3" in result


# XmlPromptTemplate Tests


class TestXmlPromptTemplateInitialization:
    """Test XmlPromptTemplate initialization."""

    def test_given_minimal_args_when_creating_template_then_uses_defaults(self):
        """
        Given: Only a name argument
        When: Creating an XmlPromptTemplate
        Then: It should use default values for optional parameters
        """
        template = XmlPromptTemplate(name="test")

        assert template.name == "test"
        assert template.schema_version == "1.0"
        assert template.response_format is None
        assert template.extra_tags == {}

    def test_given_all_args_when_creating_template_then_sets_all_attributes(self):
        """
        Given: All constructor arguments
        When: Creating an XmlPromptTemplate
        Then: It should set all attributes correctly
        """
        extra = {"custom": "value"}
        template = XmlPromptTemplate(
            name="custom",
            schema_version="2.0",
            response_format="json",
            extra_tags=extra,
        )

        assert template.name == "custom"
        assert template.schema_version == "2.0"
        assert template.response_format == "json"
        assert template.extra_tags == extra

    def test_given_no_extra_tags_when_creating_template_then_creates_empty_dict(self):
        """
        Given: No extra_tags argument
        When: Creating multiple XmlPromptTemplate instances
        Then: Each should have its own empty dict (not shared)
        """
        template1 = XmlPromptTemplate(name="test1")
        template2 = XmlPromptTemplate(name="test2")

        template1.extra_tags["key"] = "value"
        assert "key" not in template2.extra_tags


class TestXmlPromptTemplateRenderBasic:
    """Test basic XML rendering functionality."""

    def test_given_basic_context_when_rendering_then_produces_valid_xml_structure(
        self, basic_context
    ):
        """
        Given: A basic prompt context
        When: Rendering with XmlPromptTemplate
        Then: It should produce a valid XML structure with all sections
        """
        template = XmlPromptTemplate(name="test")
        result = template.render(basic_context)

        assert '<request schema="1.0">' in result
        assert "<role>helpful assistant</role>" in result
        assert "<goal>assist the user</goal>" in result
        assert "<instructions>" in result
        assert "<item>Be concise</item>" in result
        assert "<item>Be accurate</item>" in result
        assert "</instructions>" in result
        assert "<constraints>" in result
        assert "<constraint>No profanity</constraint>" in result
        assert "<constraint>Be respectful</constraint>" in result
        assert "</constraints>" in result
        assert '<input type="text">' in result
        assert "Hello world" in result
        assert "</input>" in result
        assert "</request>" in result

    def test_given_minimal_context_when_rendering_then_omits_optional_sections(
        self, minimal_context
    ):
        """
        Given: A minimal context without optional fields
        When: Rendering
        Then: It should omit optional XML sections
        """
        template = XmlPromptTemplate(name="test")
        result = template.render(minimal_context)

        assert "<role>assistant</role>" in result
        assert "<goal>help</goal>" in result
        assert '<input type="query">' in result
        # Should not have empty instructions or constraints sections
        lines = [line.strip() for line in result.split("\n")]
        assert "<instructions></instructions>" not in result
        assert "<constraints></constraints>" not in result

    def test_given_custom_schema_version_when_rendering_then_uses_custom_version(
        self, basic_context
    ):
        """
        Given: A template with custom schema version
        When: Rendering
        Then: It should use the custom schema version in the XML
        """
        template = XmlPromptTemplate(name="test", schema_version="2.5")
        result = template.render(basic_context)

        assert '<request schema="2.5">' in result

    def test_given_response_format_when_rendering_then_includes_response_format_tag(
        self, basic_context
    ):
        """
        Given: A template with response_format specified
        When: Rendering
        Then: It should include a response_format tag in the XML
        """
        template = XmlPromptTemplate(name="test", response_format="json")
        result = template.render(basic_context)