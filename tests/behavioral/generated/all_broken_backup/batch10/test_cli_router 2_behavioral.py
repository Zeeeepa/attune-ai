"""Behavioral tests for cli_router 2.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import asyncio
from pathlib import Path
from typing import Any
from unittest.mock import AsyncMock, MagicMock, Mock, mock_open, patch

import pytest
import yaml

from empathy_os.cli_router_2 import HybridRouter, RoutingPreference


@pytest.fixture
def temp_preferences_path(tmp_path):
    """Given a temporary preferences file path."""
    return tmp_path / "routing_preferences.yaml"


@pytest.fixture
def sample_preferences():
    """Given sample routing preferences."""
    return {
        "commit": RoutingPreference(
            keyword="commit", skill="dev", args="commit", usage_count=5, confidence=0.95
        ),
        "test": RoutingPreference(
            keyword="test", skill="testing", args="run", usage_count=3, confidence=0.85
        ),
    }


@pytest.fixture
def mock_smart_router():
    """Given a mocked SmartRouter."""
    with patch("empathy_os.cli_router_2.SmartRouter") as mock:
        router_instance = Mock()
        mock.return_value = router_instance
        yield router_instance


@pytest.fixture
def hybrid_router(temp_preferences_path, mock_smart_router):
    """Given a HybridRouter instance with mocked dependencies."""
    return HybridRouter(preferences_path=str(temp_preferences_path))


class TestRoutingPreference:
    """Test suite for RoutingPreference dataclass."""

    def test_given_valid_data_when_creating_preference_then_initializes_correctly(self):
        """Given valid data, when creating RoutingPreference, then initializes with correct values."""
        # Given
        keyword = "commit"
        skill = "dev"
        args = "commit"
        usage_count = 10
        confidence = 0.9

        # When
        pref = RoutingPreference(
            keyword=keyword,
            skill=skill,
            args=args,
            usage_count=usage_count,
            confidence=confidence,
        )

        # Then
        assert pref.keyword == keyword
        assert pref.skill == skill
        assert pref.args == args
        assert pref.usage_count == usage_count
        assert pref.confidence == confidence

    def test_given_minimal_data_when_creating_preference_then_uses_defaults(self):
        """Given minimal data, when creating RoutingPreference, then uses default values."""
        # Given/When
        pref = RoutingPreference(keyword="test", skill="testing")

        # Then
        assert pref.keyword == "test"
        assert pref.skill == "testing"
        assert pref.args == ""
        assert pref.usage_count == 0
        assert pref.confidence == 1.0


class TestHybridRouterInitialization:
    """Test suite for HybridRouter initialization."""

    def test_given_no_path_when_initializing_then_uses_default_path(self, mock_smart_router):
        """Given no preferences path, when initializing, then uses default path."""
        # Given/When
        router = HybridRouter()

        # Then
        expected_path = Path.home() / ".empathy" / "routing_preferences.yaml"
        assert router.preferences_path == expected_path
        assert router.preferences == {}
        assert router.smart_router is not None

    def test_given_custom_path_when_initializing_then_uses_custom_path(
        self, temp_preferences_path, mock_smart_router
    ):
        """Given custom preferences path, when initializing, then uses that path."""
        # Given
        custom_path = str(temp_preferences_path)

        # When
        router = HybridRouter(preferences_path=custom_path)

        # Then
        assert router.preferences_path == temp_preferences_path

    def test_given_initialization_when_checking_keyword_mapping_then_contains_expected_keywords(
        self, hybrid_router
    ):
        """Given router initialization, when checking keyword mapping, then contains all expected keywords."""
        # Then
        assert "commit" in hybrid_router._keyword_to_skill
        assert "test" in hybrid_router._keyword_to_skill
        assert "coverage" in hybrid_router._keyword_to_skill
        assert "security" in hybrid_router._keyword_to_skill
        assert "evaluate" in hybrid_router._keyword_to_skill
        assert ("dev", "commit") == hybrid_router._keyword_to_skill["commit"]
        assert ("testing", "run") == hybrid_router._keyword_to_skill["test"]


class TestHybridRouterLoadPreferences:
    """Test suite for loading routing preferences."""

    def test_given_existing_preferences_file_when_loading_then_loads_successfully(
        self, temp_preferences_path, hybrid_router
    ):
        """Given existing preferences file, when loading, then loads preferences successfully."""
        # Given
        preferences_data = {
            "commit": {
                "keyword": "commit",
                "skill": "dev",
                "args": "commit",
                "usage_count": 5,
                "confidence": 0.95,
            }
        }
        temp_preferences_path.parent.mkdir(parents=True, exist_ok=True)
        with open(temp_preferences_path, "w") as f:
            yaml.dump(preferences_data, f)

        # When
        hybrid_router._load_preferences()

        # Then
        assert "commit" in hybrid_router.preferences
        pref = hybrid_router.preferences["commit"]
        assert pref.keyword == "commit"
        assert pref.skill == "dev"
        assert pref.usage_count == 5
        assert pref.confidence == 0.95

    def test_given_nonexistent_file_when_loading_then_continues_without_error(
        self, hybrid_router
    ):
        """Given nonexistent preferences file, when loading, then continues without error."""
        # Given - preferences file doesn't exist

        # When/Then - should not raise
        hybrid_router._load_preferences()
        assert hybrid_router.preferences == {}

    def test_given_invalid_yaml_when_loading_then_continues_without_error(
        self, temp_preferences_path, hybrid_router
    ):
        """Given invalid YAML file, when loading, then continues without error."""
        # Given
        temp_preferences_path.parent.mkdir(parents=True, exist_ok=True)
        with open(temp_preferences_path, "w") as f:
            f.write("invalid: yaml: content: [")

        # When/Then - should not raise
        hybrid_router._load_preferences()
        assert hybrid_router.preferences == {}

    def test_given_empty_file_when_loading_then_handles_gracefully(
        self, temp_preferences_path, hybrid_router
    ):
        """Given empty preferences file, when loading, then handles gracefully."""
        # Given
        temp_preferences_path.parent.mkdir(parents=True, exist_ok=True)
        temp_preferences_path.touch()

        # When
        hybrid_router._load_preferences()

        # Then
        assert hybrid_router.preferences == {}


class TestHybridRouterSavePreferences:
    """Test suite for saving routing preferences."""

    def test_given_preferences_when_saving_then_writes_to_file(
        self, temp_preferences_path, hybrid_router
    ):
        """Given preferences, when saving, then writes to file successfully."""
        # Given
        hybrid_router.preferences = {
            "commit": RoutingPreference(
                keyword="commit", skill="dev", args="commit", usage_count=5, confidence=0.95
            )
        }

        # When
        hybrid_router._save_preferences()

        # Then
        assert temp_preferences_path.exists()
        with open(temp_preferences_path) as f:
            data = yaml.safe_load(f)
        assert "commit" in data
        assert data["commit"]["skill"] == "dev"
        assert data["commit"]["usage_count"] == 5

    def test_given_empty_preferences_when_saving_then_creates_empty_file(
        self, temp_preferences_path, hybrid_router
    ):
        """Given empty preferences, when saving, then creates empty file."""
        # Given
        hybrid_router.preferences = {}

        # When
        hybrid_router._save_preferences()

        # Then
        assert temp_preferences_path.exists()

    def test_given_missing_directory_when_saving_then_creates_directory(
        self, hybrid_router, tmp_path
    ):
        """Given missing directory, when saving, then creates directory structure."""
        # Given
        new_path = tmp_path / "nested" / "dir" / "preferences.yaml"
        hybrid_router.preferences_path = new_path
        hybrid_router.preferences = {
            "test": RoutingPreference(keyword="test", skill="testing")
        }

        # When
        hybrid_router._save_preferences()

        # Then
        assert new_path.exists()
        assert new_path.parent.exists()


class TestHybridRouterSkillRouting:
    """Test suite for skill-based routing."""

    @pytest.mark.asyncio
    async def test_given_dev_skill_when_routing_then_returns_skill_invocation(
        self, hybrid_router
    ):
        """Given /dev skill, when routing, then returns correct skill invocation."""
        # Given
        input_text = "/dev"

        # When
        result = await hybrid_router.route(input_text)

        # Then
        assert result["type"] == "skill"
        assert result["skill"] == "dev"
        assert result["args"] == ""
        assert "instruction" in result
        assert "Use Skill tool" in result["instruction"]

    @pytest.mark.asyncio
    async def test_given_testing_skill_with_args_when_routing_then_includes_args(
        self, hybrid_router
    ):
        """Given /testing skill with args, when routing, then includes args in result."""
        # Given
        input_text = "/testing run unit"

        # When
        result = await hybrid_router.route(input_text)

        # Then
        assert result["type"] == "skill"
        assert result["skill"] == "testing"
        assert result["args"] == "run unit"

    @pytest.mark.asyncio
    async def test_given_workflows_skill_when_routing_then_returns_correct_invocation(
        self, hybrid_router
    ):
        """Given /workflows skill, when routing, then returns correct invocation."""
        # Given
        input_text = "/workflows"

        # When
        result = await hybrid_router.route(input_text)

        # Then
        assert result["type"] == "skill"
        assert result["skill"] == "workflows"
        assert "instruction" in result

    @pytest.mark.asyncio
    async def test_given_learning_skill_when_routing_then_returns_correct_invocation(
        self, hybrid_router
    ):
        """Given /learning skill, when routing, then returns correct invocation."""
        # Given
        input_text = "/learning"

        # When
        result = await hybrid_router.route(input_text)

        # Then
        assert result["type"] == "skill"
        assert result["skill"] == "learning"


class TestHybridRouterKeywordRouting:
    """Test suite for keyword-based routing."""

    @pytest.mark.asyncio
    async def test_given_commit_keyword_when_routing_then_maps_to_dev_skill(
        self, hybrid_router
    ):
        """Given commit keyword, when routing, then maps to dev skill."""
        # Given
        input_text = "commit"

        # When
        result = await hybrid_router.route(input_text)

        # Then
        assert result["type"] == "skill"
        assert result["skill"] == "dev"
        assert result["args"] == "commit"

    @pytest.mark.asyncio
    async def test_given_test_keyword_when_routing_then_maps_to_testing_skill(
        self, hybrid_router
    ):
        """Given test keyword, when routing, then maps to testing skill."""
        # Given
        input_text = "test"

        # When
        result = await hybrid_router.route(input_text)

        # Then
        assert result["type"] == "skill"
        assert result["skill"] == "testing"
        assert result["args"] == "run"

    @pytest.mark.asyncio
    async def test_given_security_keyword_when_routing_then_maps_to_workflows_skill(
        self, hybrid_router
    ):
        """Given security keyword, when routing, then maps to workflows skill."""
        # Given
        input_text = "security"

        # When
        result = await hybrid_router.route(input_text)

        # Then
        assert result["type"] == "skill"
        assert result["skill"] == "workflows"
        assert result["args"] == "security"

    @pytest.mark.asyncio
    async def test_given_coverage_keyword_when_routing_then_maps_to_testing_skill(
        self, hybrid_router
    ):
        """Given coverage keyword, when routing, then maps to testing skill."""
        # Given
        input_text = "coverage"

        # When
        result = await hybrid_router.route(input_text)

        # Then
        assert result["type"] == "skill"
        assert result["skill"] == "testing"
        assert result["args"] == "coverage"

    @pytest.mark.asyncio
    async def test_given_evaluate_keyword_when_routing_then_maps_to_learning_skill(
        self, hybrid_router
    ):
        """Given evaluate keyword, when routing, then maps to learning skill."""
        # Given
        input_text = "evaluate"

        # When
        result = await hybrid_router.route(input_text)

        # Then
        assert result["type"] == "skill"
        assert result["skill"] == "learning"
        assert result["args"] == "evaluate"


class TestHybridRouterNaturalLanguage:
    """Test suite for natural language routing."""

    @pytest.mark.asyncio
    async def test_given_natural_language_when_routing_then_uses_smart_router(
        self, hybrid_router, mock_smart_router
    ):
        """Given natural language input, when routing, then uses SmartRouter."""
        # Given
        input_text = "I want to commit my changes"
        mock_smart_router.route = AsyncMock(
            return_value={
                "type": "skill",
                "skill": "dev",
                "args": "commit",
                "reasoning": "User wants to commit",
                "confidence": 0.9,
            }
        )

        # When
        result = await hybrid_router.route(input_text)

        # Then
        mock_smart_router.route.assert_called_once_with(input_text)
        assert result["type"] == "skill"
        assert result["skill"] == "dev"
        assert "reasoning" in result

    @pytest.mark.asyncio
    async def test_given_complex_query_when_routing_then_returns_smart_router_result(
        self, hybrid_router, mock_smart_router
    ):
        """Given complex query, when routing, then returns SmartRouter result."""
        # Given
        input_text = "Can you help me run tests and check coverage?"
        mock_result = {
            "type": "skill",
            "skill": "testing",
            "args": "run coverage",
            "reasoning": "User wants to run tests with coverage",
            "confidence": 0.85,
        }
        mock_smart_router.route = AsyncMock(return_value=mock_result)

        # When
        result = await hybrid_router.route(input_text)

        # Then
        assert result == mock_result

    @pytest.mark.asyncio
    async def test_given_ambiguous_input_when_routing_