"""Behavioral tests for agent_templates.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import logging
from unittest.mock import MagicMock, patch

import pytest

from empathy_os.orchestration.agent_templates import (
    AgentCapability,
    AgentTemplate,
    ResourceRequirements,
    get_template,
    get_templates_by_capability,
)


class TestAgentCapability:
    """Behavioral tests for AgentCapability dataclass."""

    def test_valid_capability_creation(self):
        """Given valid capability parameters
        When creating an AgentCapability
        Then it should be created successfully with all fields set.
        """
        # Given
        name = "analyze_gaps"
        description = "Identify test coverage gaps"
        required_tools = ["coverage_analyzer", "ast_parser"]

        # When
        capability = AgentCapability(
            name=name,
            description=description,
            required_tools=required_tools
        )

        # Then
        assert capability.name == name
        assert capability.description == description
        assert capability.required_tools == required_tools

    def test_capability_with_empty_tools_list(self):
        """Given a capability with no required tools
        When creating an AgentCapability
        Then it should use an empty list by default.
        """
        # Given/When
        capability = AgentCapability(
            name="simple_task",
            description="A simple task requiring no tools"
        )

        # Then
        assert capability.required_tools == []

    def test_capability_is_frozen(self):
        """Given a created AgentCapability
        When attempting to modify its fields
        Then it should raise an error (frozen dataclass).
        """
        # Given
        capability = AgentCapability(
            name="test",
            description="test description"
        )

        # When/Then
        with pytest.raises(AttributeError):
            capability.name = "modified"

    def test_capability_with_empty_name_raises_error(self):
        """Given an empty name
        When creating an AgentCapability
        Then it should raise a ValueError.
        """
        # Given/When/Then
        with pytest.raises(ValueError, match="name must be a non-empty string"):
            AgentCapability(
                name="",
                description="valid description"
            )

    def test_capability_with_none_name_raises_error(self):
        """Given a None name
        When creating an AgentCapability
        Then it should raise a ValueError.
        """
        # Given/When/Then
        with pytest.raises(ValueError, match="name must be a non-empty string"):
            AgentCapability(
                name=None,
                description="valid description"
            )

    def test_capability_with_non_string_name_raises_error(self):
        """Given a non-string name
        When creating an AgentCapability
        Then it should raise a ValueError.
        """
        # Given/When/Then
        with pytest.raises(ValueError, match="name must be a non-empty string"):
            AgentCapability(
                name=123,
                description="valid description"
            )

    def test_capability_with_empty_description_raises_error(self):
        """Given an empty description
        When creating an AgentCapability
        Then it should raise a ValueError.
        """
        # Given/When/Then
        with pytest.raises(ValueError, match="description must be a non-empty string"):
            AgentCapability(
                name="valid_name",
                description=""
            )

    def test_capability_with_none_description_raises_error(self):
        """Given a None description
        When creating an AgentCapability
        Then it should raise a ValueError.
        """
        # Given/When/Then
        with pytest.raises(ValueError, match="description must be a non-empty string"):
            AgentCapability(
                name="valid_name",
                description=None
            )

    def test_capability_with_non_string_description_raises_error(self):
        """Given a non-string description
        When creating an AgentCapability
        Then it should raise a ValueError.
        """
        # Given/When/Then
        with pytest.raises(ValueError, match="description must be a non-empty string"):
            AgentCapability(
                name="valid_name",
                description=456
            )

    def test_capability_with_non_list_required_tools_raises_error(self):
        """Given non-list required_tools
        When creating an AgentCapability
        Then it should raise a ValueError.
        """
        # Given/When/Then
        with pytest.raises(ValueError, match="required_tools must be a list"):
            AgentCapability(
                name="valid_name",
                description="valid description",
                required_tools="not_a_list"
            )


class TestResourceRequirements:
    """Behavioral tests for ResourceRequirements dataclass."""

    def test_valid_resource_requirements_creation(self):
        """Given valid resource parameters
        When creating ResourceRequirements
        Then it should be created successfully with all fields set.
        """
        # Given
        min_tokens = 5000
        max_tokens = 50000
        timeout_seconds = 600
        memory_mb = 1024

        # When
        requirements = ResourceRequirements(
            min_tokens=min_tokens,
            max_tokens=max_tokens,
            timeout_seconds=timeout_seconds,
            memory_mb=memory_mb
        )

        # Then
        assert requirements.min_tokens == min_tokens
        assert requirements.max_tokens == max_tokens
        assert requirements.timeout_seconds == timeout_seconds
        assert requirements.memory_mb == memory_mb

    def test_resource_requirements_with_defaults(self):
        """Given no parameters
        When creating ResourceRequirements
        Then it should use default values.
        """
        # Given/When
        requirements = ResourceRequirements()

        # Then
        assert requirements.min_tokens == 1000
        assert requirements.max_tokens == 10000
        assert requirements.timeout_seconds == 300
        assert requirements.memory_mb == 512

    def test_resource_requirements_is_frozen(self):
        """Given created ResourceRequirements
        When attempting to modify its fields
        Then it should raise an error (frozen dataclass).
        """
        # Given
        requirements = ResourceRequirements()

        # When/Then
        with pytest.raises(AttributeError):
            requirements.min_tokens = 5000

    def test_resource_requirements_with_negative_min_tokens_raises_error(self):
        """Given a negative min_tokens value
        When creating ResourceRequirements
        Then it should raise a ValueError.
        """
        # Given/When/Then
        with pytest.raises(ValueError, match="min_tokens must be non-negative"):
            ResourceRequirements(min_tokens=-100)

    def test_resource_requirements_with_zero_min_tokens(self):
        """Given zero min_tokens value
        When creating ResourceRequirements
        Then it should be accepted.
        """
        # Given/When
        requirements = ResourceRequirements(min_tokens=0)

        # Then
        assert requirements.min_tokens == 0

    def test_resource_requirements_with_max_less_than_min_raises_error(self):
        """Given max_tokens less than min_tokens
        When creating ResourceRequirements
        Then it should raise a ValueError.
        """
        # Given/When/Then
        with pytest.raises(ValueError, match="max_tokens must be >= min_tokens"):
            ResourceRequirements(min_tokens=10000, max_tokens=5000)

    def test_resource_requirements_with_equal_min_max_tokens(self):
        """Given equal min_tokens and max_tokens
        When creating ResourceRequirements
        Then it should be accepted.
        """
        # Given/When
        requirements = ResourceRequirements(min_tokens=5000, max_tokens=5000)

        # Then
        assert requirements.min_tokens == 5000
        assert requirements.max_tokens == 5000

    def test_resource_requirements_with_zero_timeout_raises_error(self):
        """Given zero timeout_seconds
        When creating ResourceRequirements
        Then it should raise a ValueError.
        """
        # Given/When/Then
        with pytest.raises(ValueError, match="timeout_seconds must be positive"):
            ResourceRequirements(timeout_seconds=0)

    def test_resource_requirements_with_negative_timeout_raises_error(self):
        """Given negative timeout_seconds
        When creating ResourceRequirements
        Then it should raise a ValueError.
        """
        # Given/When/Then
        with pytest.raises(ValueError, match="timeout_seconds must be positive"):
            ResourceRequirements(timeout_seconds=-100)

    def test_resource_requirements_with_zero_memory_raises_error(self):
        """Given zero memory_mb
        When creating ResourceRequirements
        Then it should raise a ValueError.
        """
        # Given/When/Then
        with pytest.raises(ValueError, match="memory_mb must be positive"):
            ResourceRequirements(memory_mb=0)

    def test_resource_requirements_with_negative_memory_raises_error(self):
        """Given negative memory_mb
        When creating ResourceRequirements
        Then it should raise a ValueError.
        """
        # Given/When/Then
        with pytest.raises(ValueError, match="memory_mb must be positive"):
            ResourceRequirements(memory_mb=-512)


class TestAgentTemplate:
    """Behavioral tests for AgentTemplate dataclass."""

    @pytest.fixture
    def sample_capability(self):
        """Fixture providing a sample AgentCapability."""
        return AgentCapability(
            name="analyze_gaps",
            description="Identify test coverage gaps",
            required_tools=["coverage_analyzer"]
        )

    @pytest.fixture
    def sample_resource_requirements(self):
        """Fixture providing sample ResourceRequirements."""
        return ResourceRequirements(
            min_tokens=2000,
            max_tokens=20000,
            timeout_seconds=600,
            memory_mb=1024
        )

    def test_valid_agent_template_creation(
        self, sample_capability, sample_resource_requirements
    ):
        """Given valid template parameters
        When creating an AgentTemplate
        Then it should be created successfully with all fields set.
        """
        # Given
        template_id = "test_coverage_analyzer"
        role = "Test Coverage Expert"
        capabilities = [sample_capability]
        resources = sample_resource_requirements

        # When
        template = AgentTemplate(
            id=template_id,
            role=role,
            capabilities=capabilities,
            resources=resources
        )

        # Then
        assert template.id == template_id
        assert template.role == role
        assert template.capabilities == capabilities
        assert template.resources == resources

    def test_agent_template_is_frozen(self, sample_capability):
        """Given a created AgentTemplate
        When attempting to modify its fields
        Then it should raise an error (frozen dataclass).
        """
        # Given
        template = AgentTemplate(
            id="test_template",
            role="Test Role",
            capabilities=[sample_capability],
            resources=ResourceRequirements()
        )

        # When/Then
        with pytest.raises(AttributeError):
            template.id = "modified_id"

    def test_agent_template_with_multiple_capabilities(self):
        """Given multiple capabilities
        When creating an AgentTemplate
        Then all capabilities should be stored.
        """
        # Given
        cap1 = AgentCapability(
            name="analyze_gaps",
            description="Analyze gaps",
            required_tools=["tool1"]
        )
        cap2 = AgentCapability(
            name="generate_tests",
            description="Generate tests",
            required_tools=["tool2"]
        )
        capabilities = [cap1, cap2]

        # When
        template = AgentTemplate(
            id="multi_cap_template",
            role="Multi-Capability Agent",
            capabilities=capabilities,
            resources=ResourceRequirements()
        )

        # Then
        assert len(template.capabilities) == 2
        assert cap1 in template.capabilities
        assert cap2 in template.capabilities

    def test_agent_template_with_empty_capabilities(self):
        """Given an empty capabilities list
        When creating an AgentTemplate
        Then it should be accepted.
        """
        # Given/When
        template = AgentTemplate(
            id="no_cap_template",
            role="No Capabilities Agent",
            capabilities=[],
            resources=ResourceRequirements()
        )

        # Then
        assert template.capabilities == []


class TestGetTemplate:
    """Behavioral tests for get_template function."""

    @patch('empathy_os.orchestration.agent_templates.AGENT_TEMPLATES')
    def test_get_existing_template(self, mock_templates):
        """Given an existing template ID
        When calling get_template
        Then it should return the corresponding template.
        """
        # Given
        template_id = "test_coverage_analyzer"
        expected_template = AgentTemplate(
            id=template_id,
            role="Test Coverage Expert",
            capabilities=[],
            resources=ResourceRequirements()
        )
        mock_templates.__getitem__.return_value = expected_template

        # When
        result = get_template(template_id)

        # Then
        assert result == expected_template
        mock_templates.__getitem__.assert_called_once_with(template_id)

    @patch('empathy_os.orchestration.agent_templates.AGENT_TEMPLATES')
    def test_get_non_existing_template_raises_key_error(self, mock_templates):
        """Given a non-existing template ID
        When calling get_template
        Then it should raise a KeyError.
        """
        # Given
        template_id = "non_existing_template"
        mock_templates.__getitem__.side_effect = KeyError(template_id)

        # When/Then
        with pytest.raises(KeyError):
            get_template(template_id)

    @patch('empathy_os.orchestration.agent_templates.AGENT_TEMPLATES')
    def test_get_template_with_empty_string_raises_key_error(self, mock_templates):
        """Given an empty string as template ID
        When calling get_template
        Then it should raise a KeyError.
        """
        # Given
        template_id = ""
        mock_templates.__getitem__.side_effect = KeyError(template_id)

        # When/Then
        with pytest.raises(KeyError):
            get_template(template_id)

    @patch('empathy_os.orchestration.agent_templates.AGENT_TEMPLATES')
    def test_get_template_with_none_raises_error(self, mock_templates):
        """Given None as template ID
        When calling get_template
        Then it should raise a TypeError or KeyError.
        """
        # Given
        template_id = None
        mock_templates.__getitem__.side_effect = TypeError("unhashable type")

        # When/Then
        with pytest.raises((TypeError, KeyError)):
            get_template(template_id)


class TestGetTemplatesByCapability:
    """Behavioral tests for get_templates_by_capability function."""

    @pytest.fixture
    def sample_templates(self):
        """Fixture providing sample templates."""
        cap1 = AgentCapability(
            name="analyze_gaps",
            description="Analyze gaps",
            required_tools=["tool1"]
        )
        cap2 = AgentCapability(
            name="generate_tests",
            description="Generate tests",
            required_tools=["tool2"]
        )
        cap3 = AgentCapability(
            name="analyze_gaps",
            description="Another gap analyzer",
            required_tools=["tool3"]
        )

        template1 = AgentTemplate(
            id="template1",
            role="Role 1",
            capabilities=[cap1],
            resources=ResourceRequirements()
        )
        template