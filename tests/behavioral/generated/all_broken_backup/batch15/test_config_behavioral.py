"""Behavioral tests for config.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import os
from unittest.mock import MagicMock, patch

import pytest

from empathy_os.memory.config import get_redis_config, get_redis_memory, parse_redis_url


class TestParseRedisUrl:
    """Behavioral tests for parse_redis_url function."""

    def test_given_full_redis_url_when_parsed_then_returns_all_components(self):
        """Given a complete Redis URL with all components.
        When parsed
        Then returns dict with host, port, password, and db.
        """
        # Given
        url = "redis://user:mypassword@redis.example.com:6380/2"

        # When
        result = parse_redis_url(url)

        # Then
        assert result["host"] == "redis.example.com"
        assert result["port"] == 6380
        assert result["password"] == "mypassword"
        assert result["db"] == 2

    def test_given_minimal_redis_url_when_parsed_then_returns_defaults(self):
        """Given a minimal Redis URL with only host.
        When parsed
        Then returns defaults for missing components.
        """
        # Given
        url = "redis://localhost"

        # When
        result = parse_redis_url(url)

        # Then
        assert result["host"] == "localhost"
        assert result["port"] == 6379
        assert result["password"] is None
        assert result["db"] == 0

    def test_given_url_without_db_when_parsed_then_defaults_to_zero(self):
        """Given a Redis URL without database number.
        When parsed
        Then defaults db to 0.
        """
        # Given
        url = "redis://localhost:6379"

        # When
        result = parse_redis_url(url)

        # Then
        assert result["db"] == 0

    def test_given_url_with_db_in_path_when_parsed_then_extracts_db_number(self):
        """Given a Redis URL with database in path.
        When parsed
        Then correctly extracts database number.
        """
        # Given
        url = "redis://localhost:6379/5"

        # When
        result = parse_redis_url(url)

        # Then
        assert result["db"] == 5

    def test_given_url_without_password_when_parsed_then_password_is_none(self):
        """Given a Redis URL without password.
        When parsed
        Then password is None.
        """
        # Given
        url = "redis://localhost:6379"

        # When
        result = parse_redis_url(url)

        # Then
        assert result["password"] is None

    def test_given_url_with_special_characters_in_password_when_parsed_then_preserves_password(
        self,
    ):
        """Given a Redis URL with special characters in password.
        When parsed
        Then preserves the password correctly.
        """
        # Given
        url = "redis://user:p@ssw0rd!@localhost:6379"

        # When
        result = parse_redis_url(url)

        # Then
        assert result["password"] == "p@ssw0rd!"

    def test_given_url_with_custom_port_when_parsed_then_extracts_port(self):
        """Given a Redis URL with custom port.
        When parsed
        Then extracts the custom port.
        """
        # Given
        url = "redis://localhost:7000"

        # When
        result = parse_redis_url(url)

        # Then
        assert result["port"] == 7000

    def test_given_url_without_host_when_parsed_then_defaults_to_localhost(self):
        """Given a Redis URL without explicit host.
        When parsed
        Then defaults to localhost.
        """
        # Given
        url = "redis://:6379"

        # When
        result = parse_redis_url(url)

        # Then
        assert result["host"] == "localhost"


class TestGetRedisConfig:
    """Behavioral tests for get_redis_config function."""

    def test_given_mock_mode_enabled_when_config_requested_then_returns_mock_flag(self):
        """Given EMPATHY_REDIS_MOCK environment variable is set to true.
        When get_redis_config is called
        Then returns dict with use_mock=True.
        """
        # Given
        with patch.dict(os.environ, {"EMPATHY_REDIS_MOCK": "true"}):
            # When
            result = get_redis_config()

            # Then
            assert result == {"use_mock": True}

    def test_given_mock_mode_true_uppercase_when_config_requested_then_returns_mock_flag(self):
        """Given EMPATHY_REDIS_MOCK is set to TRUE (uppercase).
        When get_redis_config is called
        Then returns dict with use_mock=True.
        """
        # Given
        with patch.dict(os.environ, {"EMPATHY_REDIS_MOCK": "TRUE"}):
            # When
            result = get_redis_config()

            # Then
            assert result == {"use_mock": True}

    def test_given_redis_url_env_var_when_config_requested_then_parses_url(self):
        """Given REDIS_URL environment variable is set.
        When get_redis_config is called
        Then parses URL and returns config with use_mock=False.
        """
        # Given
        test_url = "redis://user:pass@example.com:6380/1"
        with patch.dict(os.environ, {"REDIS_URL": test_url}, clear=True):
            # When
            result = get_redis_config()

            # Then
            assert result["host"] == "example.com"
            assert result["port"] == 6380
            assert result["password"] == "pass"
            assert result["db"] == 1
            assert result["use_mock"] is False

    def test_given_redis_public_url_when_redis_url_absent_then_uses_public_url(self):
        """Given REDIS_PUBLIC_URL is set but REDIS_URL is not.
        When get_redis_config is called
        Then uses REDIS_PUBLIC_URL.
        """
        # Given
        test_url = "redis://public.example.com:6379"
        with patch.dict(os.environ, {"REDIS_PUBLIC_URL": test_url}, clear=True):
            # When
            result = get_redis_config()

            # Then
            assert result["host"] == "public.example.com"
            assert result["use_mock"] is False

    def test_given_redis_private_url_when_others_absent_then_uses_private_url(self):
        """Given REDIS_PRIVATE_URL is set but REDIS_URL and REDIS_PUBLIC_URL are not.
        When get_redis_config is called
        Then uses REDIS_PRIVATE_URL.
        """
        # Given
        test_url = "redis://private.example.com:6379"
        with patch.dict(os.environ, {"REDIS_PRIVATE_URL": test_url}, clear=True):
            # When
            result = get_redis_config()

            # Then
            assert result["host"] == "private.example.com"
            assert result["use_mock"] is False

    def test_given_multiple_url_vars_when_config_requested_then_prioritizes_redis_url(self):
        """Given multiple Redis URL environment variables are set.
        When get_redis_config is called
        Then prioritizes REDIS_URL over others.
        """
        # Given
        with patch.dict(
            os.environ,
            {
                "REDIS_URL": "redis://primary.example.com:6379",
                "REDIS_PUBLIC_URL": "redis://public.example.com:6379",
                "REDIS_PRIVATE_URL": "redis://private.example.com:6379",
            },
            clear=True,
        ):
            # When
            result = get_redis_config()

            # Then
            assert result["host"] == "primary.example.com"

    def test_given_individual_env_vars_when_config_requested_then_uses_env_vars(self):
        """Given individual Redis environment variables are set.
        When get_redis_config is called
        Then constructs config from individual vars.
        """
        # Given
        with patch.dict(
            os.environ,
            {
                "REDIS_HOST": "custom.host.com",
                "REDIS_PORT": "7000",
                "REDIS_PASSWORD": "secret123",
                "REDIS_DB": "3",
            },
            clear=True,
        ):
            # When
            result = get_redis_config()

            # Then
            assert result["host"] == "custom.host.com"
            assert result["port"] == 7000
            assert result["password"] == "secret123"
            assert result["db"] == 3
            assert result["use_mock"] is False

    def test_given_no_env_vars_when_config_requested_then_returns_defaults(self):
        """Given no Redis environment variables are set.
        When get_redis_config is called
        Then returns default configuration.
        """
        # Given
        with patch.dict(os.environ, {}, clear=True):
            # When
            result = get_redis_config()

            # Then
            assert result["host"] == "localhost"
            assert result["port"] == 6379
            assert result["password"] is None
            assert result["db"] == 0
            assert result["use_mock"] is False

    def test_given_partial_env_vars_when_config_requested_then_fills_defaults(self):
        """Given only some individual Redis env vars are set.
        When get_redis_config is called
        Then fills in defaults for missing vars.
        """
        # Given
        with patch.dict(os.environ, {"REDIS_HOST": "myhost.com"}, clear=True):
            # When
            result = get_redis_config()

            # Then
            assert result["host"] == "myhost.com"
            assert result["port"] == 6379  # default
            assert result["password"] is None  # default
            assert result["db"] == 0  # default


class TestGetRedisMemory:
    """Behavioral tests for get_redis_memory function."""

    @patch("empathy_os.memory.config.RedisShortTermMemory")
    def test_given_explicit_url_when_memory_created_then_uses_provided_url(
        self, mock_redis_memory
    ):
        """Given an explicit URL is provided.
        When get_redis_memory is called
        Then creates memory instance with parsed URL config.
        """
        # Given
        mock_instance = MagicMock()
        mock_redis_memory.return_value = mock_instance
        test_url = "redis://explicit.host.com:6380/2"

        # When
        result = get_redis_memory(url=test_url)

        # Then
        mock_redis_memory.assert_called_once()
        call_kwargs = mock_redis_memory.call_args[1]
        assert call_kwargs["host"] == "explicit.host.com"
        assert call_kwargs["port"] == 6380
        assert call_kwargs["db"] == 2
        assert result == mock_instance

    @patch("empathy_os.memory.config.RedisShortTermMemory")
    def test_given_explicit_mock_true_when_memory_created_then_uses_mock_mode(
        self, mock_redis_memory
    ):
        """Given use_mock is explicitly set to True.
        When get_redis_memory is called
        Then creates memory instance in mock mode.
        """
        # Given
        mock_instance = MagicMock()
        mock_redis_memory.return_value = mock_instance

        # When
        with patch.dict(os.environ, {}, clear=True):
            result = get_redis_memory(use_mock=True)

        # Then
        mock_redis_memory.assert_called_once()
        call_kwargs = mock_redis_memory.call_args[1]
        assert call_kwargs["use_mock"] is True
        assert result == mock_instance

    @patch("empathy_os.memory.config.RedisShortTermMemory")
    def test_given_explicit_mock_false_when_memory_created_then_disables_mock_mode(
        self, mock_redis_memory
    ):
        """Given use_mock is explicitly set to False.
        When get_redis_memory is called
        Then creates memory instance with mock mode disabled.
        """
        # Given
        mock_instance = MagicMock()
        mock_redis_memory.return_value = mock_instance

        # When
        with patch.dict(os.environ, {"EMPATHY_REDIS_MOCK": "true"}):
            result = get_redis_memory(use_mock=False)

        # Then
        mock_redis_memory.assert_called_once()
        call_kwargs = mock_redis_memory.call_args[1]
        assert call_kwargs["use_mock"] is False
        assert result == mock_instance

    @patch("empathy_os.memory.config.RedisShortTermMemory")
    def test_given_env_vars_when_memory_created_then_uses_env_config(self, mock_redis_memory):
        """Given environment variables are set.
        When get_redis_memory is called without arguments
        Then uses configuration from environment.
        """
        # Given
        mock_instance = MagicMock()
        mock_redis_memory.return_value = mock_instance

        # When
        with patch.dict(
            os.environ,
            {
                "REDIS_HOST": "env.host.com",
                "REDIS_PORT": "6380",
                "REDIS_DB": "1",
            },
            clear=True,
        ):
            result = get_redis_memory()

        # Then
        mock_redis_memory.assert_called_once()
        call_kwargs = mock_redis_memory.call_args[1]
        assert call_kwargs["host"] == "env.host.com"
        assert call_kwargs["port"] == 6380
        assert call_kwargs["db"] == 1
        assert result == mock_instance

    @patch("empathy_os.memory.config.RedisShortTermMemory")
    def test_given_redis_url_env_when_memory_created_then_parses_url(self, mock_redis_memory):
        """Given REDIS_URL environment variable is set.
        When get_redis_memory is called
        Then parses URL and creates memory instance.
        """
        # Given
        mock_instance = MagicMock()
        mock_redis_memory.return_value = mock_instance
        test_url = "redis://user:pass@urlhost.com:6380/2"

        # When
        with patch.dict(os.environ, {"REDIS_URL": test_url}, clear=True):
            result = get_redis_memory()

        # Then
        mock_redis_memory.assert_called_once()
        call_kwargs = mock_redis_memory.call_args[1]
        assert call_kwargs["host"] == "urlhost.com"
        assert call_kwargs["port"] == 6380
        assert call_kwargs["password"] == "pass"
        assert call_kwargs["db"] == 2
        assert result == mock_instance

    @patch("empathy_os.memory.config.RedisShortTermMemory")
    def test_given_mock_env_var_when_memory_created_then_uses_mock_mode(self, mock_redis_memory):
        """Given EMPATHY_REDIS_MOCK environment variable is true.
        When get_redis_memory is called
        Then creates memory instance in mock mode.
        """
        # Given
        mock_instance = Mag