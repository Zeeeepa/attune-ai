"""Behavioral tests for helpers.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import pytest
from pathlib import Path
from unittest.mock import Mock, patch, call
from empathy_os.cli.utils.helpers import _file_exists, _show_achievements


class TestFileExists:
    """Behavioral tests for _file_exists function."""

    def test_given_existing_file_when_checked_then_returns_true(self, tmp_path):
        """Given an existing file, when checked for existence, then returns True."""
        # Given
        test_file = tmp_path / "test.txt"
        test_file.write_text("test content")

        # When
        result = _file_exists(str(test_file))

        # Then
        assert result is True

    def test_given_nonexistent_file_when_checked_then_returns_false(self, tmp_path):
        """Given a nonexistent file, when checked for existence, then returns False."""
        # Given
        test_file = tmp_path / "nonexistent.txt"

        # When
        result = _file_exists(str(test_file))

        # Then
        assert result is False

    def test_given_existing_directory_when_checked_then_returns_true(self, tmp_path):
        """Given an existing directory, when checked for existence, then returns True."""
        # Given
        test_dir = tmp_path / "test_dir"
        test_dir.mkdir()

        # When
        result = _file_exists(str(test_dir))

        # Then
        assert result is True

    def test_given_empty_path_when_checked_then_returns_false(self):
        """Given an empty path string, when checked for existence, then returns False."""
        # Given
        empty_path = ""

        # When
        result = _file_exists(empty_path)

        # Then
        assert result is False

    def test_given_relative_path_when_checked_then_handles_correctly(self, tmp_path):
        """Given a relative path, when checked for existence, then handles correctly."""
        # Given
        test_file = tmp_path / "relative.txt"
        test_file.write_text("content")
        
        # When
        with patch.object(Path, 'exists', return_value=True) as mock_exists:
            result = _file_exists("./relative.txt")
        
        # Then
        assert result is True

    def test_given_absolute_path_when_checked_then_handles_correctly(self, tmp_path):
        """Given an absolute path, when checked for existence, then handles correctly."""
        # Given
        test_file = tmp_path / "absolute.txt"
        test_file.write_text("content")

        # When
        result = _file_exists(str(test_file))

        # Then
        assert result is True

    def test_given_path_with_special_characters_when_checked_then_handles_correctly(self, tmp_path):
        """Given a path with special characters, when checked, then handles correctly."""
        # Given
        test_file = tmp_path / "file with spaces.txt"
        test_file.write_text("content")

        # When
        result = _file_exists(str(test_file))

        # Then
        assert result is True

    def test_given_symlink_when_checked_then_returns_true(self, tmp_path):
        """Given a symbolic link, when checked for existence, then returns True."""
        # Given
        original_file = tmp_path / "original.txt"
        original_file.write_text("content")
        symlink = tmp_path / "symlink.txt"
        symlink.symlink_to(original_file)

        # When
        result = _file_exists(str(symlink))

        # Then
        assert result is True


class TestShowAchievements:
    """Behavioral tests for _show_achievements function."""

    @pytest.fixture
    def mock_engine(self):
        """Create a mock engine with default stats."""
        engine = Mock()
        engine.get_stats.return_value = {
            "total_commands": 0,
            "command_counts": {},
            "patterns_learned": 0,
            "days_active": 0,
        }
        return engine

    def test_given_no_commands_when_showing_achievements_then_no_output(self, mock_engine, capsys):
        """Given no commands run, when showing achievements, then no output is displayed."""
        # Given
        mock_engine.get_stats.return_value = {
            "total_commands": 0,
            "command_counts": {},
            "patterns_learned": 0,
            "days_active": 0,
        }

        # When
        _show_achievements(mock_engine)

        # Then
        captured = capsys.readouterr()
        assert "ACHIEVEMENTS UNLOCKED" not in captured.out

    def test_given_one_command_when_showing_achievements_then_shows_first_steps(self, mock_engine, capsys):
        """Given one command run, when showing achievements, then shows First Steps."""
        # Given
        mock_engine.get_stats.return_value = {
            "total_commands": 1,
            "command_counts": {},
            "patterns_learned": 0,
            "days_active": 0,
        }

        # When
        _show_achievements(mock_engine)

        # Then
        captured = capsys.readouterr()
        assert "ACHIEVEMENTS UNLOCKED" in captured.out
        assert "First Steps" in captured.out
        assert "Ran your first command" in captured.out

    def test_given_ten_commands_when_showing_achievements_then_shows_getting_started(self, mock_engine, capsys):
        """Given ten commands run, when showing achievements, then shows Getting Started."""
        # Given
        mock_engine.get_stats.return_value = {
            "total_commands": 10,
            "command_counts": {},
            "patterns_learned": 0,
            "days_active": 0,
        }

        # When
        _show_achievements(mock_engine)

        # Then
        captured = capsys.readouterr()
        assert "Getting Started" in captured.out
        assert "Ran 10+ commands" in captured.out

    def test_given_fifty_commands_when_showing_achievements_then_shows_power_user(self, mock_engine, capsys):
        """Given fifty commands run, when showing achievements, then shows Power User."""
        # Given
        mock_engine.get_stats.return_value = {
            "total_commands": 50,
            "command_counts": {},
            "patterns_learned": 0,
            "days_active": 0,
        }

        # When
        _show_achievements(mock_engine)

        # Then
        captured = capsys.readouterr()
        assert "Power User" in captured.out
        assert "Ran 50+ commands" in captured.out

    def test_given_hundred_commands_when_showing_achievements_then_shows_expert(self, mock_engine, capsys):
        """Given hundred commands run, when showing achievements, then shows Expert."""
        # Given
        mock_engine.get_stats.return_value = {
            "total_commands": 100,
            "command_counts": {},
            "patterns_learned": 0,
            "days_active": 0,
        }

        # When
        _show_achievements(mock_engine)

        # Then
        captured = capsys.readouterr()
        assert "Expert" in captured.out
        assert "Ran 100+ commands" in captured.out

    def test_given_learn_command_used_when_showing_achievements_then_shows_pattern_learner(self, mock_engine, capsys):
        """Given learn command used, when showing achievements, then shows Pattern Learner."""
        # Given
        mock_engine.get_stats.return_value = {
            "total_commands": 5,
            "command_counts": {"learn": 1},
            "patterns_learned": 0,
            "days_active": 0,
        }

        # When
        _show_achievements(mock_engine)

        # Then
        captured = capsys.readouterr()
        assert "Pattern Learner" in captured.out
        assert "Learned from git history" in captured.out

    def test_given_sync_claude_used_when_showing_achievements_then_shows_claude_whisperer(self, mock_engine, capsys):
        """Given sync-claude command used, when showing achievements, then shows Claude Whisperer."""
        # Given
        mock_engine.get_stats.return_value = {
            "total_commands": 5,
            "command_counts": {"sync-claude": 1},
            "patterns_learned": 0,
            "days_active": 0,
        }

        # When
        _show_achievements(mock_engine)

        # Then
        captured = capsys.readouterr()
        assert "Claude Whisperer" in captured.out
        assert "Synced patterns to Claude" in captured.out

    def test_given_morning_command_used_five_times_when_showing_achievements_then_shows_early_bird(self, mock_engine, capsys):
        """Given morning command used 5+ times, when showing achievements, then shows Early Bird."""
        # Given
        mock_engine.get_stats.return_value = {
            "total_commands": 10,
            "command_counts": {"morning": 5},
            "patterns_learned": 0,
            "days_active": 0,
        }

        # When
        _show_achievements(mock_engine)

        # Then
        captured = capsys.readouterr()
        assert "Early Bird" in captured.out
        assert "Used morning briefing 5+ times" in captured.out

    def test_given_ship_command_used_ten_times_when_showing_achievements_then_shows_quality_shipper(self, mock_engine, capsys):
        """Given ship command used 10+ times, when showing achievements, then shows Quality Shipper."""
        # Given
        mock_engine.get_stats.return_value = {
            "total_commands": 15,
            "command_counts": {"ship": 10},
            "patterns_learned": 0,
            "days_active": 0,
        }

        # When
        _show_achievements(mock_engine)

        # Then
        captured = capsys.readouterr()
        assert "Quality Shipper" in captured.out
        assert "Used pre-commit checks 10+ times" in captured.out

    def test_given_health_and_fix_all_used_when_showing_achievements_then_shows_code_doctor(self, mock_engine, capsys):
        """Given health and fix-all commands used, when showing achievements, then shows Code Doctor."""
        # Given
        mock_engine.get_stats.return_value = {
            "total_commands": 10,
            "command_counts": {"health": 1, "fix-all": 1},
            "patterns_learned": 0,
            "days_active": 0,
        }

        # When
        _show_achievements(mock_engine)

        # Then
        captured = capsys.readouterr()
        assert "Code Doctor" in captured.out
        assert "Used health checks and fixes" in captured.out

    def test_given_ten_patterns_learned_when_showing_achievements_then_shows_pattern_master(self, mock_engine, capsys):
        """Given 10+ patterns learned, when showing achievements, then shows Pattern Master."""
        # Given
        mock_engine.get_stats.return_value = {
            "total_commands": 5,
            "command_counts": {},
            "patterns_learned": 10,
            "days_active": 0,
        }

        # When
        _show_achievements(mock_engine)

        # Then
        captured = capsys.readouterr()
        assert "Pattern Master" in captured.out
        assert "Learned 10+ patterns" in captured.out

    def test_given_seven_days_active_when_showing_achievements_then_shows_week_warrior(self, mock_engine, capsys):
        """Given 7+ days active, when showing achievements, then shows Week Warrior."""
        # Given
        mock_engine.get_stats.return_value = {
            "total_commands": 5,
            "command_counts": {},
            "patterns_learned": 0,
            "days_active": 7,
        }

        # When
        _show_achievements(mock_engine)

        # Then
        captured = capsys.readouterr()
        assert "Week Warrior" in captured.out
        assert "Active for 7+ days" in captured.out

    def test_given_thirty_days_active_when_showing_achievements_then_shows_monthly_maven(self, mock_engine, capsys):
        """Given 30+ days active, when showing achievements, then shows Monthly Maven."""
        # Given
        mock_engine.get_stats.return_value = {
            "total_commands": 5,
            "command_counts": {},
            "patterns_learned": 0,
            "days_active": 30,
        }

        # When
        _show_achievements(mock_engine)

        # Then
        captured = capsys.readouterr()
        assert "Monthly Maven" in captured.out
        assert "Active for 30+ days" in captured.out

    def test_given_multiple_achievements_when_showing_then_displays_all(self, mock_engine, capsys):
        """Given multiple achievements unlocked, when showing, then displays all."""
        # Given
        mock_engine.get_stats.return_value = {
            "total_commands": 100,
            "command_counts": {
                "learn": 5,
                "sync-claude": 2,
                "morning": 10,
                "ship": 15,
                "health": 3,
                "fix-all": 2,
            },
            "patterns_learned": 20,
            "days_active": 45,
        }

        # When
        _show_achievements(mock_engine)

        # Then
        captured = capsys.readouterr()
        assert "First Steps" in captured.out
        assert "Getting Started" in captured.out
        assert "Power User" in captured.out
        assert "Expert" in captured.out
        assert "Pattern Learner" in captured.out
        assert "Claude Whisperer" in captured.out
        assert "Early Bird" in captured.out
        assert "Quality Shipper" in captured.out
        assert "Code Doctor" in captured.out
        assert "Pattern Master" in captured.out
        assert "Week Warrior" in captured.out
        assert "Monthly Maven" in captured.out

    def test_given_engine_get_stats_called_when_showing_achievements_then_calls_once(self, mock_engine):
        """Given engine, when showing achievements, then get_stats is called once."""
        # Given
        mock_engine.get_stats.return_value = {
            "total_commands": 0,
            "command_counts": {},
            "patterns_learned": 0,
            "days_active": 0,
        }

        # When
        _show_achievements(mock_engine)

        # Then
        mock_engine.get_stats.assert_called_once()

    def test_given_missing_stats_fields_when_showing_achievements_then_handles_gracefully(self, mock_engine, capsys):
        """Given missing stats fields, when showing achievements, then handles gracefully."""
        # Given
        mock_engine.get_stats.return_value = {}

        # When
        _show_achievements(mock_engine)

        # Then
        captured = capsys.readouterr()
        assert "ACHIEVEMENTS UNLOCKED" not in captured.out

    def test_given_edge_case_values_when_showing_achievements_then_handles_correctly(self, mock_engine, capsys):
        """Given edge case values, when showing achievements, then handles