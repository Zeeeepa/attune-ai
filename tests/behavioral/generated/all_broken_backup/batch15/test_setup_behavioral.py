"""Behavioral tests for setup.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import sys
from argparse import Namespace
from pathlib import Path
from unittest.mock import MagicMock, Mock, call, patch

import pytest

from empathy_os.cli.commands.setup import cmd_init, cmd_validate


@pytest.fixture
def mock_logger():
    """Fixture to mock the logger."""
    with patch("empathy_os.cli.commands.setup.logger") as mock_log:
        yield mock_log


@pytest.fixture
def mock_empathy_config():
    """Fixture to mock EmpathyConfig class."""
    with patch("empathy_os.cli.commands.setup.EmpathyConfig") as mock_config_class:
        mock_instance = MagicMock()
        mock_config_class.return_value = mock_instance
        yield mock_config_class, mock_instance


@pytest.fixture
def mock_validate_file_path():
    """Fixture to mock _validate_file_path function."""
    with patch("empathy_os.cli.commands.setup._validate_file_path") as mock_validate:
        mock_validate.side_effect = lambda x: Path(x)
        yield mock_validate


@pytest.fixture
def mock_load_config():
    """Fixture to mock load_config function."""
    with patch("empathy_os.cli.commands.setup.load_config") as mock_load:
        mock_config = MagicMock()
        mock_config.user_id = "test_user"
        mock_config.target_level = 5
        mock_config.confidence_threshold = 0.75
        mock_config.persistence_backend = "sqlite"
        mock_config.metrics_enabled = True
        mock_load.return_value = mock_config
        yield mock_load, mock_config


class TestCmdInit:
    """Test suite for cmd_init function."""

    def test_given_yaml_format_when_init_then_creates_yaml_config(
        self, mock_logger, mock_empathy_config, mock_validate_file_path
    ):
        """
        Given: Arguments with yaml format and no output path specified
        When: cmd_init is called
        Then: Creates default YAML configuration file
        """
        # Given
        mock_config_class, mock_config_instance = mock_empathy_config
        args = Namespace(format="yaml", output=None)

        # When
        cmd_init(args)

        # Then
        mock_validate_file_path.assert_called_once_with("empathy.config.yaml")
        mock_config_class.assert_called_once()
        mock_config_instance.to_yaml.assert_called_once()
        assert mock_logger.info.call_count >= 4

    def test_given_json_format_when_init_then_creates_json_config(
        self, mock_logger, mock_empathy_config, mock_validate_file_path
    ):
        """
        Given: Arguments with json format and no output path specified
        When: cmd_init is called
        Then: Creates default JSON configuration file
        """
        # Given
        mock_config_class, mock_config_instance = mock_empathy_config
        args = Namespace(format="json", output=None)

        # When
        cmd_init(args)

        # Then
        mock_validate_file_path.assert_called_once_with("empathy.config.json")
        mock_config_class.assert_called_once()
        mock_config_instance.to_json.assert_called_once()
        assert mock_logger.info.call_count >= 4

    def test_given_custom_output_path_when_init_then_uses_custom_path(
        self, mock_logger, mock_empathy_config, mock_validate_file_path
    ):
        """
        Given: Arguments with custom output path
        When: cmd_init is called
        Then: Uses specified custom path for configuration file
        """
        # Given
        mock_config_class, mock_config_instance = mock_empathy_config
        custom_path = "/custom/path/config.yaml"
        args = Namespace(format="yaml", output=custom_path)

        # When
        cmd_init(args)

        # Then
        mock_validate_file_path.assert_called_once_with(custom_path)
        mock_config_instance.to_yaml.assert_called_once()

    def test_given_yaml_format_when_init_then_logs_initialization_message(
        self, mock_logger, mock_empathy_config, mock_validate_file_path
    ):
        """
        Given: Arguments with yaml format
        When: cmd_init is called
        Then: Logs initialization and success messages
        """
        # Given
        mock_config_class, mock_config_instance = mock_empathy_config
        args = Namespace(format="yaml", output="test.yaml")

        # When
        cmd_init(args)

        # Then
        mock_logger.info.assert_any_call(
            "Initializing new Empathy Framework project with format: yaml"
        )
        mock_logger.info.assert_any_call("✓ Created YAML configuration: test.yaml")

    def test_given_json_format_when_init_then_logs_json_creation(
        self, mock_logger, mock_empathy_config, mock_validate_file_path
    ):
        """
        Given: Arguments with json format
        When: cmd_init is called
        Then: Logs JSON-specific creation messages
        """
        # Given
        mock_config_class, mock_config_instance = mock_empathy_config
        args = Namespace(format="json", output="test.json")
        mock_validate_file_path.return_value = Path("test.json")

        # When
        cmd_init(args)

        # Then
        mock_logger.info.assert_any_call("✓ Created JSON configuration: test.json")

    def test_given_yaml_format_when_init_then_provides_next_steps(
        self, mock_logger, mock_empathy_config, mock_validate_file_path
    ):
        """
        Given: Arguments with yaml format
        When: cmd_init is called
        Then: Logs next steps for user
        """
        # Given
        mock_config_class, mock_config_instance = mock_empathy_config
        args = Namespace(format="yaml", output="config.yaml")

        # When
        cmd_init(args)

        # Then
        mock_logger.info.assert_any_call("\nNext steps:")
        mock_logger.info.assert_any_call(
            "  1. Edit config.yaml to customize settings"
        )
        mock_logger.info.assert_any_call(
            "  2. Use 'empathy run' to start using the framework"
        )

    def test_given_invalid_path_when_init_then_validation_raises_error(
        self, mock_logger, mock_empathy_config, mock_validate_file_path
    ):
        """
        Given: Arguments with invalid output path
        When: cmd_init is called and validation fails
        Then: Raises ValueError
        """
        # Given
        mock_config_class, mock_config_instance = mock_empathy_config
        mock_validate_file_path.side_effect = ValueError("Invalid path")
        args = Namespace(format="yaml", output="../../../etc/passwd")

        # When/Then
        with pytest.raises(ValueError, match="Invalid path"):
            cmd_init(args)

    def test_given_yaml_format_when_init_then_calls_to_yaml_with_validated_path(
        self, mock_logger, mock_empathy_config, mock_validate_file_path
    ):
        """
        Given: Arguments with yaml format
        When: cmd_init is called
        Then: Calls to_yaml with string representation of validated path
        """
        # Given
        mock_config_class, mock_config_instance = mock_empathy_config
        validated_path = Path("/validated/path/config.yaml")
        mock_validate_file_path.return_value = validated_path
        args = Namespace(format="yaml", output="config.yaml")

        # When
        cmd_init(args)

        # Then
        mock_config_instance.to_yaml.assert_called_once_with(str(validated_path))

    def test_given_json_format_when_init_then_calls_to_json_with_validated_path(
        self, mock_logger, mock_empathy_config, mock_validate_file_path
    ):
        """
        Given: Arguments with json format
        When: cmd_init is called
        Then: Calls to_json with string representation of validated path
        """
        # Given
        mock_config_class, mock_config_instance = mock_empathy_config
        validated_path = Path("/validated/path/config.json")
        mock_validate_file_path.return_value = validated_path
        args = Namespace(format="json", output="config.json")

        # When
        cmd_init(args)

        # Then
        mock_config_instance.to_json.assert_called_once_with(str(validated_path))


class TestCmdValidate:
    """Test suite for cmd_validate function."""

    def test_given_valid_config_file_when_validate_then_succeeds(
        self, mock_logger, mock_load_config
    ):
        """
        Given: Arguments with path to valid configuration file
        When: cmd_validate is called
        Then: Validates successfully and logs config details
        """
        # Given
        mock_load, mock_config = mock_load_config
        args = Namespace(config="valid_config.yaml")

        # When
        cmd_validate(args)

        # Then
        mock_load.assert_called_once_with(filepath="valid_config.yaml", use_env=False)
        mock_config.validate.assert_called_once()
        mock_logger.info.assert_any_call(
            "Validating configuration file: valid_config.yaml"
        )
        mock_logger.info.assert_any_call("✓ Configuration valid: valid_config.yaml")

    def test_given_valid_config_when_validate_then_logs_user_id(
        self, mock_logger, mock_load_config
    ):
        """
        Given: Valid configuration with user_id
        When: cmd_validate is called
        Then: Logs user_id information
        """
        # Given
        mock_load, mock_config = mock_load_config
        mock_config.user_id = "test_user_123"
        args = Namespace(config="config.yaml")

        # When
        cmd_validate(args)

        # Then
        mock_logger.info.assert_any_call("\n  User ID: test_user_123")

    def test_given_valid_config_when_validate_then_logs_target_level(
        self, mock_logger, mock_load_config
    ):
        """
        Given: Valid configuration with target_level
        When: cmd_validate is called
        Then: Logs target_level information
        """
        # Given
        mock_load, mock_config = mock_load_config
        mock_config.target_level = 7
        args = Namespace(config="config.yaml")

        # When
        cmd_validate(args)

        # Then
        mock_logger.info.assert_any_call("  Target Level: 7")

    def test_given_valid_config_when_validate_then_logs_confidence_threshold(
        self, mock_logger, mock_load_config
    ):
        """
        Given: Valid configuration with confidence_threshold
        When: cmd_validate is called
        Then: Logs confidence_threshold information
        """
        # Given
        mock_load, mock_config = mock_load_config
        mock_config.confidence_threshold = 0.85
        args = Namespace(config="config.yaml")

        # When
        cmd_validate(args)

        # Then
        mock_logger.info.assert_any_call("  Confidence Threshold: 0.85")

    def test_given_valid_config_when_validate_then_logs_persistence_backend(
        self, mock_logger, mock_load_config
    ):
        """
        Given: Valid configuration with persistence_backend
        When: cmd_validate is called
        Then: Logs persistence_backend information
        """
        # Given
        mock_load, mock_config = mock_load_config
        mock_config.persistence_backend = "postgresql"
        args = Namespace(config="config.yaml")

        # When
        cmd_validate(args)

        # Then
        mock_logger.info.assert_any_call("  Persistence Backend: postgresql")

    def test_given_valid_config_when_validate_then_logs_metrics_enabled(
        self, mock_logger, mock_load_config
    ):
        """
        Given: Valid configuration with metrics_enabled
        When: cmd_validate is called
        Then: Logs metrics_enabled information
        """
        # Given
        mock_load, mock_config = mock_load_config
        mock_config.metrics_enabled = False
        args = Namespace(config="config.yaml")

        # When
        cmd_validate(args)

        # Then
        mock_logger.info.assert_any_call("  Metrics Enabled: False")

    def test_given_file_not_found_when_validate_then_logs_error_and_exits(
        self, mock_logger, mock_load_config
    ):
        """
        Given: Arguments with path to non-existent file
        When: cmd_validate is called
        Then: Logs error and exits with code 1
        """
        # Given
        mock_load, mock_config = mock_load_config
        mock_load.side_effect = FileNotFoundError("File not found")
        args = Namespace(config="nonexistent.yaml")

        # When/Then
        with pytest.raises(SystemExit) as exc_info:
            cmd_validate(args)

        assert exc_info.value.code == 1
        mock_logger.error.assert_any_call(
            "Configuration file error: File not found"
        )
        mock_logger.error.assert_any_call(
            "✗ Cannot read configuration file: File not found"
        )

    def test_given_os_error_when_validate_then_logs_error_and_exits(
        self, mock_logger, mock_load_config
    ):
        """
        Given: Arguments with configuration file that causes OSError
        When: cmd_validate is called
        Then: Logs error and exits with code 1
        """
        # Given
        mock_load, mock_config = mock_load_config
        mock_load.side_effect = OSError("Permission denied")
        args = Namespace(config="locked.yaml")

        # When/Then
        with pytest.raises(SystemExit) as exc_info:
            cmd_validate(args)

        assert exc_info.value.code == 1
        mock_logger.error.assert_any_call(
            "Configuration file error: Permission denied"
        )

    def test_given_validation_error_when_validate_then_logs_error_and_exits(
        self, mock_logger, mock_load_config
    ):
        """
        Given: Configuration file with validation errors
        When: cmd_validate is called
        Then: Logs validation error and exits with code 1
        """
        # Given
        mock_load, mock_config = mock_load_config
        mock_config.validate.side_effect = ValueError("Invalid configuration")
        args = Namespace(config="invalid.yaml")

        # When/Then
        with pytest.raises(SystemExit) as exc_info:
            cmd_validate(args)

        assert exc_info.value.code == 1
        mock_logger.error.assert_any_call(
            "Configuration validation failed: Invalid configuration"
        )
        mock_logger.error.assert_any_call(
            "✗ Invalid configuration: Invalid