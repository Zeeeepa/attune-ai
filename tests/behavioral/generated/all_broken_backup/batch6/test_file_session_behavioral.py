"""Behavioral tests for file_session.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

from __future__ import annotations

import gzip
import json
import time
import uuid
from pathlib import Path
from unittest.mock import Mock, patch, mock_open, MagicMock

import pytest
import structlog

from empathy_os.memory.file_session import (
    FileSessionConfig,
    WorkingEntry,
    FileSessionMemory,
    SessionIndex,
    SessionMetadata,
)


# =============================================================================
# Fixtures
# =============================================================================


@pytest.fixture
def temp_empathy_dir(tmp_path):
    """Given a temporary directory structure for empathy storage."""
    empathy_dir = tmp_path / ".empathy"
    empathy_dir.mkdir()
    return empathy_dir


@pytest.fixture
def file_session_config(temp_empathy_dir):
    """Given a file session configuration with temporary directory."""
    return FileSessionConfig(
        base_dir=str(temp_empathy_dir),
        session_ttl_hours=24,
        working_ttl_seconds=3600,
        pattern_ttl_seconds=86400,
        max_sessions_before_archive=10,
        archive_compression=True,
        archive_retention_days=30,
        auto_save_interval_seconds=60,
        auto_compact_on_close=True,
    )


@pytest.fixture
def file_session_memory(file_session_config):
    """Given an initialized file session memory instance."""
    return FileSessionMemory(config=file_session_config)


@pytest.fixture
def working_entry():
    """Given a working memory entry."""
    return WorkingEntry(
        key="test_key",
        value={"data": "test_value"},
        agent_id="agent_123",
        stashed_at=time.time(),
        expires_at=time.time() + 3600,
    )


@pytest.fixture
def session_metadata():
    """Given session metadata."""
    return SessionMetadata(
        session_id="session_123",
        created_at=time.time(),
        last_accessed=time.time(),
        agent_id="agent_123",
        turn_count=5,
        archived=False,
    )


# =============================================================================
# FileSessionConfig Tests
# =============================================================================


class TestFileSessionConfig:
    """Tests for FileSessionConfig configuration class."""

    def test_given_default_config_when_created_then_has_correct_defaults(self):
        """Given default config when created then has correct default values."""
        # Given/When
        config = FileSessionConfig()

        # Then
        assert config.base_dir == ".empathy"
        assert config.sessions_subdir == "sessions"
        assert config.patterns_subdir == "patterns"
        assert config.archive_subdir == "archive"
        assert config.session_ttl_hours == 24
        assert config.working_ttl_seconds == 3600
        assert config.pattern_ttl_seconds == 86400

    def test_given_custom_config_when_created_then_has_custom_values(self):
        """Given custom config when created then has custom values."""
        # Given/When
        config = FileSessionConfig(
            base_dir="/custom/path",
            session_ttl_hours=48,
            working_ttl_seconds=7200,
        )

        # Then
        assert config.base_dir == "/custom/path"
        assert config.session_ttl_hours == 48
        assert config.working_ttl_seconds == 7200

    def test_given_config_when_accessing_sessions_dir_then_returns_correct_path(self):
        """Given config when accessing sessions_dir then returns correct path."""
        # Given
        config = FileSessionConfig(base_dir="/test")

        # When
        sessions_dir = config.sessions_dir

        # Then
        assert sessions_dir == Path("/test/sessions")

    def test_given_config_when_accessing_patterns_dir_then_returns_correct_path(self):
        """Given config when accessing patterns_dir then returns correct path."""
        # Given
        config = FileSessionConfig(base_dir="/test")

        # When
        patterns_dir = config.patterns_dir

        # Then
        assert patterns_dir == Path("/test/patterns")

    def test_given_config_when_accessing_archive_dir_then_returns_correct_path(self):
        """Given config when accessing archive_dir then returns correct path."""
        # Given
        config = FileSessionConfig(base_dir="/test")

        # When
        archive_dir = config.archive_dir

        # Then
        assert archive_dir == Path("/test/sessions/archive")


# =============================================================================
# WorkingEntry Tests
# =============================================================================


class TestWorkingEntry:
    """Tests for WorkingEntry data model."""

    def test_given_entry_when_not_expired_then_is_expired_returns_false(self):
        """Given entry when not expired then is_expired returns False."""
        # Given
        entry = WorkingEntry(
            key="test",
            value="data",
            agent_id="agent_1",
            stashed_at=time.time(),
            expires_at=time.time() + 1000,
        )

        # When
        is_expired = entry.is_expired()

        # Then
        assert is_expired is False

    def test_given_entry_when_expired_then_is_expired_returns_true(self):
        """Given entry when expired then is_expired returns True."""
        # Given
        entry = WorkingEntry(
            key="test",
            value="data",
            agent_id="agent_1",
            stashed_at=time.time(),
            expires_at=time.time() - 1000,
        )

        # When
        is_expired = entry.is_expired()

        # Then
        assert is_expired is True

    def test_given_entry_when_no_expiration_then_is_expired_returns_false(self):
        """Given entry when no expiration then is_expired returns False."""
        # Given
        entry = WorkingEntry(
            key="test",
            value="data",
            agent_id="agent_1",
            stashed_at=time.time(),
            expires_at=None,
        )

        # When
        is_expired = entry.is_expired()

        # Then
        assert is_expired is False

    def test_given_entry_when_converted_to_dict_then_contains_all_fields(self):
        """Given entry when converted to dict then contains all fields."""
        # Given
        stashed_at = time.time()
        expires_at = time.time() + 1000
        entry = WorkingEntry(
            key="test_key",
            value={"nested": "data"},
            agent_id="agent_1",
            stashed_at=stashed_at,
            expires_at=expires_at,
        )

        # When
        entry_dict = entry.to_dict()

        # Then
        assert entry_dict["key"] == "test_key"
        assert entry_dict["value"] == {"nested": "data"}
        assert entry_dict["agent_id"] == "agent_1"
        assert entry_dict["stashed_at"] == stashed_at
        assert entry_dict["expires_at"] == expires_at

    def test_given_dict_when_from_dict_then_creates_entry(self):
        """Given dict when from_dict then creates valid entry."""
        # Given
        stashed_at = time.time()
        expires_at = time.time() + 1000
        entry_dict = {
            "key": "test_key",
            "value": {"nested": "data"},
            "agent_id": "agent_1",
            "stashed_at": stashed_at,
            "expires_at": expires_at,
        }

        # When
        entry = WorkingEntry.from_dict(entry_dict)

        # Then
        assert entry.key == "test_key"
        assert entry.value == {"nested": "data"}
        assert entry.agent_id == "agent_1"
        assert entry.stashed_at == stashed_at
        assert entry.expires_at == expires_at


# =============================================================================
# SessionMetadata Tests
# =============================================================================


class TestSessionMetadata:
    """Tests for SessionMetadata data model."""

    def test_given_metadata_when_created_then_has_correct_attributes(self):
        """Given metadata when created then has correct attributes."""
        # Given
        created_at = time.time()
        last_accessed = time.time()

        # When
        metadata = SessionMetadata(
            session_id="session_123",
            created_at=created_at,
            last_accessed=last_accessed,
            agent_id="agent_1",
            turn_count=5,
            archived=False,
        )

        # Then
        assert metadata.session_id == "session_123"
        assert metadata.created_at == created_at
        assert metadata.last_accessed == last_accessed
        assert metadata.agent_id == "agent_1"
        assert metadata.turn_count == 5
        assert metadata.archived is False

    def test_given_metadata_when_converted_to_dict_then_contains_all_fields(self):
        """Given metadata when converted to dict then contains all fields."""
        # Given
        created_at = time.time()
        last_accessed = time.time()
        metadata = SessionMetadata(
            session_id="session_123",
            created_at=created_at,
            last_accessed=last_accessed,
            agent_id="agent_1",
            turn_count=5,
            archived=False,
        )

        # When
        metadata_dict = metadata.to_dict()

        # Then
        assert metadata_dict["session_id"] == "session_123"
        assert metadata_dict["created_at"] == created_at
        assert metadata_dict["last_accessed"] == last_accessed
        assert metadata_dict["agent_id"] == "agent_1"
        assert metadata_dict["turn_count"] == 5
        assert metadata_dict["archived"] is False

    def test_given_dict_when_from_dict_then_creates_metadata(self):
        """Given dict when from_dict then creates valid metadata."""
        # Given
        created_at = time.time()
        last_accessed = time.time()
        metadata_dict = {
            "session_id": "session_123",
            "created_at": created_at,
            "last_accessed": last_accessed,
            "agent_id": "agent_1",
            "turn_count": 5,
            "archived": False,
        }

        # When
        metadata = SessionMetadata.from_dict(metadata_dict)

        # Then
        assert metadata.session_id == "session_123"
        assert metadata.created_at == created_at
        assert metadata.last_accessed == last_accessed
        assert metadata.agent_id == "agent_1"
        assert metadata.turn_count == 5
        assert metadata.archived is False


# =============================================================================
# SessionIndex Tests
# =============================================================================


class TestSessionIndex:
    """Tests for SessionIndex management."""

    def test_given_new_index_when_created_then_has_empty_sessions(self):
        """Given new index when created then has empty sessions."""
        # Given/When
        index = SessionIndex()

        # Then
        assert len(index.sessions) == 0

    def test_given_index_when_adding_session_then_session_exists(self):
        """Given index when adding session then session exists."""
        # Given
        index = SessionIndex()
        metadata = SessionMetadata(
            session_id="session_1",
            created_at=time.time(),
            last_accessed=time.time(),
            agent_id="agent_1",
            turn_count=1,
            archived=False,
        )

        # When
        index.add_session(metadata)

        # Then
        assert "session_1" in index.sessions
        assert index.sessions["session_1"].session_id == "session_1"

    def test_given_index_when_getting_existing_session_then_returns_metadata(self):
        """Given index when getting existing session then returns metadata."""
        # Given
        index = SessionIndex()
        metadata = SessionMetadata(
            session_id="session_1",
            created_at=time.time(),
            last_accessed=time.time(),
            agent_id="agent_1",
            turn_count=1,
            archived=False,
        )
        index.add_session(metadata)

        # When
        result = index.get_session("session_1")

        # Then
        assert result is not None
        assert result.session_id == "session_1"

    def test_given_index_when_getting_nonexistent_session_then_returns_none(self):
        """Given index when getting nonexistent session then returns None."""
        # Given
        index = SessionIndex()

        # When
        result = index.get_session("nonexistent")

        # Then
        assert result is None

    def test_given_index_when_removing_session_then_session_removed(self):
        """Given index when removing session then session removed."""
        # Given
        index = SessionIndex()
        metadata = SessionMetadata(
            session_id="session_1",
            created_at=time.time(),
            last_accessed=time.time(),
            agent_id="agent_1",
            turn_count=1,
            archived=False,
        )
        index.add_session(metadata)

        # When
        index.remove_session("session_1")

        # Then
        assert "session_1" not in index.sessions

    def test_given_index_when_listing_sessions_then_returns_all_metadata(self):
        """Given index when listing sessions then returns all metadata."""
        # Given
        index = SessionIndex()
        metadata1 = SessionMetadata(
            session_id="session_1",
            created_at=time.time(),
            last_accessed=time.time(),
            agent_id="agent_1",
            turn_count=1,
            archived=False,
        )
        metadata2 = SessionMetadata(
            session_id="session_2",
            created_at=time.time(),
            last_accessed=time.time(),
            agent_id="agent_1",
            turn_count=2,
            archived=False,
        )
        index.add_session(metadata1)
        index.add_session(metadata2)

        # When
        sessions = index.list_sessions()

        # Then
        assert len(sessions) == 2
        assert any(s.session_id == "session_1" for s in sessions)
        assert any(s.session_id == "session_2" for s in sessions)


# =============================================================================
# FileSessionMemory Tests
# =============================================================================


class TestFileSessionMemory:
    """Tests for FileSessionMemory main functionality."""

    def test_given_config_when_initialized_then_creates_directories(
        self, file_session_config, temp_empathy_dir
    ):
        """Given config when initialized then creates necessary directories."""
        # Given/When
        memory = FileSessionMemory(config=file_session_config)

        # Then
        assert (temp_empathy_dir / "sessions").exists()
        assert (temp_empathy_dir / "patterns").exists()
        assert (temp_empathy_dir / "sessions" / "archive").exists()

    def test_given_memory_when_starting_new_session_then_creates_session_id(
        self, file_session_memory
    ):
        """Given memory when starting new session then creates session ID."""
        # Given/When
        session_id = file_session_memory.start_session(agent_id="agent_1")

        # Then
        assert session_id is not None
        assert isinstance(session_id, str)
        assert file_session_memory.current_session_id == session_id

    def test_given_memory_when_stashing_value_then