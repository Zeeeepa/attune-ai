"""Behavioral tests for cli.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import argparse
import json
import sys
from pathlib import Path
from unittest.mock import MagicMock, Mock, call, mock_open, patch

import pytest

from empathy_os.project_index.cli import main


@pytest.fixture
def mock_project_index():
    """Mock ProjectIndex for testing."""
    with patch("empathy_os.project_index.cli.ProjectIndex") as mock:
        index_instance = Mock()
        mock.return_value = index_instance
        yield mock, index_instance


@pytest.fixture
def mock_report_generator():
    """Mock ReportGenerator for testing."""
    with patch("empathy_os.project_index.cli.ReportGenerator") as mock:
        generator_instance = Mock()
        mock.return_value = generator_instance
        yield mock, generator_instance


class TestMainRefreshCommand:
    """Test the refresh command."""

    def test_given_refresh_command_when_executed_then_refreshes_index(
        self, mock_project_index
    ):
        """GIVEN a refresh command
        WHEN executed without force flag
        THEN index is refreshed
        """
        mock_class, mock_instance = mock_project_index
        mock_instance.refresh.return_value = None

        with patch.object(sys, "argv", ["cli.py", "refresh"]):
            result = main()

        assert result == 0
        mock_class.assert_called_once_with(Path("."))
        mock_instance.refresh.assert_called_once_with(force=False)

    def test_given_refresh_with_force_when_executed_then_forces_refresh(
        self, mock_project_index
    ):
        """GIVEN a refresh command with force flag
        WHEN executed
        THEN index is force refreshed
        """
        mock_class, mock_instance = mock_project_index
        mock_instance.refresh.return_value = None

        with patch.object(sys, "argv", ["cli.py", "refresh", "--force"]):
            result = main()

        assert result == 0
        mock_instance.refresh.assert_called_once_with(force=True)

    def test_given_refresh_with_project_path_when_executed_then_uses_custom_path(
        self, mock_project_index
    ):
        """GIVEN a refresh command with custom project path
        WHEN executed
        THEN uses the specified project path
        """
        mock_class, mock_instance = mock_project_index
        mock_instance.refresh.return_value = None

        with patch.object(sys, "argv", ["cli.py", "--project", "/custom/path", "refresh"]):
            result = main()

        assert result == 0
        mock_class.assert_called_once_with(Path("/custom/path"))

    def test_given_refresh_when_exception_occurs_then_returns_error_code(
        self, mock_project_index
    ):
        """GIVEN a refresh command
        WHEN an exception occurs
        THEN returns error code 1
        """
        mock_class, mock_instance = mock_project_index
        mock_instance.refresh.side_effect = Exception("Refresh failed")

        with patch.object(sys, "argv", ["cli.py", "refresh"]):
            with patch("builtins.print"):
                result = main()

        assert result == 1


class TestMainSummaryCommand:
    """Test the summary command."""

    def test_given_summary_command_when_executed_then_displays_summary(
        self, mock_project_index
    ):
        """GIVEN a summary command
        WHEN executed
        THEN displays project summary
        """
        mock_class, mock_instance = mock_project_index
        mock_instance.get_summary.return_value = {
            "total_files": 100,
            "test_coverage": 75.5,
        }

        with patch.object(sys, "argv", ["cli.py", "summary"]):
            with patch("builtins.print") as mock_print:
                result = main()

        assert result == 0
        mock_instance.get_summary.assert_called_once()
        assert mock_print.call_count > 0

    def test_given_summary_with_json_flag_when_executed_then_outputs_json(
        self, mock_project_index
    ):
        """GIVEN a summary command with JSON flag
        WHEN executed
        THEN outputs JSON format
        """
        mock_class, mock_instance = mock_project_index
        summary_data = {"total_files": 100, "test_coverage": 75.5}
        mock_instance.get_summary.return_value = summary_data

        with patch.object(sys, "argv", ["cli.py", "--json", "summary"]):
            with patch("builtins.print") as mock_print:
                result = main()

        assert result == 0
        mock_print.assert_called_once()
        # Check that JSON was printed
        call_args = mock_print.call_args[0][0]
        assert "total_files" in call_args or isinstance(call_args, str)

    def test_given_summary_when_no_data_then_handles_gracefully(
        self, mock_project_index
    ):
        """GIVEN a summary command
        WHEN no data available
        THEN handles gracefully
        """
        mock_class, mock_instance = mock_project_index
        mock_instance.get_summary.return_value = {}

        with patch.object(sys, "argv", ["cli.py", "summary"]):
            with patch("builtins.print"):
                result = main()

        assert result == 0


class TestMainReportCommand:
    """Test the report command."""

    def test_given_health_report_when_executed_then_generates_health_report(
        self, mock_project_index, mock_report_generator
    ):
        """GIVEN a health report command
        WHEN executed
        THEN generates health report
        """
        mock_gen_class, mock_gen_instance = mock_report_generator
        mock_gen_instance.generate_health_report.return_value = "Health Report"

        with patch.object(sys, "argv", ["cli.py", "report", "health"]):
            with patch("builtins.print") as mock_print:
                result = main()

        assert result == 0
        mock_gen_instance.generate_health_report.assert_called_once()
        mock_print.assert_called()

    def test_given_test_gap_report_when_executed_then_generates_test_gap_report(
        self, mock_project_index, mock_report_generator
    ):
        """GIVEN a test_gap report command
        WHEN executed
        THEN generates test gap report
        """
        mock_gen_class, mock_gen_instance = mock_report_generator
        mock_gen_instance.generate_test_gap_report.return_value = "Test Gap Report"

        with patch.object(sys, "argv", ["cli.py", "report", "test_gap"]):
            with patch("builtins.print") as mock_print:
                result = main()

        assert result == 0
        mock_gen_instance.generate_test_gap_report.assert_called_once()

    def test_given_staleness_report_when_executed_then_generates_staleness_report(
        self, mock_project_index, mock_report_generator
    ):
        """GIVEN a staleness report command
        WHEN executed
        THEN generates staleness report
        """
        mock_gen_class, mock_gen_instance = mock_report_generator
        mock_gen_instance.generate_staleness_report.return_value = "Staleness Report"

        with patch.object(sys, "argv", ["cli.py", "report", "staleness"]):
            with patch("builtins.print") as mock_print:
                result = main()

        assert result == 0
        mock_gen_instance.generate_staleness_report.assert_called_once()

    def test_given_coverage_report_when_executed_then_generates_coverage_report(
        self, mock_project_index, mock_report_generator
    ):
        """GIVEN a coverage report command
        WHEN executed
        THEN generates coverage report
        """
        mock_gen_class, mock_gen_instance = mock_report_generator
        mock_gen_instance.generate_coverage_report.return_value = "Coverage Report"

        with patch.object(sys, "argv", ["cli.py", "report", "coverage"]):
            with patch("builtins.print") as mock_print:
                result = main()

        assert result == 0
        mock_gen_instance.generate_coverage_report.assert_called_once()

    def test_given_sprint_report_when_executed_then_generates_sprint_report(
        self, mock_project_index, mock_report_generator
    ):
        """GIVEN a sprint report command
        WHEN executed
        THEN generates sprint report
        """
        mock_gen_class, mock_gen_instance = mock_report_generator
        mock_gen_instance.generate_sprint_report.return_value = "Sprint Report"

        with patch.object(sys, "argv", ["cli.py", "report", "sprint"]):
            with patch("builtins.print") as mock_print:
                result = main()

        assert result == 0
        mock_gen_instance.generate_sprint_report.assert_called_once()

    def test_given_report_with_markdown_when_executed_then_outputs_markdown(
        self, mock_project_index, mock_report_generator
    ):
        """GIVEN a report command with markdown flag
        WHEN executed
        THEN outputs markdown format
        """
        mock_gen_class, mock_gen_instance = mock_report_generator
        mock_gen_instance.generate_health_report.return_value = "# Health Report"

        with patch.object(sys, "argv", ["cli.py", "report", "health", "--markdown"]):
            with patch("builtins.print") as mock_print:
                result = main()

        assert result == 0
        mock_gen_instance.generate_health_report.assert_called_once()

    def test_given_report_with_json_when_executed_then_outputs_json(
        self, mock_project_index, mock_report_generator
    ):
        """GIVEN a report command with JSON flag
        WHEN executed
        THEN outputs JSON format
        """
        mock_gen_class, mock_gen_instance = mock_report_generator
        report_data = {"status": "healthy", "score": 85}
        mock_gen_instance.generate_health_report.return_value = report_data

        with patch.object(sys, "argv", ["cli.py", "--json", "report", "health"]):
            with patch("builtins.print") as mock_print:
                result = main()

        assert result == 0


class TestMainQueryCommand:
    """Test the query command."""

    def test_given_needing_tests_query_when_executed_then_returns_files(
        self, mock_project_index
    ):
        """GIVEN a needing_tests query
        WHEN executed
        THEN returns files needing tests
        """
        mock_class, mock_instance = mock_project_index
        mock_instance.query_needing_tests.return_value = [
            {"path": "file1.py", "priority": "high"},
            {"path": "file2.py", "priority": "medium"},
        ]

        with patch.object(sys, "argv", ["cli.py", "query", "needing_tests"]):
            with patch("builtins.print") as mock_print:
                result = main()

        assert result == 0
        mock_instance.query_needing_tests.assert_called_once()
        assert mock_print.call_count > 0

    def test_given_stale_query_when_executed_then_returns_stale_files(
        self, mock_project_index
    ):
        """GIVEN a stale query
        WHEN executed
        THEN returns stale files
        """
        mock_class, mock_instance = mock_project_index
        mock_instance.query_stale.return_value = [
            {"path": "old_file.py", "days_old": 365}
        ]

        with patch.object(sys, "argv", ["cli.py", "query", "stale"]):
            with patch("builtins.print") as mock_print:
                result = main()

        assert result == 0
        mock_instance.query_stale.assert_called_once()

    def test_given_high_impact_query_when_executed_then_returns_high_impact_files(
        self, mock_project_index
    ):
        """GIVEN a high_impact query
        WHEN executed
        THEN returns high impact files
        """
        mock_class, mock_instance = mock_project_index
        mock_instance.query_high_impact.return_value = [
            {"path": "core.py", "impact": 9.5}
        ]

        with patch.object(sys, "argv", ["cli.py", "query", "high_impact"]):
            with patch("builtins.print") as mock_print:
                result = main()

        assert result == 0
        mock_instance.query_high_impact.assert_called_once()

    def test_given_attention_query_when_executed_then_returns_attention_files(
        self, mock_project_index
    ):
        """GIVEN an attention query
        WHEN executed
        THEN returns files needing attention
        """
        mock_class, mock_instance = mock_project_index
        mock_instance.query_attention.return_value = [
            {"path": "problem.py", "reason": "low coverage"}
        ]

        with patch.object(sys, "argv", ["cli.py", "query", "attention"]):
            with patch("builtins.print") as mock_print:
                result = main()

        assert result == 0
        mock_instance.query_attention.assert_called_once()

    def test_given_all_query_when_executed_then_returns_all_files(
        self, mock_project_index
    ):
        """GIVEN an all query
        WHEN executed
        THEN returns all indexed files
        """
        mock_class, mock_instance = mock_project_index
        mock_instance.query_all.return_value = [
            {"path": "file1.py"},
            {"path": "file2.py"},
        ]

        with patch.object(sys, "argv", ["cli.py", "query", "all"]):
            with patch("builtins.print") as mock_print:
                result = main()

        assert result == 0
        mock_instance.query_all.assert_called_once()

    def test_given_query_with_limit_when_executed_then_respects_limit(
        self, mock_project_index
    ):
        """GIVEN a query with limit parameter
        WHEN executed
        THEN respects the limit
        """
        mock_class, mock_instance = mock_project_index
        mock_instance.query_needing_tests.return_value = [
            {"path": f"file{i}.py"} for i in range(5)
        ]

        with patch.object(sys, "argv", ["cli.py", "query", "needing_tests", "--limit", "5"]):
            with patch("builtins.print"):
                result = main()

        assert result == 0
        mock_instance.query_needing_tests.assert_called_once()

    def test_given_query_with_json_when_executed_then_outputs_json(
        self, mock_project_index
    ):
        """GIVEN a query with JSON flag
        WHEN executed
        THEN outputs JSON format
        """
        mock_class, mock_instance = mock_project_index
        query_results = [{"path": "