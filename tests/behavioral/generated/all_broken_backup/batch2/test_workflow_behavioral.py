"""Behavioral tests for workflow.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import json
from datetime import datetime
from pathlib import Path
from typing import Any
from unittest.mock import MagicMock, Mock, call, mock_open, patch

import pytest

from empathy_os.meta_workflows.models import (
    AgentExecutionResult,
    AgentSpec,
    FormResponse,
    MetaWorkflowResult,
    MetaWorkflowTemplate,
    TierStrategy,
)
from empathy_os.meta_workflows.workflow import MetaWorkflow


@pytest.fixture
def mock_template():
    """Provide a mock meta-workflow template."""
    return MetaWorkflowTemplate(
        id="test-template",
        name="Test Template",
        description="A test template",
        form_spec={
            "sections": [
                {
                    "title": "Test Section",
                    "questions": [
                        {
                            "id": "q1",
                            "text": "Test question?",
                            "type": "text",
                        }
                    ],
                }
            ]
        },
        agent_specs=[
            {
                "id": "agent1",
                "role": "analyst",
                "template_id": "research_analyst",
                "tier": "smart",
            }
        ],
        tier_strategy=TierStrategy.START_SMART,
        output_format="markdown",
    )


@pytest.fixture
def mock_form_response():
    """Provide a mock form response."""
    return FormResponse(
        workflow_id="test-workflow",
        template_id="test-template",
        responses={"q1": "Test answer"},
        timestamp=datetime.now(),
    )


@pytest.fixture
def mock_agent_spec():
    """Provide a mock agent specification."""
    return AgentSpec(
        id="agent1",
        role="analyst",
        template_id="research_analyst",
        tier="smart",
    )


@pytest.fixture
def mock_execution_result():
    """Provide a mock agent execution result."""
    return AgentExecutionResult(
        agent_id="agent1",
        role="analyst",
        output="Test output",
        tier_used="smart",
        success=True,
        cost=0.001,
        duration=1.5,
    )


@pytest.fixture
def temp_storage_dir(tmp_path):
    """Provide a temporary storage directory."""
    storage = tmp_path / "meta_workflows"
    storage.mkdir()
    return str(storage)


class TestMetaWorkflowInitialization:
    """Test MetaWorkflow initialization behavior."""

    def test_given_template_when_init_then_stores_template(self, mock_template):
        """Given: A template object.
        When: MetaWorkflow is initialized.
        Then: Template is stored correctly.
        """
        # When
        workflow = MetaWorkflow(template=mock_template)

        # Then
        assert workflow.template == mock_template
        assert workflow.template.id == "test-template"

    @patch("empathy_os.meta_workflows.workflow.TemplateRegistry")
    def test_given_template_id_when_init_then_loads_from_registry(
        self, mock_registry_class, mock_template
    ):
        """Given: A template ID.
        When: MetaWorkflow is initialized.
        Then: Template is loaded from registry.
        """
        # Given
        mock_registry = MagicMock()
        mock_registry.get_template.return_value = mock_template
        mock_registry_class.return_value = mock_registry

        # When
        workflow = MetaWorkflow(template_id="test-template")

        # Then
        mock_registry.get_template.assert_called_once_with("test-template")
        assert workflow.template == mock_template

    def test_given_no_template_when_init_then_raises_error(self):
        """Given: No template or template_id.
        When: MetaWorkflow is initialized.
        Then: ValueError is raised.
        """
        # When/Then
        with pytest.raises(ValueError, match="Either template or template_id"):
            MetaWorkflow()

    def test_given_storage_dir_when_init_then_creates_directory(
        self, mock_template, tmp_path
    ):
        """Given: A storage directory path.
        When: MetaWorkflow is initialized.
        Then: Directory is created.
        """
        # Given
        storage_path = tmp_path / "custom_storage"

        # When
        workflow = MetaWorkflow(template=mock_template, storage_dir=str(storage_path))

        # Then
        assert storage_path.exists()
        assert workflow.storage_dir == storage_path

    def test_given_pattern_learner_when_init_then_stores_learner(self, mock_template):
        """Given: A pattern learner instance.
        When: MetaWorkflow is initialized.
        Then: Pattern learner is stored.
        """
        # Given
        mock_learner = MagicMock()

        # When
        workflow = MetaWorkflow(template=mock_template, pattern_learner=mock_learner)

        # Then
        assert workflow.pattern_learner == mock_learner

    @patch("empathy_os.meta_workflows.workflow.SocraticFormEngine")
    @patch("empathy_os.meta_workflows.workflow.DynamicAgentCreator")
    def test_given_template_when_init_then_initializes_engines(
        self, mock_creator_class, mock_engine_class, mock_template
    ):
        """Given: A template.
        When: MetaWorkflow is initialized.
        Then: Form engine and agent creator are initialized.
        """
        # When
        workflow = MetaWorkflow(template=mock_template)

        # Then
        mock_engine_class.assert_called_once()
        mock_creator_class.assert_called_once()
        assert workflow.form_engine is not None
        assert workflow.agent_creator is not None


class TestMetaWorkflowExecution:
    """Test MetaWorkflow execution behavior."""

    @patch("empathy_os.meta_workflows.workflow.MetaWorkflow._collect_form")
    @patch("empathy_os.meta_workflows.workflow.MetaWorkflow._generate_agents")
    @patch("empathy_os.meta_workflows.workflow.MetaWorkflow._execute_agents")
    @patch("empathy_os.meta_workflows.workflow.MetaWorkflow._aggregate_results")
    @patch("empathy_os.meta_workflows.workflow.MetaWorkflow._store_results")
    def test_given_valid_inputs_when_execute_then_completes_workflow(
        self,
        mock_store,
        mock_aggregate,
        mock_execute,
        mock_generate,
        mock_collect,
        mock_template,
        mock_form_response,
        mock_execution_result,
    ):
        """Given: Valid inputs.
        When: Execute is called.
        Then: All workflow stages complete successfully.
        """
        # Given
        mock_collect.return_value = mock_form_response
        mock_generate.return_value = [AgentSpec(id="a1", role="test", tier="smart")]
        mock_execute.return_value = [mock_execution_result]
        mock_aggregate.return_value = "Aggregated output"
        mock_store.return_value = "result-id"

        workflow = MetaWorkflow(template=mock_template)

        # When
        result = workflow.execute(initial_context={"key": "value"})

        # Then
        assert isinstance(result, MetaWorkflowResult)
        assert result.workflow_id is not None
        assert result.template_id == "test-template"
        assert result.success is True
        mock_collect.assert_called_once()
        mock_generate.assert_called_once()
        mock_execute.assert_called_once()
        mock_aggregate.assert_called_once()
        mock_store.assert_called_once()

    @patch("empathy_os.meta_workflows.workflow.MetaWorkflow._collect_form")
    def test_given_form_collection_error_when_execute_then_handles_gracefully(
        self, mock_collect, mock_template
    ):
        """Given: Form collection raises error.
        When: Execute is called.
        Then: Error is handled and result indicates failure.
        """
        # Given
        mock_collect.side_effect = Exception("Form collection failed")
        workflow = MetaWorkflow(template=mock_template)

        # When
        result = workflow.execute()

        # Then
        assert result.success is False
        assert "Form collection failed" in result.error

    @patch("empathy_os.meta_workflows.workflow.MetaWorkflow._collect_form")
    @patch("empathy_os.meta_workflows.workflow.MetaWorkflow._generate_agents")
    def test_given_agent_generation_error_when_execute_then_handles_gracefully(
        self, mock_generate, mock_collect, mock_template, mock_form_response
    ):
        """Given: Agent generation raises error.
        When: Execute is called.
        Then: Error is handled and result indicates failure.
        """
        # Given
        mock_collect.return_value = mock_form_response
        mock_generate.side_effect = Exception("Agent generation failed")
        workflow = MetaWorkflow(template=mock_template)

        # When
        result = workflow.execute()

        # Then
        assert result.success is False
        assert "Agent generation failed" in result.error

    @patch("empathy_os.meta_workflows.workflow.MetaWorkflow._collect_form")
    @patch("empathy_os.meta_workflows.workflow.MetaWorkflow._generate_agents")
    @patch("empathy_os.meta_workflows.workflow.MetaWorkflow._execute_agents")
    @patch("empathy_os.meta_workflows.workflow.MetaWorkflow._aggregate_results")
    @patch("empathy_os.meta_workflows.workflow.MetaWorkflow._store_results")
    @patch("empathy_os.meta_workflows.workflow.MetaWorkflow._store_to_memory")
    def test_given_pattern_learner_when_execute_then_stores_to_memory(
        self,
        mock_store_memory,
        mock_store,
        mock_aggregate,
        mock_execute,
        mock_generate,
        mock_collect,
        mock_template,
        mock_form_response,
        mock_execution_result,
    ):
        """Given: Pattern learner is configured.
        When: Execute completes successfully.
        Then: Results are stored to memory.
        """
        # Given
        mock_collect.return_value = mock_form_response
        mock_generate.return_value = [AgentSpec(id="a1", role="test", tier="smart")]
        mock_execute.return_value = [mock_execution_result]
        mock_aggregate.return_value = "Aggregated output"
        mock_store.return_value = "result-id"

        mock_learner = MagicMock()
        workflow = MetaWorkflow(template=mock_template, pattern_learner=mock_learner)

        # When
        result = workflow.execute()

        # Then
        mock_store_memory.assert_called_once()


class TestFormCollection:
    """Test form collection behavior."""

    @patch("empathy_os.meta_workflows.workflow.SocraticFormEngine")
    def test_given_form_spec_when_collect_form_then_returns_response(
        self, mock_engine_class, mock_template, mock_form_response
    ):
        """Given: A form specification.
        When: _collect_form is called.
        Then: Form response is returned.
        """
        # Given
        mock_engine = MagicMock()
        mock_engine.collect_form.return_value = mock_form_response
        mock_engine_class.return_value = mock_engine

        workflow = MetaWorkflow(template=mock_template)

        # When
        response = workflow._collect_form("workflow-123", {"context": "data"})

        # Then
        assert response == mock_form_response
        mock_engine.collect_form.assert_called_once()

    @patch("empathy_os.meta_workflows.workflow.SocraticFormEngine")
    def test_given_initial_context_when_collect_form_then_passes_context(
        self, mock_engine_class, mock_template, mock_form_response
    ):
        """Given: Initial context data.
        When: _collect_form is called.
        Then: Context is passed to form engine.
        """
        # Given
        mock_engine = MagicMock()
        mock_engine.collect_form.return_value = mock_form_response
        mock_engine_class.return_value = mock_engine

        workflow = MetaWorkflow(template=mock_template)
        context = {"user_id": "123", "previous_data": "test"}

        # When
        workflow._collect_form("workflow-123", context)

        # Then
        call_args = mock_engine.collect_form.call_args
        assert call_args[1]["initial_context"] == context


class TestAgentGeneration:
    """Test agent generation behavior."""

    @patch("empathy_os.meta_workflows.workflow.DynamicAgentCreator")
    def test_given_agent_specs_when_generate_agents_then_returns_specs(
        self, mock_creator_class, mock_template, mock_form_response
    ):
        """Given: Agent specifications in template.
        When: _generate_agents is called.
        Then: Agent specs are returned.
        """
        # Given
        expected_specs = [
            AgentSpec(id="a1", role="analyst", tier="smart"),
            AgentSpec(id="a2", role="writer", tier="fast"),
        ]
        mock_creator = MagicMock()
        mock_creator.create_agent_team.return_value = expected_specs
        mock_creator_class.return_value = mock_creator

        workflow = MetaWorkflow(template=mock_template)

        # When
        specs = workflow._generate_agents(mock_form_response)

        # Then
        assert specs == expected_specs
        mock_creator.create_agent_team.assert_called_once()

    @patch("empathy_os.meta_workflows.workflow.DynamicAgentCreator")
    def test_given_form_responses_when_generate_agents_then_uses_responses(
        self, mock_creator_class, mock_template, mock_form_response
    ):
        """Given: Form responses with user data.
        When: _generate_agents is called.
        Then: Form responses are used in agent creation.
        """
        # Given
        mock_creator = MagicMock()
        mock_creator_class.return_value = mock_creator

        workflow = MetaWorkflow(template=mock_template)

        # When
        workflow._generate_agents(mock_form_response)

        # Then
        call_args = mock_creator.create_agent_team.call_args
        assert call_args[0][1] == mock_form_response


class TestAgentExecution:
    """Test agent execution behavior."""

    @patch("empathy_os.meta_workflows.workflow.ModelRouter")
    @patch("empathy_os.meta_workflows.workflow.get_template")
    @patch("empathy_os.meta_workflows.workflow.UsageTracker")
    def test_given_agent_specs_when_execute_agents_then_executes_all(
        self,
        mock_tracker_class,
        mock_get_template,
        mock_router_class,
        mock_template,
        mock_form_response,
    ):
        """Given: Multiple agent specs.
        When: _execute_agents is called.
        Then: All agents are executed.
        """
        # Given