"""Behavioral tests for summary_index.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import json
import time
from datetime import datetime
from unittest.mock import MagicMock, Mock, patch, call

import pytest

from empathy_os.memory.summary_index import (
    AgentContext,
    ConversationSummary,
)


@pytest.fixture
def mock_redis():
    """Fixture providing a mocked Redis client."""
    redis_mock = MagicMock()
    redis_mock.hset.return_value = 1
    redis_mock.hget.return_value = None
    redis_mock.hgetall.return_value = {}
    redis_mock.zadd.return_value = 1
    redis_mock.zrange.return_value = []
    redis_mock.sadd.return_value = 1
    redis_mock.smembers.return_value = set()
    redis_mock.delete.return_value = 1
    redis_mock.exists.return_value = 0
    return redis_mock


@pytest.fixture
def mock_redis_memory(mock_redis):
    """Fixture providing a mocked RedisShortTermMemory."""
    with patch("empathy_os.memory.summary_index.RedisShortTermMemory") as mock_class:
        memory_instance = MagicMock()
        memory_instance.redis = mock_redis
        mock_class.return_value = memory_instance
        yield memory_instance


@pytest.fixture
def sample_agent_context():
    """Fixture providing a sample AgentContext."""
    return AgentContext(
        working_on="Building authentication system",
        decisions=["Use JWT tokens", "Implement OAuth2", "Add rate limiting"],
        relevant_files=["auth.py", "middleware.py", "config.py"],
        recent_events=[
            {"type": "code_change", "content": "Added login endpoint"},
            {"type": "decision", "content": "Chose bcrypt for hashing"},
        ],
        open_questions=["Should we add 2FA?", "Which OAuth providers?"],
        topics=["authentication", "security", "backend"],
        session_id="test-session-123",
        updated_at="2025-01-15T10:30:00Z",
    )


class TestAgentContext:
    """Test suite for AgentContext dataclass."""

    def test_given_empty_context_when_created_then_has_defaults(self):
        """Test that AgentContext initializes with proper defaults."""
        # Given/When
        context = AgentContext(working_on="Test task")

        # Then
        assert context.working_on == "Test task"
        assert context.decisions == []
        assert context.relevant_files == []
        assert context.recent_events == []
        assert context.open_questions == []
        assert context.topics == []
        assert context.session_id == ""
        assert context.updated_at == ""

    def test_given_full_context_when_to_prompt_then_formats_markdown(self, sample_agent_context):
        """Test that to_prompt generates proper markdown format."""
        # Given
        context = sample_agent_context

        # When
        prompt = context.to_prompt()

        # Then
        assert "## Session Context (from memory)" in prompt
        assert "**Working on:** Building authentication system" in prompt
        assert "**Key decisions made:**" in prompt
        assert "- Use JWT tokens" in prompt
        assert "**Open questions:**" in prompt
        assert "- Should we add 2FA?" in prompt
        assert "**Recent timeline:**" in prompt
        assert "1. Code_change: Added login endpoint" in prompt
        assert "**Key files:** auth.py, middleware.py, config.py" in prompt

    def test_given_context_with_many_decisions_when_to_prompt_then_limits_to_five(self):
        """Test that to_prompt limits decisions to last 5."""
        # Given
        context = AgentContext(
            working_on="Test",
            decisions=[f"Decision {i}" for i in range(10)],
        )

        # When
        prompt = context.to_prompt()

        # Then
        assert "Decision 5" in prompt
        assert "Decision 9" in prompt
        assert "Decision 0" not in prompt
        assert "Decision 4" not in prompt

    def test_given_context_with_many_events_when_to_prompt_then_limits_to_five(self):
        """Test that to_prompt limits events to last 5."""
        # Given
        context = AgentContext(
            working_on="Test",
            recent_events=[{"type": "event", "content": f"Event {i}"} for i in range(10)],
        )

        # When
        prompt = context.to_prompt()

        # Then
        assert "Event 5" in prompt
        assert "Event 9" in prompt
        assert "Event 0" not in prompt
        assert "Event 4" not in prompt

    def test_given_context_with_many_questions_when_to_prompt_then_limits_to_three(self):
        """Test that to_prompt limits open questions to last 3."""
        # Given
        context = AgentContext(
            working_on="Test",
            open_questions=[f"Question {i}?" for i in range(10)],
        )

        # When
        prompt = context.to_prompt()

        # Then
        assert "Question 7?" in prompt
        assert "Question 9?" in prompt
        assert "Question 0?" not in prompt
        assert "Question 6?" not in prompt

    def test_given_context_with_many_files_when_to_prompt_then_limits_to_ten(self):
        """Test that to_prompt limits files to last 10."""
        # Given
        context = AgentContext(
            working_on="Test",
            relevant_files=[f"file{i}.py" for i in range(20)],
        )

        # When
        prompt = context.to_prompt()

        # Then
        assert "file10.py" in prompt
        assert "file19.py" in prompt
        assert "file0.py" not in prompt
        assert "file9.py" not in prompt

    def test_given_context_with_empty_fields_when_to_prompt_then_skips_sections(self):
        """Test that to_prompt skips empty sections."""
        # Given
        context = AgentContext(working_on="Test task")

        # When
        prompt = context.to_prompt()

        # Then
        assert "**Working on:** Test task" in prompt
        assert "**Key decisions made:**" not in prompt
        assert "**Open questions:**" not in prompt
        assert "**Recent timeline:**" not in prompt
        assert "**Key files:**" not in prompt

    def test_given_event_without_content_when_to_prompt_then_uses_str_representation(self):
        """Test that to_prompt handles events without content field."""
        # Given
        context = AgentContext(
            working_on="Test",
            recent_events=[{"type": "action", "data": "some data"}],
        )

        # When
        prompt = context.to_prompt()

        # Then
        assert "Action:" in prompt
        assert "{'type': 'action', 'data': 'some data'}" in prompt

    def test_given_context_when_to_dict_then_returns_all_fields(self, sample_agent_context):
        """Test that to_dict returns complete dictionary representation."""
        # Given
        context = sample_agent_context

        # When
        result = context.to_dict()

        # Then
        assert result["working_on"] == "Building authentication system"
        assert len(result["decisions"]) == 3
        assert result["decisions"][0] == "Use JWT tokens"
        assert len(result["relevant_files"]) == 3
        assert len(result["recent_events"]) == 2
        assert len(result["open_questions"]) == 2
        assert len(result["topics"]) == 3
        assert result["session_id"] == "test-session-123"
        assert result["updated_at"] == "2025-01-15T10:30:00Z"

    def test_given_empty_context_when_to_dict_then_returns_empty_collections(self):
        """Test that to_dict handles empty context properly."""
        # Given
        context = AgentContext(working_on="")

        # When
        result = context.to_dict()

        # Then
        assert result["working_on"] == ""
        assert result["decisions"] == []
        assert result["relevant_files"] == []
        assert result["recent_events"] == []
        assert result["open_questions"] == []
        assert result["topics"] == []


class TestConversationSummary:
    """Test suite for ConversationSummary class."""

    def test_given_session_id_when_initialized_then_creates_summary(self, mock_redis_memory):
        """Test that ConversationSummary initializes correctly."""
        # Given
        session_id = "test-session-123"

        # When
        summary = ConversationSummary(session_id)

        # Then
        assert summary.session_id == session_id
        assert summary.redis is not None

    def test_given_new_summary_when_update_working_on_then_stores_in_redis(self, mock_redis_memory):
        """Test that update_working_on stores value in Redis."""
        # Given
        summary = ConversationSummary("session-1")
        task = "Building API endpoints"

        # When
        summary.update_working_on(task)

        # Then
        mock_redis_memory.redis.hset.assert_called_with(
            "summary:session-1",
            "working_on",
            task,
        )

    def test_given_decision_when_add_decision_then_appends_to_list(self, mock_redis_memory):
        """Test that add_decision appends to decisions list."""
        # Given
        summary = ConversationSummary("session-1")
        mock_redis_memory.redis.hget.return_value = json.dumps(["Decision 1"])

        # When
        summary.add_decision("Decision 2")

        # Then
        calls = mock_redis_memory.redis.hset.call_args_list
        assert any("decisions" in str(call) for call in calls)
        stored_value = json.loads(calls[-1][0][2])
        assert "Decision 1" in stored_value
        assert "Decision 2" in stored_value

    def test_given_no_existing_decisions_when_add_decision_then_creates_new_list(
        self, mock_redis_memory
    ):
        """Test that add_decision creates new list if none exists."""
        # Given
        summary = ConversationSummary("session-1")
        mock_redis_memory.redis.hget.return_value = None

        # When
        summary.add_decision("First decision")

        # Then
        calls = mock_redis_memory.redis.hset.call_args_list
        stored_value = json.loads(calls[-1][0][2])
        assert stored_value == ["First decision"]

    def test_given_file_when_add_file_then_appends_to_list(self, mock_redis_memory):
        """Test that add_file appends to files list."""
        # Given
        summary = ConversationSummary("session-1")
        mock_redis_memory.redis.hget.return_value = json.dumps(["file1.py"])

        # When
        summary.add_file("file2.py")

        # Then
        calls = mock_redis_memory.redis.hset.call_args_list
        stored_value = json.loads(calls[-1][0][2])
        assert "file1.py" in stored_value
        assert "file2.py" in stored_value

    def test_given_duplicate_file_when_add_file_then_not_duplicated(self, mock_redis_memory):
        """Test that add_file doesn't add duplicates."""
        # Given
        summary = ConversationSummary("session-1")
        mock_redis_memory.redis.hget.return_value = json.dumps(["file1.py"])

        # When
        summary.add_file("file1.py")

        # Then
        calls = mock_redis_memory.redis.hset.call_args_list
        stored_value = json.loads(calls[-1][0][2])
        assert stored_value.count("file1.py") == 1

    def test_given_question_when_add_question_then_appends_to_list(self, mock_redis_memory):
        """Test that add_question appends to questions list."""
        # Given
        summary = ConversationSummary("session-1")
        mock_redis_memory.redis.hget.return_value = json.dumps(["Question 1?"])

        # When
        summary.add_question("Question 2?")

        # Then
        calls = mock_redis_memory.redis.hset.call_args_list
        stored_value = json.loads(calls[-1][0][2])
        assert "Question 1?" in stored_value
        assert "Question 2?" in stored_value

    def test_given_event_when_add_timeline_event_then_stores_with_timestamp(self, mock_redis_memory):
        """Test that add_timeline_event stores event with timestamp."""
        # Given
        summary = ConversationSummary("session-1")
        event_data = {"type": "code_change", "content": "Updated function"}

        # When
        with patch("time.time", return_value=1234567890.0):
            summary.add_timeline_event(event_data)

        # Then
        mock_redis_memory.redis.zadd.assert_called_once()
        call_args = mock_redis_memory.redis.zadd.call_args
        assert call_args[0][0] == "timeline:session-1"
        assert 1234567890.0 in call_args[1].values()

    def test_given_topic_when_add_topic_then_stores_in_redis(self, mock_redis_memory):
        """Test that add_topic stores topic in Redis."""
        # Given
        summary = ConversationSummary("session-1")
        mock_redis_memory.redis.hget.return_value = json.dumps(["topic1"])

        # When
        summary.add_topic("topic2")

        # Then
        calls = mock_redis_memory.redis.hset.call_args_list
        stored_value = json.loads(calls[-1][0][2])
        assert "topic1" in stored_value
        assert "topic2" in stored_value
        mock_redis_memory.redis.sadd.assert_called_with("topic_index:topic2", "session-1")

    def test_given_duplicate_topic_when_add_topic_then_not_duplicated(self, mock_redis_memory):
        """Test that add_topic doesn't add duplicate topics."""
        # Given
        summary = ConversationSummary("session-1")
        mock_redis_memory.redis.hget.return_value = json.dumps(["authentication"])

        # When
        summary.add_topic("authentication")

        # Then
        calls = mock_redis_memory.redis.hset.call_args_list
        stored_value = json.loads(calls[-1][0][2])
        assert stored_value.count("authentication") == 1

    def test_given_summary_data_when_get_context_then_returns_agent_context(
        self, mock_redis_memory
    ):
        """Test that get_context returns properly formatted AgentContext."""
        # Given
        summary = ConversationSummary("session-1")
        mock_redis_memory.redis.hgetall.return_value = {
            b"working_on": b"Test task",
            b"decisions": json.dumps(