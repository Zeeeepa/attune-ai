"""Behavioral tests for ab_testing.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

from __future__ import annotations

import hashlib
import json
import math
from datetime import datetime
from pathlib import Path
from typing import Any
from unittest.mock import MagicMock, Mock, mock_open, patch

import pytest

from empathy_os.socratic.ab_testing import (
    ABTestingManager,
    AllocationStrategy,
    Experiment,
    ExperimentStatus,
    Variant,
    calculate_sample_size,
    calculate_statistical_significance,
    determine_winning_variant,
)


# =============================================================================
# FIXTURES
# =============================================================================


@pytest.fixture
def temp_storage_path(tmp_path):
    """Given a temporary storage directory."""
    storage_dir = tmp_path / "ab_testing"
    storage_dir.mkdir()
    return storage_dir


@pytest.fixture
def control_variant():
    """Given a control variant."""
    return Variant(
        variant_id="control",
        name="Control",
        description="Control variant",
        config={"model": "gpt-4"},
        is_control=True,
        traffic_percentage=50.0,
    )


@pytest.fixture
def test_variant():
    """Given a test variant."""
    return Variant(
        variant_id="variant_a",
        name="Variant A",
        description="Test variant A",
        config={"model": "gpt-4-turbo"},
        is_control=False,
        traffic_percentage=50.0,
    )


@pytest.fixture
def experiment(control_variant, test_variant):
    """Given an experiment with control and test variants."""
    return Experiment(
        experiment_id="exp_001",
        name="Test Experiment",
        description="Testing different models",
        goal="Improve response quality",
        variants=[control_variant, test_variant],
        allocation_strategy=AllocationStrategy.FIXED,
    )


@pytest.fixture
def ab_manager(temp_storage_path):
    """Given an A/B testing manager."""
    return ABTestingManager(storage_path=temp_storage_path)


# =============================================================================
# VARIANT TESTS
# =============================================================================


class TestVariant:
    """Tests for Variant class."""

    def test_variant_creation(self):
        """
        Given variant parameters
        When creating a new variant
        Then it should initialize with correct values
        """
        # Given
        variant_id = "test_variant"
        name = "Test Variant"
        description = "A test variant"
        config = {"param": "value"}

        # When
        variant = Variant(
            variant_id=variant_id,
            name=name,
            description=description,
            config=config,
            is_control=False,
            traffic_percentage=30.0,
        )

        # Then
        assert variant.variant_id == variant_id
        assert variant.name == name
        assert variant.description == description
        assert variant.config == config
        assert variant.is_control is False
        assert variant.traffic_percentage == 30.0
        assert variant.impressions == 0
        assert variant.conversions == 0
        assert variant.total_success_score == 0.0

    def test_conversion_rate_zero_impressions(self):
        """
        Given a variant with zero impressions
        When calculating conversion rate
        Then it should return 0.0
        """
        # Given
        variant = Variant(
            variant_id="test",
            name="Test",
            description="Test",
            config={},
        )

        # When
        rate = variant.conversion_rate

        # Then
        assert rate == 0.0

    def test_conversion_rate_with_data(self):
        """
        Given a variant with impressions and conversions
        When calculating conversion rate
        Then it should return correct percentage
        """
        # Given
        variant = Variant(
            variant_id="test",
            name="Test",
            description="Test",
            config={},
        )
        variant.impressions = 100
        variant.conversions = 25

        # When
        rate = variant.conversion_rate

        # Then
        assert rate == 0.25

    def test_avg_success_score_zero_impressions(self):
        """
        Given a variant with zero impressions
        When calculating average success score
        Then it should return 0.0
        """
        # Given
        variant = Variant(
            variant_id="test",
            name="Test",
            description="Test",
            config={},
        )

        # When
        score = variant.avg_success_score

        # Then
        assert score == 0.0

    def test_avg_success_score_with_data(self):
        """
        Given a variant with impressions and success scores
        When calculating average success score
        Then it should return correct average
        """
        # Given
        variant = Variant(
            variant_id="test",
            name="Test",
            description="Test",
            config={},
        )
        variant.impressions = 10
        variant.total_success_score = 75.0

        # When
        score = variant.avg_success_score

        # Then
        assert score == 7.5

    def test_to_dict(self):
        """
        Given a variant with data
        When converting to dictionary
        Then it should include all fields
        """
        # Given
        variant = Variant(
            variant_id="test",
            name="Test",
            description="Test variant",
            config={"key": "value"},
            is_control=True,
            traffic_percentage=60.0,
        )
        variant.impressions = 50
        variant.conversions = 10
        variant.total_success_score = 400.0

        # When
        data = variant.to_dict()

        # Then
        assert data["variant_id"] == "test"
        assert data["name"] == "Test"
        assert data["description"] == "Test variant"
        assert data["config"] == {"key": "value"}
        assert data["is_control"] is True
        assert data["traffic_percentage"] == 60.0
        assert data["impressions"] == 50
        assert data["conversions"] == 10
        assert data["total_success_score"] == 400.0

    def test_from_dict(self):
        """
        Given a dictionary with variant data
        When creating variant from dictionary
        Then it should initialize correctly
        """
        # Given
        data = {
            "variant_id": "test",
            "name": "Test",
            "description": "Test variant",
            "config": {"key": "value"},
            "is_control": True,
            "traffic_percentage": 60.0,
            "impressions": 50,
            "conversions": 10,
            "total_success_score": 400.0,
        }

        # When
        variant = Variant.from_dict(data)

        # Then
        assert variant.variant_id == "test"
        assert variant.name == "Test"
        assert variant.impressions == 50
        assert variant.conversions == 10


# =============================================================================
# EXPERIMENT TESTS
# =============================================================================


class TestExperiment:
    """Tests for Experiment class."""

    def test_experiment_creation(self, control_variant, test_variant):
        """
        Given experiment parameters
        When creating a new experiment
        Then it should initialize with correct values
        """
        # Given
        experiment_id = "exp_001"
        name = "Test Experiment"
        description = "Testing"
        goal = "Improve quality"
        variants = [control_variant, test_variant]

        # When
        experiment = Experiment(
            experiment_id=experiment_id,
            name=name,
            description=description,
            goal=goal,
            variants=variants,
            allocation_strategy=AllocationStrategy.FIXED,
        )

        # Then
        assert experiment.experiment_id == experiment_id
        assert experiment.name == name
        assert experiment.description == description
        assert experiment.goal == goal
        assert len(experiment.variants) == 2
        assert experiment.status == ExperimentStatus.DRAFT
        assert experiment.allocation_strategy == AllocationStrategy.FIXED

    def test_get_variant(self, experiment):
        """
        Given an experiment with variants
        When getting a variant by ID
        Then it should return the correct variant
        """
        # Given/When
        variant = experiment.get_variant("control")

        # Then
        assert variant is not None
        assert variant.variant_id == "control"

    def test_get_variant_not_found(self, experiment):
        """
        Given an experiment with variants
        When getting a non-existent variant
        Then it should return None
        """
        # Given/When
        variant = experiment.get_variant("non_existent")

        # Then
        assert variant is None

    def test_start_experiment(self, experiment):
        """
        Given a draft experiment
        When starting the experiment
        Then it should change status to running and set start time
        """
        # Given
        assert experiment.status == ExperimentStatus.DRAFT
        assert experiment.start_time is None

        # When
        experiment.start()

        # Then
        assert experiment.status == ExperimentStatus.RUNNING
        assert experiment.start_time is not None

    def test_pause_experiment(self, experiment):
        """
        Given a running experiment
        When pausing the experiment
        Then it should change status to paused
        """
        # Given
        experiment.start()
        assert experiment.status == ExperimentStatus.RUNNING

        # When
        experiment.pause()

        # Then
        assert experiment.status == ExperimentStatus.PAUSED

    def test_resume_experiment(self, experiment):
        """
        Given a paused experiment
        When resuming the experiment
        Then it should change status to running
        """
        # Given
        experiment.start()
        experiment.pause()
        assert experiment.status == ExperimentStatus.PAUSED

        # When
        experiment.resume()

        # Then
        assert experiment.status == ExperimentStatus.RUNNING

    def test_complete_experiment(self, experiment):
        """
        Given a running experiment
        When completing the experiment
        Then it should change status to completed and set end time
        """
        # Given
        experiment.start()
        assert experiment.end_time is None

        # When
        experiment.complete()

        # Then
        assert experiment.status == ExperimentStatus.COMPLETED
        assert experiment.end_time is not None

    def test_stop_experiment(self, experiment):
        """
        Given a running experiment
        When stopping the experiment
        Then it should change status to stopped and set end time
        """
        # Given
        experiment.start()

        # When
        experiment.stop()

        # Then
        assert experiment.status == ExperimentStatus.STOPPED
        assert experiment.end_time is not None

    def test_record_impression(self, experiment):
        """
        Given an experiment and variant
        When recording an impression
        Then it should increment the impression count
        """
        # Given
        variant_id = "control"
        initial_impressions = experiment.get_variant(variant_id).impressions

        # When
        experiment.record_impression(variant_id)

        # Then
        assert experiment.get_variant(variant_id).impressions == initial_impressions + 1

    def test_record_conversion(self, experiment):
        """
        Given an experiment and variant
        When recording a conversion with success score
        Then it should increment conversions and update success score
        """
        # Given
        variant_id = "control"
        variant = experiment.get_variant(variant_id)
        initial_conversions = variant.conversions
        initial_score = variant.total_success_score
        success_score = 8.5

        # When
        experiment.record_conversion(variant_id, success_score)

        # Then
        assert variant.conversions == initial_conversions + 1
        assert variant.total_success_score == initial_score + success_score

    def test_to_dict(self, experiment):
        """
        Given an experiment
        When converting to dictionary
        Then it should include all fields
        """
        # Given
        experiment.start()

        # When
        data = experiment.to_dict()

        # Then
        assert data["experiment_id"] == "exp_001"
        assert data["name"] == "Test Experiment"
        assert data["status"] == "running"
        assert len(data["variants"]) == 2
        assert "start_time" in data

    def test_from_dict(self, control_variant, test_variant):
        """
        Given a dictionary with experiment data
        When creating experiment from dictionary
        Then it should initialize correctly
        """
        # Given
        data = {
            "experiment_id": "exp_002",
            "name": "Test",
            "description": "Test desc",
            "goal": "Test goal",
            "variants": [control_variant.to_dict(), test_variant.to_dict()],
            "status": "running",
            "allocation_strategy": "fixed",
            "start_time": "2026-01-01T00:00:00",
            "end_time": None,
            "epsilon": 0.1,
            "metadata": {},
        }

        # When
        experiment = Experiment.from_dict(data)

        # Then
        assert experiment.experiment_id == "exp_002"
        assert experiment.name == "Test"
        assert len(experiment.variants) == 2
        assert experiment.status == ExperimentStatus.RUNNING


# =============================================================================
# AB TESTING MANAGER TESTS
# =============================================================================


class TestABTestingManager:
    """Tests for ABTestingManager class."""

    def test_manager_creation(self, temp_storage_path):
        """
        Given a storage path
        When creating an AB testing manager
        Then it should initialize correctly
        """
        # Given/When
        manager = ABTestingManager(storage_path=temp_storage_path)

        # Then
        assert manager.storage_path == temp_storage_path
        assert len(manager.experiments) == 0

    def test_create_experiment(self, ab_manager, control_variant, test_variant):
        """
        Given experiment parameters
        When creating an experiment
        Then it should add it to the manager
        """
        # Given
        name = "New Experiment"
        description = "Testing"
        goal = "Improve metrics"
        variants = [control_variant, test_variant]

        # When
        experiment = ab_manager.create_experiment(
            name=name,
            description=description,
            goal=goal,
            variants=variants,
        )

        # Then
        assert experiment.name == name
        assert len(ab_manager.experiments) == 1
        assert ab_manager.experiments[experiment.experiment_id] == experiment

    def test_get_experiment(self, ab_manager, experiment):
        """
        Given a manager with an experiment
        When getting the experiment by ID
        Then it should return the experiment
        """
        # Given
        ab_manager.experiments[experiment.experiment_id] = experiment

        # When
        retrieved = ab_manager.get_experiment(experiment.experiment_id)

        # Then
        assert retrieved == experiment

    def test_get_experiment_not_found(self, ab_manager):
        """
        Given a manager without experiments
        When getting a non-existent experiment
        Then it should return None
        """
        # Given/When
        experiment = ab_manager.get_experiment("non_existent")

        # Then
        assert experiment is None

    def test_list_experiments_all(self, ab_manager, experiment):
        """
        Given a manager with experiments
        When listing all experiments
        Then it should return all experiments
        """
        # Given
        ab_manager.experiments[experiment.experiment_id] = experiment

        # When
        experiments = ab_manager.list_experiments()

        # Then
        assert len(experiments) == 1
        assert experiments[0] == experiment

    def test_list_experiments_by_