"""Behavioral tests for secrets_detector.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import math
import re
from unittest.mock import Mock, patch

import pytest
import structlog

from empathy_os.memory.security.secrets_detector import (
    SecretDetection,
    SecretType,
    SecretsDetector,
    Severity,
)


# Fixtures


@pytest.fixture
def detector():
    """Given a SecretsDetector instance."""
    return SecretsDetector()


@pytest.fixture
def mock_logger():
    """Given a mocked logger."""
    with patch("empathy_os.memory.security.secrets_detector.logger") as mock_log:
        yield mock_log


@pytest.fixture
def sample_secret_detection():
    """Given a sample SecretDetection object."""
    return SecretDetection(
        secret_type=SecretType.OPENAI_API_KEY,
        severity=Severity.HIGH,
        line_number=1,
        column_start=10,
        column_end=50,
        context_snippet="api_key = ...",
        confidence=0.95,
        metadata={"provider": "openai"},
    )


# SecretType Enum Tests


class TestSecretType:
    """Tests for SecretType enum."""

    def test_given_secret_type_enum_when_accessing_values_then_returns_correct_strings(
        self,
    ):
        """Given SecretType enum, when accessing values, then returns correct strings."""
        # When/Then
        assert SecretType.ANTHROPIC_API_KEY.value == "anthropic_api_key"
        assert SecretType.OPENAI_API_KEY.value == "openai_api_key"
        assert SecretType.AWS_ACCESS_KEY.value == "aws_access_key"
        assert SecretType.PASSWORD.value == "password"
        assert SecretType.RSA_PRIVATE_KEY.value == "rsa_private_key"
        assert SecretType.JWT_TOKEN.value == "jwt_token"
        assert SecretType.DATABASE_URL.value == "database_url"
        assert SecretType.HIGH_ENTROPY_STRING.value == "high_entropy_string"

    def test_given_secret_types_when_iterating_then_includes_all_types(self):
        """Given SecretType enum, when iterating, then includes all secret types."""
        # When
        secret_types = list(SecretType)

        # Then
        assert len(secret_types) > 15
        assert SecretType.GENERIC_API_KEY in secret_types
        assert SecretType.BEARER_TOKEN in secret_types


# Severity Enum Tests


class TestSeverity:
    """Tests for Severity enum."""

    def test_given_severity_enum_when_accessing_values_then_returns_correct_strings(
        self,
    ):
        """Given Severity enum, when accessing values, then returns correct strings."""
        # When/Then
        assert Severity.CRITICAL.value == "critical"
        assert Severity.HIGH.value == "high"
        assert Severity.MEDIUM.value == "medium"
        assert Severity.LOW.value == "low"

    def test_given_severity_levels_when_comparing_then_maintains_order(self):
        """Given severity levels, when comparing, then maintains priority order."""
        # When
        severities = [Severity.CRITICAL, Severity.HIGH, Severity.MEDIUM, Severity.LOW]

        # Then
        assert len(severities) == 4
        assert Severity.CRITICAL in severities


# SecretDetection Tests


class TestSecretDetection:
    """Tests for SecretDetection dataclass."""

    def test_given_detection_data_when_creating_instance_then_stores_all_fields(self):
        """Given detection data, when creating instance, then stores all fields correctly."""
        # Given
        secret_type = SecretType.AWS_SECRET_KEY
        severity = Severity.CRITICAL
        line_number = 42
        column_start = 5
        column_end = 45

        # When
        detection = SecretDetection(
            secret_type=secret_type,
            severity=severity,
            line_number=line_number,
            column_start=column_start,
            column_end=column_end,
        )

        # Then
        assert detection.secret_type == secret_type
        assert detection.severity == severity
        assert detection.line_number == line_number
        assert detection.column_start == column_start
        assert detection.column_end == column_end
        assert detection.context_snippet == ""
        assert detection.confidence == 1.0
        assert detection.metadata == {}

    def test_given_detection_with_optional_fields_when_creating_then_stores_optional_data(
        self,
    ):
        """Given detection with optional fields, when creating, then stores optional data."""
        # Given
        context = "password = ..."
        confidence = 0.75
        metadata = {"key": "value"}

        # When
        detection = SecretDetection(
            secret_type=SecretType.PASSWORD,
            severity=Severity.HIGH,
            line_number=1,
            column_start=0,
            column_end=20,
            context_snippet=context,
            confidence=confidence,
            metadata=metadata,
        )

        # Then
        assert detection.context_snippet == context
        assert detection.confidence == confidence
        assert detection.metadata == metadata

    def test_given_detection_when_converting_to_dict_then_returns_serializable_dict(
        self, sample_secret_detection
    ):
        """Given detection, when converting to dict, then returns serializable dictionary."""
        # When
        result = sample_secret_detection.to_dict()

        # Then
        assert isinstance(result, dict)
        assert result["secret_type"] == "openai_api_key"
        assert result["severity"] == "high"
        assert result["line_number"] == 1
        assert result["column_start"] == 10
        assert result["column_end"] == 50
        assert result["context_snippet"] == "api_key = ..."
        assert result["confidence"] == 0.95
        assert result["metadata"] == {"provider": "openai"}

    def test_given_detection_with_default_values_when_converting_to_dict_then_includes_defaults(
        self,
    ):
        """Given detection with defaults, when converting to dict, then includes default values."""
        # Given
        detection = SecretDetection(
            secret_type=SecretType.GENERIC_API_KEY,
            severity=Severity.MEDIUM,
            line_number=5,
            column_start=0,
            column_end=10,
        )

        # When
        result = detection.to_dict()

        # Then
        assert result["context_snippet"] == ""
        assert result["confidence"] == 1.0
        assert result["metadata"] == {}


# SecretsDetector Initialization Tests


class TestSecretsDetectorInitialization:
    """Tests for SecretsDetector initialization."""

    def test_given_no_args_when_creating_detector_then_uses_default_config(self):
        """Given no arguments, when creating detector, then uses default configuration."""
        # When
        detector = SecretsDetector()

        # Then
        assert detector.min_entropy_threshold == 4.5
        assert detector.min_secret_length == 16
        assert detector.max_secret_length == 512
        assert isinstance(detector.patterns, dict)
        assert len(detector.patterns) > 0

    def test_given_custom_config_when_creating_detector_then_applies_custom_config(
        self,
    ):
        """Given custom config, when creating detector, then applies custom configuration."""
        # Given
        min_entropy = 5.0
        min_length = 20
        max_length = 256

        # When
        detector = SecretsDetector(
            min_entropy_threshold=min_entropy,
            min_secret_length=min_length,
            max_secret_length=max_length,
        )

        # Then
        assert detector.min_entropy_threshold == min_entropy
        assert detector.min_secret_length == min_length
        assert detector.max_secret_length == max_length

    def test_given_detector_when_initialized_then_compiles_regex_patterns(
        self, detector
    ):
        """Given detector, when initialized, then compiles regex patterns."""
        # Then
        assert isinstance(detector.patterns, dict)
        for secret_type, pattern in detector.patterns.items():
            assert isinstance(secret_type, SecretType)
            assert isinstance(pattern, re.Pattern)


# Pattern Detection Tests


class TestPatternDetection:
    """Tests for detecting secrets using regex patterns."""

    def test_given_anthropic_api_key_when_scanning_then_detects_key(self, detector):
        """Given Anthropic API key, when scanning, then detects the key."""
        # Given
        text = 'api_key = "sk-ant-api03-1234567890abcdef"'

        # When
        detections = detector.scan(text)

        # Then
        assert len(detections) > 0
        assert any(d.secret_type == SecretType.ANTHROPIC_API_KEY for d in detections)

    def test_given_openai_api_key_when_scanning_then_detects_key(self, detector):
        """Given OpenAI API key, when scanning, then detects the key."""
        # Given
        text = 'OPENAI_API_KEY="sk-1234567890abcdefghijklmnopqrstuvwxyz123456"'

        # When
        detections = detector.scan(text)

        # Then
        assert len(detections) > 0
        assert any(d.secret_type == SecretType.OPENAI_API_KEY for d in detections)

    def test_given_aws_access_key_when_scanning_then_detects_key(self, detector):
        """Given AWS access key, when scanning, then detects the key."""
        # Given
        text = "AWS_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE"

        # When
        detections = detector.scan(text)

        # Then
        assert len(detections) > 0
        assert any(d.secret_type == SecretType.AWS_ACCESS_KEY for d in detections)

    def test_given_aws_secret_key_when_scanning_then_detects_key_with_critical_severity(
        self, detector
    ):
        """Given AWS secret key, when scanning, then detects key with critical severity."""
        # Given
        text = "aws_secret_access_key=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"

        # When
        detections = detector.scan(text)

        # Then
        assert len(detections) > 0
        aws_detections = [
            d for d in detections if d.secret_type == SecretType.AWS_SECRET_KEY
        ]
        assert len(aws_detections) > 0
        assert all(d.severity == Severity.CRITICAL for d in aws_detections)

    def test_given_github_token_when_scanning_then_detects_token(self, detector):
        """Given GitHub token, when scanning, then detects the token."""
        # Given
        text = "github_token=ghp_1234567890abcdefghijklmnopqrstuvwxyz"

        # When
        detections = detector.scan(text)

        # Then
        assert len(detections) > 0
        assert any(d.secret_type == SecretType.GITHUB_TOKEN for d in detections)

    def test_given_slack_token_when_scanning_then_detects_token(self, detector):
        """Given Slack token, when scanning, then detects the token."""
        # Given
        text = "SLACK_TOKEN=xoxb-FAKE-TEST-TOKEN-NOT-REAL-abcdefghijklmnop"

        # When
        detections = detector.scan(text)

        # Then
        assert len(detections) > 0
        assert any(d.secret_type == SecretType.SLACK_TOKEN for d in detections)

    def test_given_stripe_key_when_scanning_then_detects_key(self, detector):
        """Given Stripe key, when scanning, then detects the key."""
        # Given
        text = "stripe_key=sk_test_FAKE_NOT_REAL_TEST_KEY_EXAMPLE_12345"

        # When
        detections = detector.scan(text)

        # Then
        assert len(detections) > 0
        assert any(d.secret_type == SecretType.STRIPE_KEY for d in detections)

    def test_given_generic_api_key_pattern_when_scanning_then_detects_key(
        self, detector
    ):
        """Given generic API key pattern, when scanning, then detects the key."""
        # Given
        text = "api_key=abcdef1234567890abcdef1234567890"

        # When
        detections = detector.scan(text)

        # Then
        assert len(detections) > 0
        # Should detect either as generic API key or high entropy string

    def test_given_password_in_assignment_when_scanning_then_detects_password(
        self, detector
    ):
        """Given password in assignment, when scanning, then detects password."""
        # Given
        text = 'password = "MySecretPassword123!"'

        # When
        detections = detector.scan(text)

        # Then
        assert len(detections) > 0
        assert any(d.secret_type == SecretType.PASSWORD for d in detections)

    def test_given_basic_auth_header_when_scanning_then_detects_auth(self, detector):
        """Given Basic Auth header, when scanning, then detects authentication."""
        # Given
        text = "Authorization: Basic dXNlcm5hbWU6cGFzc3dvcmQ="

        # When
        detections = detector.scan(text)

        # Then
        assert len(detections) > 0
        assert any(d.secret_type == SecretType.BASIC_AUTH for d in detections)

    def test_given_rsa_private_key_when_scanning_then_detects_key_with_critical_severity(
        self, detector
    ):
        """Given RSA private key, when scanning, then detects key with critical severity."""
        # Given
        text = """-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEA1234567890abcdef
-----END RSA PRIVATE KEY-----"""

        # When
        detections = detector.scan(text)

        # Then
        assert len(detections) > 0
        rsa_detections = [
            d for d in detections if d.secret_type == SecretType.RSA_PRIVATE_KEY
        ]
        assert len(rsa_detections) > 0
        assert all(d.severity == Severity.CRITICAL for d in rsa_detections)

    def test_given_ssh_private_key_when_scanning_then_detects_key(self, detector):
        """Given SSH private key, when scanning, then detects the key."""
        # Given
        text = """-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAA
-----END OPENSSH PRIVATE KEY-----"""

        # When
        detections = detector.scan(text)

        # Then
        assert len(detections) > 0
        assert any(d.secret_type == SecretType.SSH_PRIVATE_KEY for d in detections)

    def test_given_ec_private_key_when_scanning_then_detects_key(self, detector