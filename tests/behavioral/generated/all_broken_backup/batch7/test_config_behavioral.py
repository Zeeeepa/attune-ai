"""Behavioral tests for config.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import json
import os
import tempfile
from pathlib import Path
from unittest.mock import MagicMock, patch

import pytest

from empathy_os.models import ModelInfo
from empathy_os.models.registry import ModelProvider, ModelTier
from empathy_os.workflows.config import (
    DEFAULT_MODELS,
    ModelConfig,
    WorkflowConfig,
    _validate_file_path,
    get_model,
)


class TestValidateFilePath:
    """Behavioral tests for _validate_file_path function."""

    def test_given_valid_path_when_validating_then_returns_resolved_path(self):
        """Given a valid file path, when validating, then returns resolved Path object."""
        # Given
        path = "test_file.txt"

        # When
        result = _validate_file_path(path)

        # Then
        assert isinstance(result, Path)
        assert result.is_absolute()

    def test_given_empty_string_when_validating_then_raises_value_error(self):
        """Given an empty string, when validating, then raises ValueError."""
        # Given
        path = ""

        # When/Then
        with pytest.raises(ValueError, match="path must be a non-empty string"):
            _validate_file_path(path)

    def test_given_none_when_validating_then_raises_value_error(self):
        """Given None, when validating, then raises ValueError."""
        # Given
        path = None

        # When/Then
        with pytest.raises(ValueError, match="path must be a non-empty string"):
            _validate_file_path(path)

    def test_given_path_with_null_bytes_when_validating_then_raises_value_error(self):
        """Given a path with null bytes, when validating, then raises ValueError."""
        # Given
        path = "test\x00file.txt"

        # When/Then
        with pytest.raises(ValueError, match="path contains null bytes"):
            _validate_file_path(path)

    def test_given_path_outside_allowed_dir_when_validating_then_raises_value_error(self):
        """Given a path outside allowed directory, when validating, then raises ValueError."""
        # Given
        with tempfile.TemporaryDirectory() as tmpdir:
            path = "/tmp/outside.txt"
            allowed_dir = tmpdir

            # When/Then
            with pytest.raises(ValueError, match=f"path must be within {allowed_dir}"):
                _validate_file_path(path, allowed_dir)

    def test_given_path_in_etc_when_validating_then_raises_value_error(self):
        """Given a path in /etc, when validating, then raises ValueError."""
        # Given
        path = "/etc/passwd"

        # When/Then
        with pytest.raises(ValueError, match="Cannot write to system directory: /etc"):
            _validate_file_path(path)

    def test_given_path_in_sys_when_validating_then_raises_value_error(self):
        """Given a path in /sys, when validating, then raises ValueError."""
        # Given
        path = "/sys/kernel/debug"

        # When/Then
        with pytest.raises(ValueError, match="Cannot write to system directory: /sys"):
            _validate_file_path(path)

    def test_given_path_in_proc_when_validating_then_raises_value_error(self):
        """Given a path in /proc, when validating, then raises ValueError."""
        # Given
        path = "/proc/cpuinfo"

        # When/Then
        with pytest.raises(ValueError, match="Cannot write to system directory: /proc"):
            _validate_file_path(path)

    def test_given_path_in_dev_when_validating_then_raises_value_error(self):
        """Given a path in /dev, when validating, then raises ValueError."""
        # Given
        path = "/dev/null"

        # When/Then
        with pytest.raises(ValueError, match="Cannot write to system directory: /dev"):
            _validate_file_path(path)

    def test_given_path_within_allowed_dir_when_validating_then_returns_path(self):
        """Given a path within allowed directory, when validating, then returns resolved path."""
        # Given
        with tempfile.TemporaryDirectory() as tmpdir:
            path = os.path.join(tmpdir, "test.txt")
            allowed_dir = tmpdir

            # When
            result = _validate_file_path(path, allowed_dir)

            # Then
            assert isinstance(result, Path)
            assert str(result).startswith(tmpdir)

    def test_given_invalid_path_when_validating_then_raises_value_error(self):
        """Given an invalid path, when validating, then raises ValueError."""
        # Given
        with patch("pathlib.Path.resolve", side_effect=OSError("Invalid path")):
            path = "invalid"

            # When/Then
            with pytest.raises(ValueError, match="Invalid path"):
                _validate_file_path(path)


class TestModelConfig:
    """Behavioral tests for ModelConfig class."""

    def test_given_model_info_when_creating_from_model_info_then_returns_model_config(self):
        """Given a ModelInfo object, when creating ModelConfig, then returns ModelConfig with correct values."""
        # Given
        model_info = ModelInfo(
            name="gpt-4",
            provider=ModelProvider.OPENAI,
            tier=ModelTier.ADVANCED,
            input_cost_per_million=30.0,
            output_cost_per_million=60.0,
            max_tokens=8192,
            supports_vision=True,
            supports_tools=True,
        )

        # When
        config = ModelConfig.from_model_info(model_info)

        # Then
        assert config.name == "gpt-4"
        assert config.provider == "openai"
        assert config.tier == "advanced"
        assert config.input_cost_per_million == 30.0
        assert config.output_cost_per_million == 60.0
        assert config.max_tokens == 8192
        assert config.supports_vision is True
        assert config.supports_tools is True

    def test_given_minimal_model_info_when_creating_from_model_info_then_uses_defaults(self):
        """Given a minimal ModelInfo, when creating ModelConfig, then uses default values."""
        # Given
        model_info = ModelInfo(
            name="test-model",
            provider=ModelProvider.LOCAL,
            tier=ModelTier.BASIC,
        )

        # When
        config = ModelConfig.from_model_info(model_info)

        # Then
        assert config.name == "test-model"
        assert config.provider == "local"
        assert config.tier == "basic"
        assert config.input_cost_per_million == 0.0
        assert config.output_cost_per_million == 0.0
        assert config.max_tokens == 4096
        assert config.supports_vision is False
        assert config.supports_tools is True

    def test_given_model_config_when_accessing_attributes_then_returns_correct_values(self):
        """Given a ModelConfig instance, when accessing attributes, then returns correct values."""
        # Given
        config = ModelConfig(
            name="claude-3-opus",
            provider="anthropic",
            tier="advanced",
            input_cost_per_million=15.0,
            output_cost_per_million=75.0,
            max_tokens=4096,
            supports_vision=True,
            supports_tools=True,
        )

        # When/Then
        assert config.name == "claude-3-opus"
        assert config.provider == "anthropic"
        assert config.tier == "advanced"
        assert config.input_cost_per_million == 15.0
        assert config.output_cost_per_million == 75.0
        assert config.max_tokens == 4096
        assert config.supports_vision is True
        assert config.supports_tools is True


class TestGetModel:
    """Behavioral tests for get_model function."""

    def test_given_valid_workflow_when_getting_model_then_returns_model_config(self):
        """Given a valid workflow name, when getting model, then returns ModelConfig."""
        # Given
        workflow = "chat"

        # When
        result = get_model(workflow)

        # Then
        assert isinstance(result, ModelConfig)
        assert result.name is not None

    def test_given_unknown_workflow_when_getting_model_then_returns_default_model(self):
        """Given an unknown workflow, when getting model, then returns default model."""
        # Given
        workflow = "unknown_workflow_xyz"

        # When
        result = get_model(workflow)

        # Then
        assert isinstance(result, ModelConfig)
        # Should return a default model from the registry

    @patch.dict(os.environ, {"EMPATHY_WORKFLOW_PROVIDER": "openai"})
    def test_given_env_var_provider_when_getting_model_then_uses_env_provider(self):
        """Given EMPATHY_WORKFLOW_PROVIDER env var, when getting model, then uses that provider."""
        # Given
        workflow = "chat"

        # When
        result = get_model(workflow)

        # Then
        assert result.provider == "openai"

    @patch.dict(os.environ, {"EMPATHY_CHAT_MODEL": "gpt-4"})
    def test_given_workflow_specific_env_var_when_getting_model_then_uses_specific_model(self):
        """Given workflow-specific env var, when getting model, then uses that model."""
        # Given
        workflow = "chat"

        # When
        result = get_model(workflow)

        # Then
        assert result.name == "gpt-4"

    def test_given_override_provider_when_getting_model_then_uses_override(self):
        """Given override provider argument, when getting model, then uses override provider."""
        # Given
        workflow = "chat"
        override_provider = "anthropic"

        # When
        result = get_model(workflow, provider=override_provider)

        # Then
        assert result.provider == "anthropic"

    def test_given_override_model_when_getting_model_then_uses_override(self):
        """Given override model argument, when getting model, then uses override model."""
        # Given
        workflow = "chat"
        override_model = "claude-3-opus-20240229"

        # When
        result = get_model(workflow, model=override_model)

        # Then
        assert result.name == "claude-3-opus-20240229"


class TestWorkflowConfig:
    """Behavioral tests for WorkflowConfig class."""

    def test_given_no_args_when_creating_workflow_config_then_uses_defaults(self):
        """Given no arguments, when creating WorkflowConfig, then uses default values."""
        # Given/When
        config = WorkflowConfig()

        # Then
        assert config.default_provider is not None
        assert config.default_model is not None

    def test_given_custom_provider_when_creating_workflow_config_then_uses_custom_provider(self):
        """Given custom provider, when creating WorkflowConfig, then uses custom provider."""
        # Given
        provider = "anthropic"

        # When
        config = WorkflowConfig(default_provider=provider)

        # Then
        assert config.default_provider == provider

    def test_given_custom_model_when_creating_workflow_config_then_uses_custom_model(self):
        """Given custom model, when creating WorkflowConfig, then uses custom model."""
        # Given
        model = "gpt-4"

        # When
        config = WorkflowConfig(default_model=model)

        # Then
        assert config.default_model == model

    def test_given_workflow_config_when_getting_model_for_workflow_then_returns_config(self):
        """Given a WorkflowConfig, when getting model for workflow, then returns ModelConfig."""
        # Given
        config = WorkflowConfig()
        workflow = "chat"

        # When
        result = config.get_model(workflow)

        # Then
        assert isinstance(result, ModelConfig)

    def test_given_workflow_overrides_when_getting_model_then_uses_overrides(self):
        """Given workflow-specific overrides, when getting model, then uses overrides."""
        # Given
        config = WorkflowConfig(
            workflow_overrides={"chat": {"provider": "anthropic", "model": "claude-3-opus"}}
        )
        workflow = "chat"

        # When
        result = config.get_model(workflow)

        # Then
        assert result.provider == "anthropic"
        assert "claude" in result.name.lower()

    @patch.dict(os.environ, {"EMPATHY_WORKFLOW_PROVIDER": "openai"})
    def test_given_env_var_when_creating_config_then_uses_env_var(self):
        """Given EMPATHY_WORKFLOW_PROVIDER env var, when creating config, then uses env var."""
        # Given/When
        config = WorkflowConfig()

        # Then
        assert config.default_provider == "openai"

    def test_given_config_file_when_loading_then_loads_config(self):
        """Given a config file, when loading WorkflowConfig, then loads configuration."""
        # Given
        with tempfile.NamedTemporaryFile(mode="w", suffix=".json", delete=False) as f:
            config_data = {
                "default_provider": "anthropic",
                "default_model": "claude-3-opus",
                "workflow_overrides": {"chat": {"model": "gpt-4"}},
            }
            json.dump(config_data, f)
            config_file = f.name

        try:
            # When
            config = WorkflowConfig.from_file(config_file)

            # Then
            assert config.default_provider == "anthropic"
            assert config.default_model == "claude-3-opus"
            assert "chat" in config.workflow_overrides
        finally:
            os.unlink(config_file)

    def test_given_yaml_config_when_loading_then_loads_yaml_config(self):
        """Given a YAML config file, when loading WorkflowConfig, then loads configuration."""
        # Given
        pytest.importorskip("yaml")
        with tempfile.NamedTemporaryFile(mode="w", suffix=".yaml", delete=False) as f:
            f.write(
                """
default_provider: openai
default_model: gpt-4
workflow_overrides:
  chat:
    model: gpt-3.5-turbo
"""
            )
            config_file = f.name

        try:
            # When
            config = WorkflowConfig.from_file(config_file)

            # Then
            assert config.default_provider == "openai"
            assert config.default_model == "gpt-4"
            assert "chat" in config.workflow_overrides
        finally:
            os.unlink(config_file)

    def test_given_nonexistent_file_when_loading_then_raises_error(self):
        """Given a nonexistent config file, when loading, then raises FileNotFoundError."""
        # Given
        config_file = "/nonexistent/path/config.json"

        # When/Then
        with pytest.raises(FileNotFoundError):
            WorkflowConfig.from_file(config_file)

    def test_given_invalid_json_when_loading_then_raises_error(self):
        """Given an invalid JSON config file, when loading, then raises error."""
        # Given
        with tempfile.NamedTempor