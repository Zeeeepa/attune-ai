"""Behavioral tests for workflow.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import argparse
import pytest
from unittest.mock import Mock, MagicMock, patch

from empathy_os.cli.parsers import workflow


class TestRegisterParsers:
    """Behavioral tests for register_parsers function."""

    @pytest.fixture
    def mock_subparsers(self):
        """Create a mock subparsers object."""
        subparsers = Mock()
        parser = Mock()
        subparsers.add_parser.return_value = parser
        parser.add_argument = Mock()
        parser.set_defaults = Mock()
        return subparsers, parser

    def test_given_subparsers_when_register_parsers_then_workflow_parser_added(
        self, mock_subparsers
    ):
        """
        Given: A valid subparsers object
        When: register_parsers is called
        Then: A workflow parser is added with correct help text
        """
        subparsers, parser = mock_subparsers

        workflow.register_parsers(subparsers)

        subparsers.add_parser.assert_any_call(
            "workflow",
            help="Multi-model workflows for cost-optimized task pipelines",
        )

    def test_given_subparsers_when_register_parsers_then_workflow_setup_parser_added(
        self, mock_subparsers
    ):
        """
        Given: A valid subparsers object
        When: register_parsers is called
        Then: A workflow-setup parser is added with deprecated notice
        """
        subparsers, parser = mock_subparsers

        workflow.register_parsers(subparsers)

        subparsers.add_parser.assert_any_call(
            "workflow-setup",
            help="[DEPRECATED] Interactive setup wizard (use 'empathy init' instead)",
        )

    def test_given_subparsers_when_register_parsers_then_action_argument_added(
        self, mock_subparsers
    ):
        """
        Given: A valid subparsers object
        When: register_parsers is called
        Then: Action argument is added with correct choices
        """
        subparsers, parser = mock_subparsers

        workflow.register_parsers(subparsers)

        # Verify action argument was added
        parser.add_argument.assert_any_call(
            "action",
            choices=["list", "describe", "run", "config"],
            help="Action: list, describe, run, or config",
        )

    def test_given_subparsers_when_register_parsers_then_name_argument_added(
        self, mock_subparsers
    ):
        """
        Given: A valid subparsers object
        When: register_parsers is called
        Then: Name argument is added as optional
        """
        subparsers, parser = mock_subparsers

        workflow.register_parsers(subparsers)

        parser.add_argument.assert_any_call(
            "name",
            nargs="?",
            help="Workflow name (for describe/run)",
        )

    def test_given_subparsers_when_register_parsers_then_input_argument_added(
        self, mock_subparsers
    ):
        """
        Given: A valid subparsers object
        When: register_parsers is called
        Then: Input argument is added with short flag
        """
        subparsers, parser = mock_subparsers

        workflow.register_parsers(subparsers)

        parser.add_argument.assert_any_call(
            "--input",
            "-i",
            help="JSON input data for workflow execution",
        )

    def test_given_subparsers_when_register_parsers_then_provider_argument_added(
        self, mock_subparsers
    ):
        """
        Given: A valid subparsers object
        When: register_parsers is called
        Then: Provider argument is added with all supported providers
        """
        subparsers, parser = mock_subparsers

        workflow.register_parsers(subparsers)

        parser.add_argument.assert_any_call(
            "--provider",
            "-p",
            choices=["anthropic", "openai", "google", "ollama", "hybrid"],
            default=None,
            help="Model provider: anthropic, openai, google, ollama, or hybrid (mix of best models)",
        )

    def test_given_subparsers_when_register_parsers_then_force_argument_added(
        self, mock_subparsers
    ):
        """
        Given: A valid subparsers object
        When: register_parsers is called
        Then: Force argument is added as action store_true
        """
        subparsers, parser = mock_subparsers

        workflow.register_parsers(subparsers)

        parser.add_argument.assert_any_call(
            "--force",
            action="store_true",
            help="Force overwrite existing config file",
        )

    def test_given_subparsers_when_register_parsers_then_json_argument_added(
        self, mock_subparsers
    ):
        """
        Given: A valid subparsers object
        When: register_parsers is called
        Then: JSON argument is added as action store_true
        """
        subparsers, parser = mock_subparsers

        workflow.register_parsers(subparsers)

        parser.add_argument.assert_any_call(
            "--json",
            action="store_true",
            help="Output as JSON"
        )

    def test_given_subparsers_when_register_parsers_then_use_recommended_tier_argument_added(
        self, mock_subparsers
    ):
        """
        Given: A valid subparsers object
        When: register_parsers is called
        Then: Use-recommended-tier argument is added with proper help text
        """
        subparsers, parser = mock_subparsers

        workflow.register_parsers(subparsers)

        parser.add_argument.assert_any_call(
            "--use-recommended-tier",
            action="store_true",
            help="Enable intelligent tier fallback: start with CHEAP tier and automatically upgrade if quality gates fail",
        )

    def test_given_subparsers_when_register_parsers_then_write_tests_argument_added(
        self, mock_subparsers
    ):
        """
        Given: A valid subparsers object
        When: register_parsers is called
        Then: Write-tests argument is added for test-gen workflow
        """
        subparsers, parser = mock_subparsers

        workflow.register_parsers(subparsers)

        parser.add_argument.assert_any_call(
            "--write-tests",
            action="store_true",
            help="(test-gen workflow) Write generated tests to disk",
        )

    def test_given_subparsers_when_register_parsers_then_output_dir_argument_added(
        self, mock_subparsers
    ):
        """
        Given: A valid subparsers object
        When: register_parsers is called
        Then: Output-dir argument is added with default value
        """
        subparsers, parser = mock_subparsers

        workflow.register_parsers(subparsers)

        parser.add_argument.assert_any_call(
            "--output-dir",
            default="tests/generated",
            help="(test-gen workflow) Output directory for generated tests",
        )

    def test_given_subparsers_when_register_parsers_then_health_score_threshold_argument_added(
        self, mock_subparsers
    ):
        """
        Given: A valid subparsers object
        When: register_parsers is called
        Then: Health-score-threshold argument is added with proper type and default
        """
        subparsers, parser = mock_subparsers

        workflow.register_parsers(subparsers)

        parser.add_argument.assert_any_call(
            "--health-score-threshold",
            type=int,
            default=95,
            help="(health-check workflow) Minimum health score required (0-100, default: 95 for very strict quality)",
        )

    @patch('empathy_os.cli.parsers.workflow.workflow')
    def test_given_subparsers_when_register_parsers_then_workflow_func_set(
        self, mock_workflow_module, mock_subparsers
    ):
        """
        Given: A valid subparsers object
        When: register_parsers is called
        Then: Workflow parser has correct default function set
        """
        subparsers, parser = mock_subparsers
        mock_workflow_module.cmd_workflow = Mock()

        workflow.register_parsers(subparsers)

        parser.set_defaults.assert_any_call(func=mock_workflow_module.cmd_workflow)

    @patch('empathy_os.cli.parsers.workflow.workflow')
    def test_given_subparsers_when_register_parsers_then_workflow_setup_func_set(
        self, mock_workflow_module, mock_subparsers
    ):
        """
        Given: A valid subparsers object
        When: register_parsers is called
        Then: Workflow-setup parser has correct default function set
        """
        subparsers, parser = mock_subparsers
        mock_workflow_module.cmd_workflow_legacy = Mock()

        workflow.register_parsers(subparsers)

        parser.set_defaults.assert_any_call(func=mock_workflow_module.cmd_workflow_legacy)

    def test_given_subparsers_when_register_parsers_then_two_parsers_added(
        self, mock_subparsers
    ):
        """
        Given: A valid subparsers object
        When: register_parsers is called
        Then: Exactly two parsers are added (workflow and workflow-setup)
        """
        subparsers, parser = mock_subparsers

        workflow.register_parsers(subparsers)

        assert subparsers.add_parser.call_count == 2

    def test_given_subparsers_when_register_parsers_then_all_arguments_configured(
        self, mock_subparsers
    ):
        """
        Given: A valid subparsers object
        When: register_parsers is called
        Then: All workflow parser arguments are configured
        """
        subparsers, parser = mock_subparsers

        workflow.register_parsers(subparsers)

        # Should have 11 arguments for workflow parser
        # action, name, input, provider, force, json, use-recommended-tier,
        # write-tests, output-dir, health-score-threshold
        assert parser.add_argument.call_count >= 10


class TestIntegrationWithArgumentParser:
    """Integration tests with real ArgumentParser."""

    @pytest.fixture
    def parser(self):
        """Create a real ArgumentParser with workflow subparsers."""
        parser = argparse.ArgumentParser()
        subparsers = parser.add_subparsers(dest="command")
        workflow.register_parsers(subparsers)
        return parser

    def test_given_parser_when_parse_workflow_list_then_action_is_list(self, parser):
        """
        Given: A configured argument parser
        When: Parsing 'workflow list' command
        Then: Action is set to 'list'
        """
        args = parser.parse_args(["workflow", "list"])

        assert args.command == "workflow"
        assert args.action == "list"

    def test_given_parser_when_parse_workflow_describe_with_name_then_name_set(
        self, parser
    ):
        """
        Given: A configured argument parser
        When: Parsing 'workflow describe' with name
        Then: Action is 'describe' and name is set
        """
        args = parser.parse_args(["workflow", "describe", "test-workflow"])

        assert args.action == "describe"
        assert args.name == "test-workflow"

    def test_given_parser_when_parse_workflow_run_then_action_is_run(self, parser):
        """
        Given: A configured argument parser
        When: Parsing 'workflow run' command
        Then: Action is set to 'run'
        """
        args = parser.parse_args(["workflow", "run", "my-workflow"])

        assert args.action == "run"
        assert args.name == "my-workflow"

    def test_given_parser_when_parse_workflow_config_then_action_is_config(self, parser):
        """
        Given: A configured argument parser
        When: Parsing 'workflow config' command
        Then: Action is set to 'config'
        """
        args = parser.parse_args(["workflow", "config"])

        assert args.action == "config"

    def test_given_parser_when_parse_with_input_flag_then_input_set(self, parser):
        """
        Given: A configured argument parser
        When: Parsing with --input flag
        Then: Input is set correctly
        """
        args = parser.parse_args(["workflow", "run", "test", "--input", '{"key": "value"}'])

        assert args.input == '{"key": "value"}'

    def test_given_parser_when_parse_with_short_input_flag_then_input_set(self, parser):
        """
        Given: A configured argument parser
        When: Parsing with -i short flag
        Then: Input is set correctly
        """
        args = parser.parse_args(["workflow", "run", "test", "-i", "data.json"])

        assert args.input == "data.json"

    def test_given_parser_when_parse_with_provider_anthropic_then_provider_set(
        self, parser
    ):
        """
        Given: A configured argument parser
        When: Parsing with --provider anthropic
        Then: Provider is set to anthropic
        """
        args = parser.parse_args(["workflow", "run", "test", "--provider", "anthropic"])

        assert args.provider == "anthropic"

    def test_given_parser_when_parse_with_provider_openai_then_provider_set(
        self, parser
    ):
        """
        Given: A configured argument parser
        When: Parsing with --provider openai
        Then: Provider is set to openai
        """
        args = parser.parse_args(["workflow", "run", "test", "-p", "openai"])

        assert args.provider == "openai"

    def test_given_parser_when_parse_with_provider_google_then_provider_set(
        self, parser
    ):
        """
        Given: A configured argument parser
        When: Parsing with --provider google
        Then: Provider is set to google
        """
        args = parser.parse_args(["workflow", "run", "test", "--provider", "google"])

        assert args.provider == "google"

    def test_given_parser_when_parse_with_provider_ollama_then_provider_set(
        self, parser
    ):
        """
        Given: A configured argument parser
        When: Parsing with --provider ollama
        Then: Provider is set to ollama
        """
        args = parser.parse_args(["workflow", "run", "test", "--provider", "ollama"])

        assert args.provider == "ollama"

    def test_given_parser_when_parse_with_provider_hybrid_then_provider_set(
        self, parser
    ):
        """
        Given: A configured argument parser
        When: Parsing with --provider hybrid
        Then: Provider is set to hybrid
        """
        args =