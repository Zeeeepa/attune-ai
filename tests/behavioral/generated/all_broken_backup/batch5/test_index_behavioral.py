"""Behavioral tests for index.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import json
from datetime import datetime
from pathlib import Path
from unittest.mock import MagicMock, Mock, mock_open, patch

import pytest

from empathy_os.project_index.index import ProjectIndex
from empathy_os.project_index.models import (
    FileRecord,
    IndexConfig,
    ProjectSummary,
)


@pytest.fixture
def temp_project_root(tmp_path):
    """Create a temporary project root directory."""
    project_root = tmp_path / "test_project"
    project_root.mkdir()
    (project_root / ".empathy").mkdir()
    return project_root


@pytest.fixture
def mock_redis_client():
    """Create a mock Redis client."""
    return MagicMock()


@pytest.fixture
def sample_config():
    """Create a sample IndexConfig."""
    return IndexConfig(
        include_patterns=["*.py", "*.md"],
        exclude_patterns=["__pycache__", "*.pyc"],
        max_file_size_mb=10,
    )


@pytest.fixture
def sample_file_record():
    """Create a sample FileRecord."""
    return FileRecord(
        path="src/main.py",
        size_bytes=1024,
        modified_at=datetime(2025, 1, 1, 12, 0, 0),
        hash="abc123",
        mime_type="text/x-python",
    )


@pytest.fixture
def sample_index_data():
    """Create sample index data for JSON persistence."""
    return {
        "schema_version": "1.0",
        "generated_at": "2025-01-01T12:00:00",
        "config": {
            "include_patterns": ["*.py"],
            "exclude_patterns": ["*.pyc"],
            "max_file_size_mb": 10,
        },
        "summary": {
            "total_files": 2,
            "total_size_bytes": 2048,
            "file_types": {"py": 2},
            "indexed_at": "2025-01-01T12:00:00",
        },
        "records": {
            "src/main.py": {
                "path": "src/main.py",
                "size_bytes": 1024,
                "modified_at": "2025-01-01T12:00:00",
                "hash": "abc123",
                "mime_type": "text/x-python",
            },
            "src/utils.py": {
                "path": "src/utils.py",
                "size_bytes": 1024,
                "modified_at": "2025-01-01T12:00:00",
                "hash": "def456",
                "mime_type": "text/x-python",
            },
        },
    }


class TestProjectIndexInitialization:
    """Test ProjectIndex initialization behavior."""

    def test_given_project_root_when_init_then_creates_index_with_defaults(
        self, temp_project_root
    ):
        """Test that ProjectIndex initializes with default values."""
        # Given: A project root path
        # When: Initializing ProjectIndex
        index = ProjectIndex(str(temp_project_root))

        # Then: Index is created with defaults
        assert index.project_root == temp_project_root
        assert isinstance(index.config, IndexConfig)
        assert index.redis_client is None
        assert index.workers is None
        assert index.use_parallel is True
        assert index._records == {}
        assert isinstance(index._summary, ProjectSummary)
        assert index._generated_at is None

    def test_given_custom_config_when_init_then_uses_custom_config(
        self, temp_project_root, sample_config
    ):
        """Test that custom config is properly set."""
        # Given: A custom IndexConfig
        # When: Initializing with custom config
        index = ProjectIndex(str(temp_project_root), config=sample_config)

        # Then: Custom config is used
        assert index.config == sample_config
        assert index.config.include_patterns == ["*.py", "*.md"]
        assert index.config.max_file_size_mb == 10

    def test_given_redis_client_when_init_then_stores_redis_client(
        self, temp_project_root, mock_redis_client
    ):
        """Test that Redis client is properly stored."""
        # Given: A Redis client
        # When: Initializing with Redis client
        index = ProjectIndex(
            str(temp_project_root), redis_client=mock_redis_client
        )

        # Then: Redis client is stored
        assert index.redis_client == mock_redis_client

    def test_given_workers_config_when_init_then_stores_worker_count(
        self, temp_project_root
    ):
        """Test that worker count is properly stored."""
        # Given: A worker count
        # When: Initializing with worker count
        index = ProjectIndex(str(temp_project_root), workers=4)

        # Then: Worker count is stored
        assert index.workers == 4

    def test_given_use_parallel_false_when_init_then_disables_parallel(
        self, temp_project_root
    ):
        """Test that parallel processing can be disabled."""
        # Given: use_parallel set to False
        # When: Initializing with use_parallel=False
        index = ProjectIndex(str(temp_project_root), use_parallel=False)

        # Then: Parallel processing is disabled
        assert index.use_parallel is False

    def test_given_project_root_when_init_then_sets_index_path(
        self, temp_project_root
    ):
        """Test that index path is correctly set."""
        # Given: A project root
        # When: Initializing ProjectIndex
        index = ProjectIndex(str(temp_project_root))

        # Then: Index path is set correctly
        expected_path = temp_project_root / ".empathy" / "project_index.json"
        assert index._index_path == expected_path


class TestProjectIndexLoad:
    """Test ProjectIndex load behavior."""

    def test_given_no_index_file_when_load_then_returns_false(
        self, temp_project_root
    ):
        """Test that load returns False when no index file exists."""
        # Given: No index file exists
        index = ProjectIndex(str(temp_project_root))

        # When: Loading the index
        result = index.load()

        # Then: Load returns False
        assert result is False

    def test_given_valid_index_file_when_load_then_loads_successfully(
        self, temp_project_root, sample_index_data
    ):
        """Test that valid index file is loaded successfully."""
        # Given: A valid index file
        index = ProjectIndex(str(temp_project_root))
        index_path = temp_project_root / ".empathy" / "project_index.json"
        index_path.write_text(json.dumps(sample_index_data))

        # When: Loading the index
        result = index.load()

        # Then: Load succeeds and data is loaded
        assert result is True
        assert len(index._records) == 2
        assert "src/main.py" in index._records
        assert index.config.include_patterns == ["*.py"]

    def test_given_wrong_schema_version_when_load_then_returns_false(
        self, temp_project_root, sample_index_data
    ):
        """Test that mismatched schema version causes load to fail."""
        # Given: An index file with wrong schema version
        sample_index_data["schema_version"] = "2.0"
        index = ProjectIndex(str(temp_project_root))
        index_path = temp_project_root / ".empathy" / "project_index.json"
        index_path.write_text(json.dumps(sample_index_data))

        # When: Loading the index
        result = index.load()

        # Then: Load fails due to schema mismatch
        assert result is False

    def test_given_corrupted_json_when_load_then_returns_false(
        self, temp_project_root
    ):
        """Test that corrupted JSON causes load to fail."""
        # Given: A corrupted JSON file
        index = ProjectIndex(str(temp_project_root))
        index_path = temp_project_root / ".empathy" / "project_index.json"
        index_path.write_text("{ invalid json }")

        # When: Loading the index
        result = index.load()

        # Then: Load fails gracefully
        assert result is False

    def test_given_index_file_without_config_when_load_then_uses_defaults(
        self, temp_project_root
    ):
        """Test that missing config in index file uses defaults."""
        # Given: An index file without config section
        data = {
            "schema_version": "1.0",
            "generated_at": "2025-01-01T12:00:00",
            "summary": {
                "total_files": 0,
                "total_size_bytes": 0,
                "file_types": {},
                "indexed_at": "2025-01-01T12:00:00",
            },
            "records": {},
        }
        index = ProjectIndex(str(temp_project_root))
        index_path = temp_project_root / ".empathy" / "project_index.json"
        index_path.write_text(json.dumps(data))

        # When: Loading the index
        result = index.load()

        # Then: Load succeeds with default config
        assert result is True

    @patch("builtins.open", side_effect=PermissionError("Access denied"))
    def test_given_permission_error_when_load_then_returns_false(
        self, mock_file, temp_project_root
    ):
        """Test that permission error during load is handled."""
        # Given: Permission error on file access
        index = ProjectIndex(str(temp_project_root))
        index_path = temp_project_root / ".empathy" / "project_index.json"
        index_path.write_text("{}")  # Create file first

        # When: Loading the index with permission error
        result = index.load()

        # Then: Load fails gracefully
        assert result is False


class TestProjectIndexSave:
    """Test ProjectIndex save behavior."""

    def test_given_records_when_save_then_creates_index_file(
        self, temp_project_root, sample_file_record
    ):
        """Test that save creates index file with records."""
        # Given: An index with records
        index = ProjectIndex(str(temp_project_root))
        index._records["src/main.py"] = sample_file_record
        index._summary = ProjectSummary(
            total_files=1,
            total_size_bytes=1024,
            file_types={"py": 1},
            indexed_at=datetime(2025, 1, 1, 12, 0, 0),
        )
        index._generated_at = datetime(2025, 1, 1, 12, 0, 0)

        # When: Saving the index
        with patch("empathy_os.project_index.index._validate_file_path"):
            index.save()

        # Then: Index file is created
        index_path = temp_project_root / ".empathy" / "project_index.json"
        assert index_path.exists()
        data = json.loads(index_path.read_text())
        assert data["schema_version"] == "1.0"
        assert "src/main.py" in data["records"]

    def test_given_empty_index_when_save_then_creates_empty_index_file(
        self, temp_project_root
    ):
        """Test that save works with empty index."""
        # Given: An empty index
        index = ProjectIndex(str(temp_project_root))
        index._generated_at = datetime(2025, 1, 1, 12, 0, 0)

        # When: Saving the index
        with patch("empathy_os.project_index.index._validate_file_path"):
            index.save()

        # Then: Index file is created with empty records
        index_path = temp_project_root / ".empathy" / "project_index.json"
        assert index_path.exists()
        data = json.loads(index_path.read_text())
        assert data["records"] == {}

    def test_given_nonexistent_directory_when_save_then_creates_directory(
        self, temp_project_root
    ):
        """Test that save creates .empathy directory if needed."""
        # Given: No .empathy directory
        empathy_dir = temp_project_root / ".empathy"
        empathy_dir.rmdir()
        index = ProjectIndex(str(temp_project_root))
        index._generated_at = datetime(2025, 1, 1, 12, 0, 0)

        # When: Saving the index
        with patch("empathy_os.project_index.index._validate_file_path"):
            index.save()

        # Then: Directory and file are created
        assert empathy_dir.exists()
        assert (empathy_dir / "project_index.json").exists()

    @patch("empathy_os.project_index.index._validate_file_path")
    @patch("pathlib.Path.mkdir", side_effect=PermissionError("Access denied"))
    def test_given_permission_error_when_save_then_raises_error(
        self, mock_mkdir, mock_validate, temp_project_root
    ):
        """Test that permission error during save raises exception."""
        # Given: Permission error on directory creation
        index = ProjectIndex(str(temp_project_root))
        (temp_project_root / ".empathy").rmdir()
        index._generated_at = datetime(2025, 1, 1, 12, 0, 0)

        # When/Then: Saving raises PermissionError
        with pytest.raises(PermissionError):
            index.save()

    def test_given_redis_client_when_save_then_syncs_to_redis(
        self, temp_project_root, mock_redis_client, sample_file_record
    ):
        """Test that save syncs data to Redis if client is present."""
        # Given: Index with Redis client
        index = ProjectIndex(
            str(temp_project_root), redis_client=mock_redis_client
        )
        index._records["src/main.py"] = sample_file_record
        index._generated_at = datetime(2025, 1, 1, 12, 0, 0)

        # When: Saving the index
        with patch("empathy_os.project_index.index._validate_file_path"):
            index.save()

        # Then: Redis sync is attempted (implementation-dependent)
        # This test verifies the client is available for use
        assert index.redis_client is not None


class TestProjectIndexQuery:
    """Test ProjectIndex query methods."""

    def test_given_records_when_get_record_then_returns_record(
        self, temp_project_root, sample_file_record
    ):
        """Test that get_record returns the correct record."""
        # Given: An index with a record
        index = ProjectIndex(str(temp_project_root))
        index._records["src/main.py"] = sample_file_record

        # When: Getting the record
        record = index.get_record("src/main.py")

        # Then: Correct record is returned
        assert record == sample_file_record
        assert record.path == "src/main.py"

    def test_given_no_record_when_get_record_then_returns_none(
        self, temp_project_root
    ):
        """Test that get_record returns None for missing record."""
        # Given: An empty