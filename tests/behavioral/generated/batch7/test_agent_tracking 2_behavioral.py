"""Behavioral tests for agent_tracking 2.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

from __future__ import annotations

import json
import time
from datetime import datetime, timedelta
from typing import Any
from unittest.mock import MagicMock, Mock, patch

import pytest

from empathy_os.telemetry.agent_tracking_2 import (
    AgentHeartbeat,
    HeartbeatCoordinator,
)


# Fixtures


@pytest.fixture
def sample_metadata() -> dict[str, Any]:
    """Given a sample metadata dictionary."""
    return {
        "workflow": "code-review",
        "run_id": "xyz123",
        "user_id": "user-456",
    }


@pytest.fixture
def sample_heartbeat(sample_metadata: dict[str, Any]) -> AgentHeartbeat:
    """Given a sample AgentHeartbeat instance."""
    return AgentHeartbeat(
        agent_id="test-agent-001",
        status="running",
        progress=0.5,
        current_task="Processing data",
        last_beat=datetime(2025, 1, 15, 12, 0, 0),
        metadata=sample_metadata,
    )


@pytest.fixture
def mock_redis():
    """Given a mocked Redis client."""
    redis_mock = MagicMock()
    redis_mock.setex = MagicMock(return_value=True)
    redis_mock.get = MagicMock(return_value=None)
    redis_mock.delete = MagicMock(return_value=1)
    redis_mock.keys = MagicMock(return_value=[])
    redis_mock.pipeline = MagicMock()
    return redis_mock


@pytest.fixture
def coordinator(mock_redis):
    """Given a HeartbeatCoordinator with mocked Redis."""
    with patch("empathy_os.telemetry.agent_tracking_2.redis.Redis", return_value=mock_redis):
        coord = HeartbeatCoordinator(redis_client=mock_redis)
        coord.current_agent_id = None
        return coord


# AgentHeartbeat Tests


class TestAgentHeartbeatCreation:
    """Test AgentHeartbeat creation and initialization."""

    def test_create_heartbeat_with_all_fields(self, sample_metadata: dict[str, Any]):
        """
        Given all required and optional fields
        When creating an AgentHeartbeat
        Then it should initialize with all values correctly.
        """
        # Given
        agent_id = "agent-123"
        status = "running"
        progress = 0.75
        current_task = "Task ABC"
        last_beat = datetime.utcnow()

        # When
        heartbeat = AgentHeartbeat(
            agent_id=agent_id,
            status=status,
            progress=progress,
            current_task=current_task,
            last_beat=last_beat,
            metadata=sample_metadata,
        )

        # Then
        assert heartbeat.agent_id == agent_id
        assert heartbeat.status == status
        assert heartbeat.progress == progress
        assert heartbeat.current_task == current_task
        assert heartbeat.last_beat == last_beat
        assert heartbeat.metadata == sample_metadata

    def test_create_heartbeat_without_metadata(self):
        """
        Given no metadata is provided
        When creating an AgentHeartbeat
        Then it should initialize with empty metadata dict.
        """
        # When
        heartbeat = AgentHeartbeat(
            agent_id="agent-456",
            status="starting",
            progress=0.0,
            current_task="Initializing",
            last_beat=datetime.utcnow(),
        )

        # Then
        assert heartbeat.metadata == {}

    def test_heartbeat_with_various_statuses(self):
        """
        Given different status values
        When creating AgentHeartbeat instances
        Then they should accept all valid statuses.
        """
        statuses = ["starting", "running", "completed", "failed", "cancelled"]

        for status in statuses:
            # When
            heartbeat = AgentHeartbeat(
                agent_id=f"agent-{status}",
                status=status,
                progress=0.5,
                current_task="Task",
                last_beat=datetime.utcnow(),
            )

            # Then
            assert heartbeat.status == status

    def test_heartbeat_with_boundary_progress_values(self):
        """
        Given boundary progress values
        When creating AgentHeartbeat instances
        Then they should accept 0.0 and 1.0.
        """
        # When - minimum progress
        heartbeat_min = AgentHeartbeat(
            agent_id="agent-min",
            status="starting",
            progress=0.0,
            current_task="Starting",
            last_beat=datetime.utcnow(),
        )

        # Then
        assert heartbeat_min.progress == 0.0

        # When - maximum progress
        heartbeat_max = AgentHeartbeat(
            agent_id="agent-max",
            status="completed",
            progress=1.0,
            current_task="Finished",
            last_beat=datetime.utcnow(),
        )

        # Then
        assert heartbeat_max.progress == 1.0


class TestAgentHeartbeatSerialization:
    """Test AgentHeartbeat serialization methods."""

    def test_to_dict_converts_all_fields(self, sample_heartbeat: AgentHeartbeat):
        """
        Given an AgentHeartbeat instance
        When calling to_dict()
        Then it should return a dictionary with all fields.
        """
        # When
        result = sample_heartbeat.to_dict()

        # Then
        assert result["agent_id"] == sample_heartbeat.agent_id
        assert result["status"] == sample_heartbeat.status
        assert result["progress"] == sample_heartbeat.progress
        assert result["current_task"] == sample_heartbeat.current_task
        assert result["metadata"] == sample_heartbeat.metadata

    def test_to_dict_converts_datetime_to_isoformat(self, sample_heartbeat: AgentHeartbeat):
        """
        Given an AgentHeartbeat with datetime last_beat
        When calling to_dict()
        Then last_beat should be in ISO format string.
        """
        # When
        result = sample_heartbeat.to_dict()

        # Then
        assert isinstance(result["last_beat"], str)
        assert result["last_beat"] == "2025-01-15T12:00:00"

    def test_to_dict_handles_string_last_beat(self):
        """
        Given an AgentHeartbeat with string last_beat
        When calling to_dict()
        Then it should keep the string as is.
        """
        # Given
        heartbeat = AgentHeartbeat(
            agent_id="agent-001",
            status="running",
            progress=0.5,
            current_task="Task",
            last_beat="2025-01-15T12:00:00",
        )

        # When
        result = heartbeat.to_dict()

        # Then
        assert result["last_beat"] == "2025-01-15T12:00:00"

    def test_from_dict_creates_heartbeat(self, sample_metadata: dict[str, Any]):
        """
        Given a dictionary with heartbeat data
        When calling from_dict()
        Then it should create an AgentHeartbeat instance.
        """
        # Given
        data = {
            "agent_id": "agent-789",
            "status": "running",
            "progress": 0.6,
            "current_task": "Processing",
            "last_beat": "2025-01-15T14:30:00",
            "metadata": sample_metadata,
        }

        # When
        heartbeat = AgentHeartbeat.from_dict(data)

        # Then
        assert heartbeat.agent_id == data["agent_id"]
        assert heartbeat.status == data["status"]
        assert heartbeat.progress == data["progress"]
        assert heartbeat.current_task == data["current_task"]
        assert isinstance(heartbeat.last_beat, datetime)
        assert heartbeat.metadata == sample_metadata

    def test_from_dict_parses_iso_datetime(self):
        """
        Given a dictionary with ISO format last_beat string
        When calling from_dict()
        Then it should convert to datetime object.
        """
        # Given
        data = {
            "agent_id": "agent-001",
            "status": "running",
            "progress": 0.5,
            "current_task": "Task",
            "last_beat": "2025-01-15T12:00:00",
        }

        # When
        heartbeat = AgentHeartbeat.from_dict(data)

        # Then
        assert isinstance(heartbeat.last_beat, datetime)
        assert heartbeat.last_beat.year == 2025
        assert heartbeat.last_beat.month == 1
        assert heartbeat.last_beat.day == 15

    def test_from_dict_handles_datetime_object(self):
        """
        Given a dictionary with datetime object as last_beat
        When calling from_dict()
        Then it should use the datetime directly.
        """
        # Given
        last_beat_dt = datetime(2025, 2, 20, 10, 30, 0)
        data = {
            "agent_id": "agent-002",
            "status": "completed",
            "progress": 1.0,
            "current_task": "Done",
            "last_beat": last_beat_dt,
        }

        # When
        heartbeat = AgentHeartbeat.from_dict(data)

        # Then
        assert heartbeat.last_beat == last_beat_dt

    def test_from_dict_defaults_invalid_last_beat(self):
        """
        Given a dictionary with invalid last_beat
        When calling from_dict()
        Then it should default to current UTC time.
        """
        # Given
        data = {
            "agent_id": "agent-003",
            "status": "running",
            "progress": 0.3,
            "current_task": "Task",
            "last_beat": 12345,  # Invalid type
        }

        # When
        before = datetime.utcnow()
        heartbeat = AgentHeartbeat.from_dict(data)
        after = datetime.utcnow()

        # Then
        assert isinstance(heartbeat.last_beat, datetime)
        assert before <= heartbeat.last_beat <= after

    def test_from_dict_without_metadata(self):
        """
        Given a dictionary without metadata field
        When calling from_dict()
        Then it should default to empty dict.
        """
        # Given
        data = {
            "agent_id": "agent-004",
            "status": "running",
            "progress": 0.5,
            "current_task": "Task",
            "last_beat": "2025-01-15T12:00:00",
        }

        # When
        heartbeat = AgentHeartbeat.from_dict(data)

        # Then
        assert heartbeat.metadata == {}

    def test_serialization_roundtrip(self, sample_heartbeat: AgentHeartbeat):
        """
        Given an AgentHeartbeat instance
        When converting to dict and back
        Then it should preserve all data.
        """
        # When
        data = sample_heartbeat.to_dict()
        restored = AgentHeartbeat.from_dict(data)

        # Then
        assert restored.agent_id == sample_heartbeat.agent_id
        assert restored.status == sample_heartbeat.status
        assert restored.progress == sample_heartbeat.progress
        assert restored.current_task == sample_heartbeat.current_task
        assert restored.metadata == sample_heartbeat.metadata


class TestHeartbeatCoordinatorInitialization:
    """Test HeartbeatCoordinator initialization."""

    def test_coordinator_initializes_with_default_values(self, mock_redis):
        """
        Given no custom parameters
        When creating a HeartbeatCoordinator
        Then it should initialize with default values.
        """
        # When
        coordinator = HeartbeatCoordinator(redis_client=mock_redis)

        # Then
        assert coordinator.HEARTBEAT_TTL == 30
        assert coordinator.HEARTBEAT_INTERVAL == 10
        assert coordinator.current_agent_id is None

    def test_coordinator_accepts_redis_client(self, mock_redis):
        """
        Given a Redis client
        When creating a HeartbeatCoordinator
        Then it should use the provided client.
        """
        # When
        coordinator = HeartbeatCoordinator(redis_client=mock_redis)

        # Then
        assert coordinator.redis_client == mock_redis


class TestHeartbeatCoordinatorStartHeartbeat:
    """Test starting agent heartbeat tracking."""

    def test_start_heartbeat_creates_initial_entry(self, coordinator, mock_redis, sample_metadata):
        """
        Given an agent_id and metadata
        When calling start_heartbeat()
        Then it should create a heartbeat entry in Redis.
        """
        # Given
        agent_id = "agent-start-001"

        # When
        with patch("empathy_os.telemetry.agent_tracking_2.datetime") as mock_datetime:
            mock_datetime.utcnow.return_value = datetime(2025, 1, 15, 12, 0, 0)
            coordinator.start_heartbeat(agent_id=agent_id, metadata=sample_metadata)

        # Then
        assert coordinator.current_agent_id == agent_id
        mock_redis.setex.assert_called_once()

    def test_start_heartbeat_sets_correct_ttl(self, coordinator, mock_redis):
        """
        Given an agent starting
        When calling start_heartbeat()
        Then it should set Redis TTL to HEARTBEAT_TTL.
        """
        # Given
        agent_id = "agent-ttl-001"

        # When
        coordinator.start_heartbeat(agent_id=agent_id)

        # Then
        call_args = mock_redis.setex.call_args
        assert call_args[0][1] == coordinator.HEARTBEAT_TTL

    def test_start_heartbeat_initial_status_is_starting(self, coordinator, mock_redis):
        """
        Given a new agent
        When calling start_heartbeat()
        Then initial status should be "starting".
        """
        # Given
        agent_id = "agent-status-001"

        # When
        with patch("empathy_os.telemetry.agent_tracking_2.datetime") as mock_datetime:
            mock_datetime.utcnow.return_value = datetime(2025, 1, 15, 12, 0, 0)
            coordinator.start_heartbeat(agent_id=agent_id)

        # Then
        call_args = mock_redis.setex.call_args
        stored_data = json.loads(call_args[0][2])
        assert stored_data["status"] == "starting"
        assert stored_data["progress"] == 0.0

    def test_start_heartbeat_stores_metadata(self, coordinator, mock_redis, sample_metadata):
        """
        Given metadata is provided
        When calling start_heartbeat()
        Then metadata should be stored in the heartbeat.
        """
        # Given
        agent_id = "agent-meta-001"

        # When
        with patch("empathy_os.telemetry.agent_tracking_2.datetime") as mock_datetime:
            mock_datetime.utcnow.return_value = datetime(2025, 1, 15, 12, 0, 0)
            coordinator.start_heartbeat(agent_id