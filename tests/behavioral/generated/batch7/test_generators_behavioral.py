"""Behavioral tests for generators.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import json
from pathlib import Path
from unittest.mock import Mock, mock_open, patch

import pytest

from empathy_os.workflows.keyboard_shortcuts.generators import (
    CLIAliasGenerator,
    VSCodeKeybindingsGenerator,
)
from empathy_os.workflows.keyboard_shortcuts.schema import (
    Feature,
    FeatureCategory,
    FeatureManifest,
    GeneratedShortcuts,
    KeyboardLayout,
    LayoutShortcuts,
    ShortcutAssignment,
)


@pytest.fixture
def sample_feature():
    """Given a basic feature with command."""
    return Feature(
        id="test_feature",
        label="Test Feature",
        command="test.command",
        priority=1,
        preferred_keys=["t"],
    )


@pytest.fixture
def sample_category(sample_feature):
    """Given a feature category containing features."""
    return FeatureCategory(
        name="Test Category",
        description="Test description",
        features=[sample_feature],
    )


@pytest.fixture
def sample_manifest(sample_category):
    """Given a feature manifest with prefix and categories."""
    return FeatureManifest(
        project_name="Test Project",
        prefix="ctrl+k",
        categories=[sample_category],
        mnemonic="Test mnemonic",
    )


@pytest.fixture
def sample_shortcut():
    """Given a shortcut assignment."""
    return ShortcutAssignment(
        feature_id="test_feature",
        key="t",
        mnemonic="Test",
        priority=1,
    )


@pytest.fixture
def sample_layout_shortcuts(sample_shortcut):
    """Given layout shortcuts with assignments."""
    return LayoutShortcuts(
        layout=KeyboardLayout.QWERTY,
        shortcuts=[sample_shortcut],
    )


@pytest.fixture
def sample_generated_shortcuts(sample_manifest, sample_layout_shortcuts):
    """Given generated shortcuts for all layouts."""
    return GeneratedShortcuts(
        manifest=sample_manifest,
        layouts={
            KeyboardLayout.QWERTY: sample_layout_shortcuts,
        },
    )


@pytest.fixture
def temp_output_dir(tmp_path):
    """Given a temporary output directory."""
    return tmp_path / "output"


class TestVSCodeKeybindingsGenerator:
    """Behavioral tests for VSCodeKeybindingsGenerator."""

    def test_generate_creates_output_directory(self, sample_generated_shortcuts, temp_output_dir):
        """Given output directory doesn't exist
        When generating keybindings
        Then directory should be created.
        """
        # Given
        generator = VSCodeKeybindingsGenerator()
        assert not temp_output_dir.exists()

        # When
        generator.generate(sample_generated_shortcuts, temp_output_dir)

        # Then
        assert temp_output_dir.exists()
        assert temp_output_dir.is_dir()

    def test_generate_returns_layout_file_mapping(self, sample_generated_shortcuts, temp_output_dir):
        """Given shortcuts for multiple layouts
        When generating keybindings
        Then should return dict mapping layout names to file paths.
        """
        # Given
        generator = VSCodeKeybindingsGenerator()
        shortcuts = sample_generated_shortcuts

        # When
        result = generator.generate(shortcuts, temp_output_dir)

        # Then
        assert isinstance(result, dict)
        assert "qwerty" in result
        assert isinstance(result["qwerty"], Path)
        assert result["qwerty"].exists()

    def test_generate_creates_json_file_per_layout(self, sample_generated_shortcuts, temp_output_dir):
        """Given shortcuts for QWERTY layout
        When generating keybindings
        Then should create qwerty.json file.
        """
        # Given
        generator = VSCodeKeybindingsGenerator()

        # When
        result = generator.generate(sample_generated_shortcuts, temp_output_dir)

        # Then
        expected_file = temp_output_dir / "qwerty.json"
        assert expected_file.exists()
        assert result["qwerty"] == expected_file

    def test_generate_creates_valid_json_content(self, sample_generated_shortcuts, temp_output_dir):
        """Given shortcuts with feature assignments
        When generating keybindings
        Then should create valid JSON content.
        """
        # Given
        generator = VSCodeKeybindingsGenerator()

        # When
        result = generator.generate(sample_generated_shortcuts, temp_output_dir)

        # Then
        content = result["qwerty"].read_text()
        parsed = json.loads(content)
        assert isinstance(parsed, list)

    def test_generate_includes_keybinding_entries(self, sample_generated_shortcuts, temp_output_dir):
        """Given shortcuts with assigned keys
        When generating keybindings
        Then should include keybinding entries.
        """
        # Given
        generator = VSCodeKeybindingsGenerator()

        # When
        result = generator.generate(sample_generated_shortcuts, temp_output_dir)

        # Then
        content = result["qwerty"].read_text()
        parsed = json.loads(content)
        assert len(parsed) > 0

    def test_generate_bindings_creates_correct_structure(self, sample_manifest, sample_layout_shortcuts):
        """Given manifest and layout shortcuts
        When generating bindings
        Then should create proper keybinding structure.
        """
        # Given
        generator = VSCodeKeybindingsGenerator()

        # When
        bindings = generator._generate_bindings(sample_manifest, sample_layout_shortcuts)

        # Then
        assert len(bindings) == 1
        binding = bindings[0]
        assert "key" in binding
        assert "mac" in binding
        assert "command" in binding
        assert "// mnemonic" in binding

    def test_generate_bindings_uses_prefix_for_key(self, sample_manifest, sample_layout_shortcuts):
        """Given manifest with prefix 'ctrl+k'
        When generating bindings
        Then should include prefix in key binding.
        """
        # Given
        generator = VSCodeKeybindingsGenerator()

        # When
        bindings = generator._generate_bindings(sample_manifest, sample_layout_shortcuts)

        # Then
        assert bindings[0]["key"] == "ctrl+k t"

    def test_generate_bindings_converts_ctrl_to_cmd_for_mac(self, sample_manifest, sample_layout_shortcuts):
        """Given manifest with ctrl prefix
        When generating bindings
        Then mac binding should use cmd instead of ctrl.
        """
        # Given
        generator = VSCodeKeybindingsGenerator()

        # When
        bindings = generator._generate_bindings(sample_manifest, sample_layout_shortcuts)

        # Then
        assert bindings[0]["mac"] == "cmd+k t"

    def test_generate_bindings_includes_command(self, sample_manifest, sample_layout_shortcuts):
        """Given feature with command
        When generating bindings
        Then should include command in binding.
        """
        # Given
        generator = VSCodeKeybindingsGenerator()

        # When
        bindings = generator._generate_bindings(sample_manifest, sample_layout_shortcuts)

        # Then
        assert bindings[0]["command"] == "test.command"

    def test_generate_bindings_includes_mnemonic(self, sample_manifest, sample_layout_shortcuts):
        """Given shortcut with mnemonic
        When generating bindings
        Then should include mnemonic as comment.
        """
        # Given
        generator = VSCodeKeybindingsGenerator()

        # When
        bindings = generator._generate_bindings(sample_manifest, sample_layout_shortcuts)

        # Then
        assert bindings[0]["// mnemonic"] == "Test"

    def test_generate_bindings_skips_missing_features(self, sample_manifest):
        """Given shortcut referencing non-existent feature
        When generating bindings
        Then should skip that binding.
        """
        # Given
        generator = VSCodeKeybindingsGenerator()
        invalid_shortcut = ShortcutAssignment(
            feature_id="non_existent",
            key="x",
            mnemonic="Missing",
            priority=1,
        )
        layout_shortcuts = LayoutShortcuts(
            layout=KeyboardLayout.QWERTY,
            shortcuts=[invalid_shortcut],
        )

        # When
        bindings = generator._generate_bindings(sample_manifest, layout_shortcuts)

        # Then
        assert len(bindings) == 0

    def test_find_command_returns_command_for_valid_id(self, sample_manifest):
        """Given feature with known ID
        When finding command
        Then should return the command.
        """
        # Given
        generator = VSCodeKeybindingsGenerator()

        # When
        command = generator._find_command(sample_manifest, "test_feature")

        # Then
        assert command == "test.command"

    def test_find_command_returns_none_for_unknown_id(self, sample_manifest):
        """Given unknown feature ID
        When finding command
        Then should return None.
        """
        # Given
        generator = VSCodeKeybindingsGenerator()

        # When
        command = generator._find_command(sample_manifest, "unknown_id")

        # Then
        assert command is None

    def test_generate_handles_multiple_shortcuts(self, sample_manifest, temp_output_dir):
        """Given multiple shortcuts in layout
        When generating keybindings
        Then should create binding for each shortcut.
        """
        # Given
        generator = VSCodeKeybindingsGenerator()
        
        # Add multiple features
        feature2 = Feature(
            id="test_feature2",
            label="Test Feature 2",
            command="test.command2",
            priority=2,
            preferred_keys=["x"],
        )
        sample_manifest.categories[0].features.append(feature2)
        
        shortcuts = [
            ShortcutAssignment(feature_id="test_feature", key="t", mnemonic="Test", priority=1),
            ShortcutAssignment(feature_id="test_feature2", key="x", mnemonic="Test2", priority=2),
        ]
        layout_shortcuts = LayoutShortcuts(layout=KeyboardLayout.QWERTY, shortcuts=shortcuts)
        generated = GeneratedShortcuts(
            manifest=sample_manifest,
            layouts={KeyboardLayout.QWERTY: layout_shortcuts},
        )

        # When
        result = generator.generate(generated, temp_output_dir)

        # Then
        content = result["qwerty"].read_text()
        parsed = json.loads(content)
        assert len(parsed) == 2

    def test_generate_handles_empty_shortcuts(self, sample_manifest, temp_output_dir):
        """Given layout with no shortcuts
        When generating keybindings
        Then should create empty JSON array.
        """
        # Given
        generator = VSCodeKeybindingsGenerator()
        layout_shortcuts = LayoutShortcuts(layout=KeyboardLayout.QWERTY, shortcuts=[])
        generated = GeneratedShortcuts(
            manifest=sample_manifest,
            layouts={KeyboardLayout.QWERTY: layout_shortcuts},
        )

        # When
        result = generator.generate(generated, temp_output_dir)

        # Then
        content = result["qwerty"].read_text()
        parsed = json.loads(content)
        assert parsed == []

    @patch('empathy_os.config._validate_file_path')
    def test_generate_validates_output_path(self, mock_validate, sample_generated_shortcuts, temp_output_dir):
        """Given output file path
        When generating keybindings
        Then should validate file path.
        """
        # Given
        generator = VSCodeKeybindingsGenerator()
        temp_output_dir.mkdir(parents=True, exist_ok=True)
        output_file = temp_output_dir / "qwerty.json"
        mock_validate.return_value = output_file

        # When
        generator.generate(sample_generated_shortcuts, temp_output_dir)

        # Then
        mock_validate.assert_called()


class TestCLIAliasGenerator:
    """Behavioral tests for CLIAliasGenerator."""

    def test_generate_creates_parent_directory(self, sample_generated_shortcuts, temp_output_dir):
        """Given output file in non-existent directory
        When generating aliases
        Then should create parent directory.
        """
        # Given
        generator = CLIAliasGenerator()
        output_file = temp_output_dir / "aliases.sh"
        assert not output_file.parent.exists()

        # When
        generator.generate(sample_generated_shortcuts, output_file)

        # Then
        assert output_file.parent.exists()

    def test_generate_returns_output_path(self, sample_generated_shortcuts, temp_output_dir):
        """Given output file path
        When generating aliases
        Then should return the output path.
        """
        # Given
        generator = CLIAliasGenerator()
        output_file = temp_output_dir / "aliases.sh"

        # When
        result = generator.generate(sample_generated_shortcuts, output_file)

        # Then
        assert result == output_file
        assert isinstance(result, Path)

    def test_generate_creates_output_file(self, sample_generated_shortcuts, temp_output_dir):
        """Given shortcuts to generate
        When generating aliases
        Then should create output file.
        """
        # Given
        generator = CLIAliasGenerator()
        output_file = temp_output_dir / "aliases.sh"

        # When
        generator.generate(sample_generated_shortcuts, output_file)

        # Then
        assert output_file.exists()

    def test_generate_includes_bash_header(self, sample_generated_shortcuts, temp_output_dir):
        """Given shortcuts to generate
        When generating aliases
        Then should include bash header.
        """
        # Given
        generator = CLIAliasGenerator()
        output_file = temp_output_dir / "aliases.sh"

        # When
        generator.generate(sample_generated_shortcuts, output_file)

        # Then
        content = output_file.read_text()
        assert "#!/bin/bash" in content

    def test_generate_includes_project_name_in_header(self, sample_generated_shortcuts, temp_output_dir):
        """Given manifest with project name
        When generating aliases
        Then should include project name in header.
        """
        # Given
        generator = CLIAliasGenerator()
        output_file = temp_output_dir / "aliases.sh"

        # When
        generator.generate(sample_generated_shortcuts, output_file)

        # Then
        content = output_file.read_text()
        assert "Test Project" in content

    def test_generate_includes_mnemonic_in_header(self, sample_generated_shortcuts, temp_output_dir):
        """Given manifest with mnemonic
        When generating aliases
        Then should include mnemonic in header.
        """
        # Given
        generator = CLIAliasGenerator()
        output_file = temp_output_dir / "aliases.sh"

        # When
        generator.generate(sample_generated_shortcuts, output_file)

        # Then
        content = output_file.read_text()
        assert "Test mnemonic" in content

    def test_generate_uses_qwerty_layout(self, sample_manifest, temp_output_dir):
        """Given shortcuts for multiple layouts
        When generating aliases
        Then should use QWERTY layout.
        """
        # Given
        generator = CLIAliasGenerator()
        output_file = temp_output_dir / "aliases.sh"
        
        qwerty_shortcuts = LayoutShortcuts(
            layout=KeyboardLayout.