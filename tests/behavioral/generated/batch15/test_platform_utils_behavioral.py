"""Behavioral tests for platform_utils.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import asyncio
import os
import sys
from pathlib import Path
from typing import Generator
from unittest.mock import MagicMock, Mock, patch

import pytest

from empathy_os.platform_utils import (
    get_default_cache_dir,
    get_default_config_dir,
    get_default_data_dir,
    get_default_log_dir,
    get_event_loop,
    get_file_encoding,
    is_linux,
    is_macos,
    is_windows,
    normalize_path,
    safe_create_directory,
)


class TestPlatformDetection:
    """Test suite for platform detection functions."""

    def test_is_windows_when_on_windows(self) -> None:
        """Given platform is Windows, when checking is_windows, then returns True."""
        # Given
        with patch("empathy_os.platform_utils.platform.system", return_value="Windows"):
            # When
            result = is_windows()
            
            # Then
            assert result is True

    def test_is_windows_when_not_on_windows(self) -> None:
        """Given platform is not Windows, when checking is_windows, then returns False."""
        # Given
        with patch("empathy_os.platform_utils.platform.system", return_value="Linux"):
            # When
            result = is_windows()
            
            # Then
            assert result is False

    def test_is_macos_when_on_macos(self) -> None:
        """Given platform is macOS, when checking is_macos, then returns True."""
        # Given
        with patch("empathy_os.platform_utils.platform.system", return_value="Darwin"):
            # When
            result = is_macos()
            
            # Then
            assert result is True

    def test_is_macos_when_not_on_macos(self) -> None:
        """Given platform is not macOS, when checking is_macos, then returns False."""
        # Given
        with patch("empathy_os.platform_utils.platform.system", return_value="Windows"):
            # When
            result = is_macos()
            
            # Then
            assert result is False

    def test_is_linux_when_on_linux(self) -> None:
        """Given platform is Linux, when checking is_linux, then returns True."""
        # Given
        with patch("empathy_os.platform_utils.platform.system", return_value="Linux"):
            # When
            result = is_linux()
            
            # Then
            assert result is True

    def test_is_linux_when_not_on_linux(self) -> None:
        """Given platform is not Linux, when checking is_linux, then returns False."""
        # Given
        with patch("empathy_os.platform_utils.platform.system", return_value="Darwin"):
            # When
            result = is_linux()
            
            # Then
            assert result is False


class TestDefaultLogDirectory:
    """Test suite for get_default_log_dir function."""

    def test_get_default_log_dir_on_windows(self) -> None:
        """Given Windows platform, when getting log dir, then returns APPDATA/empathy/logs."""
        # Given
        with patch("empathy_os.platform_utils.is_windows", return_value=True), \
             patch("empathy_os.platform_utils.is_macos", return_value=False), \
             patch.dict(os.environ, {"APPDATA": "C:\\Users\\Test\\AppData\\Roaming"}):
            # When
            result = get_default_log_dir()
            
            # Then
            assert result == Path("C:\\Users\\Test\\AppData\\Roaming") / "empathy" / "logs"

    def test_get_default_log_dir_on_windows_without_appdata(self) -> None:
        """Given Windows without APPDATA, when getting log dir, then uses home directory."""
        # Given
        with patch("empathy_os.platform_utils.is_windows", return_value=True), \
             patch("empathy_os.platform_utils.is_macos", return_value=False), \
             patch.dict(os.environ, {}, clear=True), \
             patch("os.path.expanduser", return_value="/home/test"):
            # When
            result = get_default_log_dir()
            
            # Then
            assert result == Path("/home/test") / "empathy" / "logs"

    def test_get_default_log_dir_on_macos(self) -> None:
        """Given macOS platform, when getting log dir, then returns ~/Library/Logs/empathy."""
        # Given
        with patch("empathy_os.platform_utils.is_windows", return_value=False), \
             patch("empathy_os.platform_utils.is_macos", return_value=True), \
             patch("pathlib.Path.home", return_value=Path("/Users/test")):
            # When
            result = get_default_log_dir()
            
            # Then
            assert result == Path("/Users/test") / "Library" / "Logs" / "empathy"

    def test_get_default_log_dir_on_linux_with_var_log_writable(self) -> None:
        """Given Linux with writable /var/log, when getting log dir, then returns /var/log/empathy."""
        # Given
        with patch("empathy_os.platform_utils.is_windows", return_value=False), \
             patch("empathy_os.platform_utils.is_macos", return_value=False):
            
            mock_var_log = MagicMock()
            mock_var_log.exists.return_value = True
            
            with patch("pathlib.Path", return_value=mock_var_log):
                # When
                result = get_default_log_dir()
                
                # Then
                assert result == mock_var_log

    def test_get_default_log_dir_on_linux_without_var_log(self) -> None:
        """Given Linux without writable /var/log, when getting log dir, then returns user directory."""
        # Given
        with patch("empathy_os.platform_utils.is_windows", return_value=False), \
             patch("empathy_os.platform_utils.is_macos", return_value=False):
            
            mock_var_log = MagicMock()
            mock_var_log.exists.return_value = False
            mock_var_log.parent.exists.return_value = False
            
            with patch("pathlib.Path") as mock_path, \
                 patch("os.access", return_value=False):
                
                mock_path.return_value = mock_var_log
                mock_path.home.return_value = Path("/home/test")
                
                # When
                result = get_default_log_dir()
                
                # Then
                assert str(result).endswith(".local/share/empathy/logs")


class TestDefaultDataDirectory:
    """Test suite for get_default_data_dir function."""

    def test_get_default_data_dir_on_windows(self) -> None:
        """Given Windows platform, when getting data dir, then returns APPDATA/empathy."""
        # Given
        with patch("empathy_os.platform_utils.is_windows", return_value=True), \
             patch("empathy_os.platform_utils.is_macos", return_value=False), \
             patch.dict(os.environ, {"APPDATA": "C:\\Users\\Test\\AppData\\Roaming"}):
            # When
            result = get_default_data_dir()
            
            # Then
            assert result == Path("C:\\Users\\Test\\AppData\\Roaming") / "empathy"

    def test_get_default_data_dir_on_windows_without_appdata(self) -> None:
        """Given Windows without APPDATA, when getting data dir, then uses home directory."""
        # Given
        with patch("empathy_os.platform_utils.is_windows", return_value=True), \
             patch("empathy_os.platform_utils.is_macos", return_value=False), \
             patch.dict(os.environ, {}, clear=True), \
             patch("os.path.expanduser", return_value="/home/test"):
            # When
            result = get_default_data_dir()
            
            # Then
            assert result == Path("/home/test") / "empathy"

    def test_get_default_data_dir_on_macos(self) -> None:
        """Given macOS platform, when getting data dir, then returns ~/Library/Application Support/empathy."""
        # Given
        with patch("empathy_os.platform_utils.is_windows", return_value=False), \
             patch("empathy_os.platform_utils.is_macos", return_value=True), \
             patch("pathlib.Path.home", return_value=Path("/Users/test")):
            # When
            result = get_default_data_dir()
            
            # Then
            assert result == Path("/Users/test") / "Library" / "Application Support" / "empathy"

    def test_get_default_data_dir_on_linux(self) -> None:
        """Given Linux platform, when getting data dir, then returns ~/.local/share/empathy."""
        # Given
        with patch("empathy_os.platform_utils.is_windows", return_value=False), \
             patch("empathy_os.platform_utils.is_macos", return_value=False), \
             patch.dict(os.environ, {}, clear=True), \
             patch("pathlib.Path.home", return_value=Path("/home/test")):
            # When
            result = get_default_data_dir()
            
            # Then
            assert result == Path("/home/test") / ".local" / "share" / "empathy"

    def test_get_default_data_dir_on_linux_with_xdg_data_home(self) -> None:
        """Given Linux with XDG_DATA_HOME, when getting data dir, then uses XDG_DATA_HOME."""
        # Given
        with patch("empathy_os.platform_utils.is_windows", return_value=False), \
             patch("empathy_os.platform_utils.is_macos", return_value=False), \
             patch.dict(os.environ, {"XDG_DATA_HOME": "/custom/data"}):
            # When
            result = get_default_data_dir()
            
            # Then
            assert result == Path("/custom/data") / "empathy"


class TestDefaultConfigDirectory:
    """Test suite for get_default_config_dir function."""

    def test_get_default_config_dir_on_windows(self) -> None:
        """Given Windows platform, when getting config dir, then returns APPDATA/empathy."""
        # Given
        with patch("empathy_os.platform_utils.is_windows", return_value=True), \
             patch("empathy_os.platform_utils.is_macos", return_value=False), \
             patch.dict(os.environ, {"APPDATA": "C:\\Users\\Test\\AppData\\Roaming"}):
            # When
            result = get_default_config_dir()
            
            # Then
            assert result == Path("C:\\Users\\Test\\AppData\\Roaming") / "empathy"

    def test_get_default_config_dir_on_windows_without_appdata(self) -> None:
        """Given Windows without APPDATA, when getting config dir, then uses home directory."""
        # Given
        with patch("empathy_os.platform_utils.is_windows", return_value=True), \
             patch("empathy_os.platform_utils.is_macos", return_value=False), \
             patch.dict(os.environ, {}, clear=True), \
             patch("os.path.expanduser", return_value="/home/test"):
            # When
            result = get_default_config_dir()
            
            # Then
            assert result == Path("/home/test") / "empathy"

    def test_get_default_config_dir_on_macos(self) -> None:
        """Given macOS platform, when getting config dir, then returns ~/Library/Preferences/empathy."""
        # Given
        with patch("empathy_os.platform_utils.is_windows", return_value=False), \
             patch("empathy_os.platform_utils.is_macos", return_value=True), \
             patch("pathlib.Path.home", return_value=Path("/Users/test")):
            # When
            result = get_default_config_dir()
            
            # Then
            assert result == Path("/Users/test") / "Library" / "Preferences" / "empathy"

    def test_get_default_config_dir_on_linux(self) -> None:
        """Given Linux platform, when getting config dir, then returns ~/.config/empathy."""
        # Given
        with patch("empathy_os.platform_utils.is_windows", return_value=False), \
             patch("empathy_os.platform_utils.is_macos", return_value=False), \
             patch.dict(os.environ, {}, clear=True), \
             patch("pathlib.Path.home", return_value=Path("/home/test")):
            # When
            result = get_default_config_dir()
            
            # Then
            assert result == Path("/home/test") / ".config" / "empathy"

    def test_get_default_config_dir_on_linux_with_xdg_config_home(self) -> None:
        """Given Linux with XDG_CONFIG_HOME, when getting config dir, then uses XDG_CONFIG_HOME."""
        # Given
        with patch("empathy_os.platform_utils.is_windows", return_value=False), \
             patch("empathy_os.platform_utils.is_macos", return_value=False), \
             patch.dict(os.environ, {"XDG_CONFIG_HOME": "/custom/config"}):
            # When
            result = get_default_config_dir()
            
            # Then
            assert result == Path("/custom/config") / "empathy"


class TestDefaultCacheDirectory:
    """Test suite for get_default_cache_dir function."""

    def test_get_default_cache_dir_on_windows(self) -> None:
        """Given Windows platform, when getting cache dir, then returns LOCALAPPDATA/empathy/cache."""
        # Given
        with patch("empathy_os.platform_utils.is_windows", return_value=True), \
             patch("empathy_os.platform_utils.is_macos", return_value=False), \
             patch.dict(os.environ, {"LOCALAPPDATA": "C:\\Users\\Test\\AppData\\Local"}):
            # When
            result = get_default_cache_dir()
            
            # Then
            assert result == Path("C:\\Users\\Test\\AppData\\Local") / "empathy" / "cache"

    def test_get_default_cache_dir_on_windows_without_localappdata(self) -> None:
        """Given Windows without LOCALAPPDATA, when getting cache dir, then uses APPDATA."""
        # Given
        with patch("empathy_os.platform_utils.is_windows", return_value=True), \
             patch("empathy_os.platform_utils.is_macos", return_value=False), \
             patch.dict(os.environ, {"APPDATA": "C:\\Users\\Test\\AppData\\Roaming"}):
            
            if "LOCALAPPDATA" in os.environ:
                del os.environ["LOCALAPPDATA"]
            
            # When
            result = get_default_cache_dir()
            
            # Then
            assert result == Path("C:\\Users\\Test\\AppData\\Roaming") / "empathy" / "cache"

    def test_get_default_cache_dir_