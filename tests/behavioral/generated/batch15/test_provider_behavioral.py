"""Behavioral tests for provider.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import sys
from argparse import Namespace
from pathlib import Path
from unittest.mock import MagicMock, Mock, mock_open, patch

import pytest
import yaml

from empathy_os.cli.commands.provider import cmd_provider_set, cmd_provider_show


class TestCmdProviderShow:
    """Behavioral tests for cmd_provider_show command."""

    @pytest.fixture
    def mock_model_registry(self):
        """Fixture providing a mock model registry."""
        return {
            "anthropic": {
                "cheap": Mock(
                    id="claude-3-haiku-20240307",
                    input_cost_per_million=0.25,
                    output_cost_per_million=1.25,
                ),
                "capable": Mock(
                    id="claude-3-5-sonnet-20241022",
                    input_cost_per_million=3.0,
                    output_cost_per_million=15.0,
                ),
                "premium": Mock(
                    id="claude-3-opus-20240229",
                    input_cost_per_million=15.0,
                    output_cost_per_million=75.0,
                ),
            }
        }

    @pytest.fixture
    def mock_provider_config_with_key(self):
        """Fixture providing a ProviderConfig with API key detected."""
        mock_config = Mock()
        mock_config.available_providers = ["anthropic"]
        return mock_config

    @pytest.fixture
    def mock_provider_config_without_key(self):
        """Fixture providing a ProviderConfig without API key."""
        mock_config = Mock()
        mock_config.available_providers = []
        return mock_config

    def test_show_with_api_key_detected(
        self, capsys, mock_model_registry, mock_provider_config_with_key
    ):
        """
        GIVEN Anthropic API key is set in environment
        WHEN cmd_provider_show is called
        THEN it displays provider configuration with API key confirmation
        """
        # Given
        args = Namespace()

        # When
        with patch(
            "empathy_os.cli.commands.provider.MODEL_REGISTRY", mock_model_registry
        ):
            with patch(
                "empathy_os.cli.commands.provider.ProviderConfig.auto_detect",
                return_value=mock_provider_config_with_key,
            ):
                cmd_provider_show(args)

        # Then
        captured = capsys.readouterr()
        assert "Provider Configuration (Claude-Native v5.0.0)" in captured.out
        assert "✓ ANTHROPIC_API_KEY detected" in captured.out
        assert "Provider: anthropic" in captured.out
        assert "claude-3-haiku-20240307" in captured.out
        assert "claude-3-5-sonnet-20241022" in captured.out
        assert "claude-3-opus-20240229" in captured.out

    def test_show_without_api_key_detected(
        self, capsys, mock_model_registry, mock_provider_config_without_key
    ):
        """
        GIVEN Anthropic API key is not set
        WHEN cmd_provider_show is called
        THEN it displays warning message and setup instructions
        """
        # Given
        args = Namespace()

        # When
        with patch(
            "empathy_os.cli.commands.provider.MODEL_REGISTRY", mock_model_registry
        ):
            with patch(
                "empathy_os.cli.commands.provider.ProviderConfig.auto_detect",
                return_value=mock_provider_config_without_key,
            ):
                cmd_provider_show(args)

        # Then
        captured = capsys.readouterr()
        assert "⚠️  ANTHROPIC_API_KEY not detected" in captured.out
        assert "export ANTHROPIC_API_KEY='your-key-here'" in captured.out
        assert "https://console.anthropic.com/settings/keys" in captured.out

    def test_show_displays_model_pricing(
        self, capsys, mock_model_registry, mock_provider_config_with_key
    ):
        """
        GIVEN model registry with pricing information
        WHEN cmd_provider_show is called
        THEN it displays cost per million tokens for each tier
        """
        # Given
        args = Namespace()

        # When
        with patch(
            "empathy_os.cli.commands.provider.MODEL_REGISTRY", mock_model_registry
        ):
            with patch(
                "empathy_os.cli.commands.provider.ProviderConfig.auto_detect",
                return_value=mock_provider_config_with_key,
            ):
                cmd_provider_show(args)

        # Then
        captured = capsys.readouterr()
        assert "$0.25/$1.25 per M tokens" in captured.out
        assert "$3.00/$15.00 per M tokens" in captured.out
        assert "$15.00/$75.00 per M tokens" in captured.out

    def test_show_displays_all_tiers(
        self, capsys, mock_model_registry, mock_provider_config_with_key
    ):
        """
        GIVEN model registry with three tiers
        WHEN cmd_provider_show is called
        THEN it displays cheap, capable, and premium tiers
        """
        # Given
        args = Namespace()

        # When
        with patch(
            "empathy_os.cli.commands.provider.MODEL_REGISTRY", mock_model_registry
        ):
            with patch(
                "empathy_os.cli.commands.provider.ProviderConfig.auto_detect",
                return_value=mock_provider_config_with_key,
            ):
                cmd_provider_show(args)

        # Then
        captured = capsys.readouterr()
        assert "cheap" in captured.out
        assert "capable" in captured.out
        assert "premium" in captured.out

    def test_show_handles_empty_model_registry(
        self, capsys, mock_provider_config_with_key
    ):
        """
        GIVEN model registry with no anthropic models
        WHEN cmd_provider_show is called
        THEN it displays provider info without models
        """
        # Given
        args = Namespace()
        empty_registry = {"anthropic": {}}

        # When
        with patch("empathy_os.cli.commands.provider.MODEL_REGISTRY", empty_registry):
            with patch(
                "empathy_os.cli.commands.provider.ProviderConfig.auto_detect",
                return_value=mock_provider_config_with_key,
            ):
                cmd_provider_show(args)

        # Then
        captured = capsys.readouterr()
        assert "Provider: anthropic" in captured.out
        assert "Model mapping:" in captured.out


class TestCmdProviderSet:
    """Behavioral tests for cmd_provider_set command."""

    @pytest.fixture
    def mock_workflows_path(self, tmp_path):
        """Fixture providing a temporary workflows.yaml path."""
        return tmp_path / ".empathy" / "workflows.yaml"

    @pytest.fixture
    def existing_config(self):
        """Fixture providing existing workflow configuration."""
        return {"default_provider": "old_provider", "other_config": "value"}

    def test_set_anthropic_provider_new_config(self, capsys, tmp_path):
        """
        GIVEN no existing workflows.yaml file
        WHEN cmd_provider_set is called with 'anthropic'
        THEN it creates new config file with anthropic as default provider
        """
        # Given
        args = Namespace(name="anthropic")
        workflows_path = tmp_path / ".empathy" / "workflows.yaml"

        # When
        with patch("empathy_os.cli.commands.provider.Path") as mock_path:
            mock_path.return_value = workflows_path
            mock_path.return_value.exists.return_value = False
            mock_path.return_value.parent.mkdir = MagicMock()

            with patch(
                "empathy_os.cli.commands.provider._validate_file_path",
                return_value=workflows_path,
            ):
                workflows_path.parent.mkdir(parents=True, exist_ok=True)
                cmd_provider_set(args)

        # Then
        captured = capsys.readouterr()
        assert "✓ Default provider set to: anthropic" in captured.out
        assert workflows_path.exists()
        with open(workflows_path) as f:
            config = yaml.safe_load(f)
        assert config["default_provider"] == "anthropic"

    def test_set_anthropic_provider_existing_config(self, capsys, tmp_path):
        """
        GIVEN existing workflows.yaml file with configuration
        WHEN cmd_provider_set is called with 'anthropic'
        THEN it updates default_provider while preserving other config
        """
        # Given
        args = Namespace(name="anthropic")
        workflows_path = tmp_path / ".empathy" / "workflows.yaml"
        workflows_path.parent.mkdir(parents=True, exist_ok=True)

        existing_config = {"default_provider": "old_provider", "other_config": "value"}
        with open(workflows_path, "w") as f:
            yaml.dump(existing_config, f)

        # When
        with patch("empathy_os.cli.commands.provider.Path") as mock_path:
            mock_path.return_value = workflows_path
            mock_path.return_value.exists.return_value = True

            with patch(
                "empathy_os.cli.commands.provider._validate_file_path",
                return_value=workflows_path,
            ):
                cmd_provider_set(args)

        # Then
        captured = capsys.readouterr()
        assert "✓ Default provider set to: anthropic" in captured.out
        with open(workflows_path) as f:
            config = yaml.safe_load(f)
        assert config["default_provider"] == "anthropic"
        assert config["other_config"] == "value"

    def test_set_invalid_provider_exits(self, capsys):
        """
        GIVEN invalid provider name (not 'anthropic')
        WHEN cmd_provider_set is called
        THEN it exits with error message and migration guide
        """
        # Given
        args = Namespace(name="openai")

        # When/Then
        with pytest.raises(SystemExit) as exc_info:
            cmd_provider_set(args)

        assert exc_info.value.code == 1
        captured = capsys.readouterr()
        assert "❌ Error: Provider 'openai' is not supported" in captured.out
        assert "Empathy Framework is now Claude-native (v5.0.0)" in captured.out
        assert "Only 'anthropic' provider is available" in captured.out
        assert "docs/CLAUDE_NATIVE.md" in captured.out

    def test_set_case_insensitive_anthropic(self, capsys, tmp_path):
        """
        GIVEN provider name 'ANTHROPIC' in uppercase
        WHEN cmd_provider_set is called
        THEN it accepts the provider and sets it correctly
        """
        # Given
        args = Namespace(name="ANTHROPIC")
        workflows_path = tmp_path / ".empathy" / "workflows.yaml"

        # When
        with patch("empathy_os.cli.commands.provider.Path") as mock_path:
            mock_path.return_value = workflows_path
            mock_path.return_value.exists.return_value = False
            mock_path.return_value.parent.mkdir = MagicMock()

            with patch(
                "empathy_os.cli.commands.provider._validate_file_path",
                return_value=workflows_path,
            ):
                workflows_path.parent.mkdir(parents=True, exist_ok=True)
                cmd_provider_set(args)

        # Then
        captured = capsys.readouterr()
        assert "✓ Default provider set to: ANTHROPIC" in captured.out

    def test_set_creates_directory_if_not_exists(self, tmp_path):
        """
        GIVEN .empathy directory does not exist
        WHEN cmd_provider_set is called with 'anthropic'
        THEN it creates the directory and config file
        """
        # Given
        args = Namespace(name="anthropic")
        workflows_path = tmp_path / ".empathy" / "workflows.yaml"

        # When
        with patch("empathy_os.cli.commands.provider.Path") as mock_path:
            mock_path.return_value = workflows_path
            mock_path.return_value.exists.return_value = False
            mock_path.return_value.parent.mkdir = MagicMock()

            with patch(
                "empathy_os.cli.commands.provider._validate_file_path",
                return_value=workflows_path,
            ):
                workflows_path.parent.mkdir(parents=True, exist_ok=True)
                cmd_provider_set(args)

        # Then
        assert workflows_path.parent.exists()
        assert workflows_path.exists()

    def test_set_handles_empty_existing_file(self, capsys, tmp_path):
        """
        GIVEN existing but empty workflows.yaml file
        WHEN cmd_provider_set is called with 'anthropic'
        THEN it creates valid configuration
        """
        # Given
        args = Namespace(name="anthropic")
        workflows_path = tmp_path / ".empathy" / "workflows.yaml"
        workflows_path.parent.mkdir(parents=True, exist_ok=True)
        workflows_path.write_text("")

        # When
        with patch("empathy_os.cli.commands.provider.Path") as mock_path:
            mock_path.return_value = workflows_path
            mock_path.return_value.exists.return_value = True

            with patch(
                "empathy_os.cli.commands.provider._validate_file_path",
                return_value=workflows_path,
            ):
                cmd_provider_set(args)

        # Then
        captured = capsys.readouterr()
        assert "✓ Default provider set to: anthropic" in captured.out
        with open(workflows_path) as f:
            config = yaml.safe_load(f)
        assert config["default_provider"] == "anthropic"

    def test_set_provider_with_mixed_case(self, capsys):
        """
        GIVEN provider name 'AnThRoPiC' with mixed case
        WHEN cmd_provider_set is called
        THEN it accepts the provider (case-insensitive validation)
        """
        # Given
        args = Namespace(name="AnThRoPiC")
        workflows_path = Path(".empathy/workflows.yaml")

        # When
        with patch("empathy_os.cli.commands.provider.Path") as mock_path:
            mock_path.return_value = workflows_path
            mock_path.return_value.exists.return_value = False
            mock_path.return_value.parent.mkdir = MagicMock()

            mock_file = mock_open()
            with patch("builtins.open", mock_file):
                with patch(
                    "empathy_os.cli.commands.provider._validate_file_path",
                    return_value=workflows_path,
                ):
                    cmd_provider_set(args)

        # Then
        captured = capsys.readouterr()
        assert "✓ Default provider set to: AnThRoPiC" in captured.out

    def test_set_non_anthropic_provider_shows_migration_guide(self, capsys):
        """