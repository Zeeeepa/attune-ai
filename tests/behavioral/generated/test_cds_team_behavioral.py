"""Behavioral tests for cds_team.

Generated by LLM-enhanced test generation system.
Fixed to match actual module API signatures.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import pytest
import json
from unittest.mock import MagicMock, patch

from attune.agents.healthcare.cds_team import (
    Tier,
    AlertLevel,
    TriggerType,
    ClinicalEvent,
    AgentResult,
    CDSDecision,
    ProgressiveAgent,
    AlertPrioritizerAgent,
    ProtocolMatcherAgent,
    RiskScorerAgent,
    NotificationRouterAgent,
    CDSTeam,
    _extract_json,
)


@pytest.fixture
def mock_redis():
    """Create a mock Redis client that supports required operations."""
    redis_mock = MagicMock()
    redis_mock.ping.return_value = True
    redis_mock.get.return_value = None  # No cache hits
    redis_mock.setex.return_value = True
    redis_mock.publish.return_value = 1
    return redis_mock


@pytest.fixture
def sample_event():
    """Create a sample clinical event."""
    return ClinicalEvent(
        event_id="evt-001",
        trigger_type=TriggerType.LAB_RESULT,
        patient_id="patient_123",
        data={"symptoms": ["fever", "cough"], "temperature": 102.5},
    )


def test_extract_json_markdown_block():
    """Test JSON extraction from markdown code block."""
    input_text = """
    Here is some JSON:
    ```json
    {
        "key": "value",
        "number": 42
    }
    ```
    """
    result = _extract_json(input_text)
    assert json.loads(result) == {"key": "value", "number": 42}


def test_extract_json_raw_object():
    """Test JSON extraction from raw JSON object."""
    input_text = '{"patient_id": "123", "risk": 0.8}'
    result = _extract_json(input_text)
    assert json.loads(result) == {"patient_id": "123", "risk": 0.8}


def test_extract_json_returns_text_when_no_json():
    """Test _extract_json returns text as-is when no JSON found."""
    input_text = "Just plain text with no JSON"
    result = _extract_json(input_text)
    assert result == input_text.strip()


@pytest.mark.parametrize("tier", [Tier.CHEAP, Tier.CAPABLE, Tier.PREMIUM])
def test_tier_enum(tier):
    """Verify Tier enum values."""
    assert isinstance(tier, Tier)
    assert tier.value in ["cheap", "capable", "premium"]


@pytest.mark.parametrize(
    "alert_level", [AlertLevel.CRITICAL, AlertLevel.WARNING, AlertLevel.INFO]
)
def test_alert_level_enum(alert_level):
    """Verify AlertLevel enum values."""
    assert isinstance(alert_level, AlertLevel)
    assert alert_level.value in ["critical", "warning", "info"]


@pytest.mark.parametrize(
    "trigger_type",
    [
        TriggerType.LAB_RESULT,
        TriggerType.VITAL_SIGN,
        TriggerType.MEDICATION_ORDER,
    ],
)
def test_trigger_type_enum(trigger_type):
    """Verify TriggerType enum values."""
    assert isinstance(trigger_type, TriggerType)


def test_clinical_event_creation():
    """Test ClinicalEvent dataclass creation with all required fields."""
    event = ClinicalEvent(
        event_id="evt-test",
        trigger_type=TriggerType.LAB_RESULT,
        patient_id="patient_456",
        data={"lab": "CBC", "value": 12.5},
    )
    assert event.event_id == "evt-test"
    assert event.trigger_type == TriggerType.LAB_RESULT
    assert event.patient_id == "patient_456"
    assert event.data == {"lab": "CBC", "value": 12.5}
    assert event.timestamp > 0  # auto-set by time.time()


def test_agent_result_creation():
    """Test AgentResult dataclass creation."""
    result = AgentResult(
        agent_id="test-agent-1",
        agent_role="Test Role",
        success=True,
        tier_used=Tier.CHEAP,
        result={"score": 0.85},
        execution_time_ms=150.0,
    )
    assert result.agent_id == "test-agent-1"
    assert result.success is True
    assert result.tier_used == Tier.CHEAP
    assert result.escalated is False  # default


def test_cds_decision_creation():
    """Test CDSDecision dataclass creation."""
    agent_result = AgentResult(
        agent_id="test-1",
        agent_role="Tester",
        success=True,
        tier_used=Tier.CHEAP,
        result={},
        execution_time_ms=100.0,
    )
    decision = CDSDecision(
        event_id="evt-001",
        patient_id="patient_123",
        alert_level=AlertLevel.WARNING,
        risk_score=0.75,
        matched_protocols=["sepsis-3"],
        notifications=[{"channel": "pager"}],
        agent_results=[agent_result],
        total_time_ms=500.0,
    )
    assert decision.risk_score == 0.75
    assert decision.alert_level == AlertLevel.WARNING
    assert len(decision.agent_results) == 1


def test_progressive_agent_initialization(mock_redis):
    """Test ProgressiveAgent initialization with correct constructor."""
    agent = ProgressiveAgent(
        agent_id="test-agent",
        role="Test Agent",
        redis_client=mock_redis,
    )
    assert agent.agent_id == "test-agent"
    assert agent.role == "Test Agent"
    assert agent.current_tier == Tier.CHEAP
    assert agent.total_cost == 0.0
    assert agent.total_tokens == 0


def test_alert_prioritizer_initialization(mock_redis):
    """Test AlertPrioritizerAgent creates with correct defaults."""
    agent = AlertPrioritizerAgent(redis_client=mock_redis)
    assert agent.role == "Alert Prioritizer"
    assert agent.current_tier == Tier.CHEAP
    assert Tier.CHEAP in agent.thresholds


def test_alert_prioritizer_process(mock_redis, sample_event):
    """Test AlertPrioritizerAgent.process() returns AgentResult."""
    agent = AlertPrioritizerAgent(redis_client=mock_redis)
    result = agent.process(sample_event)
    assert isinstance(result, AgentResult)
    assert result.success is True
    assert result.agent_role == "Alert Prioritizer"


def test_protocol_matcher_initialization(mock_redis):
    """Test ProtocolMatcherAgent creates with correct defaults."""
    agent = ProtocolMatcherAgent(redis_client=mock_redis)
    assert agent.role == "Protocol Matcher"


def test_protocol_matcher_process(mock_redis, sample_event):
    """Test ProtocolMatcherAgent.process() returns AgentResult."""
    agent = ProtocolMatcherAgent(redis_client=mock_redis)
    result = agent.process(sample_event)
    assert isinstance(result, AgentResult)
    assert result.success is True


def test_risk_scorer_initialization(mock_redis):
    """Test RiskScorerAgent creates with correct defaults."""
    agent = RiskScorerAgent(redis_client=mock_redis)
    assert agent.role == "Risk Scorer"


def test_risk_scorer_process(mock_redis, sample_event):
    """Test RiskScorerAgent.process() returns AgentResult."""
    agent = RiskScorerAgent(redis_client=mock_redis)
    result = agent.process(sample_event)
    assert isinstance(result, AgentResult)
    assert result.success is True


def test_notification_router_initialization(mock_redis):
    """Test NotificationRouterAgent creates with routing rules."""
    agent = NotificationRouterAgent(redis_client=mock_redis)
    assert agent.role == "Notification Router"
    assert AlertLevel.CRITICAL in agent.routing_rules
    assert AlertLevel.WARNING in agent.routing_rules
    assert AlertLevel.INFO in agent.routing_rules


def test_notification_router_critical_routing(mock_redis):
    """Test that critical alerts route to rapid response team."""
    agent = NotificationRouterAgent(redis_client=mock_redis)
    rules = agent.routing_rules[AlertLevel.CRITICAL]
    assert "rapid_response" in rules["recipients"]
    assert "pager" in rules["channels"]


def test_notification_router_process(mock_redis):
    """Test NotificationRouterAgent.process() with alert level in data."""
    agent = NotificationRouterAgent(redis_client=mock_redis)
    event = ClinicalEvent(
        event_id="evt-notify",
        trigger_type=TriggerType.VITAL_SIGN,
        patient_id="patient_789",
        data={"alert_level": "critical"},
    )
    result = agent.process(event)
    assert isinstance(result, AgentResult)
    assert result.success is True


@patch("attune.agents.healthcare.cds_team.redis.Redis")
def test_cds_team_initialization(mock_redis_cls):
    """Test CDSTeam creates all four agents."""
    mock_instance = MagicMock()
    mock_instance.ping.return_value = True
    mock_redis_cls.return_value = mock_instance

    team = CDSTeam()
    assert len(team.agents) == 4
    assert team.get_total_cost() == 0.0
    assert team.get_total_tokens() == 0
