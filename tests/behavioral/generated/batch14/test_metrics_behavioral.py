"""Behavioral tests for metrics.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import sys
from argparse import Namespace
from unittest.mock import Mock, patch, MagicMock

import pytest

from empathy_os.cli.commands.metrics import cmd_metrics_show, cmd_state_list


@pytest.fixture
def mock_args_metrics():
    """Fixture providing mock arguments for metrics show command."""
    args = Namespace()
    args.db = "./metrics.db"
    args.user = "test_user_123"
    return args


@pytest.fixture
def mock_args_state():
    """Fixture providing mock arguments for state list command."""
    args = Namespace()
    args.state_dir = "./states"
    return args


@pytest.fixture
def sample_user_stats():
    """Fixture providing sample user statistics data."""
    return {
        "total_operations": 150,
        "success_rate": 0.95,
        "avg_response_time_ms": 245.5,
        "first_use": "2025-01-01 10:00:00",
        "last_use": "2025-01-15 14:30:00",
        "level_1_count": 10,
        "level_2_count": 25,
        "level_3_count": 50,
        "level_4_count": 40,
        "level_5_count": 25,
    }


@pytest.fixture
def mock_metrics_collector():
    """Fixture providing a mock MetricsCollector."""
    with patch("empathy_os.cli.commands.metrics.MetricsCollector") as mock:
        yield mock


@pytest.fixture
def mock_state_manager():
    """Fixture providing a mock StateManager."""
    with patch("empathy_os.cli.commands.metrics.StateManager") as mock:
        yield mock


@pytest.fixture
def mock_logger():
    """Fixture providing a mock logger."""
    with patch("empathy_os.cli.commands.metrics.logger") as mock:
        yield mock


class TestCmdMetricsShow:
    """Test suite for cmd_metrics_show function."""

    def test_successful_metrics_retrieval(
        self, mock_args_metrics, mock_metrics_collector, mock_logger, sample_user_stats
    ):
        """
        Given a valid user ID and database path
        When cmd_metrics_show is called
        Then metrics are retrieved and displayed successfully.
        """
        # Given
        mock_collector_instance = Mock()
        mock_collector_instance.get_user_stats.return_value = sample_user_stats
        mock_metrics_collector.return_value = mock_collector_instance

        # When
        cmd_metrics_show(mock_args_metrics)

        # Then
        mock_metrics_collector.assert_called_once_with("./metrics.db")
        mock_collector_instance.get_user_stats.assert_called_once_with("test_user_123")
        
        # Verify logger calls include key information
        assert any("test_user_123" in str(call) for call in mock_logger.info.call_args_list)
        assert any("150" in str(call) for call in mock_logger.info.call_args_list)

    def test_metrics_retrieval_with_minimal_stats(
        self, mock_args_metrics, mock_metrics_collector, mock_logger
    ):
        """
        Given user statistics with minimal data
        When cmd_metrics_show is called
        Then default values are used for missing fields.
        """
        # Given
        minimal_stats = {
            "total_operations": 5,
            "success_rate": 1.0,
            "first_use": "2025-01-01 10:00:00",
            "last_use": "2025-01-01 10:05:00",
        }
        mock_collector_instance = Mock()
        mock_collector_instance.get_user_stats.return_value = minimal_stats
        mock_metrics_collector.return_value = mock_collector_instance

        # When
        cmd_metrics_show(mock_args_metrics)

        # Then
        mock_collector_instance.get_user_stats.assert_called_once()
        # Verify that missing fields are handled with .get() defaults
        assert any("0 ms" in str(call) or "0.0" in str(call) for call in mock_logger.info.call_args_list)

    def test_database_not_found_error(
        self, mock_args_metrics, mock_metrics_collector, mock_logger
    ):
        """
        Given a non-existent database path
        When cmd_metrics_show is called
        Then FileNotFoundError is caught and system exits with code 1.
        """
        # Given
        mock_collector_instance = Mock()
        mock_collector_instance.get_user_stats.side_effect = FileNotFoundError(
            "Database not found"
        )
        mock_metrics_collector.return_value = mock_collector_instance

        # When/Then
        with pytest.raises(SystemExit) as exc_info:
            cmd_metrics_show(mock_args_metrics)
        
        assert exc_info.value.code == 1
        mock_logger.error.assert_called()
        assert any("database" in str(call).lower() for call in mock_logger.error.call_args_list)

    def test_database_access_error(
        self, mock_args_metrics, mock_metrics_collector, mock_logger
    ):
        """
        Given a database with access permissions issues
        When cmd_metrics_show is called
        Then OSError is caught and system exits with code 1.
        """
        # Given
        mock_collector_instance = Mock()
        mock_collector_instance.get_user_stats.side_effect = OSError(
            "Permission denied"
        )
        mock_metrics_collector.return_value = mock_collector_instance

        # When/Then
        with pytest.raises(SystemExit) as exc_info:
            cmd_metrics_show(mock_args_metrics)
        
        assert exc_info.value.code == 1
        mock_logger.error.assert_called()

    def test_user_not_found_error(
        self, mock_args_metrics, mock_metrics_collector, mock_logger
    ):
        """
        Given a user ID that doesn't exist in the database
        When cmd_metrics_show is called
        Then KeyError is caught and system exits with code 1.
        """
        # Given
        mock_collector_instance = Mock()
        mock_collector_instance.get_user_stats.side_effect = KeyError("user_id")
        mock_metrics_collector.return_value = mock_collector_instance

        # When/Then
        with pytest.raises(SystemExit) as exc_info:
            cmd_metrics_show(mock_args_metrics)
        
        assert exc_info.value.code == 1
        mock_logger.error.assert_called()
        assert any("not found" in str(call).lower() for call in mock_logger.error.call_args_list)

    def test_unexpected_error_during_retrieval(
        self, mock_args_metrics, mock_metrics_collector, mock_logger
    ):
        """
        Given an unexpected error during metrics retrieval
        When cmd_metrics_show is called
        Then exception is caught and system exits with code 1.
        """
        # Given
        mock_collector_instance = Mock()
        mock_collector_instance.get_user_stats.side_effect = RuntimeError(
            "Unexpected error"
        )
        mock_metrics_collector.return_value = mock_collector_instance

        # When/Then
        with pytest.raises(SystemExit) as exc_info:
            cmd_metrics_show(mock_args_metrics)
        
        assert exc_info.value.code == 1
        mock_logger.exception.assert_called()
        mock_logger.error.assert_called()

    def test_metrics_show_with_custom_db_path(
        self, mock_metrics_collector, mock_logger, sample_user_stats
    ):
        """
        Given a custom database path
        When cmd_metrics_show is called
        Then the collector is initialized with the custom path.
        """
        # Given
        args = Namespace()
        args.db = "/custom/path/metrics.db"
        args.user = "custom_user"
        
        mock_collector_instance = Mock()
        mock_collector_instance.get_user_stats.return_value = sample_user_stats
        mock_metrics_collector.return_value = mock_collector_instance

        # When
        cmd_metrics_show(args)

        # Then
        mock_metrics_collector.assert_called_once_with("/custom/path/metrics.db")

    def test_metrics_display_all_empathy_levels(
        self, mock_args_metrics, mock_metrics_collector, mock_logger, sample_user_stats
    ):
        """
        Given user statistics with all empathy levels
        When cmd_metrics_show is called
        Then all 5 empathy levels are displayed.
        """
        # Given
        mock_collector_instance = Mock()
        mock_collector_instance.get_user_stats.return_value = sample_user_stats
        mock_metrics_collector.return_value = mock_collector_instance

        # When
        cmd_metrics_show(mock_args_metrics)

        # Then
        info_calls = [str(call) for call in mock_logger.info.call_args_list]
        assert any("Level 1" in call for call in info_calls)
        assert any("Level 2" in call for call in info_calls)
        assert any("Level 3" in call for call in info_calls)
        assert any("Level 4" in call for call in info_calls)
        assert any("Level 5" in call for call in info_calls)

    def test_metrics_with_zero_operations(
        self, mock_args_metrics, mock_metrics_collector, mock_logger
    ):
        """
        Given user statistics with zero operations
        When cmd_metrics_show is called
        Then metrics are displayed with zero values.
        """
        # Given
        zero_stats = {
            "total_operations": 0,
            "success_rate": 0.0,
            "first_use": "Never",
            "last_use": "Never",
        }
        mock_collector_instance = Mock()
        mock_collector_instance.get_user_stats.return_value = zero_stats
        mock_metrics_collector.return_value = mock_collector_instance

        # When
        cmd_metrics_show(mock_args_metrics)

        # Then
        mock_collector_instance.get_user_stats.assert_called_once()
        assert any("0" in str(call) for call in mock_logger.info.call_args_list)

    def test_metrics_with_special_characters_in_user_id(
        self, mock_metrics_collector, mock_logger, sample_user_stats
    ):
        """
        Given a user ID with special characters
        When cmd_metrics_show is called
        Then metrics are retrieved correctly.
        """
        # Given
        args = Namespace()
        args.db = "./metrics.db"
        args.user = "user@example.com"
        
        mock_collector_instance = Mock()
        mock_collector_instance.get_user_stats.return_value = sample_user_stats
        mock_metrics_collector.return_value = mock_collector_instance

        # When
        cmd_metrics_show(args)

        # Then
        mock_collector_instance.get_user_stats.assert_called_once_with("user@example.com")


class TestCmdStateList:
    """Test suite for cmd_state_list function."""

    def test_list_states_with_users(
        self, mock_args_state, mock_state_manager, mock_logger
    ):
        """
        Given a state directory with multiple users
        When cmd_state_list is called
        Then all user states are listed.
        """
        # Given
        mock_manager_instance = Mock()
        mock_manager_instance.list_users.return_value = [
            "user1",
            "user2",
            "user3",
        ]
        mock_state_manager.return_value = mock_manager_instance

        # When
        cmd_state_list(mock_args_state)

        # Then
        mock_state_manager.assert_called_once_with("./states")
        mock_manager_instance.list_users.assert_called_once()
        assert any("3" in str(call) for call in mock_logger.info.call_args_list)

    def test_list_states_with_no_users(
        self, mock_args_state, mock_state_manager, mock_logger
    ):
        """
        Given an empty state directory
        When cmd_state_list is called
        Then an empty list is displayed.
        """
        # Given
        mock_manager_instance = Mock()
        mock_manager_instance.list_users.return_value = []
        mock_state_manager.return_value = mock_manager_instance

        # When
        cmd_state_list(mock_args_state)

        # Then
        mock_manager_instance.list_users.assert_called_once()
        assert any("0" in str(call) for call in mock_logger.info.call_args_list)

    def test_list_states_with_custom_directory(
        self, mock_state_manager, mock_logger
    ):
        """
        Given a custom state directory path
        When cmd_state_list is called
        Then the StateManager is initialized with the custom path.
        """
        # Given
        args = Namespace()
        args.state_dir = "/custom/state/dir"
        
        mock_manager_instance = Mock()
        mock_manager_instance.list_users.return_value = ["user1"]
        mock_state_manager.return_value = mock_manager_instance

        # When
        cmd_state_list(args)

        # Then
        mock_state_manager.assert_called_once_with("/custom/state/dir")

    def test_list_states_with_single_user(
        self, mock_args_state, mock_state_manager, mock_logger
    ):
        """
        Given a state directory with one user
        When cmd_state_list is called
        Then that single user is listed.
        """
        # Given
        mock_manager_instance = Mock()
        mock_manager_instance.list_users.return_value = ["single_user"]
        mock_state_manager.return_value = mock_manager_instance

        # When
        cmd_state_list(mock_args_state)

        # Then
        mock_manager_instance.list_users.assert_called_once()
        assert any("1" in str(call) for call in mock_logger.info.call_args_list)

    def test_list_states_with_many_users(
        self, mock_args_state, mock_state_manager, mock_logger
    ):
        """
        Given a state directory with many users
        When cmd_state_list is called
        Then the count reflects all users.
        """
        # Given
        mock_manager_instance = Mock()
        users = [f"user{i}" for i in range(100)]
        mock_manager_instance.list_users.return_value = users
        mock_state_manager.return_value = mock_manager_instance

        # When
        cmd_state_list(mock_args_state)

        # Then
        mock_manager_instance.list_users.assert_called_once()
        assert any("100" in str(call) for call in mock_logger.info.call_args_list)

    def test_list_states_logs_directory_path(
        self, mock_args_state, mock_state_manager, mock_logger
    ):
        """
        Given a state directory path
        When cmd_state_list is called
        Then the directory path is logged.
        """
        # Given
        mock_manager_