"""Behavioral tests for agent_creator.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import logging
from typing import Any
from unittest.mock import Mock, patch

import pytest

from empathy_os.meta_workflows.agent_creator import DynamicAgentCreator
from empathy_os.meta_workflows.models import (
    AgentCompositionRule,
    AgentSpec,
    FormResponse,
    MetaWorkflowTemplate,
    TierStrategy,
)


# Fixtures


@pytest.fixture
def mock_form_response():
    """Create a mock FormResponse for testing."""
    response = Mock(spec=FormResponse)
    response.responses = {
        "budget": "high",
        "timeline": "urgent",
        "complexity": "complex",
        "team_size": "large",
    }
    response.get_response = lambda key, default=None: response.responses.get(key, default)
    return response


@pytest.fixture
def mock_agent_composition_rule():
    """Create a mock AgentCompositionRule for testing."""
    rule = Mock(spec=AgentCompositionRule)
    rule.role = "test_analyst"
    rule.tier_strategy = TierStrategy.BALANCED
    rule.capabilities = ["analyze", "report"]
    rule.priority = 1
    rule.should_create = Mock(return_value=True)
    return rule


@pytest.fixture
def mock_agent_composition_rule_failing():
    """Create a mock AgentCompositionRule that fails conditions."""
    rule = Mock(spec=AgentCompositionRule)
    rule.role = "optional_agent"
    rule.tier_strategy = TierStrategy.COST_OPTIMIZED
    rule.capabilities = ["optional_task"]
    rule.priority = 2
    rule.should_create = Mock(return_value=False)
    return rule


@pytest.fixture
def mock_meta_workflow_template(mock_agent_composition_rule):
    """Create a mock MetaWorkflowTemplate for testing."""
    template = Mock(spec=MetaWorkflowTemplate)
    template.template_id = "test_template_001"
    template.agent_composition_rules = [mock_agent_composition_rule]
    return template


@pytest.fixture
def mock_meta_workflow_template_empty():
    """Create a mock MetaWorkflowTemplate with no rules."""
    template = Mock(spec=MetaWorkflowTemplate)
    template.template_id = "empty_template_001"
    template.agent_composition_rules = []
    return template


@pytest.fixture
def mock_meta_workflow_template_multiple(
    mock_agent_composition_rule, mock_agent_composition_rule_failing
):
    """Create a mock MetaWorkflowTemplate with multiple rules."""
    template = Mock(spec=MetaWorkflowTemplate)
    template.template_id = "multi_template_001"
    
    # Add additional rules
    rule2 = Mock(spec=AgentCompositionRule)
    rule2.role = "coordinator"
    rule2.tier_strategy = TierStrategy.PERFORMANCE_OPTIMIZED
    rule2.capabilities = ["coordinate", "manage"]
    rule2.priority = 0
    rule2.should_create = Mock(return_value=True)
    
    template.agent_composition_rules = [
        mock_agent_composition_rule,
        rule2,
        mock_agent_composition_rule_failing,
    ]
    return template


@pytest.fixture
def dynamic_agent_creator():
    """Create a DynamicAgentCreator instance for testing."""
    return DynamicAgentCreator()


# Test DynamicAgentCreator.__init__


class TestDynamicAgentCreatorInit:
    """Tests for DynamicAgentCreator initialization."""

    def test_initialization_creates_stats_dict(self):
        """Given a new DynamicAgentCreator instance is created,
        When the instance is initialized,
        Then creation_stats should be initialized with correct keys and zero values.
        """
        # Given/When
        creator = DynamicAgentCreator()

        # Then
        assert "total_rules_evaluated" in creator.creation_stats
        assert "agents_created" in creator.creation_stats
        assert "rules_skipped" in creator.creation_stats
        assert creator.creation_stats["total_rules_evaluated"] == 0
        assert creator.creation_stats["agents_created"] == 0
        assert creator.creation_stats["rules_skipped"] == 0

    def test_initialization_stats_are_separate_instances(self):
        """Given two DynamicAgentCreator instances are created,
        When they are initialized separately,
        Then each instance should have independent creation_stats.
        """
        # Given/When
        creator1 = DynamicAgentCreator()
        creator2 = DynamicAgentCreator()
        
        creator1.creation_stats["agents_created"] = 5

        # Then
        assert creator1.creation_stats["agents_created"] == 5
        assert creator2.creation_stats["agents_created"] == 0


# Test DynamicAgentCreator.create_agents


class TestCreateAgents:
    """Tests for DynamicAgentCreator.create_agents method."""

    def test_create_agents_with_valid_template_and_response(
        self,
        dynamic_agent_creator,
        mock_meta_workflow_template,
        mock_form_response,
    ):
        """Given a valid template with one composition rule and form response,
        When create_agents is called,
        Then one agent should be created and stats should be updated.
        """
        # Given
        with patch.object(
            dynamic_agent_creator,
            "_create_agent_from_rule",
            return_value=Mock(spec=AgentSpec, role="test_analyst", agent_id="agent_001"),
        ) as mock_create:

            # When
            agents = dynamic_agent_creator.create_agents(
                mock_meta_workflow_template, mock_form_response
            )

            # Then
            assert len(agents) == 1
            assert dynamic_agent_creator.creation_stats["total_rules_evaluated"] == 1
            assert dynamic_agent_creator.creation_stats["agents_created"] == 1
            assert dynamic_agent_creator.creation_stats["rules_skipped"] == 0
            mock_create.assert_called_once()

    def test_create_agents_with_empty_template(
        self,
        dynamic_agent_creator,
        mock_meta_workflow_template_empty,
        mock_form_response,
        caplog,
    ):
        """Given a template with no composition rules,
        When create_agents is called,
        Then an empty list should be returned and a warning should be logged.
        """
        # Given/When
        with caplog.at_level(logging.WARNING):
            agents = dynamic_agent_creator.create_agents(
                mock_meta_workflow_template_empty, mock_form_response
            )

        # Then
        assert len(agents) == 0
        assert "has no composition rules" in caplog.text

    def test_create_agents_with_multiple_rules(
        self,
        dynamic_agent_creator,
        mock_meta_workflow_template_multiple,
        mock_form_response,
    ):
        """Given a template with multiple composition rules (some passing, some failing),
        When create_agents is called,
        Then only agents with passing conditions should be created.
        """
        # Given
        with patch.object(
            dynamic_agent_creator,
            "_create_agent_from_rule",
            side_effect=[
                Mock(spec=AgentSpec, role="test_analyst", agent_id="agent_001"),
                Mock(spec=AgentSpec, role="coordinator", agent_id="agent_002"),
            ],
        ):

            # When
            agents = dynamic_agent_creator.create_agents(
                mock_meta_workflow_template_multiple, mock_form_response
            )

            # Then
            assert len(agents) == 2
            assert dynamic_agent_creator.creation_stats["total_rules_evaluated"] == 3
            assert dynamic_agent_creator.creation_stats["agents_created"] == 2
            assert dynamic_agent_creator.creation_stats["rules_skipped"] == 1

    def test_create_agents_logs_debug_info_for_created_agents(
        self,
        dynamic_agent_creator,
        mock_meta_workflow_template,
        mock_form_response,
        caplog,
    ):
        """Given a valid template and form response,
        When create_agents is called,
        Then debug logs should contain agent creation details.
        """
        # Given
        mock_agent = Mock(spec=AgentSpec)
        mock_agent.role = "test_analyst"
        mock_agent.agent_id = "agent_001"
        mock_agent.tier_strategy = TierStrategy.BALANCED

        with patch.object(
            dynamic_agent_creator,
            "_create_agent_from_rule",
            return_value=mock_agent,
        ):

            # When
            with caplog.at_level(logging.DEBUG):
                dynamic_agent_creator.create_agents(
                    mock_meta_workflow_template, mock_form_response
                )

            # Then
            assert "Created agent: test_analyst" in caplog.text
            assert "tier: balanced" in caplog.text
            assert "agent_001" in caplog.text

    def test_create_agents_logs_debug_info_for_skipped_agents(
        self,
        dynamic_agent_creator,
        mock_meta_workflow_template_multiple,
        mock_form_response,
        caplog,
    ):
        """Given a template with rules that fail conditions,
        When create_agents is called,
        Then debug logs should contain skipped agent information.
        """
        # Given
        with patch.object(
            dynamic_agent_creator,
            "_create_agent_from_rule",
            side_effect=[
                Mock(spec=AgentSpec, role="test_analyst", agent_id="agent_001"),
                Mock(spec=AgentSpec, role="coordinator", agent_id="agent_002"),
            ],
        ):

            # When
            with caplog.at_level(logging.DEBUG):
                dynamic_agent_creator.create_agents(
                    mock_meta_workflow_template_multiple, mock_form_response
                )

            # Then
            assert "Skipped agent optional_agent" in caplog.text
            assert "conditions not met" in caplog.text

    def test_create_agents_logs_summary_info(
        self,
        dynamic_agent_creator,
        mock_meta_workflow_template_multiple,
        mock_form_response,
        caplog,
    ):
        """Given a template with multiple rules,
        When create_agents is called,
        Then info logs should contain summary of creation process.
        """
        # Given
        with patch.object(
            dynamic_agent_creator,
            "_create_agent_from_rule",
            side_effect=[
                Mock(spec=AgentSpec, role="test_analyst", agent_id="agent_001"),
                Mock(spec=AgentSpec, role="coordinator", agent_id="agent_002"),
            ],
        ):

            # When
            with caplog.at_level(logging.INFO):
                dynamic_agent_creator.create_agents(
                    mock_meta_workflow_template_multiple, mock_form_response
                )

            # Then
            assert "Evaluating 3 composition rules" in caplog.text
            assert "Created 2 agents from 3 rules" in caplog.text

    def test_create_agents_calls_should_create_on_rules(
        self,
        dynamic_agent_creator,
        mock_meta_workflow_template,
        mock_form_response,
    ):
        """Given a template with composition rules,
        When create_agents is called,
        Then should_create should be called on each rule with form_response.
        """
        # Given
        rule = mock_meta_workflow_template.agent_composition_rules[0]
        
        with patch.object(
            dynamic_agent_creator,
            "_create_agent_from_rule",
            return_value=Mock(spec=AgentSpec),
        ):

            # When
            dynamic_agent_creator.create_agents(
                mock_meta_workflow_template, mock_form_response
            )

            # Then
            rule.should_create.assert_called_once_with(mock_form_response)

    def test_create_agents_returns_empty_list_when_all_rules_fail(
        self,
        dynamic_agent_creator,
        mock_form_response,
    ):
        """Given a template where all rules fail conditions,
        When create_agents is called,
        Then an empty list should be returned.
        """
        # Given
        template = Mock(spec=MetaWorkflowTemplate)
        template.template_id = "failing_template"
        
        failing_rule = Mock(spec=AgentCompositionRule)
        failing_rule.role = "failing_agent"
        failing_rule.should_create = Mock(return_value=False)
        
        template.agent_composition_rules = [failing_rule]

        # When
        agents = dynamic_agent_creator.create_agents(template, mock_form_response)

        # Then
        assert len(agents) == 0
        assert dynamic_agent_creator.creation_stats["agents_created"] == 0
        assert dynamic_agent_creator.creation_stats["rules_skipped"] == 1

    def test_create_agents_accumulates_stats_across_calls(
        self,
        dynamic_agent_creator,
        mock_meta_workflow_template,
        mock_form_response,
    ):
        """Given multiple calls to create_agents,
        When the method is called repeatedly,
        Then stats should accumulate across calls.
        """
        # Given
        with patch.object(
            dynamic_agent_creator,
            "_create_agent_from_rule",
            return_value=Mock(spec=AgentSpec),
        ):

            # When
            dynamic_agent_creator.create_agents(
                mock_meta_workflow_template, mock_form_response
            )
            dynamic_agent_creator.create_agents(
                mock_meta_workflow_template, mock_form_response
            )

            # Then
            assert dynamic_agent_creator.creation_stats["total_rules_evaluated"] == 1  # Overwritten
            assert dynamic_agent_creator.creation_stats["agents_created"] == 2  # Accumulated


# Test DynamicAgentCreator._create_agent_from_rule


class TestCreateAgentFromRule:
    """Tests for DynamicAgentCreator._create_agent_from_rule method."""

    def test_create_agent_from_rule_creates_agent_spec(
        self,
        dynamic_agent_creator,
        mock_agent_composition_rule,
        mock_form_response,
    ):
        """Given a valid composition rule and form response,
        When _create_agent_from_rule is called,
        Then an AgentSpec should be created with correct attributes.
        """
        # Given/When
        agent = dynamic_agent_creator._create_agent_from_rule(
            mock_agent_composition_rule, mock_form_response
        )

        # Then
        assert isinstance(agent, AgentSpec)
        assert agent.role == "test_analyst"
        assert agent.tier_strategy == TierStrategy.BALANCED
        assert agent.capabilities == ["analyze", "report"]
        assert agent.priority == 1

    def test_create_agent_from_rule_generates_unique_agent_id(
        self,
        dynamic_agent_creator,
        mock_agent_composition_rule,
        mock_form_response,
    ):
        """Given multiple calls to _create_agent_from_rule,
        When agents are created,
        Then each agent should have a unique agent_id.
        """
        # Given/When
        agent1 = dynamic_agent_creator._create_agent_from_rule(
            mock_agent_composition_rule,