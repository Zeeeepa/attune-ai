"""Behavioral tests for config.

Generated by LLM-enhanced test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import json
import os
import sys
import tempfile
from pathlib import Path

import pytest

from attune.config import EmpathyConfig, _validate_file_path


class TestEmpathyConfig:
    def test_default_config_initialization(self):
        """Verify default configuration values are set correctly."""
        config = EmpathyConfig()

        assert config.user_id == "default_user"
        assert config.target_level == 3
        assert config.confidence_threshold == 0.75
        assert config.persistence_enabled is True
        assert config.persistence_backend == "sqlite"

    def test_custom_config_initialization(self):
        """Verify custom configuration values override defaults."""
        config = EmpathyConfig(user_id="test_user", target_level=5, confidence_threshold=0.9)

        assert config.user_id == "test_user"
        assert config.target_level == 5
        assert config.confidence_threshold == 0.9

    def test_from_yaml_valid_configuration(self, tmp_path):
        """Test loading configuration from a valid YAML file."""
        yaml_content = """
        user_id: yaml_user
        target_level: 4
        confidence_threshold: 0.8
        """

        yaml_file = tmp_path / "config.yaml"
        yaml_file.write_text(yaml_content)

        config = EmpathyConfig.from_yaml(str(yaml_file))

        assert config.user_id == "yaml_user"
        assert config.target_level == 4
        assert config.confidence_threshold == 0.8

    def test_from_json_valid_configuration(self, tmp_path):
        """Test loading configuration from a valid JSON file."""
        json_content = {"user_id": "json_user", "target_level": 2, "confidence_threshold": 0.6}

        json_file = tmp_path / "config.json"
        json_file.write_text(json.dumps(json_content))

        config = EmpathyConfig.from_json(str(json_file))

        assert config.user_id == "json_user"
        assert config.target_level == 2
        assert config.confidence_threshold == 0.6

    def test_to_dict_conversion(self):
        """Verify dictionary conversion preserves all attributes."""
        config = EmpathyConfig(user_id="convert_user")
        config_dict = config.to_dict()

        assert isinstance(config_dict, dict)
        assert config_dict["user_id"] == "convert_user"

    def test_to_json_conversion(self, tmp_path):
        """Test JSON serialization of configuration."""
        config = EmpathyConfig(user_id="json_export")
        json_file = tmp_path / "export.json"

        config.to_json(str(json_file))

        with open(json_file) as f:
            loaded_data = json.load(f)

        assert loaded_data["user_id"] == "json_export"


def test_validate_file_path_success():
    """Test successful file path validation."""
    with tempfile.TemporaryDirectory() as tmpdir:
        resolved_tmpdir = str(Path(tmpdir).resolve())
        test_file = os.path.join(resolved_tmpdir, "test.txt")
        validated_path = _validate_file_path(test_file, resolved_tmpdir)
        assert isinstance(validated_path, Path)
        assert str(validated_path) == test_file


def test_validate_file_path_dangerous_path_raises_error():
    """Verify validation prevents writes to system directories."""
    dangerous_path = "C:\\Windows\\System32\\test.txt" if sys.platform == "win32" else "/etc/passwd"
    with pytest.raises(ValueError):
        _validate_file_path(dangerous_path)


def test_validate_file_path_null_bytes_raises_error():
    """Test that null bytes in path raise a ValueError."""
    with pytest.raises(ValueError):
        _validate_file_path("test\x00file.txt")
