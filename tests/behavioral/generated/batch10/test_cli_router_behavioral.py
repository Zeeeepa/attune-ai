"""Behavioral tests for cli_router.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

from pathlib import Path
from unittest.mock import AsyncMock, MagicMock, Mock, mock_open, patch

import pytest
import yaml

from empathy_os.cli_router import HybridRouter, RoutingPreference


@pytest.fixture
def temp_preferences_path(tmp_path):
    """Provide a temporary path for routing preferences."""
    return tmp_path / "routing_preferences.yaml"


@pytest.fixture
def sample_preferences():
    """Provide sample routing preferences data."""
    return {
        "commit": {
            "keyword": "commit",
            "skill": "dev",
            "args": "commit",
            "usage_count": 10,
            "confidence": 0.95,
        },
        "test": {
            "keyword": "test",
            "skill": "testing",
            "args": "run",
            "usage_count": 5,
            "confidence": 0.90,
        },
    }


@pytest.fixture
def mock_smart_router():
    """Provide a mocked SmartRouter instance."""
    with patch("empathy_os.cli_router.SmartRouter") as mock_router_class:
        mock_instance = AsyncMock()
        mock_router_class.return_value = mock_instance
        yield mock_instance


class TestRoutingPreference:
    """Behavioral tests for RoutingPreference dataclass."""

    def test_routing_preference_creation_with_defaults(self):
        """
        Given: Basic keyword and skill parameters
        When: Creating a RoutingPreference instance
        Then: It should initialize with default values
        """
        pref = RoutingPreference(keyword="commit", skill="dev")

        assert pref.keyword == "commit"
        assert pref.skill == "dev"
        assert pref.args == ""
        assert pref.usage_count == 0
        assert pref.confidence == 1.0

    def test_routing_preference_creation_with_all_fields(self):
        """
        Given: All RoutingPreference parameters
        When: Creating a RoutingPreference instance
        Then: It should initialize with provided values
        """
        pref = RoutingPreference(
            keyword="test",
            skill="testing",
            args="run --coverage",
            usage_count=15,
            confidence=0.85,
        )

        assert pref.keyword == "test"
        assert pref.skill == "testing"
        assert pref.args == "run --coverage"
        assert pref.usage_count == 15
        assert pref.confidence == 0.85


class TestHybridRouterInitialization:
    """Behavioral tests for HybridRouter initialization."""

    def test_initialization_with_default_preferences_path(self, mock_smart_router):
        """
        Given: No preferences path provided
        When: Initializing HybridRouter
        Then: It should use default path in home directory
        """
        router = HybridRouter()

        expected_path = Path.home() / ".empathy" / "routing_preferences.yaml"
        assert router.preferences_path == expected_path
        assert isinstance(router.preferences, dict)
        assert len(router.preferences) == 0

    def test_initialization_with_custom_preferences_path(
        self, temp_preferences_path, mock_smart_router
    ):
        """
        Given: Custom preferences path
        When: Initializing HybridRouter
        Then: It should use the provided path
        """
        router = HybridRouter(preferences_path=str(temp_preferences_path))

        assert router.preferences_path == temp_preferences_path
        assert isinstance(router.preferences, dict)

    def test_keyword_to_skill_mapping_exists(self, mock_smart_router):
        """
        Given: HybridRouter initialization
        When: Checking keyword mappings
        Then: It should contain expected keyword-to-skill mappings
        """
        router = HybridRouter()

        # Dev commands
        assert router._keyword_to_skill["commit"] == ("dev", "commit")
        assert router._keyword_to_skill["review"] == ("dev", "review")
        assert router._keyword_to_skill["refactor"] == ("dev", "refactor")
        assert router._keyword_to_skill["debug"] == ("dev", "debug")

        # Testing commands
        assert router._keyword_to_skill["test"] == ("testing", "run")
        assert router._keyword_to_skill["coverage"] == ("testing", "coverage")
        assert router._keyword_to_skill["benchmark"] == ("testing", "benchmark")

        # Learning commands
        assert router._keyword_to_skill["evaluate"] == ("learning", "evaluate")
        assert router._keyword_to_skill["patterns"] == ("learning", "patterns")


class TestHybridRouterSkillRouting:
    """Behavioral tests for skill-based routing (e.g., /dev, /testing)."""

    @pytest.mark.asyncio
    async def test_route_dev_skill_direct(self, mock_smart_router):
        """
        Given: User input "/dev"
        When: Routing the input
        Then: It should return dev skill invocation metadata
        """
        router = HybridRouter()
        result = await router.route("/dev")

        assert result["type"] == "skill"
        assert result["skill"] == "dev"
        assert result["args"] == ""
        assert "instruction" in result
        assert "Skill" in result["instruction"]

    @pytest.mark.asyncio
    async def test_route_testing_skill_direct(self, mock_smart_router):
        """
        Given: User input "/testing"
        When: Routing the input
        Then: It should return testing skill invocation metadata
        """
        router = HybridRouter()
        result = await router.route("/testing")

        assert result["type"] == "skill"
        assert result["skill"] == "testing"
        assert result["args"] == ""
        assert "instruction" in result

    @pytest.mark.asyncio
    async def test_route_workflows_skill_direct(self, mock_smart_router):
        """
        Given: User input "/workflows"
        When: Routing the input
        Then: It should return workflows skill invocation metadata
        """
        router = HybridRouter()
        result = await router.route("/workflows")

        assert result["type"] == "skill"
        assert result["skill"] == "workflows"
        assert result["args"] == ""
        assert "instruction" in result

    @pytest.mark.asyncio
    async def test_route_learning_skill_direct(self, mock_smart_router):
        """
        Given: User input "/learning"
        When: Routing the input
        Then: It should return learning skill invocation metadata
        """
        router = HybridRouter()
        result = await router.route("/learning")

        assert result["type"] == "skill"
        assert result["skill"] == "learning"
        assert result["args"] == ""
        assert "instruction" in result

    @pytest.mark.asyncio
    async def test_route_skill_with_args(self, mock_smart_router):
        """
        Given: User input "/dev commit --message 'fix bug'"
        When: Routing the input
        Then: It should return dev skill with arguments
        """
        router = HybridRouter()
        result = await router.route("/dev commit --message 'fix bug'")

        assert result["type"] == "skill"
        assert result["skill"] == "dev"
        assert result["args"] == "commit --message 'fix bug'"
        assert "instruction" in result


class TestHybridRouterKeywordRouting:
    """Behavioral tests for keyword-based routing (e.g., commit, test)."""

    @pytest.mark.asyncio
    async def test_route_commit_keyword(self, mock_smart_router):
        """
        Given: User input "commit"
        When: Routing the input
        Then: It should map to dev skill with commit args
        """
        router = HybridRouter()
        result = await router.route("commit")

        assert result["type"] == "skill"
        assert result["skill"] == "dev"
        assert result["args"] == "commit"
        assert "instruction" in result

    @pytest.mark.asyncio
    async def test_route_test_keyword(self, mock_smart_router):
        """
        Given: User input "test"
        When: Routing the input
        Then: It should map to testing skill with run args
        """
        router = HybridRouter()
        result = await router.route("test")

        assert result["type"] == "skill"
        assert result["skill"] == "testing"
        assert result["args"] == "run"
        assert "instruction" in result

    @pytest.mark.asyncio
    async def test_route_coverage_keyword(self, mock_smart_router):
        """
        Given: User input "coverage"
        When: Routing the input
        Then: It should map to testing skill with coverage args
        """
        router = HybridRouter()
        result = await router.route("coverage")

        assert result["type"] == "skill"
        assert result["skill"] == "testing"
        assert result["args"] == "coverage"
        assert "instruction" in result

    @pytest.mark.asyncio
    async def test_route_review_keyword(self, mock_smart_router):
        """
        Given: User input "review"
        When: Routing the input
        Then: It should map to dev skill with review args
        """
        router = HybridRouter()
        result = await router.route("review")

        assert result["type"] == "skill"
        assert result["skill"] == "dev"
        assert result["args"] == "review"
        assert "instruction" in result

    @pytest.mark.asyncio
    async def test_route_refactor_keyword(self, mock_smart_router):
        """
        Given: User input "refactor"
        When: Routing the input
        Then: It should map to dev skill with refactor args
        """
        router = HybridRouter()
        result = await router.route("refactor")

        assert result["type"] == "skill"
        assert result["skill"] == "dev"
        assert result["args"] == "refactor"
        assert "instruction" in result

    @pytest.mark.asyncio
    async def test_route_evaluate_keyword(self, mock_smart_router):
        """
        Given: User input "evaluate"
        When: Routing the input
        Then: It should map to learning skill with evaluate args
        """
        router = HybridRouter()
        result = await router.route("evaluate")

        assert result["type"] == "skill"
        assert result["skill"] == "learning"
        assert result["args"] == "evaluate"
        assert "instruction" in result


class TestHybridRouterNaturalLanguageRouting:
    """Behavioral tests for natural language routing."""

    @pytest.mark.asyncio
    async def test_route_natural_language_commit(self, mock_smart_router):
        """
        Given: Natural language input "I want to commit my changes"
        When: Routing the input
        Then: It should use SmartRouter to classify and route
        """
        router = HybridRouter()
        mock_smart_router.classify_and_route.return_value = {
            "type": "skill",
            "skill": "dev",
            "args": "commit",
            "reasoning": "User wants to commit changes",
        }

        result = await router.route("I want to commit my changes")

        assert result["type"] == "skill"
        assert result["skill"] == "dev"
        assert result["args"] == "commit"
        assert "reasoning" in result
        mock_smart_router.classify_and_route.assert_called_once()

    @pytest.mark.asyncio
    async def test_route_natural_language_test(self, mock_smart_router):
        """
        Given: Natural language input "run the test suite"
        When: Routing the input
        Then: It should use SmartRouter to classify and route
        """
        router = HybridRouter()
        mock_smart_router.classify_and_route.return_value = {
            "type": "skill",
            "skill": "testing",
            "args": "run",
            "reasoning": "User wants to run tests",
        }

        result = await router.route("run the test suite")

        assert result["type"] == "skill"
        assert result["skill"] == "testing"
        assert "reasoning" in result
        mock_smart_router.classify_and_route.assert_called_once()

    @pytest.mark.asyncio
    async def test_route_natural_language_complex_query(self, mock_smart_router):
        """
        Given: Complex natural language input
        When: Routing the input
        Then: It should delegate to SmartRouter
        """
        router = HybridRouter()
        complex_query = "Can you help me review the code and suggest improvements?"
        mock_smart_router.classify_and_route.return_value = {
            "type": "skill",
            "skill": "dev",
            "args": "review",
            "reasoning": "Code review request",
        }

        result = await router.route(complex_query)

        assert result["type"] == "skill"
        mock_smart_router.classify_and_route.assert_called_once_with(complex_query)


class TestHybridRouterPreferencesManagement:
    """Behavioral tests for preferences loading and saving."""

    @pytest.mark.asyncio
    async def test_load_preferences_file_exists(
        self, temp_preferences_path, sample_preferences, mock_smart_router
    ):
        """
        Given: Existing preferences file with data
        When: Loading preferences
        Then: It should load preferences into memory
        """
        temp_preferences_path.write_text(yaml.dump(sample_preferences))
        router = HybridRouter(preferences_path=str(temp_preferences_path))

        await router.load_preferences()

        assert "commit" in router.preferences
        assert router.preferences["commit"].keyword == "commit"
        assert router.preferences["commit"].skill == "dev"
        assert router.preferences["commit"].usage_count == 10
        assert router.preferences["commit"].confidence == 0.95

    @pytest.mark.asyncio
    async def test_load_preferences_file_not_exists(
        self, temp_preferences_path, mock_smart_router
    ):
        """
        Given: Non-existent preferences file
        When: Loading preferences
        Then: It should handle gracefully without error
        """
        router = HybridRouter(preferences_path=str(temp_preferences_path))

        await router.load_preferences()

        assert len(router.preferences) == 0

    @pytest.mark.asyncio
    async def test_load_preferences_malformed_yaml(
        self, temp_preferences_path, mock_smart_router
    ):
        """
        Given: Malformed YAML preferences file
        When: Loading preferences
        Then: It should handle error gracefully
        """
        temp_preferences_path.write_text("invalid: yaml: content: [")
        router = HybridRouter(preferences_path=str(temp_preferences_path))

        await router.load_preferences()

        assert len(router.preferences) == 0

    @pytest.mark.asyncio
    async def test_save_preferences(
        self, temp_preferences_path, mock_smart_router
    ):
        """
        Given: Router with preferences in memory
        When: Saving preferences
        Then: It should write preferences to file
        """
        router = HybridRouter(preferences_path=str(temp_preferences_path))
        router.preferences["commit"] = RoutingPreference(
            keyword="commit", skill="dev", args="commit", usage_count=5, confidence=0.9
        )

        await router.save_preferences()

        assert temp_preferences_path.exists()
        loaded_data = yaml.safe_load(temp_preferences_path.read_text())
        assert "