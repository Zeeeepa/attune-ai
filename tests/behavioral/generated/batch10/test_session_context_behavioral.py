"""Behavioral tests for session_context.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import json
import uuid
from datetime import datetime
from typing import Any
from unittest.mock import MagicMock, Mock, patch

import pytest

from empathy_os.meta_workflows.session_context import SessionContext


# Fixtures


@pytest.fixture
def mock_memory():
    """Create a mock UnifiedMemory instance."""
    memory = Mock()
    memory.user_id = "test_user@example.com"
    memory.store_short_term = Mock(return_value=True)
    memory.query_short_term = Mock(return_value=[])
    return memory


@pytest.fixture
def session_context(mock_memory):
    """Create a SessionContext instance with mock memory."""
    return SessionContext(memory=mock_memory, session_id="test-session-123")


@pytest.fixture
def session_context_no_memory():
    """Create a SessionContext instance without memory (graceful fallback)."""
    return SessionContext(memory=None, session_id="no-memory-session")


@pytest.fixture
def sample_form_schema():
    """Create a sample form schema for testing."""
    return {
        "template_id": "python_package_publish",
        "title": "Python Package Publish",
        "questions": [
            {
                "id": "has_tests",
                "type": "select",
                "label": "Has tests?",
                "options": ["Yes", "No"],
            },
            {
                "id": "package_name",
                "type": "text",
                "label": "Package name",
            },
        ],
    }


# Initialization Tests


class TestSessionContextInitialization:
    """Test SessionContext initialization behavior."""

    def test_given_memory_when_initialized_then_sets_attributes(self, mock_memory):
        """Given a valid memory instance, when SessionContext is initialized, then it sets all attributes correctly."""
        # Given
        session_id = "custom-session-id"
        default_ttl = 7200

        # When
        context = SessionContext(
            memory=mock_memory, session_id=session_id, default_ttl=default_ttl
        )

        # Then
        assert context.memory == mock_memory
        assert context.session_id == session_id
        assert context.user_id == "test_user@example.com"
        assert context.default_ttl == default_ttl

    def test_given_no_session_id_when_initialized_then_generates_uuid(
        self, mock_memory
    ):
        """Given no session_id, when SessionContext is initialized, then it generates a UUID."""
        # When
        context = SessionContext(memory=mock_memory)

        # Then
        assert context.session_id is not None
        assert len(context.session_id) == 36  # UUID format
        # Verify it's a valid UUID
        uuid.UUID(context.session_id)

    def test_given_no_memory_when_initialized_then_sets_anonymous_user(self):
        """Given no memory instance, when SessionContext is initialized, then it sets user_id to anonymous."""
        # When
        context = SessionContext(memory=None)

        # Then
        assert context.memory is None
        assert context.user_id == "anonymous"

    def test_given_default_params_when_initialized_then_uses_default_ttl(
        self, mock_memory
    ):
        """Given default parameters, when SessionContext is initialized, then it uses default TTL of 3600."""
        # When
        context = SessionContext(memory=mock_memory)

        # Then
        assert context.default_ttl == 3600

    @patch("empathy_os.meta_workflows.session_context.logger")
    def test_given_initialization_when_created_then_logs_info(
        self, mock_logger, mock_memory
    ):
        """Given SessionContext creation, when initialized, then it logs initialization info."""
        # When
        context = SessionContext(memory=mock_memory, session_id="test-123")

        # Then
        mock_logger.info.assert_called_once()
        log_message = mock_logger.info.call_args[0][0]
        assert "session_id=test-123" in log_message
        assert "user_id=test_user@example.com" in log_message
        assert "memory=enabled" in log_message

    @patch("empathy_os.meta_workflows.session_context.logger")
    def test_given_no_memory_when_created_then_logs_disabled(self, mock_logger):
        """Given no memory, when SessionContext is created, then it logs memory as disabled."""
        # When
        context = SessionContext(memory=None)

        # Then
        log_message = mock_logger.info.call_args[0][0]
        assert "memory=disabled" in log_message


# Record Choice Tests


class TestRecordChoice:
    """Test recording user choices in session context."""

    def test_given_valid_choice_when_recorded_then_stores_in_memory(
        self, session_context, mock_memory
    ):
        """Given a valid choice, when recorded, then it stores in short-term memory."""
        # Given
        template_id = "python_package_publish"
        question_id = "has_tests"
        choice = "Yes"

        # When
        result = session_context.record_choice(template_id, question_id, choice)

        # Then
        assert result is True
        mock_memory.store_short_term.assert_called_once()
        call_args = mock_memory.store_short_term.call_args
        assert call_args[1]["ttl"] == 3600

    def test_given_custom_ttl_when_recorded_then_uses_custom_ttl(
        self, session_context, mock_memory
    ):
        """Given a custom TTL, when choice is recorded, then it uses the custom TTL."""
        # Given
        custom_ttl = 7200

        # When
        session_context.record_choice(
            "template", "question", "answer", ttl=custom_ttl
        )

        # Then
        call_args = mock_memory.store_short_term.call_args
        assert call_args[1]["ttl"] == custom_ttl

    def test_given_no_memory_when_recorded_then_returns_false(
        self, session_context_no_memory
    ):
        """Given no memory instance, when choice is recorded, then it returns False gracefully."""
        # When
        result = session_context_no_memory.record_choice("template", "question", "Yes")

        # Then
        assert result is False

    @patch("empathy_os.meta_workflows.session_context.logger")
    def test_given_no_memory_when_recorded_then_logs_warning(
        self, mock_logger, session_context_no_memory
    ):
        """Given no memory, when choice is recorded, then it logs a warning."""
        # When
        session_context_no_memory.record_choice("template", "question", "answer")

        # Then
        mock_logger.warning.assert_called_once()
        log_message = mock_logger.warning.call_args[0][0]
        assert "No memory available" in log_message

    def test_given_memory_error_when_recorded_then_returns_false(
        self, session_context, mock_memory
    ):
        """Given memory store error, when choice is recorded, then it returns False."""
        # Given
        mock_memory.store_short_term.side_effect = Exception("Storage error")

        # When
        result = session_context.record_choice("template", "question", "answer")

        # Then
        assert result is False

    @patch("empathy_os.meta_workflows.session_context.logger")
    def test_given_memory_error_when_recorded_then_logs_error(
        self, mock_logger, session_context, mock_memory
    ):
        """Given memory store error, when choice is recorded, then it logs the error."""
        # Given
        mock_memory.store_short_term.side_effect = Exception("Storage error")

        # When
        session_context.record_choice("template", "question", "answer")

        # Then
        mock_logger.error.assert_called_once()
        log_message = mock_logger.error.call_args[0][0]
        assert "Error recording choice" in log_message

    def test_given_dict_choice_when_recorded_then_stores_correctly(
        self, session_context, mock_memory
    ):
        """Given a dict choice, when recorded, then it stores the dict correctly."""
        # Given
        choice_dict = {"key": "value", "nested": {"data": 123}}

        # When
        result = session_context.record_choice("template", "question", choice_dict)

        # Then
        assert result is True
        call_args = mock_memory.store_short_term.call_args
        stored_data = call_args[0][0]
        assert "choice" in stored_data
        assert stored_data["choice"] == choice_dict

    def test_given_list_choice_when_recorded_then_stores_correctly(
        self, session_context, mock_memory
    ):
        """Given a list choice, when recorded, then it stores the list correctly."""
        # Given
        choice_list = ["option1", "option2", "option3"]

        # When
        result = session_context.record_choice("template", "question", choice_list)

        # Then
        assert result is True
        call_args = mock_memory.store_short_term.call_args
        stored_data = call_args[0][0]
        assert stored_data["choice"] == choice_list

    def test_given_none_choice_when_recorded_then_stores_none(
        self, session_context, mock_memory
    ):
        """Given None as choice, when recorded, then it stores None."""
        # When
        result = session_context.record_choice("template", "question", None)

        # Then
        assert result is True
        call_args = mock_memory.store_short_term.call_args
        stored_data = call_args[0][0]
        assert stored_data["choice"] is None

    def test_given_numeric_choice_when_recorded_then_stores_number(
        self, session_context, mock_memory
    ):
        """Given a numeric choice, when recorded, then it stores the number."""
        # When
        result = session_context.record_choice("template", "question", 42)

        # Then
        assert result is True
        call_args = mock_memory.store_short_term.call_args
        stored_data = call_args[0][0]
        assert stored_data["choice"] == 42

    def test_given_boolean_choice_when_recorded_then_stores_boolean(
        self, session_context, mock_memory
    ):
        """Given a boolean choice, when recorded, then it stores the boolean."""
        # When
        result = session_context.record_choice("template", "question", True)

        # Then
        assert result is True
        call_args = mock_memory.store_short_term.call_args
        stored_data = call_args[0][0]
        assert stored_data["choice"] is True

    def test_given_recorded_choice_when_stored_then_includes_metadata(
        self, session_context, mock_memory
    ):
        """Given a recorded choice, when stored, then it includes session and template metadata."""
        # Given
        template_id = "my_template"
        question_id = "my_question"

        # When
        session_context.record_choice(template_id, question_id, "answer")

        # Then
        call_args = mock_memory.store_short_term.call_args
        stored_data = call_args[0][0]
        assert stored_data["session_id"] == "test-session-123"
        assert stored_data["template_id"] == template_id
        assert stored_data["question_id"] == question_id
        assert "timestamp" in stored_data

    @patch("empathy_os.meta_workflows.session_context.logger")
    def test_given_successful_record_when_stored_then_logs_debug(
        self, mock_logger, session_context, mock_memory
    ):
        """Given successful record, when choice is stored, then it logs debug message."""
        # When
        session_context.record_choice("template", "question", "answer")

        # Then
        mock_logger.debug.assert_called()
        log_message = mock_logger.debug.call_args[0][0]
        assert "Recorded choice" in log_message


# Suggest Defaults Tests


class TestSuggestDefaults:
    """Test suggesting default values based on session history."""

    def test_given_recent_choices_when_suggested_then_returns_defaults(
        self, session_context, mock_memory
    ):
        """Given recent choices, when defaults are suggested, then it returns the most recent choices."""
        # Given
        mock_memory.query_short_term.return_value = [
            {
                "question_id": "has_tests",
                "choice": "Yes",
                "timestamp": "2024-01-15T10:00:00",
            },
            {
                "question_id": "package_name",
                "choice": "my_package",
                "timestamp": "2024-01-15T10:01:00",
            },
        ]

        # When
        defaults = session_context.suggest_defaults("python_package_publish")

        # Then
        assert defaults == {"has_tests": "Yes", "package_name": "my_package"}

    def test_given_no_history_when_suggested_then_returns_empty_dict(
        self, session_context, mock_memory
    ):
        """Given no history, when defaults are suggested, then it returns empty dict."""
        # Given
        mock_memory.query_short_term.return_value = []

        # When
        defaults = session_context.suggest_defaults("new_template")

        # Then
        assert defaults == {}

    def test_given_no_memory_when_suggested_then_returns_empty_dict(
        self, session_context_no_memory
    ):
        """Given no memory, when defaults are suggested, then it returns empty dict gracefully."""
        # When
        defaults = session_context_no_memory.suggest_defaults("template")

        # Then
        assert defaults == {}

    @patch("empathy_os.meta_workflows.session_context.logger")
    def test_given_no_memory_when_suggested_then_logs_warning(
        self, mock_logger, session_context_no_memory
    ):
        """Given no memory, when defaults are suggested, then it logs a warning."""
        # When
        session_context_no_memory.suggest_defaults("template")

        # Then
        mock_logger.warning.assert_called_once()
        log_message = mock_logger.warning.call_args[0][0]
        assert "No memory available" in log_message

    def test_given_memory_error_when_suggested_then_returns_empty_dict(
        self, session_context, mock_memory
    ):
        """Given memory query error, when defaults are suggested, then it returns empty dict."""
        # Given
        mock_memory.query_short_term.side_effect = Exception("Query error")

        # When
        defaults = session_context.suggest_defaults("template")

        # Then
        assert defaults == {}

    @patch("empathy_os.meta_workflows.session_context.logger")
    def test_given_memory_error_when_suggested_then_logs_error(
        self, mock_logger, session_context, mock_memory
    ):
        """Given memory query error, when defaults are suggested, then it logs the error."""
        # Given
        mock_memory.query_short_term.side_effect = Exception("Query error")

        # When
        session_context.suggest_defaults("template")

        # Then
        mock_logger.