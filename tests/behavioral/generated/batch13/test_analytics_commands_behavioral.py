"""Behavioral tests for analytics_commands.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

from datetime import datetime, timedelta
from pathlib import Path
from unittest.mock import MagicMock, Mock, patch, call

import pytest
import typer
from typer.testing import CliRunner

from empathy_os.meta_workflows.cli_commands.analytics_commands import show_analytics


@pytest.fixture
def cli_runner():
    """Provide a Typer CLI runner for testing commands."""
    return CliRunner()


@pytest.fixture
def mock_console():
    """Provide a mocked Rich console."""
    with patch("empathy_os.meta_workflows.cli_commands.analytics_commands.console") as mock:
        yield mock


@pytest.fixture
def mock_pattern_learner():
    """Provide a mocked PatternLearner instance."""
    with patch("empathy_os.meta_workflows.cli_commands.analytics_commands.PatternLearner") as mock_class:
        mock_instance = MagicMock()
        mock_class.return_value = mock_instance
        yield mock_instance


@pytest.fixture
def sample_analytics_report():
    """Provide a sample analytics report structure."""
    return {
        "summary": {
            "total_runs": 100,
            "successful_runs": 85,
            "success_rate": 0.85,
            "total_cost": 125.50,
            "avg_cost_per_run": 1.255,
            "total_agents_created": 250,
            "avg_agents_per_run": 2.5,
        },
        "recommendations": [
            "Consider using tier-1 for simple tasks",
            "Optimize agent creation for better cost efficiency",
        ],
        "insights": {
            "pattern_1": "High success rate on tier-1",
            "pattern_2": "Cost spikes on tier-4",
        },
    }


@pytest.fixture
def sample_analytics_report_empty():
    """Provide an empty analytics report structure."""
    return {
        "summary": {
            "total_runs": 0,
            "successful_runs": 0,
            "success_rate": 0.0,
            "total_cost": 0.0,
            "avg_cost_per_run": 0.0,
            "total_agents_created": 0,
            "avg_agents_per_run": 0.0,
        },
        "recommendations": [],
        "insights": {},
    }


class TestShowAnalyticsBasicFunctionality:
    """Test basic functionality of show_analytics command."""

    def test_given_no_template_id_when_show_analytics_called_then_displays_all_analytics(
        self, mock_console, mock_pattern_learner, sample_analytics_report
    ):
        """
        Given: No template ID is specified
        When: show_analytics is called
        Then: Analytics for all templates are displayed
        """
        # Given
        mock_pattern_learner.generate_analytics_report.return_value = sample_analytics_report

        # When
        show_analytics(template_id=None)

        # Then
        mock_pattern_learner.generate_analytics_report.assert_called_once_with(template_id=None)
        assert mock_console.print.call_count > 0
        # Verify summary is displayed
        calls = [str(call) for call in mock_console.print.call_args_list]
        assert any("Meta-Workflow Analytics Report" in str(call) for call in calls)

    def test_given_template_id_when_show_analytics_called_then_displays_template_specific_analytics(
        self, mock_console, mock_pattern_learner, sample_analytics_report
    ):
        """
        Given: A specific template ID is provided
        When: show_analytics is called
        Then: Analytics for that template are displayed
        """
        # Given
        template_id = "test_template_123"
        mock_pattern_learner.generate_analytics_report.return_value = sample_analytics_report

        # When
        show_analytics(template_id=template_id)

        # Then
        mock_pattern_learner.generate_analytics_report.assert_called_once_with(template_id=template_id)
        calls = [str(call) for call in mock_console.print.call_args_list]
        assert any("test_template_123" in str(call) for call in calls)

    def test_given_min_confidence_when_show_analytics_called_then_parameter_accepted(
        self, mock_console, mock_pattern_learner, sample_analytics_report
    ):
        """
        Given: A minimum confidence threshold is provided
        When: show_analytics is called
        Then: The command executes successfully
        """
        # Given
        mock_pattern_learner.generate_analytics_report.return_value = sample_analytics_report

        # When
        show_analytics(template_id=None, min_confidence=0.7)

        # Then
        mock_pattern_learner.generate_analytics_report.assert_called_once()
        assert mock_console.print.call_count > 0


class TestShowAnalyticsMemoryIntegration:
    """Test memory-enhanced analytics functionality."""

    def test_given_use_memory_flag_when_show_analytics_called_then_initializes_unified_memory(
        self, mock_console, mock_pattern_learner, sample_analytics_report
    ):
        """
        Given: use_memory flag is set to True
        When: show_analytics is called
        Then: UnifiedMemory is initialized and used
        """
        # Given
        mock_pattern_learner.generate_analytics_report.return_value = sample_analytics_report

        with patch(
            "empathy_os.meta_workflows.cli_commands.analytics_commands.UnifiedMemory"
        ) as mock_unified_memory:
            mock_memory_instance = MagicMock()
            mock_unified_memory.return_value = mock_memory_instance

            with patch(
                "empathy_os.meta_workflows.cli_commands.analytics_commands.PatternLearner"
            ) as mock_pl_class:
                mock_pl_instance = MagicMock()
                mock_pl_class.return_value = mock_pl_instance
                mock_pl_instance.generate_analytics_report.return_value = sample_analytics_report

                # When
                show_analytics(template_id=None, use_memory=True)

                # Then
                mock_unified_memory.assert_called_once_with(user_id="cli_analytics")
                # Verify PatternLearner was called twice: once without memory, once with
                assert mock_pl_class.call_count == 2
                calls = [str(call) for call in mock_console.print.call_args_list]
                assert any("memory-enhanced analytics" in str(call) for call in calls)

    def test_given_use_memory_false_when_show_analytics_called_then_no_memory_initialization(
        self, mock_console, mock_pattern_learner, sample_analytics_report
    ):
        """
        Given: use_memory flag is set to False
        When: show_analytics is called
        Then: UnifiedMemory is not initialized
        """
        # Given
        mock_pattern_learner.generate_analytics_report.return_value = sample_analytics_report

        with patch(
            "empathy_os.meta_workflows.cli_commands.analytics_commands.UnifiedMemory"
        ) as mock_unified_memory:
            # When
            show_analytics(template_id=None, use_memory=False)

            # Then
            mock_unified_memory.assert_not_called()
            calls = [str(call) for call in mock_console.print.call_args_list]
            assert not any("memory-enhanced analytics" in str(call) for call in calls)


class TestShowAnalyticsReportDisplay:
    """Test report display formatting and content."""

    def test_given_report_with_recommendations_when_displayed_then_shows_recommendations(
        self, mock_console, mock_pattern_learner, sample_analytics_report
    ):
        """
        Given: Analytics report contains recommendations
        When: Report is displayed
        Then: Recommendations section is shown
        """
        # Given
        mock_pattern_learner.generate_analytics_report.return_value = sample_analytics_report

        # When
        show_analytics(template_id=None)

        # Then
        calls = [str(call) for call in mock_console.print.call_args_list]
        assert any("Recommendations" in str(call) for call in calls)
        assert any("tier-1" in str(call) for call in calls)

    def test_given_report_without_recommendations_when_displayed_then_no_recommendations_section(
        self, mock_console, mock_pattern_learner, sample_analytics_report_empty
    ):
        """
        Given: Analytics report has no recommendations
        When: Report is displayed
        Then: Recommendations section is not shown
        """
        # Given
        mock_pattern_learner.generate_analytics_report.return_value = sample_analytics_report_empty

        # When
        show_analytics(template_id=None)

        # Then
        calls = [str(call) for call in mock_console.print.call_args_list]
        # Recommendations header should not be present
        recommendation_calls = [call for call in calls if "Recommendations" in str(call)]
        assert len(recommendation_calls) == 0

    def test_given_valid_report_when_displayed_then_shows_all_summary_metrics(
        self, mock_console, mock_pattern_learner, sample_analytics_report
    ):
        """
        Given: A valid analytics report
        When: Report is displayed
        Then: All summary metrics are shown
        """
        # Given
        mock_pattern_learner.generate_analytics_report.return_value = sample_analytics_report

        # When
        show_analytics(template_id=None)

        # Then
        all_calls = "\n".join([str(call) for call in mock_console.print.call_args_list])
        # Verify key metrics are present in some form
        assert mock_console.print.call_count > 5  # Multiple print calls for report


class TestShowAnalyticsErrorHandling:
    """Test error handling scenarios."""

    def test_given_pattern_learner_error_when_show_analytics_called_then_raises_exception(
        self, mock_console, mock_pattern_learner
    ):
        """
        Given: PatternLearner raises an exception
        When: show_analytics is called
        Then: Exception is propagated
        """
        # Given
        mock_pattern_learner.generate_analytics_report.side_effect = Exception("Pattern learner error")

        # When/Then
        with pytest.raises(Exception) as exc_info:
            show_analytics(template_id=None)

        assert "Pattern learner error" in str(exc_info.value)

    def test_given_memory_initialization_error_when_use_memory_true_then_raises_exception(
        self, mock_console, mock_pattern_learner
    ):
        """
        Given: UnifiedMemory initialization fails
        When: show_analytics is called with use_memory=True
        Then: Exception is raised
        """
        # Given
        with patch(
            "empathy_os.meta_workflows.cli_commands.analytics_commands.UnifiedMemory"
        ) as mock_unified_memory:
            mock_unified_memory.side_effect = ImportError("Memory module not found")

            # When/Then
            with pytest.raises(ImportError) as exc_info:
                show_analytics(template_id=None, use_memory=True)

            assert "Memory module not found" in str(exc_info.value)

    def test_given_invalid_report_structure_when_displayed_then_handles_gracefully(
        self, mock_console, mock_pattern_learner
    ):
        """
        Given: Analytics report has missing or invalid structure
        When: Report is displayed
        Then: Error is handled gracefully
        """
        # Given
        invalid_report = {"summary": {}}  # Missing required fields
        mock_pattern_learner.generate_analytics_report.return_value = invalid_report

        # When/Then
        with pytest.raises(KeyError):
            show_analytics(template_id=None)


class TestShowAnalyticsEdgeCases:
    """Test edge cases and boundary conditions."""

    def test_given_zero_runs_when_show_analytics_called_then_displays_empty_report(
        self, mock_console, mock_pattern_learner, sample_analytics_report_empty
    ):
        """
        Given: Analytics report shows zero runs
        When: Report is displayed
        Then: Empty report is displayed correctly
        """
        # Given
        mock_pattern_learner.generate_analytics_report.return_value = sample_analytics_report_empty

        # When
        show_analytics(template_id=None)

        # Then
        assert mock_console.print.call_count > 0
        mock_pattern_learner.generate_analytics_report.assert_called_once()

    def test_given_very_high_confidence_when_show_analytics_called_then_accepts_parameter(
        self, mock_console, mock_pattern_learner, sample_analytics_report
    ):
        """
        Given: Minimum confidence is set to 1.0
        When: show_analytics is called
        Then: Command executes successfully
        """
        # Given
        mock_pattern_learner.generate_analytics_report.return_value = sample_analytics_report

        # When
        show_analytics(template_id=None, min_confidence=1.0)

        # Then
        mock_pattern_learner.generate_analytics_report.assert_called_once()

    def test_given_zero_confidence_when_show_analytics_called_then_accepts_parameter(
        self, mock_console, mock_pattern_learner, sample_analytics_report
    ):
        """
        Given: Minimum confidence is set to 0.0
        When: show_analytics is called
        Then: Command executes successfully
        """
        # Given
        mock_pattern_learner.generate_analytics_report.return_value = sample_analytics_report

        # When
        show_analytics(template_id=None, min_confidence=0.0)

        # Then
        mock_pattern_learner.generate_analytics_report.assert_called_once()

    def test_given_very_long_template_id_when_show_analytics_called_then_handles_correctly(
        self, mock_console, mock_pattern_learner, sample_analytics_report
    ):
        """
        Given: Template ID is very long
        When: show_analytics is called
        Then: Command handles the long ID correctly
        """
        # Given
        long_template_id = "template_" + "x" * 1000
        mock_pattern_learner.generate_analytics_report.return_value = sample_analytics_report

        # When
        show_analytics(template_id=long_template_id)

        # Then
        mock_pattern_learner.generate_analytics_report.assert_called_once_with(
            template_id=long_template_id
        )

    def test_given_special_characters_in_template_id_when_show_analytics_called_then_handles_correctly(
        self, mock_console, mock_pattern_learner, sample_analytics_report
    ):
        """
        Given: Template ID contains special characters
        When: show_analytics is called
        Then: Command handles special characters correctly
        """
        # Given
        special_template_id = "template@#$%^&*()_+-={}[]|:;<>?,./~`"
        mock_pattern_learner.generate_analytics_report.return_value = sample_analytics_report

        # When
        show_analytics(template_id=special_template_id)

        # Then
        mock_pattern_learner.generate_analytics_report.assert_called_once_with(
            template_id=special_template_id
        )


class TestShowAnalyticsReportContent:
    """Test specific report content and formatting."""

    def test_given_high_success_rate_when_displayed_then_shows_percentage_correctly(
        self, mock_console, mock_pattern_learner
    ):
        """
        Given: Report has high success rate
        When: Report is displayed
        Then: Success rate is formatted as percentage
        """
        # Given
        report = {
            "summary": {
                "total_runs": 100,
                "successful_runs": 95,
                "success_rate": 0.95,
                "total_cost": 100.0,
                "avg_cost_per_run": 1.0,
                "total_agents_created": 200,
                "avg_agents_per_run": 2.0,
            },
            "recommendations": [],
        }
        mock_pattern_learner.generate_analytics_report.return_value = report

        # When
        show_analytics(template_id=None)

        # Then
        assert mock_console.print.call_count > 0

    def test_given_cost_metrics_when_displayed_then_shows_currency_format(
        self, mock_console, mock_pattern_learner
    ):
        """
        Given: Report contains cost metrics
        When: Report is displayed
        Then: Costs are formatted as currency
        """
        # Given
        report = {
            "summary": {
                "total_runs": 50,
                "successful_runs": 40,
                "success_rate": 0.8,
                "total_cost": 1234.567,
                "avg_cost_per_run": 24.691,
                "total_agents_created": 100,
                "avg_agents_per_run": 2.0,
            },
            "recommendations": [],
        }
        mock_pattern_learner.generate_analytics_report.return_value = report

        # When
        show_analytics(template_id=None)

        # Then
        assert mock_console.print.call_count > 0

    def test_given_agent_metrics_when_displayed_then_shows_counts_correctly(
        self, mock_console, mock_pattern_learner
    ):
        """
        Given: Report contains agent creation metrics
        When: Report is displayed
        Then: Agent counts are displayed correctly
        """
        # Given
        report = {
            "summary": {
                "total_runs": 25,
                "successful_runs": 20,
                "success_rate": 0.8,
                "total_cost": 50.0,
                "avg_cost_per_run": 2.0,
                "total_agents_created": 150,
                "avg_agents_per_run": 6.0,
            },
            "recommendations": [],
        }
        mock_pattern_learner.generate_analytics_report.return_value = report

        # When
        show_analytics(template_id=None)

        # Then
        assert mock_console.print.call_count > 0


class TestShowAnalyticsIntegration:
    """Test integration scenarios."""

    def test_given_all_parameters_when_show_analytics_called_then_works_correctly(
        self, mock_console, mock_pattern_learner, sample_analytics_report
    ):
        """
        Given: All optional parameters are provided
        When: show_analytics is called
        Then: Command executes successfully with all parameters
        """
        # Given
        mock_pattern_learner.generate_analytics_report.return_value = sample_analytics_report

        with patch(
            "empathy_os.meta_workflows.cli_commands.analytics_commands.UnifiedMemory"
        ) as mock_unified_memory:
            mock_memory_instance = MagicMock()
            mock_unified_memory.return_value = mock_memory_instance

            with patch(
                "empathy_os.meta_workflows.cli_commands.analytics_commands.PatternLearner"
            ) as mock_pl_class:
                mock_pl_instance = MagicMock()
                mock_pl_class.return_value = mock_pl_instance
                mock_pl_instance.generate_analytics_report.return_value = sample_analytics_report

                # When
                show_analytics(
                    template_id="test_template",
                    min_confidence=0.75,
                    use_memory=True,
                )

                # Then
                assert mock_pl_instance.generate_analytics_report.call_count > 0
                assert mock_console.print.call_count > 0

    def test_given_pattern_learner_initialization_when_show_analytics_called_then_creates_instance(
        self, mock_console, sample_analytics_report
    ):
        """
        Given: PatternLearner needs to be initialized
        When: show_analytics is called
        Then: PatternLearner instance is created
        """
        # Given
        with patch(
            "empathy_os.meta_workflows.cli_commands.analytics_commands.PatternLearner"
        ) as mock_pl_class:
            mock_pl_instance = MagicMock()
            mock_pl_class.return_value = mock_pl_instance
            mock_pl_instance.generate_analytics_report.return_value = sample_analytics_report

            # When
            show_analytics(template_id=None)

            # Then
            assert mock_pl_class.call_count == 1
            mock_pl_instance.generate_analytics_report.assert_called_once()