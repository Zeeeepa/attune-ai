"""Behavioral tests for config_commands.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

import pytest
from unittest.mock import Mock, MagicMock, patch, call
from typer.testing import CliRunner
from rich.console import Console
from rich.table import Table

from empathy_os.meta_workflows.cli_commands.config_commands import (
    suggest_defaults_cmd,
    console,
)


@pytest.fixture
def cli_runner():
    """Provide a Typer CLI test runner."""
    return CliRunner()


@pytest.fixture
def mock_console():
    """Provide a mocked Rich console."""
    with patch('empathy_os.meta_workflows.cli_commands.config_commands.console') as mock:
        yield mock


@pytest.fixture
def mock_unified_memory():
    """Provide a mocked UnifiedMemory instance."""
    mock = Mock()
    mock.user_id = "test_user"
    return mock


@pytest.fixture
def mock_session_context():
    """Provide a mocked SessionContext instance."""
    mock = Mock()
    mock.session_id = "test_session"
    mock.suggest_defaults = Mock(return_value={})
    return mock


@pytest.fixture
def mock_template():
    """Provide a mocked template with form schema."""
    mock = Mock()
    mock.name = "Test Template"
    mock.form_schema = Mock()
    
    # Create mock questions
    question1 = Mock()
    question1.id = "question_1"
    question1.text = "What is your name?"
    
    question2 = Mock()
    question2.id = "question_2"
    question2.text = "Select your options"
    
    mock.form_schema.questions = [question1, question2]
    return mock


@pytest.fixture
def mock_template_registry(mock_template):
    """Provide a mocked TemplateRegistry."""
    mock = Mock()
    mock.load_template = Mock(return_value=mock_template)
    return mock


class TestSuggestDefaultsCommand:
    """Test suite for suggest_defaults_cmd function."""

    def test_given_valid_template_when_no_history_then_shows_no_suggestions(
        self, cli_runner, mock_console, mock_unified_memory, mock_session_context, 
        mock_template_registry, mock_template
    ):
        """
        GIVEN a valid template ID with no history
        WHEN suggest_defaults_cmd is called
        THEN it should display a message indicating no suggestions are available
        """
        # GIVEN
        with patch('empathy_os.meta_workflows.cli_commands.config_commands.UnifiedMemory', 
                   return_value=mock_unified_memory), \
             patch('empathy_os.meta_workflows.cli_commands.config_commands.SessionContext', 
                   return_value=mock_session_context), \
             patch('empathy_os.meta_workflows.cli_commands.config_commands.TemplateRegistry', 
                   return_value=mock_template_registry):
            
            mock_session_context.suggest_defaults.return_value = {}
            
            # WHEN
            suggest_defaults_cmd(
                template_id="test_template",
                session_id=None,
                user_id="test_user"
            )
            
            # THEN
            assert mock_template_registry.load_template.called
            assert mock_session_context.suggest_defaults.called
            assert any(
                "No suggestions available" in str(call_args) 
                for call_args in mock_console.print.call_args_list
            )

    def test_given_valid_template_when_suggestions_exist_then_displays_table(
        self, cli_runner, mock_console, mock_unified_memory, mock_session_context,
        mock_template_registry, mock_template
    ):
        """
        GIVEN a valid template ID with existing suggestions
        WHEN suggest_defaults_cmd is called
        THEN it should display suggestions in a formatted table
        """
        # GIVEN
        suggestions = {
            "question_1": "John Doe",
            "question_2": ["option1", "option2"]
        }
        
        with patch('empathy_os.meta_workflows.cli_commands.config_commands.UnifiedMemory', 
                   return_value=mock_unified_memory), \
             patch('empathy_os.meta_workflows.cli_commands.config_commands.SessionContext', 
                   return_value=mock_session_context), \
             patch('empathy_os.meta_workflows.cli_commands.config_commands.TemplateRegistry', 
                   return_value=mock_template_registry):
            
            mock_session_context.suggest_defaults.return_value = suggestions
            
            # WHEN
            suggest_defaults_cmd(
                template_id="test_template",
                session_id="test_session",
                user_id="test_user"
            )
            
            # THEN
            mock_template_registry.load_template.assert_called_once_with("test_template")
            mock_session_context.suggest_defaults.assert_called_once_with(
                template_id="test_template",
                form_schema=mock_template.form_schema
            )
            
            # Verify console print calls
            print_calls = [str(call_args) for call_args in mock_console.print.call_args_list]
            assert any("Suggested Defaults for:" in call for call in print_calls)
            assert any("Found 2 suggested default(s)" in call for call in print_calls)

    def test_given_invalid_template_when_loading_fails_then_exits_with_error(
        self, cli_runner, mock_console, mock_unified_memory, mock_session_context,
        mock_template_registry
    ):
        """
        GIVEN an invalid template ID
        WHEN suggest_defaults_cmd is called
        THEN it should display an error message and exit with code 1
        """
        # GIVEN
        with patch('empathy_os.meta_workflows.cli_commands.config_commands.UnifiedMemory', 
                   return_value=mock_unified_memory), \
             patch('empathy_os.meta_workflows.cli_commands.config_commands.SessionContext', 
                   return_value=mock_session_context), \
             patch('empathy_os.meta_workflows.cli_commands.config_commands.TemplateRegistry', 
                   return_value=mock_template_registry):
            
            mock_template_registry.load_template.return_value = None
            
            # WHEN/THEN
            with pytest.raises(SystemExit) as exc_info:
                suggest_defaults_cmd(
                    template_id="invalid_template",
                    session_id=None,
                    user_id="test_user"
                )
            
            assert exc_info.value.code == 1
            print_calls = [str(call_args) for call_args in mock_console.print.call_args_list]
            assert any("Error" in call and "Template not found" in call for call in print_calls)

    def test_given_session_id_when_provided_then_uses_specific_session(
        self, cli_runner, mock_console, mock_unified_memory, mock_session_context,
        mock_template_registry, mock_template
    ):
        """
        GIVEN a specific session ID
        WHEN suggest_defaults_cmd is called
        THEN it should initialize SessionContext with that session ID
        """
        # GIVEN
        session_id = "custom_session_123"
        
        with patch('empathy_os.meta_workflows.cli_commands.config_commands.UnifiedMemory', 
                   return_value=mock_unified_memory) as mock_memory_cls, \
             patch('empathy_os.meta_workflows.cli_commands.config_commands.SessionContext', 
                   return_value=mock_session_context) as mock_session_cls, \
             patch('empathy_os.meta_workflows.cli_commands.config_commands.TemplateRegistry', 
                   return_value=mock_template_registry):
            
            mock_session_context.suggest_defaults.return_value = {}
            
            # WHEN
            suggest_defaults_cmd(
                template_id="test_template",
                session_id=session_id,
                user_id="test_user"
            )
            
            # THEN
            mock_session_cls.assert_called_once_with(
                memory=mock_unified_memory,
                session_id=session_id
            )

    def test_given_custom_user_id_when_provided_then_uses_custom_user(
        self, cli_runner, mock_console, mock_unified_memory, mock_session_context,
        mock_template_registry, mock_template
    ):
        """
        GIVEN a custom user ID
        WHEN suggest_defaults_cmd is called
        THEN it should initialize UnifiedMemory with that user ID
        """
        # GIVEN
        user_id = "custom_user_456"
        
        with patch('empathy_os.meta_workflows.cli_commands.config_commands.UnifiedMemory', 
                   return_value=mock_unified_memory) as mock_memory_cls, \
             patch('empathy_os.meta_workflows.cli_commands.config_commands.SessionContext', 
                   return_value=mock_session_context), \
             patch('empathy_os.meta_workflows.cli_commands.config_commands.TemplateRegistry', 
                   return_value=mock_template_registry):
            
            mock_session_context.suggest_defaults.return_value = {}
            
            # WHEN
            suggest_defaults_cmd(
                template_id="test_template",
                session_id=None,
                user_id=user_id
            )
            
            # THEN
            mock_memory_cls.assert_called_once_with(user_id=user_id)

    def test_given_list_value_when_displaying_then_formats_as_comma_separated(
        self, cli_runner, mock_console, mock_unified_memory, mock_session_context,
        mock_template_registry, mock_template
    ):
        """
        GIVEN suggestions containing list values
        WHEN displaying the results
        THEN list values should be formatted as comma-separated strings
        """
        # GIVEN
        suggestions = {
            "question_2": ["option1", "option2", "option3"]
        }
        
        with patch('empathy_os.meta_workflows.cli_commands.config_commands.UnifiedMemory', 
                   return_value=mock_unified_memory), \
             patch('empathy_os.meta_workflows.cli_commands.config_commands.SessionContext', 
                   return_value=mock_session_context), \
             patch('empathy_os.meta_workflows.cli_commands.config_commands.TemplateRegistry', 
                   return_value=mock_template_registry):
            
            mock_session_context.suggest_defaults.return_value = suggestions
            
            # WHEN
            suggest_defaults_cmd(
                template_id="test_template",
                session_id=None,
                user_id="test_user"
            )
            
            # THEN
            # Verify table creation (list should be comma-separated)
            assert mock_console.print.called

    def test_given_question_without_match_when_displaying_then_uses_question_id(
        self, cli_runner, mock_console, mock_unified_memory, mock_session_context,
        mock_template_registry, mock_template
    ):
        """
        GIVEN suggestions for a question ID not in the schema
        WHEN displaying the results
        THEN it should use the question ID as fallback text
        """
        # GIVEN
        suggestions = {
            "unknown_question": "some value"
        }
        
        with patch('empathy_os.meta_workflows.cli_commands.config_commands.UnifiedMemory', 
                   return_value=mock_unified_memory), \
             patch('empathy_os.meta_workflows.cli_commands.config_commands.SessionContext', 
                   return_value=mock_session_context), \
             patch('empathy_os.meta_workflows.cli_commands.config_commands.TemplateRegistry', 
                   return_value=mock_template_registry):
            
            mock_session_context.suggest_defaults.return_value = suggestions
            
            # WHEN
            suggest_defaults_cmd(
                template_id="test_template",
                session_id=None,
                user_id="test_user"
            )
            
            # THEN
            assert mock_console.print.called

    def test_given_template_name_when_displaying_then_shows_template_info(
        self, cli_runner, mock_console, mock_unified_memory, mock_session_context,
        mock_template_registry, mock_template
    ):
        """
        GIVEN a template with a name
        WHEN suggest_defaults_cmd displays results
        THEN it should show the template name and ID
        """
        # GIVEN
        mock_template.name = "My Awesome Template"
        
        with patch('empathy_os.meta_workflows.cli_commands.config_commands.UnifiedMemory', 
                   return_value=mock_unified_memory), \
             patch('empathy_os.meta_workflows.cli_commands.config_commands.SessionContext', 
                   return_value=mock_session_context), \
             patch('empathy_os.meta_workflows.cli_commands.config_commands.TemplateRegistry', 
                   return_value=mock_template_registry):
            
            mock_session_context.suggest_defaults.return_value = {}
            
            # WHEN
            suggest_defaults_cmd(
                template_id="test_template",
                session_id=None,
                user_id="test_user"
            )
            
            # THEN
            print_calls = [str(call_args) for call_args in mock_console.print.call_args_list]
            assert any("My Awesome Template" in call for call in print_calls)
            assert any("Template ID: test_template" in call for call in print_calls)

    def test_given_multiple_suggestions_when_displaying_then_shows_count(
        self, cli_runner, mock_console, mock_unified_memory, mock_session_context,
        mock_template_registry, mock_template
    ):
        """
        GIVEN multiple suggestions
        WHEN displaying the results
        THEN it should show the correct count of suggestions
        """
        # GIVEN
        suggestions = {
            "question_1": "value1",
            "question_2": "value2",
            "question_3": "value3"
        }
        
        with patch('empathy_os.meta_workflows.cli_commands.config_commands.UnifiedMemory', 
                   return_value=mock_unified_memory), \
             patch('empathy_os.meta_workflows.cli_commands.config_commands.SessionContext', 
                   return_value=mock_session_context), \
             patch('empathy_os.meta_workflows.cli_commands.config_commands.TemplateRegistry', 
                   return_value=mock_template_registry):
            
            mock_session_context.suggest_defaults.return_value = suggestions
            
            # WHEN
            suggest_defaults_cmd(
                template_id="test_template",
                session_id=None,
                user_id="test_user"
            )
            
            # THEN
            print_calls = [str(call_args) for call_args in mock_console.print.call_args_list]
            assert any("Found 3 suggested default(s)" in call for call in print_calls)

    def test_given_exception_during_execution_when_called_then_propagates_error(
        self, cli_runner, mock_console, mock_unified_memory, mock_session_context,
        mock_template_registry
    ):
        """
        GIVEN an unexpected exception during execution
        WHEN suggest_defaults_cmd is called
        THEN the exception should propagate
        """
        # GIVEN
        with patch('empathy_os.meta_workflows.cli_commands.config_commands.UnifiedMemory', 
                   side_effect=Exception("Unexpected error")):
            
            # WHEN/THEN
            with pytest.raises(Exception) as exc_info:
                suggest_defaults_cmd(
                    template_id="test_template",
                    session_id=None,
                    user_id="test_user"
                )
            
            assert "Unexpected error" in str(exc_info.value)

    def test_given_empty_suggestions_dict_when_displaying_then_shows_no_suggestions(
        self, cli_runner, mock_console, mock_unified_memory, mock_session_context,
        mock_template_registry, mock_template
    ):
        """
        GIVEN an empty suggestions dictionary
        WHEN displaying the results
        THEN it should show the no suggestions message
        """
        # GIVEN
        with patch('empathy_os.meta_workflows.cli_commands.config_commands.UnifiedMemory', 
                   return_value=mock_unified_memory), \
             patch('empathy_os.meta_workflows.cli_commands.config_commands.SessionContext', 
                   return_value=mock_session_context), \
             patch('empathy_os.meta_workflows.cli_commands.config_commands.TemplateRegistry', 
                   return_value=mock_template_registry):
            
            mock_session_context.suggest_defaults.return_value = {}
            
            # WHEN
            suggest_defaults_cmd(
                template_id="test_template",
                session_id=None,
                user_id="test_user"
            )
            
            # THEN
            print_calls = [str(call_args) for call_args in mock_console.print.call_args_list]
            assert any("No suggestions available" in call for call in print_calls)

    def test_given_default_user_id_when_not_provided_then_uses_cli_user(
        self, cli_runner, mock_console, mock_unified_memory, mock_session_context,
        mock_template_registry, mock_template
    ):
        """
        GIVEN no custom user ID
        WHEN suggest_defaults_cmd is called with default parameters
        THEN it should use 'cli_user' as default
        """
        # GIVEN
        with patch('empathy_os.meta_workflows.cli_commands.config_commands.UnifiedMemory', 
                   return_value=mock_unified_memory) as mock_memory_cls, \
             patch('empathy_os.meta_workflows.cli_commands.config_commands.SessionContext', 
                   return_value=mock_session_context), \
             patch('empathy_os.meta_workflows.cli_commands.config_commands.TemplateRegistry', 
                   return_value=mock_template_registry):
            
            mock_session_context.suggest_defaults.return_value = {}
            
            # WHEN
            suggest_defaults_cmd(
                template_id="test_template",
                session_id=None,
                user_id="cli_user"  # default value
            )
            
            # THEN
            mock_memory_cls.assert_called_once_with(user_id="cli_user")

    def test_given_string_value_when_displaying_then_converts_to_string(
        self, cli_runner, mock_console, mock_unified_memory, mock_session_context,
        mock_template_registry, mock_template
    ):
        """
        GIVEN suggestions with various value types
        WHEN displaying the results
        THEN all values should be converted to strings
        """
        # GIVEN
        suggestions = {
            "question_1": 123,
            "question_2": True
        }
        
        with patch('empathy_os.meta_workflows.cli_commands.config_commands.UnifiedMemory', 
                   return_value=mock_unified_memory), \
             patch('empathy_os.meta_workflows.cli_commands.config_commands.SessionContext', 
                   return_value=mock_session_context), \
             patch('empathy_os.meta_workflows.cli_commands.config_commands.TemplateRegistry', 
                   return_value=mock_template_registry):
            
            mock_session_context.suggest_defaults.return_value = suggestions
            
            # WHEN
            suggest_defaults_cmd(
                template_id="test_template",
                session_id=None,
                user_id="test_user"
            )
            
            # THEN
            assert mock_console.print.called