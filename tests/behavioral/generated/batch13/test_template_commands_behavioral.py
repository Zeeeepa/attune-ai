"""Behavioral tests for template_commands.

Generated by enhanced autonomous test generation system.

Copyright 2026 Smart-AI-Memory
Licensed under Apache 2.0
"""

from unittest.mock import Mock, patch

import pytest
import typer
from typer.testing import CliRunner

from attune.meta_workflows.cli_commands.template_commands import (
    console,
    list_templates,
    meta_workflow_app,
)


@pytest.fixture
def cli_runner():
    """Provide a CLI runner for testing Typer applications."""
    return CliRunner()


@pytest.fixture
def mock_registry():
    """Provide a mock TemplateRegistry."""
    with patch(
        "attune.meta_workflows.cli_commands.template_commands.TemplateRegistry"
    ) as mock:
        yield mock


@pytest.fixture
def mock_console():
    """Provide a mock Console."""
    with patch(
        "attune.meta_workflows.cli_commands.template_commands.console"
    ) as mock:
        yield mock


@pytest.fixture
def sample_template():
    """Provide a sample template object."""
    template = Mock()
    template.template_id = "test-template"
    template.name = "Test Template"
    template.description = "A test template description"
    template.version = "1.0.0"
    template.author = "Test Author"
    template.tags = ["test", "sample"]
    template.estimated_duration_minutes = 10
    template.form_schema.questions = [Mock(), Mock()]
    template.agent_composition_rules = [Mock(), Mock(), Mock()]
    template.estimated_cost_range = [0.10, 0.50]  # List, not dict - accessed with [0] and [1]
    return template


class TestListTemplates:
    """Behavioral tests for list_templates command."""

    def test_given_no_templates_when_list_called_then_shows_empty_message(
        self, mock_registry, mock_console
    ):
        """Given no templates exist,
        When list_templates is called,
        Then it shows a message indicating no templates found.
        """
        # Given
        registry_instance = Mock()
        registry_instance.list_templates.return_value = []
        mock_registry.return_value = registry_instance

        # When
        list_templates()

        # Then
        mock_console.print.assert_any_call("[yellow]No templates found.[/yellow]")
        assert any(
            "Create templates" in str(call_args)
            for call_args in mock_console.print.call_args_list
        )

    def test_given_templates_exist_when_list_called_then_displays_templates(
        self, mock_registry, mock_console, sample_template
    ):
        """Given templates exist in registry,
        When list_templates is called,
        Then it displays template information.
        """
        # Given
        registry_instance = Mock()
        registry_instance.list_templates.return_value = ["test-template"]
        registry_instance.load_template.return_value = sample_template
        registry_instance.is_builtin.return_value = False
        mock_registry.return_value = registry_instance

        # When
        list_templates()

        # Then
        registry_instance.list_templates.assert_called_once()
        registry_instance.load_template.assert_called_once_with("test-template")
        assert mock_console.print.called

    def test_given_custom_storage_dir_when_list_called_then_uses_custom_dir(
        self, mock_registry, mock_console
    ):
        """Given a custom storage directory,
        When list_templates is called,
        Then it uses the custom directory.
        """
        # Given
        custom_dir = "/custom/templates"
        registry_instance = Mock()
        registry_instance.list_templates.return_value = []
        mock_registry.return_value = registry_instance

        # When
        list_templates(storage_dir=custom_dir)

        # Then
        mock_registry.assert_called_once_with(storage_dir=custom_dir)

    def test_given_builtin_templates_when_list_called_then_shows_builtin_badge(
        self, mock_registry, mock_console, sample_template
    ):
        """Given built-in templates exist,
        When list_templates is called,
        Then it shows built-in badge.
        """
        # Given
        registry_instance = Mock()
        registry_instance.list_templates.return_value = ["builtin-template"]
        registry_instance.load_template.return_value = sample_template
        registry_instance.is_builtin.return_value = True
        mock_registry.return_value = registry_instance

        # When
        list_templates()

        # Then
        registry_instance.is_builtin.assert_called_with("builtin-template")
        # Check that console.print was called with Panel containing the badge
        call_args = mock_console.print.call_args_list
        from rich.panel import Panel
        panel_calls = [call for call in call_args if call[0] and isinstance(call[0][0], Panel)]
        assert len(panel_calls) > 0, "Expected at least one Panel to be printed"
        # Access the Panel's renderable content
        panel = panel_calls[0][0][0]
        panel_content = str(panel.renderable)
        assert "ðŸ“¦ BUILT-IN" in panel_content or "BUILT-IN" in panel_content

    def test_given_user_templates_when_list_called_then_shows_user_badge(
        self, mock_registry, mock_console, sample_template
    ):
        """Given user templates exist,
        When list_templates is called,
        Then it shows user badge.
        """
        # Given
        registry_instance = Mock()
        registry_instance.list_templates.return_value = ["user-template"]
        registry_instance.load_template.return_value = sample_template
        registry_instance.is_builtin.return_value = False
        mock_registry.return_value = registry_instance

        # When
        list_templates()

        # Then
        # Check that console.print was called with Panel containing the user badge
        call_args = mock_console.print.call_args_list
        from rich.panel import Panel
        panel_calls = [call for call in call_args if call[0] and isinstance(call[0][0], Panel)]
        assert len(panel_calls) > 0, "Expected at least one Panel to be printed"
        panel = panel_calls[0][0][0]
        panel_content = str(panel.renderable)
        assert "ðŸ‘¤ USER" in panel_content or "USER" in panel_content

    def test_given_mixed_templates_when_list_called_then_counts_correctly(
        self, mock_registry, mock_console, sample_template
    ):
        """Given both built-in and user templates exist,
        When list_templates is called,
        Then it counts them correctly.
        """
        # Given
        registry_instance = Mock()
        registry_instance.list_templates.return_value = [
            "builtin-1",
            "builtin-2",
            "user-1",
        ]
        registry_instance.load_template.return_value = sample_template
        registry_instance.is_builtin.side_effect = lambda t: t.startswith("builtin")
        mock_registry.return_value = registry_instance

        # When
        list_templates()

        # Then
        print_calls = [str(call) for call in mock_console.print.call_args_list]
        # Should show 2 built-in and 1 user
        assert any("3 total" in call for call in print_calls)

    def test_given_templates_with_cost_range_when_list_called_then_displays_costs(
        self, mock_registry, mock_console, sample_template
    ):
        """Given templates with cost ranges,
        When list_templates is called,
        Then it displays cost information.
        """
        # Given
        registry_instance = Mock()
        registry_instance.list_templates.return_value = ["test-template"]
        registry_instance.load_template.return_value = sample_template
        registry_instance.is_builtin.return_value = False
        mock_registry.return_value = registry_instance

        # When
        list_templates()

        # Then
        # Cost information is displayed in a Panel
        call_args = mock_console.print.call_args_list
        from rich.panel import Panel
        panel_calls = [call for call in call_args if call[0] and isinstance(call[0][0], Panel)]
        assert len(panel_calls) > 0, "Expected at least one Panel to be printed"
        panel = panel_calls[0][0][0]
        panel_content = str(panel.renderable)
        # Should display cost range formatted as $0.10-$0.50
        assert "0.10" in panel_content or "0.50" in panel_content

    def test_given_template_load_fails_when_list_called_then_skips_template(
        self, mock_registry, mock_console
    ):
        """Given a template fails to load,
        When list_templates is called,
        Then it skips that template without crashing.
        """
        # Given
        registry_instance = Mock()
        registry_instance.list_templates.return_value = ["broken-template"]
        registry_instance.load_template.return_value = None
        mock_registry.return_value = registry_instance

        # When
        list_templates()

        # Then - should not raise exception
        mock_console.print.assert_called()

    def test_given_multiple_templates_when_list_called_then_lists_all(
        self, mock_registry, mock_console, sample_template
    ):
        """Given multiple templates,
        When list_templates is called,
        Then it lists all templates.
        """
        # Given
        template1 = Mock()
        template1.template_id = "template-1"
        template1.name = "Template 1"
        template1.description = "First template"
        template1.version = "1.0.0"
        template1.author = "Author 1"
        template1.tags = ["test"]
        template1.estimated_duration_minutes = 10
        template1.form_schema.questions = [Mock()]
        template1.agent_composition_rules = [Mock()]
        template1.estimated_cost_range = [0.10, 0.50]

        template2 = Mock()
        template2.template_id = "template-2"
        template2.name = "Template 2"
        template2.description = "Second template"
        template2.version = "2.0.0"
        template2.author = "Author 2"
        template2.tags = ["prod"]
        template2.estimated_duration_minutes = 20
        template2.form_schema.questions = [Mock(), Mock()]
        template2.agent_composition_rules = [Mock(), Mock()]
        template2.estimated_cost_range = [0.20, 1.00]

        registry_instance = Mock()
        registry_instance.list_templates.return_value = ["template-1", "template-2"]
        registry_instance.load_template.side_effect = [template1, template2]
        registry_instance.is_builtin.return_value = False
        mock_registry.return_value = registry_instance

        # When
        list_templates()

        # Then
        assert registry_instance.load_template.call_count == 2
        registry_instance.load_template.assert_any_call("template-1")
        registry_instance.load_template.assert_any_call("template-2")

    def test_given_template_with_empty_tags_when_list_called_then_handles_gracefully(
        self, mock_registry, mock_console, sample_template
    ):
        """Given a template with empty tags,
        When list_templates is called,
        Then it handles it gracefully.
        """
        # Given
        sample_template.tags = []
        registry_instance = Mock()
        registry_instance.list_templates.return_value = ["test-template"]
        registry_instance.load_template.return_value = sample_template
        registry_instance.is_builtin.return_value = False
        mock_registry.return_value = registry_instance

        # When
        list_templates()

        # Then - should not raise exception
        mock_console.print.assert_called()

    def test_given_template_with_no_questions_when_list_called_then_shows_zero(
        self, mock_registry, mock_console, sample_template
    ):
        """Given a template with no questions,
        When list_templates is called,
        Then it shows zero questions.
        """
        # Given
        sample_template.form_schema.questions = []
        registry_instance = Mock()
        registry_instance.list_templates.return_value = ["test-template"]
        registry_instance.load_template.return_value = sample_template
        registry_instance.is_builtin.return_value = False
        mock_registry.return_value = registry_instance

        # When
        list_templates()

        # Then
        # Questions count is displayed in a Panel
        call_args = mock_console.print.call_args_list
        from rich.panel import Panel
        panel_calls = [call for call in call_args if call[0] and isinstance(call[0][0], Panel)]
        assert len(panel_calls) > 0, "Expected at least one Panel to be printed"
        panel = panel_calls[0][0][0]
        panel_content = str(panel.renderable)
        assert "Questions: 0" in panel_content

    def test_given_template_with_no_rules_when_list_called_then_shows_zero(
        self, mock_registry, mock_console, sample_template
    ):
        """Given a template with no agent rules,
        When list_templates is called,
        Then it shows zero rules.
        """
        # Given
        sample_template.agent_composition_rules = []
        registry_instance = Mock()
        registry_instance.list_templates.return_value = ["test-template"]
        registry_instance.load_template.return_value = sample_template
        registry_instance.is_builtin.return_value = False
        mock_registry.return_value = registry_instance

        # When
        list_templates()

        # Then
        # Agent rules count is displayed in a Panel
        call_args = mock_console.print.call_args_list
        from rich.panel import Panel
        panel_calls = [call for call in call_args if call[0] and isinstance(call[0][0], Panel)]
        assert len(panel_calls) > 0, "Expected at least one Panel to be printed"
        panel = panel_calls[0][0][0]
        panel_content = str(panel.renderable)
        assert "Agent Rules: 0" in panel_content

    def test_given_builtin_templates_when_list_called_then_shows_migration_hint(
        self, mock_registry, mock_console, sample_template
    ):
        """Given built-in templates exist,
        When list_templates is called,
        Then it shows migration hint.
        """
        # Given
        registry_instance = Mock()
        registry_instance.list_templates.return_value = ["builtin-template"]
        registry_instance.load_template.return_value = sample_template
        registry_instance.is_builtin.return_value = True
        mock_registry.return_value = registry_instance

        # When
        list_templates()

        # Then
        print_calls = [str(call) for call in mock_console.print.call_args_list]
        assert any("migrate" in call.lower() for call in print_calls)

    def test_given_default_storage_dir_when_list_called_then_uses_default(
        self, mock_registry, mock_console
    ):
        """Given no storage directory specified,
        When list_templates is called,
        Then it uses default directory.
        """
        # Given
        registry_instance = Mock()
        registry_instance.list_templates.return_value = []
        mock_registry.return_value = registry_instance

        # When
        # Note: When no argument is provided, typer passes the default value from the Option
        # We need to call with the explicit default value
        list_templates(storage_dir=".attune/meta_workflows/templates")

        # Then
        mock_registry.assert_called_once_with(
            storage_dir=".attune/meta_workflows/templates"
        )

    def test_given_registry_error_when_list_called_then_raises_exception(
        self, mock_registry
    ):
        """Given registry initialization fails,
        When list_templates is called,
        Then it raises an exception.
        """
        # Given
        mock_registry.side_effect = Exception("Registry error")

        # When/Then
        # The function catches exceptions and raises typer.Exit instead
        with pytest.raises(typer.Exit) as exc_info:
            list_templates()
        assert exc_info.value.exit_code == 1

    def test_given_template_with_special_characters_when_list_called_then_displays(
        self, mock_registry, mock_console, sample_template
    ):
        """Given a template with special characters in name,
        When list_templates is called,
        Then it displays correctly.
        """
        # Given
        sample_template.name = "Test & Template <Special>"
        sample_template.description = "Description with 'quotes' and \"double\""
        registry_instance = Mock()
        registry_instance.list_templates.return_value = ["test-template"]
        registry_instance.load_template.return_value = sample_template
        registry_instance.is_builtin.return_value = False
        mock_registry.return_value = registry_instance

        # When
        list_templates()

        # Then - should not raise exception
        mock_console.print.assert_called()

    def test_given_template_with_long_description_when_list_called_then_displays(
        self, mock_registry, mock_console, sample_template
    ):
        """Given a template with a very long description,
        When list_templates is called,
        Then it displays the full description.
        """
        # Given
        sample_template.description = "A" * 500
        registry_instance = Mock()
        registry_instance.list_templates.return_value = ["test-template"]
        registry_instance.load_template.return_value = sample_template
        registry_instance.is_builtin.return_value = False
        mock_registry.return_value = registry_instance

        # When
        list_templates()

        # Then - should not raise exception
        mock_console.print.assert_called()

    def test_given_template_with_multiple_tags_when_list_called_then_shows_all(
        self, mock_registry, mock_console, sample_template
    ):
        """Given a template with multiple tags,
        When list_templates is called,
        Then it shows all tags.
        """
        # Given
        sample_template.tags = ["tag1", "tag2", "tag3", "tag4"]
        registry_instance = Mock()
        registry_instance.list_templates.return_value = ["test-template"]
        registry_instance.load_template.return_value = sample_template
        registry_instance.is_builtin.return_value = False
        mock_registry.return_value = registry_instance

        # When
        list_templates()

        # Then
        # Tags are displayed in a Panel
        call_args = mock_console.print.call_args_list
        from rich.panel import Panel
        panel_calls = [call for call in call_args if call[0] and isinstance(call[0][0], Panel)]
        assert len(panel_calls) > 0, "Expected at least one Panel to be printed"
        panel = panel_calls[0][0][0]
        panel_content = str(panel.renderable)
        assert "tag1, tag2, tag3, tag4" in panel_content

    def test_given_no_templates_when_list_called_then_shows_storage_dir(
        self, mock_registry, mock_console
    ):
        """Given no templates exist,
        When list_templates is called,
        Then it shows the storage directory path.
        """
        # Given
        registry_instance = Mock()
        registry_instance.list_templates.return_value = []
        mock_registry.return_value = registry_instance

        # When
        list_templates(storage_dir="/custom/path")

        # Then
        print_calls = [str(call) for call in mock_console.print.call_args_list]
        assert any("/custom/path" in call for call in print_calls)


class TestMetaWorkflowApp:
    """Behavioral tests for meta_workflow_app."""

    def test_given_meta_workflow_app_when_accessed_then_is_typer_instance(self):
        """Given the meta_workflow_app,
        When accessed,
        Then it is a Typer instance.
        """
        # Given/When/Then
        assert isinstance(meta_workflow_app, typer.Typer)

    def test_given_list_templates_command_when_registered_then_exists_in_app(self):
        """Given list-templates command,
        When registered with app,
        Then it exists in the command registry.
        """
        # Given/When
        commands = [cmd.name for cmd in meta_workflow_app.registered_commands]

        # Then
        assert "list-templates" in commands


class TestConsoleObject:
    """Behavioral tests for console object."""

    def test_given_console_when_imported_then_is_console_instance(self):
        """Given the console object,
        When imported,
        Then it is a Console instance.
        """
        # Given/When/Then
        from rich.console import Console

        assert isinstance(console, Console)


class TestIntegration:
    """Integration tests for template commands."""

    @patch("attune.meta_workflows.cli_commands.template_commands.TemplateRegistry")
    @patch("attune.meta_workflows.cli_commands.template_commands.console")
    def test_given_real_scenario_when_list_templates_then_complete_workflow(
        self, mock_console, mock_registry, sample_template
    ):
        """Given a real-world scenario with mixed templates,
        When list_templates is executed,
        Then the complete workflow executes successfully.
        """
        # Given
        builtin_template = Mock()
        builtin_template.template_id = "builtin-1"
        builtin_template.name = "Built-in Template"
        builtin_template.description = "A built-in template"
        builtin_template.version = "1.0.0"
        builtin_template.author = "System"
        builtin_template.tags = ["builtin"]
        builtin_template.estimated_duration_minutes = 10
        builtin_template.form_schema.questions = [Mock()]
        builtin_template.agent_composition_rules = [Mock()]
        builtin_template.estimated_cost_range = [0.10, 0.50]

        user_template = Mock()
        user_template.template_id = "user-1"
        user_template.name = "User Template"
        user_template.description = "A user template"
        user_template.version = "1.0.0"
        user_template.author = "User"
        user_template.tags = ["custom"]
        user_template.estimated_duration_minutes = 20
        user_template.form_schema.questions = [Mock(), Mock()]
        user_template.agent_composition_rules = [Mock(), Mock()]
        user_template.estimated_cost_range = [0.20, 1.00]

        registry_instance = Mock()
        registry_instance.list_templates.return_value = ["builtin-1", "user-1"]
        registry_instance.load_template.side_effect = [builtin_template, user_template]
        registry_instance.is_builtin.side_effect = lambda t: t == "builtin-1"
        mock_registry.return_value = registry_instance

        # When
        list_templates(storage_dir="/custom/path")

        # Then
        mock_registry.assert_called_once_with(storage_dir="/custom/path")
        assert registry_instance.list_templates.call_count == 1
        assert registry_instance.load_template.call_count == 2
        assert mock_console.print.call_count > 0

    @patch("attune.meta_workflows.cli_commands.template_commands.TemplateRegistry")
    @patch("attune.meta_workflows.cli_commands.template_commands.console")
    def test_given_empty_registry_when_list_templates_then_helpful_message(
        self, mock_console, mock_registry
    ):
        """Given an empty registry,
        When list_templates is executed,
        Then it shows helpful creation instructions.
        """
        # Given
        registry_instance = Mock()
        registry_instance.list_templates.return_value = []
        mock_registry.return_value = registry_instance

        # When
        list_templates()

        # Then
        print_calls = [str(call) for call in mock_console.print.call_args_list]
        assert any("No templates found" in call for call in print_calls)
        assert any("Create templates" in call for call in print_calls)
